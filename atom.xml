<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Wafer&#39;s Note</title>
  
  <subtitle>Shenzhen is great!</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://wafer.li/"/>
  <updated>2019-09-30T18:36:11.000Z</updated>
  <id>https://wafer.li/</id>
  
  <author>
    <name>Wafer Li</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>macOS 如何 B 站直播</title>
    <link href="https://wafer.li//Live/macos-%E5%A6%82%E4%BD%95-b-%E7%AB%99%E7%9B%B4%E6%92%AD/"/>
    <id>https://wafer.li//Live/macos-如何-b-站直播/</id>
    <published>2019-09-30T16:29:00.000Z</published>
    <updated>2019-09-30T18:36:11.000Z</updated>
    
    <content type="html"><![CDATA[<p>之前由于给 B 站交了身份证，因此就想稍微利用一下，直播写一下代码；</p><p>不过 macOS 没有 B 站的一键开播客户端，这里来介绍一下我的折腾成果。</p><a id="more"></a><h2 id="1-前期准备"><a class="markdownIt-Anchor" href="#1-前期准备"></a> 1. 前期准备</h2><ol><li>实名认证（手持身份证）的 B 站账户</li><li>OBS（录屏）</li><li>Soundflower（录制桌面声音）</li><li>弹幕库（弹幕管理）</li></ol><h2 id="2-安装"><a class="markdownIt-Anchor" href="#2-安装"></a> 2. 安装</h2><p>OBS 和 Soundflower 都可以使用 <code>brew</code> 安装</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">brew cask install obs</span><br><span class="line">brew cask install soundflower</span><br></pre></td></tr></table></figure><p>弹幕库在其<span class="exturl" data-url="aHR0cDovL2JpbGliaWxpLmRhbm1ha3UubGl2ZQ==" title="http://bilibili.danmaku.live">官网<i class="fa fa-external-link"></i></span>安装</p><h2 id="3-配置来源捕获"><a class="markdownIt-Anchor" href="#3-配置来源捕获"></a> 3. 配置来源捕获</h2><p>现在 OBS 安装之后已经有一个配置向导了，跟着配置向导走就可以配置完成。</p><p>随后在来源中建立一个捕获，如图所示：</p><p><img alt="建立捕获" data-src="../../images/%E5%BB%BA%E7%AB%8B%E6%8D%95%E8%8E%B7.png"></p><p>这里建立的是显示捕获，也就是将一个显示屏的图像全部捕获</p><p>在上方的区域会显示当前捕获的内容。</p><p>除了显示捕获之外，还可以创建窗口捕获，同时上方区域可以调整各个来源图像的大小，可以捕获多个来源并将它们统一显示到上方区域。</p><p>上方的显示区域就是你最终直播出去的图像了。</p><h2 id="4-捕捉桌面音频"><a class="markdownIt-Anchor" href="#4-捕捉桌面音频"></a> 4. 捕捉桌面音频</h2><p>通常来说，我们直播的同时也希望让观众能听到我们电脑里面播放的音乐，有时候还需要设置自动点歌功能；</p><p>但是，OBS 在 macOS 下不能捕捉桌面音频，需要一些其他的软件进行这个工作。</p><p>macOS 下的桌面音频捕捉工具有很多，但是大部分不是收费的就是配置比较复杂，经过一番对比之后，决定使用 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL21hdHRpbmdhbGxzL1NvdW5kZmxvd2Vy" title="https://github.com/mattingalls/Soundflower">Soundflower<i class="fa fa-external-link"></i></span> 进行音频捕捉。</p><p>安装它之后，会多出两个声音输出设备，如图所示：</p><p><img alt="Soundflower 音频输出设备" data-src="../../images/soundflower-%E9%9F%B3%E9%A2%91%E8%BE%93%E5%87%BA%E8%AE%BE%E5%A4%87.png"></p><p>同时，OBS 中的音频配置选项中的桌面音频也终于可以配置了。</p><p>将 mac 的声音输出设备如上图选择，然后在 OBS 的桌面音频中选择相同的输出，即可将桌面音频进行推流。</p><p>到这里，我们会发现 mac 很意料之中的没有了声音，听众能听到声音，但是我们听不到也不行啊；</p><p>不过，好在 OBS 的音频具有一个 <strong>监听并输出</strong> 的选项，在音频的高级属性中可以设置；</p><p>我们将监听设备设置为能让我们听到声音的输出，如内置的音频输出或者喇叭，然后将对应的音频轨道设置为监听并输出；</p><p>这样，我们和观众就都能听到声音了。</p><h2 id="5-开始推流"><a class="markdownIt-Anchor" href="#5-开始推流"></a> 5. 开始推流</h2><p>在音频和视频准备完毕，本地测试没有问题之后，我们就可以开始直播了。</p><p>首先，打开弹幕库的快速开播，点击开始直播获得 RTMP 地址和密码；</p><p>然后在 OBS 的推流选项中选择『自定义推流』，并填入获取到的 RTMP 地址和密码；</p><p>最后，在 OBS 主界面的右下角点击『开始推流』，你的直播就开始了！</p><h2 id="6-题外话"><a class="markdownIt-Anchor" href="#6-题外话"></a> 6. 题外话</h2><p>为了给我们的直播间能有点流量，我们最好给直播间设置一个封面。</p><p>不过封面这个东西和 B 站的政策有关，这里来介绍一下目前 (2019.10.01) 的 B 站的封面政策。</p><p>B 站的封面分为正方形和长方形两种，其中：</p><ol><li>正方形为『颜值封面』，也就是这个封面必须是『<strong>真人的脸</strong>』，注意不要把不是真人脸的图传到这里面去</li><li>长方形为普通封面，也就是可以上传普通的图片，但是也不是什么图都行，例如大面积留白，全部都是字的封面就不行</li></ol><p>B 站封面是审核制的，通不通过实际上也有一定的运气成分。</p><p>最后祝大家直播愉快(?)</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;之前由于给 B 站交了身份证，因此就想稍微利用一下，直播写一下代码；&lt;/p&gt;&lt;p&gt;不过 macOS 没有 B 站的一键开播客户端，这里来介绍一下我的折腾成果。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Live" scheme="https://wafer.li/categories/Live/"/>
    
    
      <category term="Live" scheme="https://wafer.li/tags/Live/"/>
    
      <category term="BiliBili" scheme="https://wafer.li/tags/BiliBili/"/>
    
  </entry>
  
  <entry>
    <title>音视频开发基础概念</title>
    <link href="https://wafer.li//MediaDev/%E9%9F%B3%E8%A7%86%E9%A2%91%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"/>
    <id>https://wafer.li//MediaDev/音视频开发基础知识/</id>
    <published>2019-08-07T15:33:00.000Z</published>
    <updated>2019-09-11T10:25:33.000Z</updated>
    
    <content type="html"><![CDATA[<p>最近准备入门音视频开发，就学习内容做一下笔记吧</p><a id="more"></a><h2 id="1-声音的物理相关概念"><a class="markdownIt-Anchor" href="#1-声音的物理相关概念"></a> 1. 声音的物理相关概念</h2><p>声音是纵波，是由波源振动产生的，声波在介质中传播，是通过波源振动引起介质分子的周期性振动进行的</p><h3 id="11-声音相关-n-要素解析"><a class="markdownIt-Anchor" href="#11-声音相关-n-要素解析"></a> 1.1 声音相关 n 要素解析</h3><ul><li>声波三要素<ol><li>频率</li><li>振幅</li><li>波形</li></ol></li><li>语音四要素<ol><li>音高</li><li>音强</li><li>音长</li><li>音色</li></ol></li><li>声音三要素<ol><li>音调</li><li>响度</li><li>音色</li></ol></li></ul><p>几要素之间的关系：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">频率 &lt;-&gt; 音高 = 音调</span><br><span class="line">振幅 &lt;-&gt; 音强 &lt;-&gt; 响度</span><br><span class="line">波形 &lt;-&gt; 音色</span><br></pre></td></tr></table></figure><p>具体来说，声音的音高就是音调，与声波的频率相关<br>声音的音强和响度相关，两者和声波的振幅有关<br>声音的音色与声波的波形相关，但也和其他要素有关</p><p>音长是一个音的持续时间长短，在语音学等有研究意义，但不属于声音的物理性质</p><p>下面对几个概念进行解析</p><h4 id="111-音调与频率"><a class="markdownIt-Anchor" href="#111-音调与频率"></a> 1.1.1 音调与频率</h4><p>音调或者音高是衡量人类心理对标准音高的感受，通常使用字母和升降调符号（如 <code>A#</code>）来对音高进行标记，和声波的频率相关。</p><p>标准音高记为 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord mathdefault">A</span></span></span></span>，其频率为 <strong>440Hz</strong></p><p>事实上，根据不同的标准可以列出频率和音调之间的函数关系，如广为使用的 MIDI 标准规定了一个线性的音高空间，其函数表达式为：</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>p</mi><mo>=</mo><mn>69</mn><mo>+</mo><mn>12</mn><mo>×</mo><msub><mo><mi>log</mi><mo>⁡</mo></mo><mn>2</mn></msub><mrow><mo fence="true">(</mo><mfrac><mi>f</mi><mn>440</mn></mfrac><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">p = 69 + 12\times\log_2 { \left(\frac {f}{440} \right) }</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.625em;vertical-align:-.19444em"></span><span class="mord mathdefault">p</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.72777em;vertical-align:-.08333em"></span><span class="mord">6</span><span class="mord">9</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:.72777em;vertical-align:-.08333em"></span><span class="mord">1</span><span class="mord">2</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:2.40003em;vertical-align:-.95003em"></span><span class="mop"><span class="mop">lo<span style="margin-right:.01389em">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.20696799999999996em"><span style="top:-2.4558600000000004em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.24414em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="minner"><span class="mopen delimcenter" style="top:0"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714399999999998em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">4</span><span class="mord">4</span><span class="mord">0</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathdefault" style="margin-right:.10764em">f</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0"><span class="delimsizing size3">)</span></span></span></span></span></span></span></span></p><p>其中，标准音高 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>A</mi><mo>=</mo><mn>69</mn></mrow><annotation encoding="application/x-tex">A = 69</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord mathdefault">A</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.64444em;vertical-align:0"></span><span class="mord">6</span><span class="mord">9</span></span></span></span></p><p>与音调相关的常见概念还有：</p><ol><li>音阶：按照音高排列的一系列音符，有多种组合方式，例如常见的 Do-Re-Mi 就是七声音阶</li><li>音程：两个音的音高之间的相对关系，在频率上表现为两个音的频率差距，通过调律系统确定，目前最常用的为十二平均律</li><li>八度：音程的一种，指的是两个音的频率关系为 <strong>2:1</strong></li><li>半音：采用十二平均律的一种音程划分，一个八度分为十二个半音，半音之间的频率<strong>比值</strong>为： <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mstyle scriptlevel="0" displaystyle="true"><mtext> </mtext><mroot><mn>2</mn><mn>12</mn></mroot><mo>=</mo><msup><mn>2</mn><mfrac><mn>1</mn><mn>12</mn></mfrac></msup><mo>≈</mo><mtext> </mtext></mstyle><mstyle scriptlevel="0" displaystyle="true"><mn>1.0594630943593</mn></mstyle><mstyle scriptlevel="0" displaystyle="true"><mn>1.0594630943593</mn></mstyle></mrow><annotation encoding="application/x-tex">{\displaystyle \,{\sqrt[{12}]{2}}=2^{\frac {1}{12}}\approx \,} {\displaystyle 1.0594630943593} {\displaystyle 1.0594630943593}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0879250000000003em;vertical-align:-.08390500000000001em"></span><span class="mord"><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mord sqrt"><span class="root"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.845534em"><span style="top:-3.023314em"><span class="pstrut" style="height:2.5em"></span><span class="sizing reset-size6 size1 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.956095em"><span class="svg-align" style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord" style="padding-left:.833em"><span class="mord">2</span></span></span><span style="top:-2.916095em"><span class="pstrut" style="height:3em"></span><span class="hide-tail" style="min-width:.853em;height:1.08em"><svg width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429c69,-144,104.5,-217.7,106.5,-221c5.3,-9.3,12,-14,20,-14H400000v40H845.2724s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z M834 80H400000v40H845z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.08390500000000001em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.0040200000000001em"><span style="top:-3.4130000000000003em;margin-right:.05em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.8443142857142858em"><span style="top:-2.656em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">2</span></span></span></span><span style="top:-3.2255000000000003em"><span class="pstrut" style="height:3em"></span><span class="frac-line mtight" style="border-bottom-width:.049em"></span></span><span style="top:-3.384em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.344em"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:.16666666666666666em"></span></span><span class="mord"><span class="mord">1</span><span class="mord">.</span><span class="mord">0</span><span class="mord">5</span><span class="mord">9</span><span class="mord">4</span><span class="mord">6</span><span class="mord">3</span><span class="mord">0</span><span class="mord">9</span><span class="mord">4</span><span class="mord">3</span><span class="mord">5</span><span class="mord">9</span><span class="mord">3</span></span><span class="mord"><span class="mord">1</span><span class="mord">.</span><span class="mord">0</span><span class="mord">5</span><span class="mord">9</span><span class="mord">4</span><span class="mord">6</span><span class="mord">3</span><span class="mord">0</span><span class="mord">9</span><span class="mord">4</span><span class="mord">3</span><span class="mord">5</span><span class="mord">9</span><span class="mord">3</span></span></span></span></span></li><li>全音：两个半音的距离为一个全音</li></ol><h4 id="112-音强-声压和响度"><a class="markdownIt-Anchor" href="#112-音强-声压和响度"></a> 1.1.2 音强、声压和响度</h4><p>音强、声压响度都与声波的振幅相关，都是描述声音能量大小的一个度量，其中：</p><p>音强又称声强，是<strong>客观量</strong>，定义为单位面积的声音功率，单位为 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="normal">W</mi><mi mathvariant="normal">/</mi><msup><mi mathvariant="normal">m</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\mathrm{W/m^2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-.25em"></span><span class="mord"><span class="mord mathrm" style="margin-right:.01389em">W</span><span class="mord mathrm">/</span><span class="mord"><span class="mord mathrm">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.8141079999999999em"><span style="top:-3.063em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathrm mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></p><p>声压也是<strong>客观量</strong>，是指声波通过介质时，由振动产生的<strong>压强改变量</strong>，单位为帕斯卡(<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>P</mi><mi>a</mi></mrow><annotation encoding="application/x-tex">Pa</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord mathdefault" style="margin-right:.13889em">P</span><span class="mord mathdefault">a</span></span></span></span>)</p><p>响度是<strong>主观量</strong>，指的是人类感觉声音大小的知觉量，响度不仅和音强有关，也和<strong>频率</strong>有关</p><h5 id="1121-音强和声压"><a class="markdownIt-Anchor" href="#1121-音强和声压"></a> 1.1.2.1 音强和声压</h5><p>音强和声压具有换算关系，设 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>I</mi></mrow><annotation encoding="application/x-tex">I</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord mathdefault" style="margin-right:.07847em">I</span></span></span></span> 为声强，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.625em;vertical-align:-.19444em"></span><span class="mord mathdefault">p</span></span></span></span>为声压，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>v</mi></mrow><annotation encoding="application/x-tex">v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mord mathdefault" style="margin-right:.03588em">v</span></span></span></span>为声音在介质中的速度，则：</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>I</mi><mo>=</mo><mi>p</mi><mo>⋅</mo><mi>v</mi></mrow><annotation encoding="application/x-tex">I = p \cdot v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord mathdefault" style="margin-right:.07847em">I</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.63889em;vertical-align:-.19444em"></span><span class="mord mathdefault">p</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mord mathdefault" style="margin-right:.03588em">v</span></span></span></span></span></p><blockquote><p>上面的计算式可以通过单位制运算进行验证：</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>P</mi><mi>a</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>N</mi><mi mathvariant="normal">/</mi><msup><mi>m</mi><mn>2</mn></msup></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mi>v</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>m</mi><mi mathvariant="normal">/</mi><mi>s</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mo>∴</mo><msub><mi>I</mi><mn>1</mn></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mfrac><mi>N</mi><msup><mi>m</mi><mn>2</mn></msup></mfrac><mo>⋅</mo><mfrac><mi>m</mi><mi>s</mi></mfrac></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mfrac><mi>N</mi><mrow><mi>m</mi><mi>s</mi></mrow></mfrac></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mo>∵</mo><mi>I</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>W</mi><mi mathvariant="normal">/</mi><msup><mi>m</mi><mn>2</mn></msup></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mi>P</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>F</mi><mo>⋅</mo><mi>v</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>N</mi><mo>⋅</mo><mi>m</mi><mi mathvariant="normal">/</mi><mi>s</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>W</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mo>∴</mo><msub><mi>I</mi><mn>2</mn></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mfrac><mi>W</mi><msup><mi>m</mi><mn>2</mn></msup></mfrac></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mfrac><mrow><mi>N</mi><mo>⋅</mo><mi>m</mi><mi mathvariant="normal">/</mi><mi>s</mi></mrow><msup><mi>m</mi><mn>2</mn></msup></mfrac></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mfrac><mi>N</mi><mrow><mi>m</mi><mi>s</mi></mrow></mfrac></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mo>∵</mo><msub><mi>I</mi><mn>1</mn></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msub><mi>I</mi><mn>2</mn></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mo>∴</mo><mi>C</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mi>o</mi><mi>r</mi><mi>r</mi><mi>e</mi><mi>c</mi><mi>t</mi></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned} Pa &amp;= N / m^2 \\ v &amp;= m/s \\ \therefore I_1 &amp;= \frac{N}{m^2} \cdot \frac{m}{s} \\ &amp;= \frac{N}{ms} \\ \because I &amp;= W/m^2 \\ P &amp;= F \cdot v \\ &amp;= N \cdot m/s \\ &amp;= W \\ \therefore I_2 &amp;= \frac{W}{m^2} \\ &amp;= \frac{N \cdot m/s}{m^2} \\ &amp;= \frac{N}{ms} \\ \because I_1 &amp;= I_2 \\ \therefore C&amp;orrect \end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:23.846536em;vertical-align:-11.673268000000002em"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:12.173268em"><span style="top:-14.73616em"><span class="pstrut" style="height:3.427em"></span><span class="mord"><span class="mord mathdefault" style="margin-right:.13889em">P</span><span class="mord mathdefault">a</span></span></span><span style="top:-13.23616em"><span class="pstrut" style="height:3.427em"></span><span class="mord"><span class="mord mathdefault" style="margin-right:.03588em">v</span></span></span><span style="top:-11.21583em"><span class="pstrut" style="height:3.427em"></span><span class="mord"><span class="mrel amsrm">∴</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mord"><span class="mord mathdefault" style="margin-right:.07847em">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.30110799999999993em"><span style="top:-2.5500000000000003em;margin-left:-.07847em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span><span style="top:-8.869499999999999em"><span class="pstrut" style="height:3.427em"></span><span class="mord"></span></span><span style="top:-7.019391999999998em"><span class="pstrut" style="height:3.427em"></span><span class="mord"><span class="mrel amsrm">∵</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mord mathdefault" style="margin-right:.07847em">I</span></span></span><span style="top:-5.519391999999998em"><span class="pstrut" style="height:3.427em"></span><span class="mord"><span class="mord mathdefault" style="margin-right:.13889em">P</span></span></span><span style="top:-4.019391999999998em"><span class="pstrut" style="height:3.427em"></span><span class="mord"></span></span><span style="top:-2.519391999999999em"><span class="pstrut" style="height:3.427em"></span><span class="mord"></span></span><span style="top:-.4990619999999989em"><span class="pstrut" style="height:3.427em"></span><span class="mord"><span class="mrel amsrm">∴</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mord"><span class="mord mathdefault" style="margin-right:.07847em">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.30110799999999993em"><span style="top:-2.5500000000000003em;margin-left:-.07847em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span><span style="top:1.913938em"><span class="pstrut" style="height:3.427em"></span><span class="mord"></span></span><span style="top:4.260268000000003em"><span class="pstrut" style="height:3.427em"></span><span class="mord"></span></span><span style="top:6.086268000000002em"><span class="pstrut" style="height:3.427em"></span><span class="mord"><span class="mrel amsrm">∵</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mord"><span class="mord mathdefault" style="margin-right:.07847em">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.30110799999999993em"><span style="top:-2.5500000000000003em;margin-left:-.07847em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span><span style="top:7.586268000000002em"><span class="pstrut" style="height:3.427em"></span><span class="mord"><span class="mrel amsrm">∴</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mord mathdefault" style="margin-right:.07153em">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:11.673268000000002em"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:12.173268em"><span style="top:-14.73616em"><span class="pstrut" style="height:3.427em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mord mathdefault" style="margin-right:.10903em">N</span><span class="mord">/</span><span class="mord"><span class="mord mathdefault">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.8641079999999999em"><span style="top:-3.113em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-13.23616em"><span class="pstrut" style="height:3.427em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mord mathdefault">m</span><span class="mord">/</span><span class="mord mathdefault">s</span></span></span><span style="top:-11.21583em"><span class="pstrut" style="height:3.427em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mord mathdefault">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.740108em"><span style="top:-2.9890000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathdefault" style="margin-right:.10903em">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.10756em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathdefault">s</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathdefault">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-8.869499999999999em"><span class="pstrut" style="height:3.427em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathdefault">m</span><span class="mord mathdefault">s</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathdefault" style="margin-right:.10903em">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-7.019391999999998em"><span class="pstrut" style="height:3.427em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mord mathdefault" style="margin-right:.13889em">W</span><span class="mord">/</span><span class="mord"><span class="mord mathdefault">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.8641079999999999em"><span style="top:-3.113em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-5.519391999999998em"><span class="pstrut" style="height:3.427em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mord mathdefault" style="margin-right:.13889em">F</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mord mathdefault" style="margin-right:.03588em">v</span></span></span><span style="top:-4.019391999999998em"><span class="pstrut" style="height:3.427em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mord mathdefault" style="margin-right:.10903em">N</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mord mathdefault">m</span><span class="mord">/</span><span class="mord mathdefault">s</span></span></span><span style="top:-2.519391999999999em"><span class="pstrut" style="height:3.427em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mord mathdefault" style="margin-right:.13889em">W</span></span></span><span style="top:-.4990619999999989em"><span class="pstrut" style="height:3.427em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mord mathdefault">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.740108em"><span style="top:-2.9890000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathdefault" style="margin-right:.13889em">W</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:1.913938em"><span class="pstrut" style="height:3.427em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mord mathdefault">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.740108em"><span style="top:-2.9890000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathdefault" style="margin-right:.10903em">N</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mord mathdefault">m</span><span class="mord">/</span><span class="mord mathdefault">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:4.260268000000003em"><span class="pstrut" style="height:3.427em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathdefault">m</span><span class="mord mathdefault">s</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathdefault" style="margin-right:.10903em">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:6.086268000000002em"><span class="pstrut" style="height:3.427em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mord"><span class="mord mathdefault" style="margin-right:.07847em">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.30110799999999993em"><span style="top:-2.5500000000000003em;margin-left:-.07847em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span><span style="top:7.586268000000002em"><span class="pstrut" style="height:3.427em"></span><span class="mord"><span class="mord"></span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:.02778em">r</span><span class="mord mathdefault" style="margin-right:.02778em">r</span><span class="mord mathdefault">e</span><span class="mord mathdefault">c</span><span class="mord mathdefault">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:11.673268000000002em"><span></span></span></span></span></span></span></span></span></span></span></span></p></blockquote><h5 id="1122-声压和声压级"><a class="markdownIt-Anchor" href="#1122-声压和声压级"></a> 1.1.2.2 声压和声压级</h5><p>声压的变化范围很广，因此，通常使用声压级(SPL)对声音的大小进行描述，声压级是以对数尺度衡量有效声压对一个基准值的大小，单位为分贝(<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="normal">d</mi><mi mathvariant="normal">B</mi></mrow><annotation encoding="application/x-tex">\mathrm{dB}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.69444em;vertical-align:0"></span><span class="mord"><span class="mord mathrm">d</span><span class="mord mathrm">B</span></span></span></span></span>)</p><p>声压级基准值：人类对于 <strong>1kHz</strong> 的听阈，即产生听觉的最小压强，为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>20</mn><mi>μ</mi><mrow><mi mathvariant="normal">P</mi><mi mathvariant="normal">a</mi></mrow></mrow><annotation encoding="application/x-tex">20\mu\mathrm{Pa}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.8777699999999999em;vertical-align:-.19444em"></span><span class="mord">2</span><span class="mord">0</span><span class="mord mathdefault">μ</span><span class="mord"><span class="mord mathrm">P</span><span class="mord mathrm">a</span></span></span></span></span>，也被定义为 0 分贝</p><p>声压级换算公式：</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>L</mi><mi>p</mi></msub><mo>=</mo><mn>20</mn><msub><mo><mi>log</mi><mo>⁡</mo></mo><mn>10</mn></msub><mrow><mo fence="true">(</mo><mfrac><msub><mi>p</mi><mrow><mi mathvariant="normal">r</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">s</mi></mrow></msub><msub><mi>p</mi><mrow><mi mathvariant="normal">r</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">f</mi></mrow></msub></mfrac><mo fence="true">)</mo></mrow><mrow><mi mathvariant="normal">d</mi><mi mathvariant="normal">B</mi></mrow></mrow><annotation encoding="application/x-tex">L_{p}=20\log _{10}\left({\frac {p_{\mathrm {rms} }}{p_{\mathrm {ref} }}}\right){\mathrm{dB}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.969438em;vertical-align:-.286108em"></span><span class="mord"><span class="mord mathdefault">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.15139200000000003em"><span style="top:-2.5500000000000003em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">p</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.286108em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:2.40003em;vertical-align:-.95003em"></span><span class="mord">2</span><span class="mord">0</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mop"><span class="mop">lo<span style="margin-right:.01389em">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.20696799999999996em"><span style="top:-2.4558600000000004em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.24414em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="minner"><span class="mopen delimcenter" style="top:0"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1075599999999999em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.33610799999999996em"><span style="top:-2.5500000000000003em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">r</span><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight" style="margin-right:.07778em">f</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">r</span><span class="mord mathrm mtight">m</span><span class="mord mathrm mtight">s</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.8804400000000001em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span><span class="mclose delimcenter" style="top:0"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mord"><span class="mord mathrm">d</span><span class="mord mathrm">B</span></span></span></span></span></span></span></p><p>其中，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>p</mi><mrow><mi mathvariant="normal">r</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">f</mi></mrow></msub></mrow><annotation encoding="application/x-tex">p_\mathrm{ref}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.625em;vertical-align:-.19444em"></span><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.33610799999999996em"><span style="top:-2.5500000000000003em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">r</span><span class="mord mathrm mtight">e</span><span class="mord mathrm mtight" style="margin-right:.07778em">f</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 即为声压级基准值</p><blockquote><p>分贝，是两个量度相同的单位的<strong>比值的度量</strong>，任何的两个相同单位的量的比值都可以是分贝，因此分贝的使用范围非常广泛，除了在这里的声学领域使用到以外，在通信领域，例如 WIFI 的信号强度也是使用分贝进行度量</p></blockquote><h5 id="1123-响度-声压值和频率的关系"><a class="markdownIt-Anchor" href="#1123-响度-声压值和频率的关系"></a> 1.1.2.3 响度、声压值和频率的关系</h5><p>响度不仅和声压级相关，同时和频率也有关系，这三者的关系可以制作出一张著名的<strong>等响曲线</strong></p><p><img alt="等响曲线" data-src="../../images/%E9%9F%B3%E8%A7%86%E9%A2%91%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/%E7%AD%89%E5%93%8D%E6%9B%B2%E7%BA%BF.png"></p><p>其中，里面的 1kHz 标准音声级即为响度的单位</p><p>从图中我们可以看到，曲线在 <strong>3kHz-4kHz</strong> 范围内<strong>最凹</strong>，说明在这个频率范围，达到同样响度所需要的声压级比其他范围要少，即人对 3kHz-4kHz 的声音<strong>更敏感</strong></p><h5 id="1123-响度的单位"><a class="markdownIt-Anchor" href="#1123-响度的单位"></a> 1.1.2.3 响度的单位</h5><p>响度的单位有两个，分别为<strong>方(Phon)</strong> 和 <strong>宋(Sone)</strong></p><p>方是响度的客观度量，定义为 1kHz 下的声压级，称为响度级，如 1kHz 下的 60dB 的声音响度级为 60 方；<br>方不具备数量之间的关系，两个方的数量的不同仅代表两个声音的大小不同，不能对这两个声音进行量化，如 60 方的声音比 40 方的声音大，但是不能说 60 方的响度大小为 40 方的 1.5 倍，双方不具备这种关系</p><p>宋是响度的主观度量，<strong>表示人耳在自然状态下，根据声压级的变化所表现出的对于响度听感的变化</strong>；<br>宋具有数量关系，2 宋的声音一定比 1 宋的声音大两倍</p><p>宋和方之间的关系是非线性的</p><h4 id="113-波形-基波和谐波"><a class="markdownIt-Anchor" href="#113-波形-基波和谐波"></a> 1.1.3 波形、基波和谐波</h4><p>声波总是可以分解为不同频率、不同振幅的正弦波的叠加，这种分解过程就称为傅里叶变换；</p><p>基波：一个标准的正弦波，称为基波<br>谐波：比基波的频率高<strong>整数倍</strong>的波被称作谐波</p><p>如果一个复合音由基波和它的谐波相叠加构成，那么这个过程就叫做<strong>谐波叠加</strong></p><h3 id="12-声速-反射与透射"><a class="markdownIt-Anchor" href="#12-声速-反射与透射"></a> 1.2 声速、反射与透射</h3><p>传播声音的介质有很多，如空气、水等，声音在不同介质的传播速度也不同：</p><ol><li>空气：<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>340</mn><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">/</mi><mi mathvariant="normal">s</mi></mrow></mrow><annotation encoding="application/x-tex">340\mathrm{m/s}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord">3</span><span class="mord">4</span><span class="mord">0</span><span class="mord"><span class="mord mathrm">m</span><span class="mord mathrm">/</span><span class="mord mathrm">s</span></span></span></span></span></li><li>蒸馏水：<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1497</mn><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">/</mi><mi mathvariant="normal">s</mi></mrow></mrow><annotation encoding="application/x-tex">1497\mathrm{m/s}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord">1</span><span class="mord">4</span><span class="mord">9</span><span class="mord">7</span><span class="mord"><span class="mord mathrm">m</span><span class="mord mathrm">/</span><span class="mord mathrm">s</span></span></span></span></span></li><li>铁棒：<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>5200</mn><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">/</mi><mi mathvariant="normal">s</mi></mrow></mrow><annotation encoding="application/x-tex">5200\mathrm{m/s}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord">5</span><span class="mord">2</span><span class="mord">0</span><span class="mord">0</span><span class="mord"><span class="mord mathrm">m</span><span class="mord mathrm">/</span><span class="mord mathrm">s</span></span></span></span></span></li></ol><p>声音是纵波，遇到阻碍就会发生反射与透射；</p><p>反射是声波在遇到阻碍之后，改变传播方向的一种特性<br>透射则是声波在遇到阻碍之后，穿越阻碍的一种特性</p><p>根据这两个声波的传播特点，人们开发出了两个对应的产品：吸音棉和隔音棉</p><p>吸音主要是为了减少声音反射引起的嘈杂感，吸音棉可以衰减声音的反射能量，从而达到原有声音的保真效果，在录音棚常用；</p><p>隔音主要是为了减少声音的穿透，保证主体空间的相对安静，隔音棉可以减少声音的透射能量，从而保证主体空间的安静，在 KTV 常用。</p><h3 id="13-回音"><a class="markdownIt-Anchor" href="#13-回音"></a> 1.3 回音</h3><p>回音或回声是声音遇到阻碍后反射，再次被人听到的一种现象，通常在高山和空旷山地常常出现</p><p>人耳无时无刻不在接收回音，但是如果人耳接收到两种声音的时间差小于 <strong>80 毫秒</strong>，那么人耳就无法分辨出回声</p><h3 id="14-共鸣"><a class="markdownIt-Anchor" href="#14-共鸣"></a> 1.4 共鸣</h3><p>共鸣是一个物品发声导致另一个物品发声的现象，说明声波的传播可以导致另一个物品发生振动，本质上是能量的传播过程；</p><p>吉他等乐器常常利用共鸣现象达到较好的音频效果</p><h3 id="15-与人相关的一些值"><a class="markdownIt-Anchor" href="#15-与人相关的一些值"></a> 1.5 与人相关的一些值</h3><ol><li>人耳的能听到的最小声压级为 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>0</mn><mrow><mi mathvariant="normal">d</mi><mi mathvariant="normal">B</mi></mrow><mo>=</mo><mn>20</mn><mi>μ</mi><mrow><mi mathvariant="normal">P</mi><mi mathvariant="normal">a</mi></mrow></mrow><annotation encoding="application/x-tex">0\mathrm{dB} = 20\mu\mathrm{Pa}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.69444em;vertical-align:0"></span><span class="mord">0</span><span class="mord"><span class="mord mathrm">d</span><span class="mord mathrm">B</span></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.8777699999999999em;vertical-align:-.19444em"></span><span class="mord">2</span><span class="mord">0</span><span class="mord mathdefault">μ</span><span class="mord"><span class="mord mathrm">P</span><span class="mord mathrm">a</span></span></span></span></span></li><li>人类的听觉频率范围：<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>20</mn><mrow><mi mathvariant="normal">H</mi><mi mathvariant="normal">z</mi></mrow><mo>∼</mo><mn>20</mn><mrow><mi mathvariant="normal">k</mi><mi mathvariant="normal">H</mi><mi mathvariant="normal">z</mi></mrow></mrow><annotation encoding="application/x-tex">20\mathrm{Hz} \sim 20\mathrm{kHz}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord">2</span><span class="mord">0</span><span class="mord"><span class="mord mathrm">H</span><span class="mord mathrm">z</span></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">∼</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.69444em;vertical-align:0"></span><span class="mord">2</span><span class="mord">0</span><span class="mord"><span class="mord mathrm">k</span><span class="mord mathrm">H</span><span class="mord mathrm">z</span></span></span></span></span></li><li>人类的敏感频率：<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>3</mn><mrow><mi mathvariant="normal">k</mi><mi mathvariant="normal">H</mi><mi mathvariant="normal">z</mi></mrow><mo>∼</mo><mn>4</mn><mrow><mi mathvariant="normal">k</mi><mi mathvariant="normal">H</mi><mi mathvariant="normal">z</mi></mrow></mrow><annotation encoding="application/x-tex">3\mathrm{kHz} \sim 4\mathrm{kHz}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.69444em;vertical-align:0"></span><span class="mord">3</span><span class="mord"><span class="mord mathrm">k</span><span class="mord mathrm">H</span><span class="mord mathrm">z</span></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">∼</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.69444em;vertical-align:0"></span><span class="mord">4</span><span class="mord"><span class="mord mathrm">k</span><span class="mord mathrm">H</span><span class="mord mathrm">z</span></span></span></span></span></li><li>宽频的音乐，较佳的声压级为 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>80</mn><mo>∼</mo><mn>90</mn><mrow><mi mathvariant="normal">d</mi><mi mathvariant="normal">B</mi></mrow></mrow><annotation encoding="application/x-tex">80 \sim 90 \mathrm{dB}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.64444em;vertical-align:0"></span><span class="mord">8</span><span class="mord">0</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">∼</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.69444em;vertical-align:0"></span><span class="mord">9</span><span class="mord">0</span><span class="mord"><span class="mord mathrm">d</span><span class="mord mathrm">B</span></span></span></span></span></li><li>损伤人耳的声压级：高于 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>90</mn><mrow><mi mathvariant="normal">d</mi><mi mathvariant="normal">B</mi></mrow></mrow><annotation encoding="application/x-tex">90\mathrm{dB}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.69444em;vertical-align:0"></span><span class="mord">9</span><span class="mord">0</span><span class="mord"><span class="mord mathrm">d</span><span class="mord mathrm">B</span></span></span></span></span></li><li>人耳极限：<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>105</mn><mrow><mi mathvariant="normal">d</mi><mi mathvariant="normal">B</mi></mrow></mrow><annotation encoding="application/x-tex">105\mathrm{dB}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.69444em;vertical-align:0"></span><span class="mord">1</span><span class="mord">0</span><span class="mord">5</span><span class="mord"><span class="mord mathrm">d</span><span class="mord mathrm">B</span></span></span></span></span></li><li>人耳痛阈：120 方</li><li>人耳回音的分辨最小时差：<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>80</mn><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">s</mi></mrow></mrow><annotation encoding="application/x-tex">80\mathrm{ms}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.64444em;vertical-align:0"></span><span class="mord">8</span><span class="mord">0</span><span class="mord"><span class="mord mathrm">m</span><span class="mord mathrm">s</span></span></span></span></span></li></ol><h2 id="2-数字音频"><a class="markdownIt-Anchor" href="#2-数字音频"></a> 2. 数字音频</h2><p>声音经过麦克风采集之后变成模拟信号，要将模拟进行数字化，转换为现今时代的数字音频，主要需要经历如下的三个步骤：</p><ol><li>采样</li><li>量化</li><li>编码</li></ol><h3 id="21-采样"><a class="markdownIt-Anchor" href="#21-采样"></a> 2.1 采样</h3><p>采样就是在<strong>时间轴</strong>上对信号进行离散数字化，根据奈奎斯特定理，应按照比声音的最高频率高两倍以上的频率对声音进行采样即可保持声音的原有质量。</p><p>由于人耳的听觉频率范围为 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>20</mn><mrow><mi mathvariant="normal">H</mi><mi mathvariant="normal">z</mi></mrow><mo>∼</mo><mn>20</mn><mrow><mi mathvariant="normal">k</mi><mi mathvariant="normal">H</mi><mi mathvariant="normal">z</mi></mrow></mrow><annotation encoding="application/x-tex">20\mathrm{Hz} \sim 20\mathrm{kHz}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord">2</span><span class="mord">0</span><span class="mord"><span class="mord mathrm">H</span><span class="mord mathrm">z</span></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">∼</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.69444em;vertical-align:0"></span><span class="mord">2</span><span class="mord">0</span><span class="mord"><span class="mord mathrm">k</span><span class="mord mathrm">H</span><span class="mord mathrm">z</span></span></span></span></span>，所以一般采用 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>44.1</mn><mrow><mi mathvariant="normal">k</mi><mi mathvariant="normal">H</mi><mi mathvariant="normal">z</mi></mrow></mrow><annotation encoding="application/x-tex">44.1\mathrm{kHz}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.69444em;vertical-align:0"></span><span class="mord">4</span><span class="mord">4</span><span class="mord">.</span><span class="mord">1</span><span class="mord"><span class="mord mathrm">k</span><span class="mord mathrm">H</span><span class="mord mathrm">z</span></span></span></span></span> 作为采样频率可以保持数字化后的声音质量。</p><p><img alt="声音的采样" data-src="http://static.oschina.net/uploads/img/201306/03145436_bTNr.gif"></p><h3 id="22-量化"><a class="markdownIt-Anchor" href="#22-量化"></a> 2.2 量化</h3><p>具体到每个采样值如何表示就是量化，可以使用 8bit、16bit、32bit 等表示一个采样值，使用的 bit 越多，所能表达的采样值就越精确。</p><p>比如目前最常用的 16bit 量化格式，就是在将振幅分成了 66535 层，这样量化的声音显然会比 8 bit 的更为精确。</p><h3 id="23-编码"><a class="markdownIt-Anchor" href="#23-编码"></a> 2.3 编码</h3><p>将声音信号进行数字化之后，就需要对这些采样进行存储，而编码就是这些存储的格式，有顺序存储和压缩存储等等。</p><p>其中，通常所说的音频裸数据为 PCM 格式，而最常用的压缩格式为 MP3，当然还有一些其他的格式如 WAV、OGG、FLAC 等。</p><h3 id="24-pcm-数据的描述参数"><a class="markdownIt-Anchor" href="#24-pcm-数据的描述参数"></a> 2.4 PCM 数据的描述参数</h3><p>对于直接录制得到的音频数据，PCM，有一些关于它的描述参数：</p><ul><li>量化格式（位深度）</li><li>采样频率</li><li>声道数</li><li>比特率</li></ul><p>量化格式，也叫位深度，指的是一个采样采用多少 bit 进行表示，目前普遍使用的是 16bit。</p><p>采样频率即一秒钟采样的次数，单位为赫兹(<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="normal">H</mi><mi mathvariant="normal">z</mi></mrow><annotation encoding="application/x-tex">\mathrm{Hz}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord"><span class="mord mathrm">H</span><span class="mord mathrm">z</span></span></span></span></span>)</p><p>声道数，为录制的声道的数量，通常为双声道立体声</p><p>比特率，为音频数据一秒钟的数据量大小，单位为 bit/s</p><p>其中比特率的计算公式如下：</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>b</mi><mi>i</mi><mi>t</mi><mi>r</mi><mi>a</mi><mi>t</mi><mi>e</mi><mo>=</mo><mi>s</mi><mi>a</mi><mi>m</mi><mi>p</mi><mi>l</mi><mi>e</mi><mtext> </mtext><mi>r</mi><mi>a</mi><mi>t</mi><mi>e</mi><mo>×</mo><mi>s</mi><mi>a</mi><mi>m</mi><mi>p</mi><mi>l</mi><mi>e</mi><mtext> </mtext><mi>f</mi><mi>o</mi><mi>r</mi><mi>m</mi><mi>a</mi><mi>t</mi><mo>×</mo><mi>c</mi><mi>h</mi><mi>a</mi><mi>n</mi><mi>n</mi><mi>e</mi><mi>l</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">bitrate = sample\ rate \times sample \ format \times channels</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.69444em;vertical-align:0"></span><span class="mord mathdefault">b</span><span class="mord mathdefault">i</span><span class="mord mathdefault">t</span><span class="mord mathdefault" style="margin-right:.02778em">r</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">e</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.8888799999999999em;vertical-align:-.19444em"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">a</span><span class="mord mathdefault">m</span><span class="mord mathdefault">p</span><span class="mord mathdefault" style="margin-right:.01968em">l</span><span class="mord mathdefault">e</span><span class="mspace"> </span><span class="mord mathdefault" style="margin-right:.02778em">r</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">e</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:.8888799999999999em;vertical-align:-.19444em"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">a</span><span class="mord mathdefault">m</span><span class="mord mathdefault">p</span><span class="mord mathdefault" style="margin-right:.01968em">l</span><span class="mord mathdefault">e</span><span class="mspace"> </span><span class="mord mathdefault" style="margin-right:.10764em">f</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:.02778em">r</span><span class="mord mathdefault">m</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:.69444em;vertical-align:0"></span><span class="mord mathdefault">c</span><span class="mord mathdefault">h</span><span class="mord mathdefault">a</span><span class="mord mathdefault">n</span><span class="mord mathdefault">n</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:.01968em">l</span><span class="mord mathdefault">s</span></span></span></span></span></p><p>例如，一个采样率为 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>44100</mn><mrow><mi mathvariant="normal">H</mi><mi mathvariant="normal">z</mi></mrow></mrow><annotation encoding="application/x-tex">44100\mathrm{Hz}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord">4</span><span class="mord">4</span><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mord"><span class="mord mathrm">H</span><span class="mord mathrm">z</span></span></span></span></span>，量化格式为 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>16</mn><mrow><mi mathvariant="normal">b</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">t</mi></mrow></mrow><annotation encoding="application/x-tex">16 \mathrm{bit}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.69444em;vertical-align:0"></span><span class="mord">1</span><span class="mord">6</span><span class="mord"><span class="mord mathrm">b</span><span class="mord mathrm">i</span><span class="mord mathrm">t</span></span></span></span></span>，声道数为 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>2</mn></mrow><annotation encoding="application/x-tex">2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.64444em;vertical-align:0"></span><span class="mord">2</span></span></span></span> 的 CD 的比特率为：</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>44100</mn><mo>×</mo><mn>16</mn><mo>×</mo><mn>2</mn><mo>=</mo><mn>1378.125</mn><mrow><mi mathvariant="normal">k</mi><mi mathvariant="normal">b</mi><mi mathvariant="normal">p</mi><mi mathvariant="normal">s</mi></mrow></mrow><annotation encoding="application/x-tex">44100 \times 16 \times 2 = 1378.125 \mathrm{kbps}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.72777em;vertical-align:-.08333em"></span><span class="mord">4</span><span class="mord">4</span><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:.72777em;vertical-align:-.08333em"></span><span class="mord">1</span><span class="mord">6</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:.64444em;vertical-align:0"></span><span class="mord">2</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.8888799999999999em;vertical-align:-.19444em"></span><span class="mord">1</span><span class="mord">3</span><span class="mord">7</span><span class="mord">8</span><span class="mord">.</span><span class="mord">1</span><span class="mord">2</span><span class="mord">5</span><span class="mord"><span class="mord mathrm">k</span><span class="mord mathrm">b</span><span class="mord mathrm">p</span><span class="mord mathrm">s</span></span></span></span></span></span></p><p>那么一分钟内这类 CD 音质的数据大小为：</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1378.125</mn><mo>×</mo><mn>60</mn><mo>÷</mo><mn>8</mn><mo>÷</mo><mn>1024</mn><mo>=</mo><mn>10.09</mn><mrow><mi mathvariant="normal">M</mi><mi mathvariant="normal">B</mi></mrow></mrow><annotation encoding="application/x-tex">1378.125 \times 60 \div 8 \div 1024 = 10.09\mathrm{MB}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.72777em;vertical-align:-.08333em"></span><span class="mord">1</span><span class="mord">3</span><span class="mord">7</span><span class="mord">8</span><span class="mord">.</span><span class="mord">1</span><span class="mord">2</span><span class="mord">5</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:.72777em;vertical-align:-.08333em"></span><span class="mord">6</span><span class="mord">0</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">÷</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:.72777em;vertical-align:-.08333em"></span><span class="mord">8</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">÷</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:.64444em;vertical-align:0"></span><span class="mord">1</span><span class="mord">0</span><span class="mord">2</span><span class="mord">4</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord">1</span><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">9</span><span class="mord"><span class="mord mathrm">M</span><span class="mord mathrm">B</span></span></span></span></span></span></p><p>如果量化格式更为精确，如 32bit 表示一个采样，或者采样频率更为密集，则所占的存储空间就越大。</p><h3 id="25-音频编码"><a class="markdownIt-Anchor" href="#25-音频编码"></a> 2.5 音频编码</h3><p>这里来介绍几种常见的音频编码格式</p><ol><li>WAV<blockquote><p>有多种实现方式，但都不对 PCM 进行压缩，其中一种是在 PCM 数据之前加上 44 字节的文件头信息</p></blockquote></li><li>MP3<blockquote><p>具有不错的压缩比，应用最为普遍的有损压缩声音编码格式，适用于 128 kbps 以上的音频</p></blockquote></li><li>AAC<blockquote><p>有损压缩格式，在 128 kbps 以下码率表现优异，通常用于视频中音频轨的编码</p></blockquote></li><li>OGG<blockquote><p>可以使用更小的码率实现比 MP3 更好的音质，但兼容性不够好，流媒体特性不支持，通常用于语音通信的音频消息场景</p></blockquote></li><li>FLAC<blockquote><p>无损压缩形式，FLAC 可实时播放已经压缩了的音频数据，同时具有抗损伤能力</p></blockquote></li></ol><h2 id="3-图像的物理概念"><a class="markdownIt-Anchor" href="#3-图像的物理概念"></a> 3. 图像的物理概念</h2><p>图像，实际上就是光线进入人眼后，在视网膜中形成的物体概念，根据棱镜实验，光线都是由不同的三原色光——红、绿、蓝复合而成的。</p><p>屏幕上的图像，实际上是由很多个带颜色的点构成的，每个点称为一个 <strong>像素</strong>，一个像素由三个 <strong>子像素</strong> 组成，分别为红、绿、蓝，通常我们将这三个子像素分别称为 <strong>通道</strong>；<br>而一个屏幕一共有多少个像素点，我们称为这个屏幕的 <strong>分辨率</strong>，通常由一个乘式表示，例如：1280 * 720 则表示，这个屏幕在水平方向上有 1280 个像素点，在竖直方向上有 720 个像素点。</p><p>现在的屏幕显像原理稍有不同，但是都是由屏幕背后的光源照亮前方的像素点实现的显像，因此通常屏幕是 <strong>自发光</strong> 的，而不是通过光的反射让人看到图像。</p><h2 id="4-图像的数值表示"><a class="markdownIt-Anchor" href="#4-图像的数值表示"></a> 4. 图像的数值表示</h2><h3 id="41-rgb-表示"><a class="markdownIt-Anchor" href="#41-rgb-表示"></a> 4.1 RGB 表示</h3><p>根据图像的物理原理，我们可以知道任何一种光都可以由红（R） 、绿（G）、蓝（B）表示，因此我们就有了第一种图像表示方法——RGB 表示法。</p><p>但对于每个通道如何表示，则有不同的格式：</p><ul><li>浮点表示<blockquote><p>取值范围为 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>0.0</mn><mo>∼</mo><mn>1.0</mn></mrow><annotation encoding="application/x-tex">0.0\sim1.0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.64444em;vertical-align:0"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">∼</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.64444em;vertical-align:0"></span><span class="mord">1</span><span class="mord">.</span><span class="mord">0</span></span></span></span>，OpenGL ES 中就采用这种表示形式</p></blockquote></li><li>整数表示<blockquote><p>取值范围为 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>0</mn><mo>∼</mo><mn>255</mn></mrow><annotation encoding="application/x-tex">0 \sim 255</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.64444em;vertical-align:0"></span><span class="mord">0</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">∼</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.64444em;vertical-align:0"></span><span class="mord">2</span><span class="mord">5</span><span class="mord">5</span></span></span></span>，8 bit 表示一个子像素，32 bit 表示一个像素，例如 Android 中的 <code>ARGB_8888</code> 表示格式即为 RGB 通道加 Alpha 通道（表示透明度），每个通道采用 8 bit 表示，一共 32 bit 表示一个像素</p></blockquote></li></ul><p>对于一副 1280 * 720 的图像，如果采用 <code>ARGB_8888</code> 表示法进行表示，那么这张图片的大小为：</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1280</mn><mo>×</mo><mn>720</mn><mo>×</mo><mn>4</mn><mo>=</mo><mn>3.516</mn><mrow><mi mathvariant="normal">M</mi><mi mathvariant="normal">B</mi></mrow></mrow><annotation encoding="application/x-tex">1280 \times 720 \times 4 = 3.516\mathrm{MB}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.72777em;vertical-align:-.08333em"></span><span class="mord">1</span><span class="mord">2</span><span class="mord">8</span><span class="mord">0</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:.72777em;vertical-align:-.08333em"></span><span class="mord">7</span><span class="mord">2</span><span class="mord">0</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:.64444em;vertical-align:0"></span><span class="mord">4</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord">3</span><span class="mord">.</span><span class="mord">5</span><span class="mord">1</span><span class="mord">6</span><span class="mord"><span class="mord mathrm">M</span><span class="mord mathrm">B</span></span></span></span></span></span></p><p>所以图像的裸数据都是很大的，通常要进行编码之后才能在网络上传输。</p><h3 id="42-yuv-表示法"><a class="markdownIt-Anchor" href="#42-yuv-表示法"></a> 4.2 YUV 表示法</h3><p>虽然我们知道色光由 RGB 组成，但是在彩色电视机发明之前，人们通常使用的都是老式的黑白电视机，为了保持和老式黑白电视机的兼容性，我们有另一种图像的表示方式，即 YUV 表示法。</p><p>其中，Y 表示明亮度，也称作灰阶值，UV 则表示图像的色度，包括色调和饱和度，分别用 Cr 和 Cb 表示，所以 YUV 表示法也被称作 YCrCb 表示法；<br>其中 Cr 反应了 RGB 输入信号的红色部分与 RGB 亮度之间的差异，Cb 反应的则是 RGB 蓝色部分和 RGB 亮度值之间的关系。</p><p>YUV 色彩空间相对于 RGB 空间而言，优势在于 Y 通道和 UV 通道之间是可以分离的，如果只传输 Y 通道，那么这样的图像就是黑白灰度图像，因此也解决了彩色电视机和黑白电视机的兼容问题。</p><p>YUV 最常用的表示法是 Y、U、V 都采用一个字节(8bit) 来表示，取值范围为 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>0</mn><mo>∼</mo><mn>255</mn></mrow><annotation encoding="application/x-tex">0\sim255</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.64444em;vertical-align:0"></span><span class="mord">0</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">∼</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.64444em;vertical-align:0"></span><span class="mord">2</span><span class="mord">5</span><span class="mord">5</span></span></span></span>；<br>但是在广播电视系统中，不传输很低或者很高的值，因此无论是 Rec.601 还是 BT.709 标准中，Y 的取值范围都是 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>16</mn><mo>∼</mo><mn>255</mn></mrow><annotation encoding="application/x-tex">16\sim255</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.64444em;vertical-align:0"></span><span class="mord">1</span><span class="mord">6</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">∼</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.64444em;vertical-align:0"></span><span class="mord">2</span><span class="mord">5</span><span class="mord">5</span></span></span></span>，UV 的取值范围都是 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>16</mn><mo>∼</mo><mn>240</mn></mrow><annotation encoding="application/x-tex">16\sim 240</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.64444em;vertical-align:0"></span><span class="mord">1</span><span class="mord">6</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">∼</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.64444em;vertical-align:0"></span><span class="mord">2</span><span class="mord">4</span><span class="mord">0</span></span></span></span>。</p><p>YUV 在采样中也有不同的采样格式，有 YUV444、YUV422、YUV420 这三种大类，三者的区别如下图表示：</p><p><img alt="yuv444、yuv422、yuv420 的区别" data-src="../../images/%E9%9F%B3%E8%A7%86%E9%A2%91%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/yuv444%E3%80%81yuv422%E3%80%81yuv420-%E7%9A%84%E5%8C%BA%E5%88%AB.png"></p><p>YUV444 指的是一个 Y 通道拥有独立的 UV 通道<br>YUV422 指的是两个 Y 通道共用一个 UV 通道<br>YUV420 指的是四个 Y 通道共用一个 UV 通道</p><p>为什么可以这样采样，主要是因为人眼对于图像的亮度更为敏感，而对图像的色度信息并不那么敏感，因此我们就可以减少图像的 UV 信息达到相同的显示效果。</p><p><img alt="人眼对 Y 通道更敏感" data-src="../../images/%E9%9F%B3%E8%A7%86%E9%A2%91%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/Barn-yuv.png"></p><p>其中，最常用的采样格式为 YUV 420，所谓 4、2、0 指的是，每四行像素中，有 4 行 Y 通道，2 行 UV 通道；<br>并不是只有 U 通道或者只有 V 通道，实际采样过程中，会每两行只采样一行 U 数据，而下一个两行只采样一行 V 数据。</p><p>同理 422 采样指的是，每 4 行像素中，有 4 行 Y 通道，2 行 U 通道，2 行 V 通道；<br>具体采样过程来说，就是第一个像素只采样 U 通道，第二个像素只采样 V 通道；<br>YUV 422 还有不少子类型，根据格式不同，其采样和数据存储的格式也不同。</p><p>YUV 模型就存储的内存模型上来说还有两种不同的区别，分别为：压缩存储(packed) 和平面存储(planer)；<br>所谓压缩存储指的是在内存中 Y、U、V 数据挤在一起存储，如下面的三个像素：</p><p>YUV|YUV|YUV</p><p>所谓平面存储指的是先存储一个通道，再存储另一个通道：</p><p>YYY<br>UUU<br>VVV</p><p>图像裸数据的大小是非常惊人，拿最常用的 YUV420 来说，如果是一张 1920 * 1080 分辨率的图片，色深为 8bit，那么它的大小为：</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1920</mn><mo>×</mo><mn>1080</mn><mo>×</mo><mn>1</mn><mi>b</mi><mi>y</mi><mi>t</mi><mi>e</mi><mo>×</mo><mo stretchy="false">(</mo><mn>1</mn><mo>+</mo><mn>1</mn><mi mathvariant="normal">/</mi><mn>4</mn><mo>+</mo><mn>1</mn><mi mathvariant="normal">/</mi><mn>4</mn><mo stretchy="false">)</mo><mo>=</mo><mn>2.97</mn><mrow><mi mathvariant="normal">M</mi><mi mathvariant="normal">B</mi></mrow></mrow><annotation encoding="application/x-tex">1920 \times 1080 \times 1byte \times (1 + 1/4 + 1/4) = 2.97\mathrm{MB}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.72777em;vertical-align:-.08333em"></span><span class="mord">1</span><span class="mord">9</span><span class="mord">2</span><span class="mord">0</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:.72777em;vertical-align:-.08333em"></span><span class="mord">1</span><span class="mord">0</span><span class="mord">8</span><span class="mord">0</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:.8888799999999999em;vertical-align:-.19444em"></span><span class="mord">1</span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:.03588em">y</span><span class="mord mathdefault">t</span><span class="mord mathdefault">e</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord">1</span><span class="mord">/</span><span class="mord">4</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord">1</span><span class="mord">/</span><span class="mord">4</span><span class="mclose">)</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord">2</span><span class="mord">.</span><span class="mord">9</span><span class="mord">7</span><span class="mord"><span class="mord mathrm">M</span><span class="mord mathrm">B</span></span></span></span></span></span></p><p>假如是上面这个分辨率的一个 30 帧的视频，一分钟的数据量会达到：</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>2.97</mn><mo>×</mo><mn>30</mn><mo>×</mo><mn>60</mn><mo>=</mo><mn>5.22</mn><mrow><mi mathvariant="normal">G</mi><mi mathvariant="normal">B</mi></mrow></mrow><annotation encoding="application/x-tex">2.97 \times 30 \times 60 = 5.22\mathrm{GB}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.72777em;vertical-align:-.08333em"></span><span class="mord">2</span><span class="mord">.</span><span class="mord">9</span><span class="mord">7</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:.72777em;vertical-align:-.08333em"></span><span class="mord">3</span><span class="mord">0</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:.64444em;vertical-align:0"></span><span class="mord">6</span><span class="mord">0</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord">5</span><span class="mord">.</span><span class="mord">2</span><span class="mord">2</span><span class="mord"><span class="mord mathrm">G</span><span class="mord mathrm">B</span></span></span></span></span></span></p><h3 id="43-yuv-与-rgb-的转换"><a class="markdownIt-Anchor" href="#43-yuv-与-rgb-的转换"></a> 4.3 YUV 与 RGB 的转换</h3><p>我们知道，图像的实际物理成像还是要依靠 RGB 模型进行的，所以 YUV 数据要显示到屏幕上，就必须转换为 RGB 数据才能显示。</p><p>这两个模型，根据不同的标准，有不同的转换公式进行转换，这些不同的转换公式，我们可以将其写成矩阵模式，即不同的转换矩阵：</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mrow><mo fence="true">[</mo><mtable rowspacing="0.15999999999999992em" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>R</mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>G</mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>B</mi></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>=</mo><mi>M</mi><mo>×</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.15999999999999992em" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msup><mi>Y</mi><mo mathvariant="normal">′</mo></msup></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>C</mi><mi>b</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>C</mi><mi>r</mi></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\begin{bmatrix} R \\ G \\ B \\ \end{bmatrix} = M \times \begin{bmatrix} Y&#x27; \\ Cb \\ Cr \\ \end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3.60004em;vertical-align:-1.55002em"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05002em"><span style="top:-2.2500000000000004em"><span class="pstrut" style="height:3.1550000000000002em"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-4.05002em"><span class="pstrut" style="height:3.1550000000000002em"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em"><span style="top:-4.21em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathdefault" style="margin-right:.00773em">R</span></span></span><span style="top:-3.0099999999999993em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathdefault">G</span></span></span><span style="top:-1.8099999999999994em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathdefault" style="margin-right:.05017em">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05002em"><span style="top:-2.2500000000000004em"><span class="pstrut" style="height:3.1550000000000002em"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-4.05002em"><span class="pstrut" style="height:3.1550000000000002em"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.76666em;vertical-align:-.08333em"></span><span class="mord mathdefault" style="margin-right:.10903em">M</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:3.60004em;vertical-align:-1.55002em"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05002em"><span style="top:-2.2500000000000004em"><span class="pstrut" style="height:3.1550000000000002em"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-4.05002em"><span class="pstrut" style="height:3.1550000000000002em"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em"><span style="top:-4.21em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:.22222em">Y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.751892em"><span style="top:-3.063em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.0099999999999993em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathdefault" style="margin-right:.07153em">C</span><span class="mord mathdefault">b</span></span></span><span style="top:-1.8099999999999994em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathdefault" style="margin-right:.07153em">C</span><span class="mord mathdefault" style="margin-right:.02778em">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05002em"><span style="top:-2.2500000000000004em"><span class="pstrut" style="height:3.1550000000000002em"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-4.05002em"><span class="pstrut" style="height:3.1550000000000002em"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em"><span></span></span></span></span></span></span></span></span></span></span></span></p><p>其中 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>M</mi></mrow><annotation encoding="application/x-tex">M</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord mathdefault" style="margin-right:.10903em">M</span></span></span></span> 即为不同的转换矩阵，通过转换矩阵就能得到对应标准下的 RGB 模型。</p><p>这里需要注意的一点是，RGB 通道和 YUV 通道都是有取值范围的，而且不同的转换标准中，各个通道的取值范围也是不尽相同的。</p><p>这里有个小坑点，上面所写的是 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo fence="true">[</mo><mtable rowspacing="0.15999999999999992em" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msup><mi>Y</mi><mo mathvariant="normal">′</mo></msup></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>C</mi><mi>b</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>C</mi><mi>r</mi></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><annotation encoding="application/x-tex">\begin{bmatrix}Y&#x27;\\ Cb \\ Cr\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3.60004em;vertical-align:-1.55002em"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05002em"><span style="top:-2.2500000000000004em"><span class="pstrut" style="height:3.1550000000000002em"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-4.05002em"><span class="pstrut" style="height:3.1550000000000002em"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em"><span style="top:-4.21em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:.22222em">Y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.751892em"><span style="top:-3.063em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.0099999999999993em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathdefault" style="margin-right:.07153em">C</span><span class="mord mathdefault">b</span></span></span><span style="top:-1.8099999999999994em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathdefault" style="margin-right:.07153em">C</span><span class="mord mathdefault" style="margin-right:.02778em">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05002em"><span style="top:-2.2500000000000004em"><span class="pstrut" style="height:3.1550000000000002em"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-4.05002em"><span class="pstrut" style="height:3.1550000000000002em"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em"><span></span></span></span></span></span></span></span></span></span></span>，并不是<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo fence="true">[</mo><mtable rowspacing="0.15999999999999992em" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msup><mi>Y</mi><mo mathvariant="normal">′</mo></msup></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>U</mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>V</mi></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><annotation encoding="application/x-tex">\begin{bmatrix}Y&#x27;\\ U \\ V\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3.60004em;vertical-align:-1.55002em"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05002em"><span style="top:-2.2500000000000004em"><span class="pstrut" style="height:3.1550000000000002em"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-4.05002em"><span class="pstrut" style="height:3.1550000000000002em"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em"><span style="top:-4.21em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:.22222em">Y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.751892em"><span style="top:-3.063em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.0099999999999993em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathdefault" style="margin-right:.10903em">U</span></span></span><span style="top:-1.8099999999999994em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathdefault" style="margin-right:.22222em">V</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05002em"><span style="top:-2.2500000000000004em"><span class="pstrut" style="height:3.1550000000000002em"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-4.05002em"><span class="pstrut" style="height:3.1550000000000002em"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em"><span></span></span></span></span></span></span></span></span></span></span>，实际上，涉及到这个转换运算，这两者还是有点区别的：</p><p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>C</mi><mi>b</mi></mrow><annotation encoding="application/x-tex">Cb</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.69444em;vertical-align:0"></span><span class="mord mathdefault" style="margin-right:.07153em">C</span><span class="mord mathdefault">b</span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>C</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">Cr</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord mathdefault" style="margin-right:.07153em">C</span><span class="mord mathdefault" style="margin-right:.02778em">r</span></span></span></span> 的取值范围为 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">[</mo><mo>−</mo><mn>128</mn><mo separator="true">,</mo><mn>127</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[-128,127]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mopen">[</span><span class="mord">−</span><span class="mord">1</span><span class="mord">2</span><span class="mord">8</span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord">1</span><span class="mord">2</span><span class="mord">7</span><span class="mclose">]</span></span></span></span> ，但是 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>U</mi><mi>V</mi></mrow><annotation encoding="application/x-tex">UV</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord mathdefault" style="margin-right:.10903em">U</span><span class="mord mathdefault" style="margin-right:.22222em">V</span></span></span></span> 的取值范围为 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">[</mo><mn>0</mn><mo>−</mo><mn>255</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[0-255]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mopen">[</span><span class="mord">0</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord">2</span><span class="mord">5</span><span class="mord">5</span><span class="mclose">]</span></span></span></span>，所以实际上需要做一个转换操作：</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>C</mi><mi>b</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>U</mi><mo>−</mo><mn>128</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>C</mi><mi>r</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>V</mi><mo>−</mo><mn>128</mn></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned} Cb &amp;= U - 128 \\ Cr &amp;= V - 128 \\ \end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3.0000000000000004em;vertical-align:-1.2500000000000002em"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.7500000000000002em"><span style="top:-3.91em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathdefault" style="margin-right:.07153em">C</span><span class="mord mathdefault">b</span></span></span><span style="top:-2.41em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathdefault" style="margin-right:.07153em">C</span><span class="mord mathdefault" style="margin-right:.02778em">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2500000000000002em"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.7500000000000002em"><span style="top:-3.91em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mord mathdefault" style="margin-right:.10903em">U</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mord">1</span><span class="mord">2</span><span class="mord">8</span></span></span><span style="top:-2.41em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mord mathdefault" style="margin-right:.22222em">V</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mord">1</span><span class="mord">2</span><span class="mord">8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2500000000000002em"><span></span></span></span></span></span></span></span></span></span></span></span></p><p>所以，如果需要得到黑白图像，需要将 UV 置为 128；</p><p>如果 UV 置为 0，那么得到的就是绿色。</p><p>如果计算得到的值超出了这个范围，那么就要进行 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>c</mi><mi>l</mi><mi>a</mi><mi>m</mi><mi>p</mi></mrow><annotation encoding="application/x-tex">clamp</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.8888799999999999em;vertical-align:-.19444em"></span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:.01968em">l</span><span class="mord mathdefault">a</span><span class="mord mathdefault">m</span><span class="mord mathdefault">p</span></span></span></span> 操作，将它们强制限定在这个范围之内。</p><p>同时，只有 YUV444 才能和 RGB 空间进行相互转化，如果采样格式不是 YUV444，那么就需要先拉升到 YUV444 平面才能和 RGB 进行相互转化。</p><h2 id="5-视频的编解码相关概念"><a class="markdownIt-Anchor" href="#5-视频的编解码相关概念"></a> 5. 视频的编解码相关概念</h2><p>上面我们已经看到，图像的裸数据的数据量是非常大的，因此，对视频图像进行压缩编码是很有必要的。</p><p>所有的压缩编码技术都是通过去除冗余信息来降低数据量，比如音频的压缩就是通过去除超出人类听觉范围的频率信息进行冗余信息的剔除；<br>就视频来说，由于视频是运动的，所以同时拥有时间上的冗余信息和空间上的冗余信息。</p><p>使用 <strong>帧间编码技术</strong> 能去除时间上的冗余信息，具体包括以下部分：</p><ul><li>运动补偿<blockquote><p>通过先前的局部图像来预测、补偿当前的局部图像</p></blockquote></li><li>运动表示<blockquote><p>不同区域的图像使用不同的运动矢量来描述运动信息</p></blockquote></li><li>运动估计<blockquote><p>从视频序列中抽取运动信息的技术</p></blockquote></li></ul><p>使用帧内编码技术能去除空间上的冗余信息</p><h3 id="51-视频编解码技术"><a class="markdownIt-Anchor" href="#51-视频编解码技术"></a> 5.1 视频编解码技术</h3><p>视频的编解码技术有两套标准，一套是 ISO 制定的 MPEG 标准，另一套是 ITU-T 指定的 <span>H.xxx</span> 标准。</p><p>其中，Mpeg4 AVC 标准和 H.264 标准实际上是一套技术，只不过叫不同的名字罢了。</p><h3 id="52-视频格式和编解码技术"><a class="markdownIt-Anchor" href="#52-视频格式和编解码技术"></a> 5.2 视频格式和编解码技术</h3><p>在这里要厘清一个很关键的概念，就是视频文件的格式和它使用的编解码技术没有任何关系。</p><p>例如，我们熟知的 MP4 视频，实际上 MP4 只是一个 <strong>视频容器的格式(Container Format)</strong>，它可以承载不同编码的视频轨和音频轨道。</p><p>理论上，MP4 文件也可以承载 H.265 编码的视频，而 MKV 文件也可以承载 H.264 编码的视频。</p><p>所以不能一看 MP4 视频就认为其质量一定很差。</p><h3 id="53-ipb-帧"><a class="markdownIt-Anchor" href="#53-ipb-帧"></a> 5.3 IPB 帧</h3><p>IPB 帧是常用的一种视频压缩算法的概念，其中分为：</p><ul><li>I 帧：帧内编码帧(intra picture)<blockquote><p>I 帧通常是每个 GOP(MPEG 采用的一种视频压缩技术，下面会介绍) 的第一个帧，经过适度压缩之后，作为随机访问的参考点；<br>I 帧可以得到 6:1 的压缩比而不会产生任何的模糊现象，使用 I 帧可以去除视频的空间冗余信息</p></blockquote></li><li>P 帧：前向预测编码帧(predictrive-frame)<blockquote><p>通过将图像序列中前面已经编码的帧的时间冗余信息充分去除来压缩得到的编码图像，也称为预测帧</p></blockquote></li><li>B 帧：双向预测内插编码帧(bi-directrional interpolated prediction frame)<blockquote><p>既考虑源图像序列前面的已编码帧，又估计源图像序列后面的已编码帧之间的时间冗余信息来压缩传输数据量的编码信息，也称为双向预测帧</p></blockquote></li></ul><p>从解码的角度来理解 IPB 帧：</p><p>I 帧自身可以通过视频解压算法解压成单独的一张完整视频画面，去除的是空间上的冗余信息（类似于动画的 Cut）</p><p>P 帧需要参考前面的一个 I 帧或者 P 帧来解码成一张完整的视频画面</p><p>B 帧需要参考其前一个 I 帧或者 P 帧及其后面的一个 P 帧来生成一张完整的视频画面（类似于动画的中间张）</p><p>因此 P 帧和 B 帧去除的是视频帧在时间上的冗余信息。</p><h3 id="54-idr-帧"><a class="markdownIt-Anchor" href="#54-idr-帧"></a> 5.4 IDR 帧</h3><p>H.264 中除了上述的 IPB 帧以外还有一个特殊的 IDR 帧。</p><p>我们首先看一下 IDR 帧的英文全称：instantaneous decoding refresh picture，直译为『瞬间解码刷新图像』。</p><p>如何理解呢？其实 H.264 中采用了多帧预测技术，一个 P 帧很有可能会参考 I 帧之前的帧，所以不能以找到 I 帧作为参考条件。</p><p>但是 IDR 帧是一种特殊的 I 帧，在这一帧之后的所有参考帧都只会参考到这个 IDR 帧，而不会再往前参考。</p><p>在解码器中，一旦收到一个 IDR 帧，那么就会立即『刷新』参考帧缓冲区，并将 IDR 帧作为被参考的帧。</p><h3 id="55-pts-和-dts"><a class="markdownIt-Anchor" href="#55-pts-和-dts"></a> 5.5 PTS 和 DTS</h3><p>DTS 全称为 Decoding Time Stamp，指的是某个帧解码的时间戳；<br>PTS 全称为 Presentation Time Stamp，指的是某个帧显示的时间戳。</p><p>如果没有 B 帧，那么 DTS 和 PTS 就是一样的，但是 B 帧是插入帧，需要参考前后的帧进行解码，所以会打乱解码和显示的顺序，因此就需要有这两个值来调整某一个帧的解码和显示的时间。</p><p>某帧图像什么时候显示给用户，取决于它的 PTS；<br>某帧图像什么时候进行解码，取决于它的 DTS。</p><h3 id="56-gop"><a class="markdownIt-Anchor" href="#56-gop"></a> 5.6 GOP</h3><p>上面提到了 GOP ，那么什么是 GOP 呢？</p><p>其实两个 I 帧之间形成的一组图片，就是 GOP(Group Of Pictures)。</p><p>在为编码器设置参数的时候设置的 <code>gop_size</code> 实际上就是设置两个 I 帧之间帧的数量。</p><p>一般来说， I 帧的压缩率为 7，P 帧为 20， B 帧可以达到 50。</p><p>因此，多采用 B 帧可以节省大量空间，同时可以用它来多保存 I 帧，这样可以在相同的码率下提供更好的画质。</p><p>最后，结合上述概念，给出一幅解码和显示顺序的图：</p><p><img alt="GOP 内的解码顺序和显示顺序" data-src="../../images/%E9%9F%B3%E8%A7%86%E9%A2%91%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/gop-%E5%86%85%E7%9A%84%E8%A7%A3%E7%A0%81%E9%A1%BA%E5%BA%8F%E5%92%8C%E6%98%BE%E7%A4%BA%E9%A1%BA%E5%BA%8F.png"></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;最近准备入门音视频开发，就学习内容做一下笔记吧&lt;/p&gt;
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>翻译文章——在 Android Studio 3.3 中迁移 Gradle 到 Kotlin DSL</title>
    <link href="https://wafer.li//Android/%E7%BF%BB%E8%AF%91%E6%96%87%E7%AB%A0%E2%80%94%E2%80%94%E5%9C%A8-android-studio-3-3-%E4%B8%AD%E8%BF%81%E7%A7%BB-gradle-%E5%88%B0-kotlin-dsl/"/>
    <id>https://wafer.li//Android/翻译文章——在-android-studio-3-3-中迁移-gradle-到-kotlin-dsl/</id>
    <published>2019-07-31T04:44:00.000Z</published>
    <updated>2019-07-31T06:27:20.000Z</updated>
    
    <content type="html"><![CDATA[<p>这是一篇翻译文章，目前可以作为迁移 Gradle 到 Kotlin DSL 的备忘录，译者在 Android Studio 3.5 RC-1 上也迁移成功。</p><p>原文：<span class="exturl" data-url="aHR0cHM6Ly9tZWRpdW0uY29tL0BzdG9sdG1hbmphbi9taWdyYXRpbmctZ3JhZGxlLXRvLWtvdGxpbi1kc2wtaW4tYW5kcm9pZC1zdHVkaW8tMy0zLTE4NjUxZjM3MjI3Zg==" title="https://medium.com/@stoltmanjan/migrating-gradle-to-kotlin-dsl-in-android-studio-3-3-18651f37227f">Migrating Gradle to Kotlin DSL in Android Studio 3.3<i class="fa fa-external-link"></i></span></p><a id="more"></a><blockquote><p>注意：在本文中我认为你应该了解了<span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmdyYWRsZS5vcmcva290bGluLW1lZXRzLWdyYWRsZQ==" title="https://blog.gradle.org/kotlin-meets-gradle">Kotlin 可以应用于 Gradle 中<i class="fa fa-external-link"></i></span>，同时你想寻找一个快速备忘录或者一个直接复制粘贴就能用的解决方案。如果你想寻找一个完整的文档，请到<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmdyYWRsZS5vcmcvY3VycmVudC91c2VyZ3VpZGUva290bGluX2RzbC5odG1s" title="https://docs.gradle.org/current/userguide/kotlin_dsl.html">这里<i class="fa fa-external-link"></i></span>查看。</p></blockquote><h2 id="第一步gradle-wrapper-版本"><a class="markdownIt-Anchor" href="#第一步gradle-wrapper-版本"></a> 第一步：Gradle Wrapper 版本</h2><p>迁移 Gradle 到 Kotlin DSL 推荐使用 5.0 以上的 Gradle 版本，但不巧的是，在 Android 工程中，它也同时强烈建议当你没有使用 Android Gradle Plugin 3.4 时，不要使用 Gradle 5.0。在这种情况下，请确认你使用了目前支持的最新 Gradle 版本（本文撰写时该版本为 4.10.1）</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">//gradle.properties</span></span><br><span class="line"><span class="attr">distributionBase</span>=<span class="string">GRADLE_USER_HOME</span></span><br><span class="line"><span class="attr">distributionPath</span>=<span class="string">wrapper/dists</span></span><br><span class="line"><span class="attr">zipStoreBase</span>=<span class="string">GRADLE_USER_HOME</span></span><br><span class="line"><span class="attr">zipStorePath</span>=<span class="string">wrapper/dists</span></span><br><span class="line"><span class="attr">distributionUrl</span>=<span class="string">https\://services.gradle.org/distributions/gradle-4.10.1-all.zip</span></span><br></pre></td></tr></table></figure><h2 id="第二步更改所有的单引号为双引号"><a class="markdownIt-Anchor" href="#第二步更改所有的单引号为双引号"></a> 第二步：更改所有的单引号为双引号</h2><p>使用查找和替换(在 Android Studio 中使用 <kbd>ctrl + R</kbd>)工具将 Gradle 文件中所有的单引号(<code>'</code>)改为双引号(<code>&quot;</code>)</p><p>对于一个新建的工程，你要修改以下的三个文件：</p><ul><li>settings.gradle</li><li>build.gradle (根目录)</li><li>build.gradle (模块目录)</li></ul><h2 id="第三步将所有的隐式赋值和函数调用修改为显式的"><a class="markdownIt-Anchor" href="#第三步将所有的隐式赋值和函数调用修改为显式的"></a> 第三步：将所有的隐式赋值和函数调用修改为显式的</h2><p>然后，所有的 Gradle 式的赋值和函数调用都要转换为 Koltin 式的。像下面这个例子这样将它们进行转换：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// Groovy assignment</span><br><span class="line">applicationId &quot;com.yggdralisk.githubbrowser&quot;</span><br><span class="line">// Kotlin assignment</span><br><span class="line">applicationId = &quot;com.yggdralisk.githubbrowser&quot;</span><br><span class="line">// Groovy function call</span><br><span class="line">implementation &quot;androidx.constraintlayout:constraintlayout:2.0.0-alpha3&quot;</span><br><span class="line">// Kotlin function call</span><br><span class="line">implementation(&quot;androidx.constraintlayout:constraintlayout:2.0.0-alpha3&quot;)</span><br></pre></td></tr></table></figure><p>如果你不知道在这一步该如何修改，甚至不知道该修改什么，你可以通过文章底部的示例文件链接查看一下实例文件。</p><h2 id="第四步迁移-settingsgradle-文件"><a class="markdownIt-Anchor" href="#第四步迁移-settingsgradle-文件"></a> 第四步：迁移 settings.gradle 文件</h2><blockquote><p>注意：在开始这一步之前，你应该要关掉 Gradle 的 auto-sync 功能，否则它会让你十分抓狂。当你完成了整个工程的迁移工作之后，可以将其再次打开。</p></blockquote><blockquote><p>译者注：其实 Gradle 官方并不推荐开启 auto-sync 功能，官方推荐的是开启 auto-load，但是最好是开发者自己去 sync<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup></p></blockquote><p>使用重命名文件(<kbd>shift + F6</kbd>)功能将 settings.gradle 文件重命名为 settings.gradle.kts。</p><p>对于一个新建的工程，如下所示：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//settings.gradle.kts</span></span><br><span class="line">include(<span class="string">":app"</span>)</span><br></pre></td></tr></table></figure><h2 id="第五步迁移根目录-buildgradle-文件"><a class="markdownIt-Anchor" href="#第五步迁移根目录-buildgradle-文件"></a> 第五步：迁移根目录 build.gradle 文件</h2><p>对根目录的 build.gradle 文件进行类似上一步的操作，将它的文件名修改为 build.gradle.kts</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//build.gradle.kts (Project)</span></span><br><span class="line"><span class="comment">// Top-level build file where you can add configuration options common to all sub-projects/modules.</span></span><br><span class="line">buildscript &#123;</span><br><span class="line">    <span class="keyword">val</span> kotlinVersion = <span class="string">"1.3.11"</span></span><br><span class="line">    repositories &#123;</span><br><span class="line">        google()</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line">    dependencies &#123;</span><br><span class="line">        classpath(<span class="string">"com.android.tools.build:gradle:3.3.0"</span>)</span><br><span class="line">        classpath(kotlin(<span class="string">"gradle-plugin"</span>, kotlinVersion))</span><br><span class="line"></span><br><span class="line">        <span class="comment">// <span class="doctag">NOTE:</span> Do not place your application dependencies here; they belong</span></span><br><span class="line">        <span class="comment">// in the individual module build.gradle files</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">allprojects &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        google()</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tasks &#123;</span><br><span class="line">    <span class="keyword">val</span> clean <span class="keyword">by</span> registering(Delete::<span class="class"><span class="keyword">class</span>) </span>&#123;</span><br><span class="line">        delete(buildDir)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="第六步迁移模块的-settingsgradle-文件"><a class="markdownIt-Anchor" href="#第六步迁移模块的-settingsgradle-文件"></a> 第六步：迁移模块的 settings.gradle 文件</h2><p>对于模块的 settings.gradle 文件，我们也执行同样的操作，将它的文件名修改为 build.gradle.kts</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.jetbrains.kotlin.config.KotlinCompilerVersion</span><br><span class="line"></span><br><span class="line">plugins &#123;</span><br><span class="line">    id(<span class="string">"com.android.application"</span>)</span><br><span class="line">    kotlin(<span class="string">"android"</span>)</span><br><span class="line">    kotlin(<span class="string">"android.extensions"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">android &#123;</span><br><span class="line">    compileSdkVersion(<span class="number">28</span>)</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        applicationId = <span class="string">"com.yggdralisk.githubbrowser"</span></span><br><span class="line">        minSdkVersion(<span class="number">21</span>)</span><br><span class="line">        targetSdkVersion(<span class="number">28</span>)</span><br><span class="line">        versionCode = <span class="number">1</span></span><br><span class="line">        versionName = <span class="string">"1.0"</span></span><br><span class="line">        testInstrumentationRunner = <span class="string">"android.support.test.runner.AndroidJUnitRunner"</span></span><br><span class="line">    &#125;</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        getByName(<span class="string">"release"</span>) &#123;</span><br><span class="line">            isMinifyEnabled = <span class="literal">false</span></span><br><span class="line">            proguardFiles(getDefaultProguardFile(<span class="string">"proguard-android.txt"</span>), <span class="string">"proguard-rules.pro"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    implementation(fileTree(mapOf(<span class="string">"dir"</span> to <span class="string">"libs"</span>, <span class="string">"include"</span> to listOf(<span class="string">"*.jar"</span>))))</span><br><span class="line">    implementation(kotlin(<span class="string">"stdlib-jdk7"</span>, KotlinCompilerVersion.VERSION))</span><br><span class="line">    implementation(<span class="string">"com.android.support:appcompat-v7:28.0.0"</span>)</span><br><span class="line">    testImplementation(<span class="string">"junit:junit:4.12"</span>)</span><br><span class="line">    androidTestImplementation(<span class="string">"com.android.support.test:runner:1.0.2"</span>)</span><br><span class="line">    androidTestImplementation(<span class="string">"com.android.support.test.espresso:espresso-core:3.0.2"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">repositories &#123;</span><br><span class="line">    mavenCentral()</span><br><span class="line">    maven(<span class="string">"http://repository.jetbrains.com/all"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="示例文件链接"><a class="markdownIt-Anchor" href="#示例文件链接"></a> 示例文件链接</h2><p>你可以在我的 GitHub 仓库中找到能用的 Gradle 示例文件，你也可以在任何时间随意地分叉和复制这些文件。</p><ul><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0phblN0b2x0bWFuL0dpdGh1YkJyb3dzZXIvYmxvYi9tYXN0ZXIvc2V0dGluZ3MuZ3JhZGxlLmt0cw==" title="https://github.com/JanStoltman/GithubBrowser/blob/master/settings.gradle.kts">settings.gradle.kts<i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0phblN0b2x0bWFuL0dpdGh1YkJyb3dzZXIvYmxvYi9tYXN0ZXIvYnVpbGQuZ3JhZGxlLmt0cw==" title="https://github.com/JanStoltman/GithubBrowser/blob/master/build.gradle.kts">根目录 build.gradle.kts<i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0phblN0b2x0bWFuL0dpdGh1YkJyb3dzZXIvYmxvYi9tYXN0ZXIvYXBwL2J1aWxkLmdyYWRsZS5rdHM=" title="https://github.com/JanStoltman/GithubBrowser/blob/master/app/build.gradle.kts">模块 build.gradle.kts<i class="fa fa-external-link"></i></span></li></ul><p>如果你在迁移中遇到了任何问题，记住要查看 <strong>build/sync logs</strong> 里面的错误提示，而不是看 Android Studio 弹出的错误提示，因为 Android Studio 对于 Gradle Kotlin DSL 的支持还远远称不上完美。</p><hr class="footnotes-sep"><section class="footnotes"><ol class="footnotes-list"><li id="fn1" class="footnote-item"><p><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmdyYWRsZS5vcmcvY3VycmVudC91c2VyZ3VpZGUva290bGluX2RzbC5odG1sI2F1dG9tYXRpY19idWlsZF9pbXBvcnRfdnNfYXV0b21hdGljX3JlbG9hZGluZ19vZl9zY3JpcHRfZGVwZW5kZW5jaWVz" title="https://docs.gradle.org/current/userguide/kotlin_dsl.html#automatic_build_import_vs_automatic_reloading_of_script_dependencies">https://docs.gradle.org/current/userguide/kotlin_dsl.html#automatic_build_import_vs_automatic_reloading_of_script_dependencies<i class="fa fa-external-link"></i></span> <a href="#fnref1" class="footnote-backref">↩︎</a></p></li></ol></section>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;这是一篇翻译文章，目前可以作为迁移 Gradle 到 Kotlin DSL 的备忘录，译者在 Android Studio 3.5 RC-1 上也迁移成功。&lt;/p&gt;&lt;p&gt;原文：&lt;a href=&quot;https://medium.com/@stoltmanjan/migrating-gradle-to-kotlin-dsl-in-android-studio-3-3-18651f37227f&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Migrating Gradle to Kotlin DSL in Android Studio 3.3&lt;/a&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="Android" scheme="https://wafer.li/categories/Android/"/>
    
    
      <category term="Android" scheme="https://wafer.li/tags/Android/"/>
    
      <category term="Gradle" scheme="https://wafer.li/tags/Gradle/"/>
    
      <category term="Kotlin" scheme="https://wafer.li/tags/Kotlin/"/>
    
      <category term="Translate" scheme="https://wafer.li/tags/Translate/"/>
    
  </entry>
  
  <entry>
    <title>Android 高德地图轨迹回放</title>
    <link href="https://wafer.li//android-%E9%AB%98%E5%BE%B7%E5%9C%B0%E5%9B%BE%E8%BD%A8%E8%BF%B9%E5%9B%9E%E6%94%BE/"/>
    <id>https://wafer.li//android-高德地图轨迹回放/</id>
    <published>2019-07-30T01:24:00.000Z</published>
    <updated>2019-07-30T10:14:58.000Z</updated>
    
    <content type="html"><![CDATA[<p>最近公司要求实现一个轨迹回放功能，想着 JS 都有 demo 的功能，Android 实现起来不还是小菜一碟？</p><p>结果显然是我太拿衣服了</p><a id="more"></a><h2 id="0-太长不看"><a class="markdownIt-Anchor" href="#0-太长不看"></a> 0. 太长不看</h2><p>全篇都采用高德 API 实现，基于 <span class="exturl" data-url="aHR0cHM6Ly9iaW50cmF5LmNvbS9iaW50cmF5L2pjZW50ZXIvY29tLmFtYXAuYXBpJTNBM2RtYXAvNi45LjI=" title="https://bintray.com/bintray/jcenter/com.amap.api%3A3dmap/6.9.2"><code>3dmap 6.9.2</code><i class="fa fa-external-link"></i></span> 包</p><p>使用 <code>MovingPointOverlay</code> 实现点的平滑移动</p><p>使用 <code>AMap.setCustomRenderer</code> 获取每帧回调，绘制走过的线路</p><h2 id="1-需求分析"><a class="markdownIt-Anchor" href="#1-需求分析"></a> 1. 需求分析</h2><p>轨迹回放的功能在高德的 <span class="exturl" data-url="aHR0cHM6Ly9sYnMuYW1hcC5jb20vYXBpL2phdmFzY3JpcHQtYXBpL2V4YW1wbGUvbWFya2VyL3JlcGxheWluZy1oaXN0b3JpY2FsLXJ1bm5pbmctZGF0YS8/c3VnX2luZGV4PTE=" title="https://lbs.amap.com/api/javascript-api/example/marker/replaying-historical-running-data/?sug_index=1">JS Demo<i class="fa fa-external-link"></i></span> 上有，具体来说就是点按照既定路线去移动，同时绘制其走过的路线。</p><p>那么我们可以将功能拆解为移动点和绘制线路</p><p>本来我想着这种常见的功能在网上随便搜搜就能找到的，然而显然是我太 Naive 了。</p><p>搜到的唯二相关的内容，其中一个排版很差，而且估计是公司内部代码，没有给出 demo，第二个则是硬怼一个自定义 View，但是地图肯定是要移动放大之类的，自定义 View 也需要做手势控制，实现难度相对较大。</p><p>所以最好还是在高德内部框架上实现这个需求。</p><h2 id="2-api-调研"><a class="markdownIt-Anchor" href="#2-api-调研"></a> 2. API 调研</h2><p>经过一番查找之后，我找到了 <code>SmoothMoveMarker</code> 可以实现点的平滑移动功能，然而：</p><p><img alt="SmoothMoveMarker Deprecated" data-src="../images/android-%E9%AB%98%E5%BE%B7%E5%9C%B0%E5%9B%BE%E8%BD%A8%E8%BF%B9%E5%9B%9E%E6%94%BE/smoothmovemarker-deprecated.png"></p><p>这里不得不吐槽一下高德的混淆策略，它不仅混淆了代码，同时还把文档混淆了，明明各部分文档都是公开的，将其保留在源代码里面也不会增大多少空间，然而这样全部删掉，导致我不得不切一个网页去看它的 API doc，开发效率急剧下降</p><p>在查看了高德地图的 API doc 之后，发现这个类是被 <code>MovingPointOverlay</code> 替代了，也就是说我们需要采用 <code>MovingPointOverlay</code> 实现点的平滑移动</p><h2 id="3-获取点位置回调"><a class="markdownIt-Anchor" href="#3-获取点位置回调"></a> 3. 获取点位置回调</h2><p>在 <code>MovingPointOverlay</code> 的 <a href>API doc</a> 中，有一个方法叫 <code>setMovingListener</code>，当时的我想当然的认为这个就是点移动时的回调设置方法，因此把画线的逻辑放到了里面去。</p><p>原先我将动画的总时间设置为 10 秒，此时点跑得比较快，乍一看没什么问题；<br>但是当我将动画的时间拉长，点跑得很慢的时候，问题就出现了—— <code>setMovingListener</code> <strong>并不是每帧回调！</strong></p><p>也就是说，只有当 Marker 跑到下一个路径点的时候，才能绘制上经过的路线！</p><p>这显然会导致线路绘制不平滑，达不到需求的要求。</p><p>那怎么办呢？这时候我就进入了一段瞎糊弄的时间，尝试着通过自行实现动画效果来完成需求，然而无论是经纬度计算、屏幕像素计算都存在误差，不太可能在短时间能将需求实现。</p><p>正当我想着『万策尽きた！』，无聊浏览高德地图 API doc 的时候，突然发现 <code>AMap</code> 有个 <code>runOnDrawFrame()</code> 方法，是用来触发高德地图的重绘的；</p><p>既然有这个方法，那就一定有绘制的回调方法！功夫不负有心人，在往下看了几行之后，我终于发现了这个重要的方法 <code>setCustomRenderer()</code>，而且两者意外的离的很近：</p><p><img alt="runOnDrawFrame And setCustomRenderer" data-src="../images/android-%E9%AB%98%E5%BE%B7%E5%9C%B0%E5%9B%BE%E8%BD%A8%E8%BF%B9%E5%9B%9E%E6%94%BE/runondrawframe-and-setcustomrenderer.png"></p><p>这个方法接受一个 <code>CustomRenderer</code> 参数，那么什么是 <code>CustomRenderer</code> 呢？</p><p><img alt="CustomRenderer" data-src="../images/android-%E9%AB%98%E5%BE%B7%E5%9C%B0%E5%9B%BE%E8%BD%A8%E8%BF%B9%E5%9B%9E%E6%94%BE/customrenderer.png"></p><p>从这里看，它有一个 <code>onDrawFrame()</code>，正是绘制每一帧的回调接口，那么我们只要将画线逻辑放到里面去就可以了。</p><p>当然，我们也不能抛弃 <code>setMovingListener</code>，因为我们需要它来判断是否已经到达终点。</p><h2 id="4-实现逻辑"><a class="markdownIt-Anchor" href="#4-实现逻辑"></a> 4. 实现逻辑</h2><ol><li>使用 <code>MovingPointOverlay</code> 实现点的平滑移动</li><li>使用 <code>AMap.setCustomRenderer</code> 获取每帧回调，绘制经过的线路</li><li>使用 <code>MovingPointOverlay.setMovingListener</code> 判断是否已经到达终点，如果到达终点，则清除经过线路的点</li></ol><h2 id="5-坑点"><a class="markdownIt-Anchor" href="#5-坑点"></a> 5. 坑点</h2><p>无论是 <code>setCustomRenderer</code> 还是 <code>setMovingListener</code>，它们的回调都是在 OPEN GL 线程回调，而<strong>不是在主线程回调</strong></p><p>因此，如果需要在动画完毕之后更改 UI，就必须使用 <code>runOnUiThread</code>，否则无论你怎么在里面更改 UI，都不会有任何效果</p><h2 id="6-demo"><a class="markdownIt-Anchor" href="#6-demo"></a> 6. Demo</h2><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3dhZmVyLWxpL0FNYXBSZXBsYXlEZW1v" title="https://github.com/wafer-li/AMapReplayDemo">https://github.com/wafer-li/AMapReplayDemo<i class="fa fa-external-link"></i></span></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;最近公司要求实现一个轨迹回放功能，想着 JS 都有 demo 的功能，Android 实现起来不还是小菜一碟？&lt;/p&gt;&lt;p&gt;结果显然是我太拿衣服了&lt;/p&gt;
    
    </summary>
    
    
      <category term="Android" scheme="https://wafer.li/categories/Android/"/>
    
    
      <category term="Android" scheme="https://wafer.li/tags/Android/"/>
    
      <category term="高德地图" scheme="https://wafer.li/tags/%E9%AB%98%E5%BE%B7%E5%9C%B0%E5%9B%BE/"/>
    
  </entry>
  
  <entry>
    <title>HashMap 的 loadFactor 为什么是 0.75</title>
    <link href="https://wafer.li//Interview/hashmap-%E7%9A%84-loadfactor-%E4%B8%BA%E4%BB%80%E4%B9%88%E6%98%AF-0-75/"/>
    <id>https://wafer.li//Interview/hashmap-的-loadfactor-为什么是-0-75/</id>
    <published>2019-07-11T07:46:00.000Z</published>
    <updated>2019-07-11T11:58:23.000Z</updated>
    
    <content type="html"><![CDATA[<p>之前看各大面经的时候搜索到了这个问题，切实感觉到如果刨根问底的问，自己还真不能抵挡住这种攻势，现在闲暇时间又心血来潮地想起来这个问题，就打算好好弄懂弄透，也希望能在将来面试的时候做好准备。</p><p>本文基于<span class="exturl" data-url="aHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9hLzMxNDAxODM2" title="https://stackoverflow.com/a/31401836">这个 StackOverflow 回答<i class="fa fa-external-link"></i></span>进一步推导，并给出详细解答步骤</p><a id="more"></a><h2 id="1-loadfactor-是什么"><a class="markdownIt-Anchor" href="#1-loadfactor-是什么"></a> 1. loadFactor 是什么</h2><p>loadFactor 翻译为 <strong>负载因子</strong>，是 HashMap 负载程度的一个度量，所谓负载程度即 HashMap 持有的元素数量和 HashMap 大小的比值</p><p>当 HashMap 中的元素数量大于 <code>capacity * loadFactor</code> 时，HashMap 就要扩容，并进行重新 hash</p><p>那么，我们可以得出一个重要结论，<code>loadFactor</code> 是为了让 HashMap 尽可能 <strong>不满</strong> 而存在的</p><p>众所周知，HashMap 越空越好，这样插入和查找都能尽可能接近常数级别</p><p>那么接下来的一个重要问题就是：HashMap 什么时候是空的？通过这个问题，我们就可以一步一步推导出 <code>loadFactor</code> 的值</p><h2 id="2-hashmap-什么时候不是很满"><a class="markdownIt-Anchor" href="#2-hashmap-什么时候不是很满"></a> 2. HashMap 什么时候不是很满</h2><p>我们调整 loadFactor 的根本目标在于，要让元素的插入时间缩短到最少，也就是说，<strong>元素最好不要发生碰撞</strong></p><p><strong>只要元素在插入时不发生碰撞，那么我们的 HashMap 就不算特别的满</strong></p><p>这是一个很重要的结论，通过它，我们成功地把 HashMap 满不满的问题，转换到了插入元素是否碰撞的问题</p><h2 id="3-插入元素的碰撞几率"><a class="markdownIt-Anchor" href="#3-插入元素的碰撞几率"></a> 3. 插入元素的碰撞几率</h2><p>插入元素是否碰撞，这是一个概率事件，有可能碰撞，也可能不碰撞</p><p>对于一个未知的元素，它有可能插入到 HashMap 的任何一个位置，因此，对于未知的元素插入，碰撞是<strong>等可能的</strong>，而一个元素是否碰撞和它之后的元素是否碰撞并无关系，因此是 <strong>独立的</strong></p><blockquote><p>为什么是独立的？因为 HashMap 采用拉链法解决碰撞，碰撞的元素不占用数组空间，因此一个元素是否碰撞和它前一个元素是否碰撞没有关系</p></blockquote><p>在这里，我们要引入一个假设，上面我们提到的 HashMap 不是很满，但是 loadFactor 也不应该让一个 HashMap 过于空，太空的 HashMap 会造成空间的浪费；<br>假如一个元素的插入正好导致它碰撞，那么说明这个 HashMap 肯定不是特别空旷，而且当元素插入就碰撞时，恰好说明我们需要扩大 HashMap，而不是修改元素的 <code>hash()</code> 方法</p><p>因此，我们有单个元素插入碰撞的概率为</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>p</mi><mo>=</mo><mfrac><mn>1</mn><mi>s</mi></mfrac></mrow><annotation encoding="application/x-tex">p = \frac{1}{s}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.625em;vertical-align:-.19444em"></span><span class="mord mathdefault">p</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:2.00744em;vertical-align:-.686em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathdefault">s</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><h2 id="4-hashmap-在插入过程中不发生碰撞的概率"><a class="markdownIt-Anchor" href="#4-hashmap-在插入过程中不发生碰撞的概率"></a> 4. HashMap 在插入过程中不发生碰撞的概率</h2><p>得到单个元素插入发生碰撞的概率之后，我们来考虑整个 HashMap 在插入过程中不发生碰撞的概率</p><p>对于一个 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mord mathdefault">s</span></span></span></span> 大小的 Hashmap，我们插入 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mord mathdefault">n</span></span></span></span> 个元素，这个操作属于等可能独立事件的<strong>重复操作</strong>，满足 <strong>二项分布</strong>，因此我们可以得出，在这个重复插入操作中，没有碰撞的概率为：</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>P</mi><mo stretchy="false">(</mo><mn>0</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msubsup><mi>C</mi><mi>n</mi><mn>0</mn></msubsup><mo>×</mo><mo stretchy="false">(</mo><mfrac><mn>1</mn><mi>s</mi></mfrac><msup><mo stretchy="false">)</mo><mn>0</mn></msup><mo>×</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mfrac><mn>1</mn><mi>s</mi></mfrac><msup><mo stretchy="false">)</mo><mrow><mi>n</mi><mo>−</mo><mn>0</mn></mrow></msup></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mfrac><mn>1</mn><mi>s</mi></mfrac><msup><mo stretchy="false">)</mo><mi>n</mi></msup></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned} P(0) &amp; = C_n^0 \times (\frac{1}{s})^0 \times (1 - \frac{1}{s})^{n - 0} \\ &amp; = (1 - \frac{1}{s})^n \end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:4.61488em;vertical-align:-2.05744em"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.55744em"><span style="top:-4.55744em"><span class="pstrut" style="height:3.32144em"></span><span class="mord"><span class="mord mathdefault" style="margin-right:.13889em">P</span><span class="mopen">(</span><span class="mord">0</span><span class="mclose">)</span></span></span><span style="top:-2.25em"><span class="pstrut" style="height:3.32144em"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.05744em"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.55744em"><span style="top:-4.55744em"><span class="pstrut" style="height:3.32144em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mord"><span class="mord mathdefault" style="margin-right:.07153em">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.8641079999999999em"><span style="top:-2.4530000000000003em;margin-left:-.07153em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span><span style="top:-3.113em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.247em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathdefault">s</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.8641079999999999em"><span style="top:-3.113em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathdefault">s</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.864108em"><span style="top:-3.113em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mbin mtight">−</span><span class="mord mtight">0</span></span></span></span></span></span></span></span></span></span></span><span style="top:-2.25em"><span class="pstrut" style="height:3.32144em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathdefault">s</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.7143919999999999em"><span style="top:-3.113em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.05744em"><span></span></span></span></span></span></span></span></span></span></span></span></p><h2 id="5-什么叫hashmap-很可能不满"><a class="markdownIt-Anchor" href="#5-什么叫hashmap-很可能不满"></a> 5. 什么叫“HashMap 很可能不满”</h2><p>假如一个 HashMap，它在插入元素的过程中，如果它一次碰撞都没有发生，说明它没有满；</p><p>上面我们得到了这个事件的概率，如果这个事件发生的概率很大，那么就说明 HashMap <strong>很可能不满</strong></p><p>所以，若 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mn>0</mn><mo stretchy="false">)</mo><mo>≤</mo><mn>0.5</mn></mrow><annotation encoding="application/x-tex">P(0) \le 0.5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathdefault" style="margin-right:.13889em">P</span><span class="mopen">(</span><span class="mord">0</span><span class="mclose">)</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.64444em;vertical-align:0"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">5</span></span></span></span>，则说明 HashMap 很可能没有满</p><p>则有</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right" columnspacing><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mfrac><mn>1</mn><mi>s</mi></mfrac><msup><mo stretchy="false">)</mo><mi>n</mi></msup><mo>≥</mo><mfrac><mn>1</mn><mn>2</mn></mfrac></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned} (1 - \frac{1}{s})^n \ge \frac{1}{2} \end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.30744em;vertical-align:-.90372em"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.4037200000000003em"><span style="top:-3.4037200000000003em"><span class="pstrut" style="height:3.32144em"></span><span class="mord"><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathdefault">s</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.7143919999999999em"><span style="top:-3.113em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.90372em"><span></span></span></span></span></span></span></span></span></span></span></span></p><p>其中 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mord mathdefault">n</span></span></span></span> 代表 HashMap 中元素的个数，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mord mathdefault">s</span></span></span></span> 代表 HashMap 的数组大小</p><h2 id="6-loadfactor-的计算过程"><a class="markdownIt-Anchor" href="#6-loadfactor-的计算过程"></a> 6. loadFactor 的计算过程</h2><p>HashMap 中 <code>loadFactor</code> 即为 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi><mi mathvariant="normal">/</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">n/s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathdefault">n</span><span class="mord">/</span><span class="mord mathdefault">s</span></span></span></span>，首先求出 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mord mathdefault">n</span></span></span></span>，对于上面的式子取对数，则有</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>n</mi><mi>ln</mi><mo>⁡</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mfrac><mn>1</mn><mi>s</mi></mfrac><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>≥</mo><mo>−</mo><mi>ln</mi><mo>⁡</mo><mn>2</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mi>n</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>≤</mo><mfrac><mrow><mo>−</mo><mi>ln</mi><mo>⁡</mo><mn>2</mn></mrow><mrow><mi>ln</mi><mo>⁡</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mfrac><mn>1</mn><mi>s</mi></mfrac><mo stretchy="false">)</mo></mrow></mfrac></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mi>n</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>≤</mo><mfrac><mrow><mo>−</mo><mi>ln</mi><mo>⁡</mo><mn>2</mn></mrow><mrow><mi>ln</mi><mo>⁡</mo><mfrac><mrow><mi>s</mi><mo>−</mo><mn>1</mn></mrow><mi>s</mi></mfrac></mrow></mfrac></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mi>n</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>≤</mo><mfrac><mrow><mi>ln</mi><mo>⁡</mo><mn>2</mn></mrow><mrow><mi>ln</mi><mo>⁡</mo><mfrac><mi>s</mi><mrow><mi>s</mi><mo>−</mo><mn>1</mn></mrow></mfrac></mrow></mfrac></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned} n\ln(1 - \frac{1}{s}) &amp; \ge -\ln2 \\ n &amp; \le \frac{-\ln2}{\ln(1 - \frac{1}{s})} \\ n &amp; \le \frac{-\ln2}{\ln\frac{s-1}{s}} \\ n &amp; \le \frac{\ln2}{\ln\frac{s}{s-1}} \end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:10.571307000000001em;vertical-align:-5.0356535em"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:5.5356535000000004em"><span style="top:-7.5856535em"><span class="pstrut" style="height:3.3714399999999998em"></span><span class="mord"><span class="mord mathdefault">n</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mop">ln</span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathdefault">s</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">)</span></span></span><span style="top:-5.228213499999999em"><span class="pstrut" style="height:3.3714399999999998em"></span><span class="mord"><span class="mord mathdefault">n</span></span></span><span style="top:-2.4766655em"><span class="pstrut" style="height:3.3714399999999998em"></span><span class="mord"><span class="mord mathdefault">n</span></span></span><span style="top:.2748824999999997em"><span class="pstrut" style="height:3.3714399999999998em"></span><span class="mord"><span class="mord mathdefault">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:5.0356535em"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:5.5356535000000004em"><span style="top:-7.5856535em"><span class="pstrut" style="height:3.3714399999999998em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mord">−</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mop">ln</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord">2</span></span></span><span style="top:-5.228213499999999em"><span class="pstrut" style="height:3.3714399999999998em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.37144em"><span style="top:-2.2648919999999997em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mop">ln</span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.845108em"><span style="top:-2.6550000000000002em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.345em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">)</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">−</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mop">ln</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.080108em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-2.4766655em"><span class="pstrut" style="height:3.3714399999999998em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.37144em"><span style="top:-2.2648919999999997em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mop">ln</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.845108em"><span style="top:-2.6550000000000002em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.345em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">−</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mop">ln</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.080108em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:.2748824999999997em"><span class="pstrut" style="height:3.3714399999999998em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.37144em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mop">ln</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.695392em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.403331em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mop">ln</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.089331em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:5.0356535em"><span></span></span></span></span></span></span></span></span></span></span></span></p><p>所以，当 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi><mo>≤</mo><mfrac><mrow><mi>ln</mi><mo>⁡</mo><mn>2</mn></mrow><mrow><mi>ln</mi><mo>⁡</mo><mfrac><mrow><mn>2</mn><mi>s</mi></mrow><mrow><mn>2</mn><mi>s</mi><mo>−</mo><mn>1</mn></mrow></mfrac></mrow></mfrac></mrow><annotation encoding="application/x-tex">n \le \frac{\ln2}{\ln\frac{2s}{2s-1}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.7719400000000001em;vertical-align:-.13597em"></span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1.5635929999999998em;vertical-align:-.6834849999999999em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.8801079999999999em"><span style="top:-2.59898em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight">ln</span><span class="mspace mtight" style="margin-right:.19516666666666668em"></span><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.8443142857142858em"><span style="top:-2.656em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathdefault mtight">s</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2255em"><span class="pstrut" style="height:3em"></span><span class="frac-line mtight" style="border-bottom-width:.049em"></span></span><span style="top:-3.384em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathdefault mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.40352142857142853em"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight">ln</span><span class="mspace mtight" style="margin-right:.19516666666666668em"></span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.6834849999999999em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span> 时，HashMap <strong>很可能</strong>不满，所以</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mfrac><mi>n</mi><mi>s</mi></mfrac><mo>≤</mo><mfrac><mrow><mi>ln</mi><mo>⁡</mo><mn>2</mn></mrow><mrow><mi>s</mi><mi>ln</mi><mo>⁡</mo><mfrac><mi>s</mi><mrow><mi>s</mi><mo>−</mo><mn>1</mn></mrow></mfrac></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{n}{s} \le \frac{\ln2}{s\ln\frac{s}{s-1}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.7935600000000003em;vertical-align:-.686em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.10756em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathdefault">s</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathdefault">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:2.4607710000000003em;vertical-align:-1.089331em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.37144em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mop">ln</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.695392em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.403331em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mop">ln</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.089331em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><p>当 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>s</mi><mo>→</mo><mi mathvariant="normal">∞</mi></mrow><annotation encoding="application/x-tex">s \to \infty</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">→</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mord">∞</span></span></span></span> 时，有</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>l</mi><mi>o</mi><mi>a</mi><mi>d</mi><mi>F</mi><mi>a</mi><mi>c</mi><mi>t</mi><mi>o</mi><mi>r</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><munder><mo><mi>lim</mi><mo>⁡</mo></mo><mrow><mi>s</mi><mo>→</mo><mi mathvariant="normal">∞</mi></mrow></munder><mfrac><mrow><mi>ln</mi><mo>⁡</mo><mn>2</mn></mrow><mrow><mi>s</mi><mi>ln</mi><mo>⁡</mo><mfrac><mi>s</mi><mrow><mi>s</mi><mo>−</mo><mn>1</mn></mrow></mfrac></mrow></mfrac></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned} loadFactor &amp; = \lim_{s \to \infty}\frac{\ln2}{s\ln\frac{s}{s-1}} \end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.760771em;vertical-align:-1.1303855em"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6303855em"><span style="top:-3.6303855em"><span class="pstrut" style="height:3.3714399999999998em"></span><span class="mord"><span class="mord mathdefault" style="margin-right:.01968em">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">a</span><span class="mord mathdefault">d</span><span class="mord mathdefault" style="margin-right:.13889em">F</span><span class="mord mathdefault">a</span><span class="mord mathdefault">c</span><span class="mord mathdefault">t</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:.02778em">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.1303855em"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6303855em"><span style="top:-3.6303855em"><span class="pstrut" style="height:3.3714399999999998em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.69444em"><span style="top:-2.1em;margin-left:0"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="mrel mtight">→</span><span class="mord mtight">∞</span></span></span></span><span style="top:-2.7em"><span class="pstrut" style="height:2.7em"></span><span><span class="mop">lim</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.7em"><span></span></span></span></span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.37144em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mop">ln</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.695392em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.403331em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mop">ln</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.089331em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.1303855em"><span></span></span></span></span></span></span></span></span></span></span></span></p><p>对于分母的式子有</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right" columnspacing><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><munder><mo><mi>lim</mi><mo>⁡</mo></mo><mrow><mi>s</mi><mo>→</mo><mi mathvariant="normal">∞</mi></mrow></munder><mi>s</mi><mi>ln</mi><mo>⁡</mo><mfrac><mi>s</mi><mrow><mi>s</mi><mo>−</mo><mn>1</mn></mrow></mfrac></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned} \lim_{s \to \infty}s\ln\frac{s}{s-1} \end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.17689em;vertical-align:-.8384450000000001em"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.338445em"><span style="top:-3.338445em"><span class="pstrut" style="height:3.1075600000000003em"></span><span class="mord"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.69444em"><span style="top:-2.1em;margin-left:0"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="mrel mtight">→</span><span class="mord mtight">∞</span></span></span></span><span style="top:-2.7em"><span class="pstrut" style="height:2.7em"></span><span><span class="mop">lim</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.7em"><span></span></span></span></span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mop">ln</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.10756em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mord">1</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathdefault">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.7693300000000001em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.8384450000000001em"><span></span></span></span></span></span></span></span></span></span></span></span></p><p>从形式上来看，当 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>s</mi><mo>→</mo><mi mathvariant="normal">∞</mi></mrow><annotation encoding="application/x-tex">s \to \infty</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">→</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mord">∞</span></span></span></span> 时，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mfrac><mrow><mn>2</mn><mi>s</mi></mrow><mrow><mn>2</mn><mi>s</mi><mo>−</mo><mn>1</mn></mrow></mfrac><mo>→</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\frac{2s}{2s-1} \to 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2484389999999999em;vertical-align:-.403331em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.845108em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathdefault mtight">s</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathdefault mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.403331em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">→</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.64444em;vertical-align:0"></span><span class="mord">0</span></span></span></span>，则上式为 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="normal">∞</mi><mo>⋅</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\infty \cdot 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.44445em;vertical-align:0"></span><span class="mord">∞</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:.64444em;vertical-align:0"></span><span class="mord">0</span></span></span></span> 型，应转换为 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mfrac><mn>0</mn><mi mathvariant="normal">∞</mi></mfrac></mrow><annotation encoding="application/x-tex">\frac{0}{\infty}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.190108em;vertical-align:-.345em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.845108em"><span style="top:-2.6550000000000002em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">∞</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.345em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span> 或者 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mfrac><mi mathvariant="normal">∞</mi><mn>0</mn></mfrac></mrow><annotation encoding="application/x-tex">\frac{\infty}{0}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.040392em;vertical-align:-.345em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.695392em"><span style="top:-2.6550000000000002em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">∞</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.345em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span> 计算，对 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mord mathdefault">s</span></span></span></span> 取倒数，有：<br>令 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>s</mi><mo>=</mo><mfrac><mn>1</mn><mi>t</mi></mfrac></mrow><annotation encoding="application/x-tex">s = \frac{1}{t}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1.190108em;vertical-align:-.345em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.845108em"><span style="top:-2.6550000000000002em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.345em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>：</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><munder><mo><mi>lim</mi><mo>⁡</mo></mo><mrow><mi>t</mi><mo>→</mo><mn>0</mn></mrow></munder><mfrac><mn>1</mn><mi>t</mi></mfrac><mi>ln</mi><mo>⁡</mo><mfrac><mfrac><mn>1</mn><mi>t</mi></mfrac><mrow><mfrac><mn>1</mn><mi>t</mi></mfrac><mo>−</mo><mn>1</mn></mrow></mfrac></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><munder><mo><mi>lim</mi><mo>⁡</mo></mo><mrow><mi>t</mi><mo>→</mo><mn>0</mn></mrow></munder><mfrac><mn>1</mn><mi>t</mi></mfrac><mi>ln</mi><mo>⁡</mo><mfrac><mfrac><mn>1</mn><mi>t</mi></mfrac><mfrac><mrow><mn>1</mn><mo>−</mo><mi>t</mi></mrow><mi>t</mi></mfrac></mfrac></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><munder><mo><mi>lim</mi><mo>⁡</mo></mo><mrow><mi>t</mi><mo>→</mo><mn>0</mn></mrow></munder><mfrac><mn>1</mn><mi>t</mi></mfrac><mi>ln</mi><mo>⁡</mo><mfrac><mn>1</mn><mrow><mn>1</mn><mo>−</mo><mi>t</mi></mrow></mfrac></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><munder><mo><mi>lim</mi><mo>⁡</mo></mo><mrow><mi>t</mi><mo>→</mo><mn>0</mn></mrow></munder><mfrac><mrow><mi>ln</mi><mo>⁡</mo><mfrac><mn>1</mn><mrow><mn>1</mn><mo>−</mo><mi>t</mi></mrow></mfrac></mrow><mi>t</mi></mfrac><mo>⋯</mo><mo stretchy="false">(</mo><mo>⋆</mo><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned} &amp; \lim_{t \to 0} \frac{1}{t} \ln\frac{\frac{1}{t}}{\frac{1}{t} - 1} \\ &amp; = \lim_{t \to 0}\frac{1}{t} \ln\frac{\frac{1}{t}}{\frac{1-t}{t}} \\ &amp; = \lim_{t \to 0} \frac{1}{t}\ln\frac{1}{1-t} \\ &amp; = \lim_{t \to 0} \frac{\ln\frac{1}{1-t}}{t} \cdots (\star) \\ \end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:10.966749em;vertical-align:-5.2333745em"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:5.7333745em"><span style="top:-7.7917055em"><span class="pstrut" style="height:3.638439em"></span><span class="mord"></span></span><span style="top:-4.8314895em"><span class="pstrut" style="height:3.638439em"></span><span class="mord"></span></span><span style="top:-2.1299415em"><span class="pstrut" style="height:3.638439em"></span><span class="mord"></span></span><span style="top:.5778275000000002em"><span class="pstrut" style="height:3.638439em"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:5.2333745em"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:5.7333745em"><span style="top:-7.7917055em"><span class="pstrut" style="height:3.638439em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.69444em"><span style="top:-2.082892em;margin-left:0"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mrel mtight">→</span><span class="mord mtight">0</span></span></span></span><span style="top:-2.7em"><span class="pstrut" style="height:2.7em"></span><span><span class="mop">lim</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.717108em"><span></span></span></span></span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathdefault">t</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mop">ln</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.580108em"><span style="top:-2.2648919999999997em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.845108em"><span style="top:-2.6550000000000002em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.345em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mord">1</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.7350000000000003em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.845108em"><span style="top:-2.6550000000000002em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.345em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.080108em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-4.8314895em"><span class="pstrut" style="height:3.638439em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.69444em"><span style="top:-2.082892em;margin-left:0"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mrel mtight">→</span><span class="mord mtight">0</span></span></span></span><span style="top:-2.7em"><span class="pstrut" style="height:2.7em"></span><span><span class="mop">lim</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.717108em"><span></span></span></span></span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathdefault">t</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mop">ln</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.580108em"><span style="top:-2.2648919999999997em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.845108em"><span style="top:-2.6550000000000002em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mbin mtight">−</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.345em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.7350000000000003em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.845108em"><span style="top:-2.6550000000000002em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.345em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.080108em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-2.1299415em"><span class="pstrut" style="height:3.638439em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.69444em"><span style="top:-2.082892em;margin-left:0"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mrel mtight">→</span><span class="mord mtight">0</span></span></span></span><span style="top:-2.7em"><span class="pstrut" style="height:2.7em"></span><span><span class="mop">lim</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.717108em"><span></span></span></span></span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathdefault">t</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mop">ln</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mord mathdefault">t</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.7693300000000001em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:.5778275000000002em"><span class="pstrut" style="height:3.638439em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.69444em"><span style="top:-2.082892em;margin-left:0"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mrel mtight">→</span><span class="mord mtight">0</span></span></span></span><span style="top:-2.7em"><span class="pstrut" style="height:2.7em"></span><span><span class="mop">lim</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.717108em"><span></span></span></span></span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.638439em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathdefault">t</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.7933310000000002em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mop">ln</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.845108em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mbin mtight">−</span><span class="mord mathdefault mtight">t</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.403331em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="minner">⋯</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mopen">(</span><span class="mord">⋆</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:5.2333745em"><span></span></span></span></span></span></span></span></span></span></span></span></p><p>遇见 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>x</mi><mo>→</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">x \to 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">→</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.64444em;vertical-align:0"></span><span class="mord">0</span></span></span></span>，就要想 <strong>等价无穷小</strong>，对于 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>ln</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\ln</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.69444em;vertical-align:0"></span><span class="mop">ln</span></span></span></span> 可以构造 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>ln</mi><mo>⁡</mo><mo stretchy="false">(</mo><mn>1</mn><mo>+</mo><mi>x</mi><mo stretchy="false">)</mo><mo>∼</mo><mi>x</mi></mrow><annotation encoding="application/x-tex">\ln(1 + x) \sim x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mop">ln</span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathdefault">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">∼</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mord mathdefault">x</span></span></span></span>，则有：</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mi>ln</mi><mo>⁡</mo><mfrac><mn>1</mn><mrow><mn>1</mn><mo>−</mo><mi>t</mi></mrow></mfrac></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>ln</mi><mo>⁡</mo><mfrac><mrow><mn>1</mn><mo>−</mo><mi>t</mi><mo>+</mo><mi>t</mi></mrow><mrow><mn>1</mn><mo>−</mo><mi>t</mi></mrow></mfrac></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>ln</mi><mo>⁡</mo><mn>1</mn><mo>+</mo><mfrac><mi>t</mi><mrow><mn>1</mn><mo>−</mo><mi>t</mi></mrow></mfrac></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned} &amp; \ln\frac{1}{1-t} \\ &amp; = \ln\frac{1-t+t}{1-t} \\ &amp; = \ln 1 + \frac{t}{1-t} \end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:7.14295em;vertical-align:-3.3214750000000004em"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.8214749999999995em"><span style="top:-5.8214749999999995em"><span class="pstrut" style="height:3.32144em"></span><span class="mord"></span></span><span style="top:-3.4307049999999997em"><span class="pstrut" style="height:3.32144em"></span><span class="mord"></span></span><span style="top:-1.0692949999999997em"><span class="pstrut" style="height:3.32144em"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.3214750000000004em"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.8214749999999995em"><span style="top:-5.8214749999999995em"><span class="pstrut" style="height:3.32144em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mop">ln</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mord mathdefault">t</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.7693300000000001em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-3.4307049999999997em"><span class="pstrut" style="height:3.32144em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mop">ln</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mord mathdefault">t</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mord mathdefault">t</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mord mathdefault">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.7693300000000001em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-1.0692949999999997em"><span class="pstrut" style="height:3.32144em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mop">ln</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord">1</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.29208em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mord mathdefault">t</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathdefault">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.7693300000000001em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.3214750000000004em"><span></span></span></span></span></span></span></span></span></span></span></span></p><p>则 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">(</mo><mo>⋆</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(\star)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mopen">(</span><span class="mord">⋆</span><span class="mclose">)</span></span></span></span>式则有</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><munder><mo><mi>lim</mi><mo>⁡</mo></mo><mrow><mi>t</mi><mo>→</mo><mn>0</mn></mrow></munder><mfrac><mfrac><mi>t</mi><mrow><mn>1</mn><mo>−</mo><mi>t</mi></mrow></mfrac><mi>t</mi></mfrac></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><munder><mo><mi>lim</mi><mo>⁡</mo></mo><mrow><mi>t</mi><mo>→</mo><mn>0</mn></mrow></munder><mfrac><mn>1</mn><mrow><mn>1</mn><mo>−</mo><mi>t</mi></mrow></mfrac></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mn>1</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mo>∴</mo><mi>l</mi><mi>o</mi><mi>a</mi><mi>d</mi><mi>F</mi><mi>a</mi><mi>c</mi><mi>t</mi><mi>o</mi><mi>r</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><munder><mo><mi>lim</mi><mo>⁡</mo></mo><mrow><mi>s</mi><mo>→</mo><mi mathvariant="normal">∞</mi></mrow></munder><mfrac><mrow><mi>ln</mi><mo>⁡</mo><mn>2</mn></mrow><mrow><mi>s</mi><mi>ln</mi><mo>⁡</mo><mfrac><mi>s</mi><mrow><mi>s</mi><mo>−</mo><mn>1</mn></mrow></mfrac></mrow></mfrac></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><munder><mo><mi>lim</mi><mo>⁡</mo></mo><mrow><mi>s</mi><mo>→</mo><mi mathvariant="normal">∞</mi></mrow></munder><mfrac><mrow><mi>ln</mi><mo>⁡</mo><mn>2</mn></mrow><mn>1</mn></mfrac></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>ln</mi><mo>⁡</mo><mn>2</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>∼</mo><mn>0.693</mn></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned} &amp; \lim_{t \to 0} \frac{\frac{t}{1-t}}{t} \\ &amp; = \lim_{t \to 0} \frac{1}{1-t} \\ &amp; = 1 \\ \\ \therefore loadFactor &amp; = \lim_{s \to \infty}\frac{\ln2}{s\ln\frac{s}{s-1}} \\ &amp; = \lim_{s \to \infty} \frac{\ln2}{1} \\ &amp; = \ln2 \\ &amp; \sim 0.693 \end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:16.157975999999998em;vertical-align:-7.828988000000001em"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:8.328987999999999em"><span style="top:-10.328987999999999em"><span class="pstrut" style="height:3.617887em"></span><span class="mord"></span></span><span style="top:-7.990439999999999em"><span class="pstrut" style="height:3.617887em"></span><span class="mord"></span></span><span style="top:-6.081109999999999em"><span class="pstrut" style="height:3.617887em"></span><span class="mord"></span></span><span style="top:-4.581109999999999em"><span class="pstrut" style="height:3.617887em"></span><span class="mord"></span></span><span style="top:-2.549669999999999em"><span class="pstrut" style="height:3.617887em"></span><span class="mord"><span class="mrel amsrm">∴</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mord mathdefault" style="margin-right:.01968em">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">a</span><span class="mord mathdefault">d</span><span class="mord mathdefault" style="margin-right:.13889em">F</span><span class="mord mathdefault">a</span><span class="mord mathdefault">c</span><span class="mord mathdefault">t</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:.02778em">r</span></span></span><span style="top:.21110100000000065em"><span class="pstrut" style="height:3.617887em"></span><span class="mord"></span></span><span style="top:2.0511010000000005em"><span class="pstrut" style="height:3.617887em"></span><span class="mord"></span></span><span style="top:3.551101000000001em"><span class="pstrut" style="height:3.617887em"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:7.828988000000001em"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:8.328987999999999em"><span style="top:-10.328987999999999em"><span class="pstrut" style="height:3.617887em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.69444em"><span style="top:-2.082892em;margin-left:0"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mrel mtight">→</span><span class="mord mtight">0</span></span></span></span><span style="top:-2.7em"><span class="pstrut" style="height:2.7em"></span><span><span class="mop">lim</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.717108em"><span></span></span></span></span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.617887em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathdefault">t</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.7933310000000002em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.824556em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mbin mtight">−</span><span class="mord mathdefault mtight">t</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.403331em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-7.990439999999999em"><span class="pstrut" style="height:3.617887em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.69444em"><span style="top:-2.082892em;margin-left:0"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span><span class="mrel mtight">→</span><span class="mord mtight">0</span></span></span></span><span style="top:-2.7em"><span class="pstrut" style="height:2.7em"></span><span><span class="mop">lim</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.717108em"><span></span></span></span></span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mord mathdefault">t</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.7693300000000001em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-6.081109999999999em"><span class="pstrut" style="height:3.617887em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mord">1</span></span></span><span style="top:-2.549669999999999em"><span class="pstrut" style="height:3.617887em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.69444em"><span style="top:-2.1em;margin-left:0"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="mrel mtight">→</span><span class="mord mtight">∞</span></span></span></span><span style="top:-2.7em"><span class="pstrut" style="height:2.7em"></span><span><span class="mop">lim</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.7em"><span></span></span></span></span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.37144em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mop">ln</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.695392em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.403331em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mop">ln</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.089331em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:.21110100000000065em"><span class="pstrut" style="height:3.617887em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.69444em"><span style="top:-2.1em;margin-left:0"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="mrel mtight">→</span><span class="mord mtight">∞</span></span></span></span><span style="top:-2.7em"><span class="pstrut" style="height:2.7em"></span><span><span class="mop">lim</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.7em"><span></span></span></span></span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.37144em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mop">ln</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:2.0511010000000005em"><span class="pstrut" style="height:3.617887em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mop">ln</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord">2</span></span></span><span style="top:3.551101000000001em"><span class="pstrut" style="height:3.617887em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">∼</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">6</span><span class="mord">9</span><span class="mord">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:7.828988000000001em"><span></span></span></span></span></span></span></span></span></span></span></span></p><h2 id="7-为什么是-075"><a class="markdownIt-Anchor" href="#7-为什么是-075"></a> 7. 为什么是 0.75</h2><p>从上面的计算来看，<code>loadFactor</code> 取 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>ln</mi><mo>⁡</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">\ln2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.69444em;vertical-align:0"></span><span class="mop">ln</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord">2</span></span></span></span> 时，能够让 HashMap 尽可能不满</p><p>但是在实际中，HashMap 碰撞与否，其实是与 <code>hashCode()</code> 的设计有很大关系，因此 JDK 设计者在平衡空间利用和性能方面给了一个更高的经验数字。</p><h2 id="8-总结"><a class="markdownIt-Anchor" href="#8-总结"></a> 8. 总结</h2><p>当然，这只是一家之言，你也可以从其他方面解释 0.75 这个值如何如何；</p><p>其实这种刨根问底的问题，终究希望考察你的 <strong>能力</strong> 而不是 <strong>记忆</strong>，只要你能给出自己的解释，而不是被问住，呆若木鸡，就能通过面试。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;之前看各大面经的时候搜索到了这个问题，切实感觉到如果刨根问底的问，自己还真不能抵挡住这种攻势，现在闲暇时间又心血来潮地想起来这个问题，就打算好好弄懂弄透，也希望能在将来面试的时候做好准备。&lt;/p&gt;&lt;p&gt;本文基于&lt;a href=&quot;https://stackoverflow.com/a/31401836&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;这个 StackOverflow 回答&lt;/a&gt;进一步推导，并给出详细解答步骤&lt;/p&gt;
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>Android 面经总结 2019 春招</title>
    <link href="https://wafer.li//Android/android-%E9%9D%A2%E7%BB%8F%E6%80%BB%E7%BB%93-2019-%E6%98%A5%E6%8B%9B/"/>
    <id>https://wafer.li//Android/android-面经总结-2019-春招/</id>
    <published>2019-07-11T03:21:00.000Z</published>
    <updated>2019-07-23T08:21:38.000Z</updated>
    
    <content type="html"><![CDATA[<p>折腾了好一段时间，也算是找到了工作了，做个面经总结来告慰一下我的学生生涯</p><a id="more"></a><h2 id="1-ihandy"><a class="markdownIt-Anchor" href="#1-ihandy"></a> 1. iHandy</h2><p>为什么 Android 要设计 Intent Service？直接使用线程不就行了？</p><blockquote><p>考点：Intent Service 和线程的区别<br>答：Thread 依赖于 Activity 存在，在 Activity finish 的时候 Thread 必须终止，否则会造成内存泄漏<br>Intent Service 不依赖于 Activity 存在，当 Activity 关闭之后，它依旧会继续进行，直到任务完成或者系统强制将其回收</p></blockquote><p>按下 App 强制停止，发生了什么？</p><blockquote><p>调用了 forceStopPackage()</p></blockquote><p>跨进程单例实现</p><blockquote><p>使用 AIDL 接口实现一个单例，然后制定一个进程存储（实现）这个单例，其他进程连接这个 Service 获取其 Binder</p></blockquote><h2 id="2-头条"><a class="markdownIt-Anchor" href="#2-头条"></a> 2. 头条</h2><p><span class="exturl" data-url="aHR0cHM6Ly9sZWV0Y29kZS5jb20vcHJvYmxlbXMvc29ydC1jb2xvcnMv" title="https://leetcode.com/problems/sort-colors/">荷兰国旗问题<i class="fa fa-external-link"></i></span></p><p>只遍历一次的算法</p><p><img alt="荷兰国旗算法示意图" data-src="../../images/android-%E9%9D%A2%E7%BB%8F%E6%80%BB%E7%BB%93/%E8%8D%B7%E5%85%B0%E5%9B%BD%E6%97%97%E7%AE%97%E6%B3%95%E7%A4%BA%E6%84%8F%E5%9B%BE.png"></p><p><code>curr</code> 从前往后遍历：</p><ol><li>如果遍历到白球，<code>curr++</code></li><li>如果遍历到红球，则与 <code>red</code> 交换，然后 <code>red++</code>，<code>curr++</code></li><li>如果遍历到黑球，则与 <code>black</code> 交换，<code>black--</code>，<strong><code>curr</code> 不动</strong></li></ol><p><code>curr</code> 表示 <strong>前面已经排好了</strong>，和后面交换并不保证前面已经排好</p><p>HTTPS 通信流程</p><blockquote><p>HTTPS 全称是：HTTP over TLS</p></blockquote><img data-src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U2NyaXB0VHlwZT0iYXBwbGljYXRpb24vZWNtYXNjcmlwdCIgY29udGVudFN0eWxlVHlwZT0idGV4dC9jc3MiIGhlaWdodD0iNDU0cHgiIHByZXNlcnZlQXNwZWN0UmF0aW89Im5vbmUiIHN0eWxlPSJ3aWR0aDo3NDlweDtoZWlnaHQ6NDU0cHg7IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCA3NDkgNDU0IiB3aWR0aD0iNzQ5cHgiIHpvb21BbmRQYW49Im1hZ25pZnkiPjxkZWZzPjxmaWx0ZXIgaGVpZ2h0PSIzMDAlIiBpZD0iZjFjNnU4OHRqbGY4MWsiIHdpZHRoPSIzMDAlIiB4PSItMSIgeT0iLTEiPjxmZUdhdXNzaWFuQmx1ciByZXN1bHQ9ImJsdXJPdXQiIHN0ZERldmlhdGlvbj0iMi4wIi8+PGZlQ29sb3JNYXRyaXggaW49ImJsdXJPdXQiIHJlc3VsdD0iYmx1ck91dDIiIHR5cGU9Im1hdHJpeCIgdmFsdWVzPSIwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAwIDAgMCAuNCAwIi8+PGZlT2Zmc2V0IGR4PSI0LjAiIGR5PSI0LjAiIGluPSJibHVyT3V0MiIgcmVzdWx0PSJibHVyT3V0MyIvPjxmZUJsZW5kIGluPSJTb3VyY2VHcmFwaGljIiBpbjI9ImJsdXJPdXQzIiBtb2RlPSJub3JtYWwiLz48L2ZpbHRlcj48L2RlZnM+PGc+PGxpbmUgc3R5bGU9InN0cm9rZTogI0E4MDAzNjsgc3Ryb2tlLXdpZHRoOiAxLjA7IHN0cm9rZS1kYXNoYXJyYXk6IDUuMCw1LjA7IiB4MT0iMzgiIHgyPSIzOCIgeTE9IjM4LjI5NjkiIHkyPSI0MTQuNjI1Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTogI0E4MDAzNjsgc3Ryb2tlLXdpZHRoOiAxLjA7IHN0cm9rZS1kYXNoYXJyYXk6IDUuMCw1LjA7IiB4MT0iNDEwIiB4Mj0iNDEwIiB5MT0iMzguMjk2OSIgeTI9IjQxNC42MjUiLz48cmVjdCBmaWxsPSIjRkVGRUNFIiBmaWx0ZXI9InVybCgjZjFjNnU4OHRqbGY4MWspIiBoZWlnaHQ9IjMwLjI5NjkiIHN0eWxlPSJzdHJva2U6ICNBODAwMzY7IHN0cm9rZS13aWR0aDogMS41OyIgd2lkdGg9IjU2IiB4PSI4IiB5PSIzIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZ0FuZEdseXBocyIgdGV4dExlbmd0aD0iNDIiIHg9IjE1IiB5PSIyMi45OTUxIj7lrqLmiLfnq688L3RleHQ+PHJlY3QgZmlsbD0iI0ZFRkVDRSIgZmlsdGVyPSJ1cmwoI2YxYzZ1ODh0amxmODFrKSIgaGVpZ2h0PSIzMC4yOTY5IiBzdHlsZT0ic3Ryb2tlOiAjQTgwMDM2OyBzdHJva2Utd2lkdGg6IDEuNTsiIHdpZHRoPSI1NiIgeD0iOCIgeT0iNDEzLjYyNSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmdBbmRHbHlwaHMiIHRleHRMZW5ndGg9IjQyIiB4PSIxNSIgeT0iNDMzLjYyMDEiPuWuouaIt+errzwvdGV4dD48cmVjdCBmaWxsPSIjRkVGRUNFIiBmaWx0ZXI9InVybCgjZjFjNnU4OHRqbGY4MWspIiBoZWlnaHQ9IjMwLjI5NjkiIHN0eWxlPSJzdHJva2U6ICNBODAwMzY7IHN0cm9rZS13aWR0aDogMS41OyIgd2lkdGg9IjU2IiB4PSIzODAiIHk9IjMiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nQW5kR2x5cGhzIiB0ZXh0TGVuZ3RoPSI0MiIgeD0iMzg3IiB5PSIyMi45OTUxIj7mnI3liqHnq688L3RleHQ+PHJlY3QgZmlsbD0iI0ZFRkVDRSIgZmlsdGVyPSJ1cmwoI2YxYzZ1ODh0amxmODFrKSIgaGVpZ2h0PSIzMC4yOTY5IiBzdHlsZT0ic3Ryb2tlOiAjQTgwMDM2OyBzdHJva2Utd2lkdGg6IDEuNTsiIHdpZHRoPSI1NiIgeD0iMzgwIiB5PSI0MTMuNjI1Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZ0FuZEdseXBocyIgdGV4dExlbmd0aD0iNDIiIHg9IjM4NyIgeT0iNDMzLjYyMDEiPuacjeWKoeerrzwvdGV4dD48cG9seWdvbiBmaWxsPSIjQTgwMDM2IiBwb2ludHM9IjM5OCw2NS40Mjk3LDQwOCw2OS40Mjk3LDM5OCw3My40Mjk3LDQwMiw2OS40Mjk3IiBzdHlsZT0ic3Ryb2tlOiAjQTgwMDM2OyBzdHJva2Utd2lkdGg6IDEuMDsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiAjQTgwMDM2OyBzdHJva2Utd2lkdGg6IDEuMDsiIHgxPSIzOCIgeDI9IjQwNCIgeTE9IjY5LjQyOTciIHkyPSI2OS40Mjk3Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZ0FuZEdseXBocyIgdGV4dExlbmd0aD0iMzM1IiB4PSI0NSIgeT0iNjQuMzYzOCI+5Y+R6LW36K+35rGC77yM5YyF5ous5Y2P6K6u54mI5pys77yM5pSv5oyB566X5rOV5ZKM6ZqP5py65Ye95pWwIHJhbmRvbTE8L3RleHQ+PHBvbHlnb24gZmlsbD0iI0E4MDAzNiIgcG9pbnRzPSI0OSw5NC41NjI1LDM5LDk4LjU2MjUsNDksMTAyLjU2MjUsNDUsOTguNTYyNSIgc3R5bGU9InN0cm9rZTogI0E4MDAzNjsgc3Ryb2tlLXdpZHRoOiAxLjA7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTogI0E4MDAzNjsgc3Ryb2tlLXdpZHRoOiAxLjA7IiB4MT0iNDMiIHgyPSI0MDkiIHkxPSI5OC41NjI1IiB5Mj0iOTguNTYyNSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmdBbmRHbHlwaHMiIHRleHRMZW5ndGg9IjIzNSIgeD0iNTUiIHk9IjkzLjQ5NjYiPuehruiupOeJiOacrO+8jOmaj+acuuaVsCByYW5kb20yIOWSjOaUr+aMgeeul+azlTwvdGV4dD48cG9seWdvbiBmaWxsPSIjQTgwMDM2IiBwb2ludHM9IjQ5LDEyMy42OTUzLDM5LDEyNy42OTUzLDQ5LDEzMS42OTUzLDQ1LDEyNy42OTUzIiBzdHlsZT0ic3Ryb2tlOiAjQTgwMDM2OyBzdHJva2Utd2lkdGg6IDEuMDsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiAjQTgwMDM2OyBzdHJva2Utd2lkdGg6IDEuMDsiIHgxPSI0MyIgeDI9IjQwOSIgeTE9IjEyNy42OTUzIiB5Mj0iMTI3LjY5NTMiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nQW5kR2x5cGhzIiB0ZXh0TGVuZ3RoPSIxMTciIHg9IjU1IiB5PSIxMjIuNjI5NCI+5Y+R6YCB5pyN5Yqh5Zmo5YWs6ZKl6K+B5LmmPC90ZXh0PjxsaW5lIHN0eWxlPSJzdHJva2U6ICNBODAwMzY7IHN0cm9rZS13aWR0aDogMS4wOyIgeDE9IjM4IiB4Mj0iODAiIHkxPSIxNTYuODI4MSIgeTI9IjE1Ni44MjgxIi8+PGxpbmUgc3R5bGU9InN0cm9rZTogI0E4MDAzNjsgc3Ryb2tlLXdpZHRoOiAxLjA7IiB4MT0iODAiIHgyPSI4MCIgeTE9IjE1Ni44MjgxIiB5Mj0iMTY5LjgyODEiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiAjQTgwMDM2OyBzdHJva2Utd2lkdGg6IDEuMDsiIHgxPSIzOSIgeDI9IjgwIiB5MT0iMTY5LjgyODEiIHkyPSIxNjkuODI4MSIvPjxwb2x5Z29uIGZpbGw9IiNBODAwMzYiIHBvaW50cz0iNDksMTY1LjgyODEsMzksMTY5LjgyODEsNDksMTczLjgyODEsNDUsMTY5LjgyODEiIHN0eWxlPSJzdHJva2U6ICNBODAwMzY7IHN0cm9rZS13aWR0aDogMS4wOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmdBbmRHbHlwaHMiIHRleHRMZW5ndGg9Ijc4IiB4PSI0NSIgeT0iMTUxLjc2MjIiPumqjOivgeivgeS5puetvuWQjTwvdGV4dD48bGluZSBzdHlsZT0ic3Ryb2tlOiAjQTgwMDM2OyBzdHJva2Utd2lkdGg6IDEuMDsiIHgxPSIzOCIgeDI9IjgwIiB5MT0iMTk4Ljk2MDkiIHkyPSIxOTguOTYwOSIvPjxsaW5lIHN0eWxlPSJzdHJva2U6ICNBODAwMzY7IHN0cm9rZS13aWR0aDogMS4wOyIgeDE9IjgwIiB4Mj0iODAiIHkxPSIxOTguOTYwOSIgeTI9IjIxMS45NjA5Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTogI0E4MDAzNjsgc3Ryb2tlLXdpZHRoOiAxLjA7IiB4MT0iMzkiIHgyPSI4MCIgeTE9IjIxMS45NjA5IiB5Mj0iMjExLjk2MDkiLz48cG9seWdvbiBmaWxsPSIjQTgwMDM2IiBwb2ludHM9IjQ5LDIwNy45NjA5LDM5LDIxMS45NjA5LDQ5LDIxNS45NjA5LDQ1LDIxMS45NjA5IiBzdHlsZT0ic3Ryb2tlOiAjQTgwMDM2OyBzdHJva2Utd2lkdGg6IDEuMDsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nQW5kR2x5cGhzIiB0ZXh0TGVuZ3RoPSIzNTgiIHg9IjQ1IiB5PSIxOTMuODk1Ij7nlJ/miJDpmo/mnLrmlbAgcmFuZG9tMyDlubbpgJrov4fmnI3liqHlmajlhazpkqXliqDlr4bnlJ/miJAgcHJlbWFzdGVyPC90ZXh0Pjxwb2x5Z29uIGZpbGw9IiNBODAwMzYiIHBvaW50cz0iMzk4LDIzNy4wOTM4LDQwOCwyNDEuMDkzOCwzOTgsMjQ1LjA5MzgsNDAyLDI0MS4wOTM4IiBzdHlsZT0ic3Ryb2tlOiAjQTgwMDM2OyBzdHJva2Utd2lkdGg6IDEuMDsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiAjQTgwMDM2OyBzdHJva2Utd2lkdGg6IDEuMDsiIHgxPSIzOCIgeDI9IjQwNCIgeTE9IjI0MS4wOTM4IiB5Mj0iMjQxLjA5MzgiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nQW5kR2x5cGhzIiB0ZXh0TGVuZ3RoPSIxMjMiIHg9IjQ1IiB5PSIyMzYuMDI3OCI+5Yqg5a+G5ZCO55qEIHByZW1hc3RlcjwvdGV4dD48bGluZSBzdHlsZT0ic3Ryb2tlOiAjQTgwMDM2OyBzdHJva2Utd2lkdGg6IDEuMDsiIHgxPSI0MTAiIHgyPSI0NTIiIHkxPSIyNzAuMjI2NiIgeTI9IjI3MC4yMjY2Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTogI0E4MDAzNjsgc3Ryb2tlLXdpZHRoOiAxLjA7IiB4MT0iNDUyIiB4Mj0iNDUyIiB5MT0iMjcwLjIyNjYiIHkyPSIyODMuMjI2NiIvPjxsaW5lIHN0eWxlPSJzdHJva2U6ICNBODAwMzY7IHN0cm9rZS13aWR0aDogMS4wOyIgeDE9IjQxMSIgeDI9IjQ1MiIgeTE9IjI4My4yMjY2IiB5Mj0iMjgzLjIyNjYiLz48cG9seWdvbiBmaWxsPSIjQTgwMDM2IiBwb2ludHM9IjQyMSwyNzkuMjI2Niw0MTEsMjgzLjIyNjYsNDIxLDI4Ny4yMjY2LDQxNywyODMuMjI2NiIgc3R5bGU9InN0cm9rZTogI0E4MDAzNjsgc3Ryb2tlLXdpZHRoOiAxLjA7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZ0FuZEdseXBocyIgdGV4dExlbmd0aD0iMjM3IiB4PSI0MTciIHk9IjI2NS4xNjA2Ij7nlKjnp4HpkqXop6Plr4YgcHJlbWFzdGVy77yM6I635Y+WIHJhbmRvbTM8L3RleHQ+PGxpbmUgc3R5bGU9InN0cm9rZTogI0E4MDAzNjsgc3Ryb2tlLXdpZHRoOiAxLjA7IiB4MT0iMzgiIHgyPSI4MCIgeTE9IjMxMi4zNTk0IiB5Mj0iMzEyLjM1OTQiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiAjQTgwMDM2OyBzdHJva2Utd2lkdGg6IDEuMDsiIHgxPSI4MCIgeDI9IjgwIiB5MT0iMzEyLjM1OTQiIHkyPSIzMjUuMzU5NCIvPjxsaW5lIHN0eWxlPSJzdHJva2U6ICNBODAwMzY7IHN0cm9rZS13aWR0aDogMS4wOyIgeDE9IjM5IiB4Mj0iODAiIHkxPSIzMjUuMzU5NCIgeTI9IjMyNS4zNTk0Ii8+PHBvbHlnb24gZmlsbD0iI0E4MDAzNiIgcG9pbnRzPSI0OSwzMjEuMzU5NCwzOSwzMjUuMzU5NCw0OSwzMjkuMzU5NCw0NSwzMjUuMzU5NCIgc3R5bGU9InN0cm9rZTogI0E4MDAzNjsgc3Ryb2tlLXdpZHRoOiAxLjA7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZ0FuZEdseXBocyIgdGV4dExlbmd0aD0iMzIwIiB4PSI0NSIgeT0iMzA3LjI5MzUiPuS9v+eUqCByYW5kb20xIHJhbmRvbTIgcmFuZG9tMyDnlJ/miJDlr7nnp7DliqDlr4bnp5jpkqU8L3RleHQ+PGxpbmUgc3R5bGU9InN0cm9rZTogI0E4MDAzNjsgc3Ryb2tlLXdpZHRoOiAxLjA7IiB4MT0iNDEwIiB4Mj0iNDUyIiB5MT0iMzU0LjQ5MjIiIHkyPSIzNTQuNDkyMiIvPjxsaW5lIHN0eWxlPSJzdHJva2U6ICNBODAwMzY7IHN0cm9rZS13aWR0aDogMS4wOyIgeDE9IjQ1MiIgeDI9IjQ1MiIgeTE9IjM1NC40OTIyIiB5Mj0iMzY3LjQ5MjIiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiAjQTgwMDM2OyBzdHJva2Utd2lkdGg6IDEuMDsiIHgxPSI0MTEiIHgyPSI0NTIiIHkxPSIzNjcuNDkyMiIgeTI9IjM2Ny40OTIyIi8+PHBvbHlnb24gZmlsbD0iI0E4MDAzNiIgcG9pbnRzPSI0MjEsMzYzLjQ5MjIsNDExLDM2Ny40OTIyLDQyMSwzNzEuNDkyMiw0MTcsMzY3LjQ5MjIiIHN0eWxlPSJzdHJva2U6ICNBODAwMzY7IHN0cm9rZS13aWR0aDogMS4wOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmdBbmRHbHlwaHMiIHRleHRMZW5ndGg9IjMyMCIgeD0iNDE3IiB5PSIzNDkuNDI2MyI+5L2/55SoIHJhbmRvbTEgcmFuZG9tMiByYW5kb20zIOeUn+aIkOWvueensOWKoOWvhuenmOmSpTwvdGV4dD48cG9seWdvbiBmaWxsPSIjQTgwMDM2IiBwb2ludHM9IjM5OCwzOTIuNjI1LDQwOCwzOTYuNjI1LDM5OCw0MDAuNjI1LDQwMiwzOTYuNjI1IiBzdHlsZT0ic3Ryb2tlOiAjQTgwMDM2OyBzdHJva2Utd2lkdGg6IDEuMDsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiAjQTgwMDM2OyBzdHJva2Utd2lkdGg6IDEuMDsiIHgxPSIzOCIgeDI9IjQwNCIgeTE9IjM5Ni42MjUiIHkyPSIzOTYuNjI1Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZ0FuZEdseXBocyIgdGV4dExlbmd0aD0iMTgyIiB4PSI0NSIgeT0iMzkxLjU1OTEiPuS9v+eUqOWvueensOWKoOWvhuenmOmSpei/m+ihjOWKoOWvhumAmuS/oTwvdGV4dD48IS0tTUQ1PVs1YjM5ZDA2YmNhMjIyYzQ4YzVmOGQ3NzNiOTY2NzBjMl0KQHN0YXJ0dW1sDQrlrqLmiLfnq68tPuacjeWKoeerrzog5Y+R6LW36K+35rGC77yM5YyF5ous5Y2P6K6u54mI5pys77yM5pSv5oyB566X5rOV5ZKM6ZqP5py65Ye95pWwIHJhbmRvbTENCuacjeWKoeerry0+5a6i5oi356uvOiDnoa7orqTniYjmnKzvvIzpmo/mnLrmlbAgcmFuZG9tMiDlkozmlK/mjIHnrpfms5UNCuacjeWKoeerry0+5a6i5oi356uvOiDlj5HpgIHmnI3liqHlmajlhazpkqXor4HkuaYNCuWuouaIt+erry0+5a6i5oi356uvOiDpqozor4Hor4Hkuabnrb7lkI0NCuWuouaIt+erry0+5a6i5oi356uvOiDnlJ/miJDpmo/mnLrmlbAgcmFuZG9tMyDlubbpgJrov4fmnI3liqHlmajlhazpkqXliqDlr4bnlJ/miJAgcHJlbWFzdGVyDQrlrqLmiLfnq68tPuacjeWKoeerrzog5Yqg5a+G5ZCO55qEIHByZW1hc3Rlcg0K5pyN5Yqh56uvLT7mnI3liqHnq686IOeUqOengemSpeino+WvhiBwcmVtYXN0ZXLvvIzojrflj5YgcmFuZG9tMw0K5a6i5oi356uvLT7lrqLmiLfnq686IOS9v+eUqCByYW5kb20xIHJhbmRvbTIgcmFuZG9tMyDnlJ/miJDlr7nnp7DliqDlr4bnp5jpkqUNCuacjeWKoeerry0+5pyN5Yqh56uvOiDkvb/nlKggcmFuZG9tMSByYW5kb20yIHJhbmRvbTMg55Sf5oiQ5a+556ew5Yqg5a+G56eY6ZKlDQrlrqLmiLfnq68tPuacjeWKoeerrzog5L2/55So5a+556ew5Yqg5a+G56eY6ZKl6L+b6KGM5Yqg5a+G6YCa5L+hDQpAZW5kdW1sDQoKUGxhbnRVTUwgdmVyc2lvbiAxLjIwMTkuMTIoU3VuIE5vdiAwMyAxMDoyNDo1NCBVVEMgMjAxOSkKKEdQTCBzb3VyY2UgZGlzdHJpYnV0aW9uKQpKYXZhIFJ1bnRpbWU6IEphdmEoVE0pIFNFIFJ1bnRpbWUgRW52aXJvbm1lbnQKSlZNOiBKYXZhIEhvdFNwb3QoVE0pIDY0LUJpdCBTZXJ2ZXIgVk0KSmF2YSBWZXJzaW9uOiAxLjcuMF8yNS1iMTUKT3BlcmF0aW5nIFN5c3RlbTogTGludXgKRGVmYXVsdCBFbmNvZGluZzogVVRGLTgKTGFuZ3VhZ2U6IGVuCkNvdW50cnk6IFVTCi0tPjwvZz48L3N2Zz4="><p>HTTPS 的验证过程如何防止中间人攻击？中间人偷换公钥怎么办？</p><blockquote><p>搞清楚几个问题：</p><ol><li>服务器 SSL 证书是怎么来的？<br>-&gt; 是从 CA 申请的，CA 向服务器下发公私钥对，并在证书中使用 CA 私钥对服务器公钥进行签名</li><li>客户端是如何验证的？<br>-&gt; 客户端拿到服务器公钥之后，使用 CA 公钥对签名部分进行解密，然后对比解密后的公钥是不是同一个（即签名校验）<br>所以，防止中间人攻击是经过 CA 来实现的<br>如果发现证书签名不一致，则说明遭受到了中间人攻击，那么就中断连接<br>重点：HTTPS 防止中间人是依靠 CA 实现的，因此，并不是一定可以防止中间人攻击，如果客户系统导入了奇怪的证书，就可能会遭受到中间人攻击</li></ol></blockquote><h2 id="3-珍爱网"><a class="markdownIt-Anchor" href="#3-珍爱网"></a> 3. 珍爱网</h2><p><code>HashMap</code> 与 <code>ArrayList</code> 如何扩容</p><blockquote><p>ArrayList<br>插入前先确保容量，如果不足就扩容，数组增长到 1.5 倍<br><strong>不会自动缩小</strong></p><p>HashMap</p><ol><li>初始大小 16，扩容因子 <code>loadFactor</code> 0.75</li><li>当 <code>size &gt; capacity * loadFactor</code> 时，就扩容 2 倍</li><li>数组扩容完毕之后进行 <code>rehash()</code></li><li>HashMap 的 hash 方法为 <code>hashCode &amp; (sizeOfArray - 1)</code></li><li><a href="https://wafer.li/Interview/hashmap-%E7%9A%84-loadfactor-%E4%B8%BA%E4%BB%80%E4%B9%88%E6%98%AF-0-75">为什么是 0.75</a></li></ol></blockquote><p><code>HashMap</code> 的键值对是否可以为 <code>null</code></p><blockquote><p><code>HashMap</code> 可以为 <code>null</code>(Key, Value 都可以)<br><code>HashTable</code> 不行</p></blockquote><p><code>HashMap</code> 与 <code>Set</code> 的 <code>put</code> 有什么区别</p><blockquote><p><code>HashMap</code> 的 <code>put</code> 当存在相同 Key 的时候会改变原值<br><code>Set</code> 的 <code>put</code> 不会</p></blockquote><p>GC 过程</p><ol><li>对象是否已死(GCRoot可达性)</li><li>四大引用(强 -&gt; 软 -&gt; 弱 -&gt; 虚逐步递减)<blockquote><p>强：最为普通的引用，如果对象不死，就不会被回收<br>软：稍弱一些的引用，如果即将 OutOfMemoryError 就会对其进行回收<br>弱：常用的防止内存泄漏的引用类型，只要进行垃圾回收就马上被回收<br>虚：最弱的引用，无法取到目标对象，用于跟踪对象垃圾回收的状态，通过查看引用队列是否有虚引用判断其是否即将被回收</p></blockquote></li><li>是否有必要<blockquote><p>GCRoot 不可达 -&gt; 第一次标记进入 F-Queue -&gt; F-Queue 第二次标记 -&gt; 回收</p></blockquote></li><li>回收方法区(废弃常量、无用静态类)</li><li>类没有实例</li><li>ClassLoader 也被回收</li><li>Class 对象没有被引用</li><li>回收算法</li><li>标记-清除算法(会产生内存碎片)</li><li>复制-清除算法(初生代常用，from 和 to Survivor 区域)</li><li>标记-移动算法(老生代常用，标记回收对象，回收之后移动剩余对象)</li></ol><p><code>wait()</code> 和 <code>sleep()</code> 的区别</p><ol><li><code>wait()</code> 位于 <code>Object</code>，<code>sleep()</code> 位于 <code>Thread</code></li><li><code>wait()</code> 只能用于同步块， <code>sleep()</code> 什么地方都使用</li><li><code>wait()</code> 会释放锁，<code>sleep()</code> 不会释放锁</li></ol><p>线程开启有哪几种方式</p><ol><li>继承 <code>Thread</code>，重写 <code>run()</code></li><li>实现 <code>Runnable</code>，调用 <code>Thread.start()</code></li><li>实现 <code>Callable</code>，使用 <code>FutureTask</code> 包装并传入 <code>Thread</code></li><li><code>FutureTask</code> 获取返回值实现原理 (<code>get()</code>)<blockquote><p>如果完成了，就返回，如果未完成，就阻塞主线程，等待结果</p></blockquote></li></ol><p>如何保证线程执行顺序</p><ol><li><code>thread.join()</code> 当前线程等待 <code>thread</code> 的终止</li><li>使用锁</li><li>使用 <code>Condition</code></li><li>CAS 操作</li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;折腾了好一段时间，也算是找到了工作了，做个面经总结来告慰一下我的学生生涯&lt;/p&gt;
    
    </summary>
    
    
      <category term="Android" scheme="https://wafer.li/categories/Android/"/>
    
    
      <category term="Android" scheme="https://wafer.li/tags/Android/"/>
    
      <category term="面试经验" scheme="https://wafer.li/tags/%E9%9D%A2%E8%AF%95%E7%BB%8F%E9%AA%8C/"/>
    
  </entry>
  
  <entry>
    <title>AndroidX 测试坑点详解（二）—— VectorDrawable 和 tint 问题解析</title>
    <link href="https://wafer.li//Android/android-%E6%B5%8B%E8%AF%95%E5%9D%91%E7%82%B9%E8%AF%A6%E8%A7%A3%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E2%80%94-vectordrawable-%E5%92%8C-tint-%E9%97%AE%E9%A2%98%E8%A7%A3%E6%9E%90/"/>
    <id>https://wafer.li//Android/android-测试坑点详解（二）——-vectordrawable-和-tint-问题解析/</id>
    <published>2019-06-10T09:56:00.000Z</published>
    <updated>2019-06-14T05:15:15.000Z</updated>
    
    <content type="html"><![CDATA[<p><a href="/Android/android-%E6%B5%8B%E8%AF%95%E5%9D%91%E7%82%B9%E8%AF%A6%E8%A7%A3%EF%BC%88%E4%B8%80%EF%BC%89/">上篇文章</a>我们说到如果你的 VectorDrawable 如果采用一个带 <code>&lt;selector&gt;</code> 的颜色进行着色，那么就需要在测试代码中对 Drawable 进行重新着色，而不是直接比较。</p><p>本篇文章就来着重说说其中的原理。</p><a id="more"></a><h2 id="1-测试-drawable-的主要流程"><a class="markdownIt-Anchor" href="#1-测试-drawable-的主要流程"></a> 1. 测试 Drawable 的主要流程</h2><p>首先，我们来看看整个测试程序经历的流程，自顶向下才能更好的把握是什么地方什么阶段出现了问题。</p><p>运行 Drawable 的测试的过程大体如下：</p><ol><li><code>ImageView</code> 将 Drawable 在界面中展示</li><li><code>TestRunner</code> 从 Context 中获取期望值</li><li>将两者进行比较</li></ol><p>接下来，我们就分步来看具体流程，最后来定位到底是什么地方出现了问题。</p><h2 id="2-imageview-展示-drawable-的流程"><a class="markdownIt-Anchor" href="#2-imageview-展示-drawable-的流程"></a> 2. ImageView 展示 Drawable 的流程</h2><p>在测试中，我们采用 <code>imageView.setImageResource()</code> 的方法来展示 Drawable，由于代码比较长，就不贴出全部代码了，仅仅对流程和某些关键语句和行进行介绍。</p><p>首先，<code>ImageView</code> 会将原先的 Drawable 置为空，然后在 <code>resolveUri()</code> 方法中，会对我们传入的资源 ID 进行解析，然后通过 <code>Context</code> 获取这个 Drawable：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Drawable d = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (mResource != <span class="number">0</span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    d = mContext.getDrawable(mResource);</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p>获取到 Drawable 之后，<code>ImageView</code> 就会调用 <code>updateDrawable()</code> 更新自身的 Drawable：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> void updateDrawable(Drawable d) &#123;</span><br><span class="line">    <span class="keyword">if</span> (d != mRecycleableBitmapDrawable &amp;&amp; mRecycleableBitmapDrawable != <span class="literal">null</span>) &#123;</span><br><span class="line">        mRecycleableBitmapDrawable.setBitmap(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    boolean sameDrawable = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mDrawable != <span class="literal">null</span>) &#123;</span><br><span class="line">       sameDrawable = mDrawable == d;</span><br><span class="line">       mDrawable.setCallback(<span class="literal">null</span>);</span><br><span class="line">       unscheduleDrawable(mDrawable);</span><br><span class="line">       <span class="keyword">if</span> (!sCompatDrawableVisibilityDispatch &amp;&amp; !sameDrawable &amp;&amp; isAttachedToWindow()) &#123;</span><br><span class="line">         mDrawable.setVisible(<span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     mDrawable = d;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (d != <span class="literal">null</span>) &#123;</span><br><span class="line">       d.setCallback(<span class="keyword">this</span>);</span><br><span class="line">       d.setLayoutDirection(getLayoutDirection());</span><br><span class="line">       <span class="keyword">if</span> (d.isStateful()) &#123;</span><br><span class="line">         d.setState(getDrawableState());</span><br><span class="line">       &#125;</span><br><span class="line">       ...</span><br></pre></td></tr></table></figure><p>其中，比较重要的是 <code>d.setState()</code>，正是它根据当前 <code>ImageView</code> 所处的状态（State）来对其 Drawable 进行着色的。</p><p>那么，我们看到，实际上 <code>ImageView</code> 在展示 Drawable 的时候，实际上大体上分成了两个步骤：</p><ol><li>通过 <code>Context</code> 获取 Drawable 实例</li><li>根据 <code>ImageView</code> 所处状态和相应属性对获取得到的 Drawable 做出相应改变</li><li>展示</li></ol><p>所以问题是不是出现在 <code>Context</code> 获取 Drawable 的时候呢？我们来继续看看 Context 获取 Drawable 的过程。</p><h2 id="3-context-获取-drawable-的过程"><a class="markdownIt-Anchor" href="#3-context-获取-drawable-的过程"></a> 3. Context 获取 Drawable 的过程</h2><p>所有的测试，实际上都是拿期望值和实际结果进行比较，而对于 Drawable 来说，期望值实际上就是我们本地存储的 Drawable，而获取这个期望值实际上还是通过 Context 来获取得到的。</p><p>要想深入了解这个问题的成因，我们就要首先看看 Context 获取 Drawable 的过程。</p><p>首先，<code>Context</code> 调用 <code>getDrawable()</code> 最终会调用到 <code>ResourceImpl</code> 的 <code>loadDrawable()</code> 方法，这个方法的流程大致如下：</p><ol><li>查找 Drawable 缓存</li><li>若缓存命中，则直接返回缓存值</li><li>若未命中，则创建 Drawable</li><li>使用传入的 <code>theme</code> 对新创建的 Drawable 进行相关调整（如着色等）</li><li>将 Drawable 写入缓存</li><li>返回</li></ol><p>这个流程本身没什么问题，但是在经过 <code>applyTheme()</code> 方法之后，我们发现此时的 Drawable 出现了变化：</p><p>在 <code>applyTheme()</code> 之前，Drawable 的 <code>mTintFilter</code> 和 <code>mVectorState</code> 中的 <code>mTint</code> 都是空的：</p><p><img alt="applyTheme 之前" data-src="../../images/android-%E6%B5%8B%E8%AF%95%E5%9D%91%E7%82%B9%E8%AF%A6%E8%A7%A3%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E2%80%94-vectordrawable-%E5%92%8C-tint-%E9%97%AE%E9%A2%98%E8%A7%A3%E6%9E%90/applytheme-%E4%B9%8B%E5%89%8D.png"></p><p>而在经过 <code>applyTheme()</code> 之后，Drawable 的 <code>mTintFilter</code> 和 <code>mVectorState</code> 中的 <code>mTint</code> 都被赋上了值：</p><p><img alt="applyTheme 之后" data-src="../../images/android-%E6%B5%8B%E8%AF%95%E5%9D%91%E7%82%B9%E8%AF%A6%E8%A7%A3%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E2%80%94-vectordrawable-%E5%92%8C-tint-%E9%97%AE%E9%A2%98%E8%A7%A3%E6%9E%90/applytheme-%E4%B9%8B%E5%90%8E.png"></p><p>其中更重要的一点就是这个 <code>mColor</code> 值和我们后面从 <code>ImageView</code> 的 Drawable 中得到的 <code>mColor</code> 并不一样：</p><p><img alt="ImageView Drawable 中的 mColor" data-src="../../images/android-%E6%B5%8B%E8%AF%95%E5%9D%91%E7%82%B9%E8%AF%A6%E8%A7%A3%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E2%80%94-vectordrawable-%E5%92%8C-tint-%E9%97%AE%E9%A2%98%E8%A7%A3%E6%9E%90/imageview-drawable-%E4%B8%AD%E7%9A%84-mcolor.png"></p><p>进一步的分析可以看到，在 <code>mVectorState</code> 中的 <code>mTint</code> 实际上保留了两个 <code>mColor</code> 值，其中一个是 <code>Context</code> 获取的 Drawable 的 <code>mColor</code>，另一个则是在 <code>ImageView</code> 中获取到的 <code>mColor</code>。</p><p>所以说，极有可能是在 <code>applyTheme()</code> 方法中出现了什么问题，导致其赋予 Drawable 一个错误的 <code>mTint</code> 从而导致 BUG 的出现。</p><h2 id="4-深入-applytheme-方法"><a class="markdownIt-Anchor" href="#4-深入-applytheme-方法"></a> 4. 深入 applyTheme 方法</h2><p>在上面的分析中，我们知道，在 <code>applyTheme()</code> 方法中，系统会赋予 Drawable 一个着色，但是这个着色是有问题的，那么我们只要找到哪条代码会导致着色变化即可。</p><p>经过不断的步进，我终于找到了对着色进行更改的方法——<code>updateLocalState()</code> 方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateLocalState</span><span class="params">(Resources res)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> density = Drawable.resolveDensity(res, mVectorState.mDensity);</span><br><span class="line">  <span class="keyword">if</span> (mTargetDensity != density) &#123;</span><br><span class="line">    mTargetDensity = density;</span><br><span class="line">    mDpiScaledDirty = <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  mTintFilter = updateTintFilter(mTintFilter, mVectorState.mTint, mVectorState.mTintMode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们可以看到，这个方法最后会调用 <code>updateTintFilter()</code> 使用 <code>mVectorState</code> 中的着色值对 Drawable 进行着色，而这个着色值正是我们在上面看到的那个具有两个 Int 的数组，包含了两种不同的颜色。</p><p>深入进去，我们可以发现：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span> <span class="function">PorterDuffColorFilter <span class="title">updateTintFilter</span><span class="params">(@Nullable PorterDuffColorFilter tintFilter,</span></span></span><br><span class="line"><span class="function"><span class="params">        @Nullable ColorStateList tint, @Nullable PorterDuff.Mode tintMode)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (tint == <span class="keyword">null</span> || tintMode == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> color = tint.getColorForState(getState(), Color.TRANSPARENT);</span><br><span class="line">    <span class="keyword">if</span> (tintFilter == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PorterDuffColorFilter(color, tintMode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tintFilter.setColor(color);</span><br><span class="line">    tintFilter.setMode(tintMode);</span><br><span class="line">    <span class="keyword">return</span> tintFilter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实际上，这个方法是通过 Drawable 的 State 在 <code>mVectorState.mTint</code> 中获取对应的颜色，然后对 <code>mTintFilter</code> 进行赋值的。</p><p>到这里，关键点就来了，由于我们是第一次通过 <code>Context</code> 获取 Drawable，此时，Drawable 还不具备状态，那么 <code>getState()</code> 的结果实际上是一个 <strong>空数组！</strong></p><p>我们紧接着看 <code>getColorForState()</code> 方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getColorForState</span><span class="params">(@Nullable <span class="keyword">int</span>[] stateSet, <span class="keyword">int</span> defaultColor)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> setLength = mStateSpecs.length;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; setLength; i++) &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span>[] stateSpec = mStateSpecs[i];</span><br><span class="line">    <span class="keyword">if</span> (StateSet.stateSetMatches(stateSpec, stateSet)) &#123;</span><br><span class="line">      <span class="keyword">return</span> mColors[i];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> defaultColor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>经过调试结果，我们可以看到：</p><p><img alt="getColorState 调试结果" data-src="../../images/android-%E6%B5%8B%E8%AF%95%E5%9D%91%E7%82%B9%E8%AF%A6%E8%A7%A3%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E2%80%94-vectordrawable-%E5%92%8C-tint-%E9%97%AE%E9%A2%98%E8%A7%A3%E6%9E%90/getcolorstate-%E8%B0%83%E8%AF%95%E7%BB%93%E6%9E%9C.png"></p><p>这里面的 <code>mColor</code> 正是 <code>mVectorState.mTint</code> 的两个值，并且，第一个就是 Context Drawable 的 <code>mTint</code> 值。</p><p>那么也就说明：<code>stateSetMatches()</code> 方法第一次就通过了。</p><p>所以，问题应该就是出在 <code>stateSetMatches()</code> 方法中。</p><h2 id="5-statesetmatches-方法流程"><a class="markdownIt-Anchor" href="#5-statesetmatches-方法流程"></a> 5. stateSetMatches 方法流程</h2><p>这里先上一个调试结果：</p><p><img alt="stateSetMatches调试结果" data-src="../../images/android-%E6%B5%8B%E8%AF%95%E5%9D%91%E7%82%B9%E8%AF%A6%E8%A7%A3%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E2%80%94-vectordrawable-%E5%92%8C-tint-%E9%97%AE%E9%A2%98%E8%A7%A3%E6%9E%90/statesetmatches%E8%B0%83%E8%AF%95%E7%BB%93%E6%9E%9C.png"></p><p>从调试中我们可以看到，<code>stateSpec</code> 有一个负数值，而 <code>stateSet</code> 是空的。</p><p>下面是这个方法的部分源码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">stateSetMatches</span><span class="params">(<span class="keyword">int</span>[] stateSpec, <span class="keyword">int</span>[] stateSet)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">if</span> (stateSet == <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="keyword">return</span> (stateSpec == <span class="keyword">null</span> || isWildCard(stateSpec));</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">int</span> stateSpecSize = stateSpec.length;</span><br><span class="line">     <span class="keyword">int</span> stateSetSize = stateSet.length;</span><br><span class="line">     <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; stateSpecSize; i++) &#123;</span><br><span class="line">         <span class="keyword">int</span> stateSpecState = stateSpec[i];</span><br><span class="line">         <span class="keyword">if</span> (stateSpecState == <span class="number">0</span>) &#123;</span><br><span class="line">             <span class="comment">// We've reached the end of the cases to match against.</span></span><br><span class="line">             <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">final</span> <span class="keyword">boolean</span> mustMatch;</span><br><span class="line">         <span class="keyword">if</span> (stateSpecState &gt; <span class="number">0</span>) &#123;</span><br><span class="line">             mustMatch = <span class="keyword">true</span>;</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             <span class="comment">// We use negative values to indicate must-NOT-match states.</span></span><br><span class="line">             mustMatch = <span class="keyword">false</span>;</span><br><span class="line">             stateSpecState = -stateSpecState;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">boolean</span> found = <span class="keyword">false</span>;</span><br><span class="line">         <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; stateSetSize; j++) &#123;</span><br><span class="line">           ...</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">if</span> (mustMatch &amp;&amp; !found) &#123;</span><br><span class="line">             <span class="comment">// We've reached the end of states to match and we didn't</span></span><br><span class="line">             <span class="comment">// find a must-match state.</span></span><br><span class="line">             <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>从中我们可以看到，实际上这个函数就是对比状态是否相等，由于我们的 <code>stateSet</code> 是空数组，所以就隐去了其相关的 <code>for</code> 循环部分，因为这个循环实际上是会被跳过的。</p><p>从外部的 <code>for</code> 循环中来看，我们发现由于 <code>stateSpecState</code> 是一个负数，所以 <code>mustMatch</code> 为 <code>false</code>，而由于我们又没有找到相应的符合规范的状态，因此 <code>found</code> 也是 <code>false</code>。</p><p>此时，外层的第一次也是唯一一次的 <code>for</code> 循环就结束了，那么循环跳出，<strong>最后返回 true！</strong></p><p><img alt="stateSetMatches 返回 true" data-src="../../images/android-%E6%B5%8B%E8%AF%95%E5%9D%91%E7%82%B9%E8%AF%A6%E8%A7%A3%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E2%80%94-vectordrawable-%E5%92%8C-tint-%E9%97%AE%E9%A2%98%E8%A7%A3%E6%9E%90/statesetmatches-%E8%BF%94%E5%9B%9E-true.png"></p><p>也就是说，当 Drawable 没有状态时，系统会默认其 <strong>符合任何状态！</strong></p><p>于是，<code>mColors</code> 的第一个颜色值会被返回，但实际上它并不是 <code>ColorStateList</code> 的默认值：</p><p><img alt="第一个 mColor 并不是默认值" data-src="../../images/android-%E6%B5%8B%E8%AF%95%E5%9D%91%E7%82%B9%E8%AF%A6%E8%A7%A3%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E2%80%94-vectordrawable-%E5%92%8C-tint-%E9%97%AE%E9%A2%98%E8%A7%A3%E6%9E%90/%E7%AC%AC%E4%B8%80%E4%B8%AA-mcolor-%E5%B9%B6%E4%B8%8D%E6%98%AF%E9%BB%98%E8%AE%A4%E5%80%BC.png"></p><p>而由于 <code>ImageView</code> 会在拿到 Drawable 之后通过其状态来更新着色，因此就会导致着色的不相同。</p><h2 id="6-案件重现"><a class="markdownIt-Anchor" href="#6-案件重现"></a> 6. 案件重现</h2><p>到这里，问题的成因就已经水落石出了，侦探推理完成后都会进行一下案件重演，那么在这里也重新回顾一下整个流程和问题的原因：</p><ol><li>ImageView 展示 Drawable 调用了 <code>Context</code></li><li><code>Context</code> 第一次创建 Drawable 并不带有状态</li><li>空状态导致系统着色判断错误</li><li><code>Context</code> 随即将错误的着色 Drawable 进行缓存</li><li><code>ImageView</code> 获取到 Drawable 之后根据其状态给予了正确的着色</li><li>测试程序再次通过 <code>Context</code> 获取 Drawable 由于缓存命中，返回了错误着色的 Drawable</li><li>由于测试程序获取的期望值和 <code>ImageView</code> 的真实值不相同，因此测试报错不通过</li></ol><p>其中，我们看到，问题的关键在于系统在 Drawable 初次创建完成时错误判断了其着色颜色，从而返回颜色列表的第一个值而忽略其真正的默认值。</p><p>由于我们再次通过 <code>Context</code> 取 Drawable 会因为缓存而拿到错误着色的 Drawable，所以我们需要对拿到的 Drawable 根据运行环境进行重新着色。</p><p>但是如果你的 <code>&lt;selector&gt;</code> 的第一个 <code>&lt;item&gt;</code> 就是默认的话，那么就没有这个问题，不需要重新着色了。</p><h2 id="7-附默认的-colorcontrolnormal-值"><a class="markdownIt-Anchor" href="#7-附默认的-colorcontrolnormal-值"></a> 7. 附：默认的 colorControlNormal 值</h2><p>在调试之余我还翻了一下默认的 <code>colorControlNormal</code> 值，结果是根据你设定的根主题的不同，可能会有下面的两个值：</p><ol><li><code>?android:attr/textColorPrimary</code></li><li><code>?android:attr/textColorSecondary</code></li></ol><p>但无一例外它们都是 <code>&lt;selector&gt;</code>，而且有状态的颜色值处在第一个。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- textColorPrimary --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">selector</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">android:state_enabled</span>=<span class="string">"false"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:alpha</span>=<span class="string">"?attr/disabledAlpha"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:color</span>=<span class="string">"?attr/colorForeground"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">android:alpha</span>=<span class="string">"?attr/primaryContentAlpha"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:color</span>=<span class="string">"?attr/colorForeground"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">selector</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- textColorSecondary --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">selector</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">android:state_enabled</span>=<span class="string">"false"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:alpha</span>=<span class="string">"?attr/disabledAlpha"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:color</span>=<span class="string">"?attr/colorForeground"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">android:alpha</span>=<span class="string">"?attr/secondaryContentAlpha"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:color</span>=<span class="string">"?attr/colorForeground"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">selector</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;/Android/android-%E6%B5%8B%E8%AF%95%E5%9D%91%E7%82%B9%E8%AF%A6%E8%A7%A3%EF%BC%88%E4%B8%80%EF%BC%89/&quot;&gt;上篇文章&lt;/a&gt;我们说到如果你的 VectorDrawable 如果采用一个带 &lt;code&gt;&amp;lt;selector&amp;gt;&lt;/code&gt; 的颜色进行着色，那么就需要在测试代码中对 Drawable 进行重新着色，而不是直接比较。&lt;/p&gt;&lt;p&gt;本篇文章就来着重说说其中的原理。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Android" scheme="https://wafer.li/categories/Android/"/>
    
    
      <category term="Android" scheme="https://wafer.li/tags/Android/"/>
    
      <category term="Instrument Test" scheme="https://wafer.li/tags/Instrument-Test/"/>
    
  </entry>
  
  <entry>
    <title>AndroidX 测试坑点详解（一）</title>
    <link href="https://wafer.li//Android/android-%E6%B5%8B%E8%AF%95%E5%9D%91%E7%82%B9%E8%AF%A6%E8%A7%A3%EF%BC%88%E4%B8%80%EF%BC%89/"/>
    <id>https://wafer.li//Android/android-测试坑点详解（一）/</id>
    <published>2019-05-31T07:49:00.000Z</published>
    <updated>2019-06-14T05:15:15.000Z</updated>
    
    <content type="html"><![CDATA[<p>最近在迁移到 AndroidX 之后一直折腾 TDD 的事情，也遇到了大的小的不少坑点；</p><p>鉴于 AndroidX 在测试方面还没有太多的文档，就写一篇博文来总结一下折腾的经验，也给后来人做一些参考。</p><a id="more"></a><h2 id="1-国产-rom-的坑"><a class="markdownIt-Anchor" href="#1-国产-rom-的坑"></a> 1. 国产 ROM 的坑</h2><p><code>ActivityScenario</code> 和 <code>ActivityScenarioRule</code> 是新推出的操作 Activity 生命周期的类。</p><p>当构建 <code>ActivityScenario</code> 时，它便会自动启动你指定的 Activity 并让它处于 <code>RESUMED</code> 状态。</p><p>使用示例如下：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(AndroidJunit4::class)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainActivityTest</span> </span>&#123;</span><br><span class="line">  <span class="meta">@get:Rule</span></span><br><span class="line">  <span class="keyword">val</span> mainActivityScenarioRule = ActivityScenarioRule&lt;MainActivity&gt;(MainActivity::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>)</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">onCreate_saveInstanceNull</span><span class="params">()</span></span> &#123;</span><br><span class="line">        mainActivityScenarioRule.scenario</span><br><span class="line">                .onActivity &#123; activity -&gt;</span><br><span class="line">                  <span class="comment">// 在这里获取 Activity 实例</span></span><br><span class="line">                &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但是，当我在手机上跑这个测试的时候，却遇到了下面的问题：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java.lang.AssertionError: Activity never becomes requested state <span class="string">"[RESUMED]"</span></span><br><span class="line">(last lifecycle transition = <span class="string">"PRE_ON_CREATE"</span>)</span><br></pre></td></tr></table></figure><p>也就是说，我这个 Activity 实际上并没有真正的 <code>onCreate</code> 而是一直处于被创建之前的状态，随后因为超时导致了报错退出。</p><blockquote><p>具体的超时时间是 45 秒</p></blockquote><p>但是到底是什么东西导致我的 Activity 启动不了却没有什么头绪，直到我用模拟器运行测试代码的时候，我发现： <strong>居然测试通过了！</strong></p><p>原来，Android 的仪器测试(Instrumented Test)都会构建一个独立的 <code>test.apk</code> 并自动安装和运行。</p><p>而国产的手机系统对于应用自启动的管理非常激进（例如华为），而我也没有对 <code>test.apk</code> 设置白名单，于是系统就一直禁止 <code>tesk.apk</code> 的启动，导致测试失败。</p><p>在华为的手机应用管家中为 <code>test.apk</code> 设置白名单，测试就可以通过了。</p><h2 id="2-fragment-testing-的坑"><a class="markdownIt-Anchor" href="#2-fragment-testing-的坑"></a> 2. Fragment Testing 的坑</h2><h3 id="21-编译依赖的坑"><a class="markdownIt-Anchor" href="#21-编译依赖的坑"></a> 2.1 编译依赖的坑</h3><p>和 <code>ActivityScenario</code> 一样，Google 也提供了一个 <code>FragmentScenario</code> 方便在测试中获取 <code>Fragment</code> 实例和对 <code>Fragment</code> 进行操作。</p><p>但是需要引入 <code>fragment-testing</code> 库，按照 Google 的文档是下面的这条语句:</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">debugImplementation <span class="string">'androidx.fragment:fragment-testing:1.1.0-alpha07'</span></span><br></pre></td></tr></table></figure><p>这里就是它的第一个坑，如果你只引入上面的这条语句，实际上根本不可能成功 Build。</p><p>主要有以下两点原因：</p><ol><li><p><code>fragment-testing</code> 需要依赖 <code>androidx.test.core</code>，而 debugImplementation 并没有引入 <code>androidx.text.core</code></p></li><li><p>我们需要在 Instrumented Test 中使用 <code>fragment-testing</code>，而上面并没有在 <code>androidTestImplementation</code> 引入</p></li></ol><p>于是乎，正确的引入方式是：</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">debugImplementation(Libs.androidx_test_core)</span><br><span class="line">debugImplementation(Libs.fragment_testing)</span><br><span class="line">androidTestImplementation(Libs.androidx_test_core)</span><br><span class="line">androidTestImplementation(Libs.fragment_testing)</span><br></pre></td></tr></table></figure><p>那么能不能把 <code>debugImplementation</code> 换成普通的 <code>implementation</code> 呢？</p><p>很可惜，这是不行的，不过至于为什么不行，我目前并没有对此进行深入研究。</p><h3 id="22-主题的坑"><a class="markdownIt-Anchor" href="#22-主题的坑"></a> 2.2 主题的坑</h3><p>导入和依赖的坑解决之后就到了如何使用的环节了。</p><p>具体的用法为：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">testFragment</span><span class="params">()</span></span> &#123;</span><br><span class="line">  launchFragmentScenario&lt;LoginFragment&gt;() &#123; fragment -&gt;</span><br><span class="line">    <span class="comment">// 使用 fragment</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但是，这么使用也是不行的。</p><p>如果你使用了 Material 的组件，例如 <code>TextInputLayout</code>，那么它会报如下错误：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Caused by: android.view.InflateException: Binary XML file line</span><br><span class="line">#9: Error inflating class</span><br><span class="line">**com.google.android.material.textfield.TextInputLayout**</span><br></pre></td></tr></table></figure><p>在查阅相关资料之后，发现了<span class="exturl" data-url="aHR0cHM6Ly9pc3N1ZXRyYWNrZXIuZ29vZ2xlLmNvbS9pc3N1ZXMvMTE5MDU0NDMx" title="https://issuetracker.google.com/issues/119054431">一个相关的 Issue<i class="fa fa-external-link"></i></span></p><p>其中 Google 的人指出：</p><blockquote><p>You need to tell FragmentScenario <strong>what theme you want</strong> if you want something <strong>other than the default Theme.WithActionBar</strong>, that’s correct.</p></blockquote><p>也就是说，如果你使用了 Material 相关的主题，比如说常见的 <code>Theme.Appcompat</code> 等，那么就需要向 <code>FragmentScenario</code> 明确指出你使用的主题样式。</p><p>也就是说，上面的代码需要写成：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">testFragment</span><span class="params">()</span></span> &#123;</span><br><span class="line">  launchFragmentScenario&lt;LoginFragment&gt;(</span><br><span class="line">    themeResId = R.style.Your_App_Theme</span><br><span class="line">    ) &#123; fragment -&gt;</span><br><span class="line">    <span class="comment">// 使用 fragment</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>程序才能正常运行。</p><h2 id="3-onfragmentonactivity-和-check-的坑"><a class="markdownIt-Anchor" href="#3-onfragmentonactivity-和-check-的坑"></a> 3. onFragment/onActivity 和 check 的坑</h2><p><code>ActivityScenario</code> 和 <code>FragmentScenario</code> 都提供了一个相应的高阶函数 <code>onActivity()</code> 和 <code>onFragment()</code>，可以在其中获取到对应的 <code>Activity</code> 和 <code>Fragment</code> 的实例，并用它做相应的操作。</p><blockquote><p>实际上 <code>onFragment()</code> 内部也是调用了 <code>onActivity()</code></p></blockquote><p>但是！需要注意的是，这两个 <code>on</code> 方法都是运行在主线程的，而 Espresso 的 <code>check()</code> 函数是一个耗时操作，如果你在 <code>onFragment()</code> 中调用 <code>check()</code>，那么就会 <strong>阻塞 UI 线程</strong>。</p><p>也就是说，需要将 <code>onView()</code> 相关的内容放到 <code>onFragment/onActivity</code> 的外面：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">launchFragmentInContainer&lt;LoginFragment&gt;(</span><br><span class="line">    themeResId = R.style.Theme_Shrine</span><br><span class="line">).onFragment &#123;</span><br><span class="line">    tintColorRes = typedValue.resourceId</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">onView(withContentDescription(R.string.shr_logo_content_description))</span><br><span class="line">    .check(matches(withDrawable(R.drawable.shr_logo, tintColorRes)))</span><br><span class="line">    .check(matches(isCompletelyDisplayed()))</span><br></pre></td></tr></table></figure><p>等等，放到外面就不会阻塞 UI 线程了吗？难道不会阻塞 <code>test.apk</code> 的 UI 线程？</p><p>经过反编译 <code>tesk.apk</code> 之后发现，实际上 <code>test.apk</code> <strong>只包含测试用例相关的内容</strong>，甚至没有一个 <code>Activity</code>，而真正的被测试的内容实际上还是在我们原来的 apk 之中，<code>test.apk</code> 实际上是通过启动被测试的 apk 的相关内容来实现仪器测试的。</p><p>也就是说，如果将 <code>onView</code> 相关的代码放到外面，实际上是在 <code>test.apk</code> 里面跑的，也就不会对被测试的 apk 进行阻塞。</p><h2 id="4-动画的坑"><a class="markdownIt-Anchor" href="#4-动画的坑"></a> 4. 动画的坑</h2><p>Android 官方的 Espresso 测试框架不能兼容动画效果，在跑测试，特别是点击、输入等 UI 测试时，需要进入开发者模式把能显示动画的都关掉：</p><p><img alt="Turn Off Animation" data-src="../../images/android-espresso-%E5%9D%91%E7%82%B9%E8%AF%A6%E8%A7%A3%EF%BC%88%E4%B8%80%EF%BC%89/turn-off-animation.png"></p><p>不然 Espresso 会报 <code>PerformException</code>。</p><h2 id="5-测试-imageview-的-drawable-的坑"><a class="markdownIt-Anchor" href="#5-测试-imageview-的-drawable-的坑"></a> 5. 测试 ImageView 的 Drawable 的坑</h2><h3 id="51-androidtint-的坑"><a class="markdownIt-Anchor" href="#51-androidtint-的坑"></a> 5.1 android:tint 的坑</h3><p>对于 <code>ImageView</code>，我们需要测试它是否展示出了我们传入的 Drawable，不过比较可惜的是，Espresso 自身并没有提供 <code>withDrawable()</code> 方法，幸运的是，我们可以通过 Kotlin 的扩展函数实现这个功能：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">withDrawable</span><span class="params">(<span class="meta">@DrawableRes</span> id: <span class="type">Int</span>, <span class="meta">@ColorRes</span> tint: <span class="type">Int</span>? = <span class="literal">null</span>, tintMode: <span class="type">PorterDuff</span>.<span class="type">Mode</span> = SRC_IN)</span></span> = <span class="keyword">object</span> : TypeSafeMatcher&lt;View&gt;() &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">describeTo</span><span class="params">(description: <span class="type">Description</span>)</span></span> &#123;</span><br><span class="line">        description.appendText(<span class="string">"ImageView with drawable same as drawable with id <span class="variable">$id</span>"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">matchesSafely</span><span class="params">(view: <span class="type">View</span>)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        <span class="keyword">val</span> context = view.context</span><br><span class="line">        <span class="keyword">val</span> expectedBitmap = context.getDrawable(id)?.toBitmap()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> view <span class="keyword">is</span> ImageView &amp;&amp; view.drawable.toBitmap().sameAs(expectedBitmap)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但是，<code>ImageView</code> 支持着色 (tint) 功能，真正显示出来的 Drawable 和我们从 <code>Context</code> 里面拿到的 Drawable 很可能是不一样的，因此，我们也需要给 <code>expectedBitmap</code> 进行着色：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="built_in">Int</span>.<span class="title">toColor</span><span class="params">(context: <span class="type">Context</span>)</span></span> = ContextCompat.getColor(context, <span class="keyword">this</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> Drawable.<span class="title">tinted</span><span class="params">(<span class="meta">@ColorInt</span> tintColor: <span class="type">Int</span>? = <span class="literal">null</span>, tintMode: <span class="type">PorterDuff</span>.<span class="type">Mode</span> = SRC_IN)</span></span> =</span><br><span class="line">        apply &#123;</span><br><span class="line">            setTintList(tintColor?.toColorStateList())</span><br><span class="line">            setTintMode(tintMode)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="built_in">Int</span>.<span class="title">toColorStateList</span><span class="params">()</span></span> = ColorStateList.valueOf(<span class="keyword">this</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">withDrawable</span><span class="params">(<span class="meta">@DrawableRes</span> id: <span class="type">Int</span>, <span class="meta">@ColorRes</span> tint: <span class="type">Int</span>? = <span class="literal">null</span>, tintMode: <span class="type">PorterDuff</span>.<span class="type">Mode</span> = SRC_IN)</span></span> = <span class="keyword">object</span> : TypeSafeMatcher&lt;View&gt;() &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">describeTo</span><span class="params">(description: <span class="type">Description</span>)</span></span> &#123;</span><br><span class="line">        description.appendText(<span class="string">"ImageView with drawable same as drawable with id <span class="variable">$id</span>"</span>)</span><br><span class="line">        tint?.let &#123; description.appendText(<span class="string">", tint color id: <span class="variable">$tint</span>, mode: <span class="variable">$tintMode</span>"</span>) &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">matchesSafely</span><span class="params">(view: <span class="type">View</span>)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        <span class="keyword">val</span> context = view.context</span><br><span class="line">        <span class="keyword">val</span> tintColor = tint?.toColor(context)</span><br><span class="line">        <span class="keyword">val</span> expectedBitmap = context.getDrawable(id)?.tinted(tintColor, tintMode)?.toBitmap()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> view <span class="keyword">is</span> ImageView &amp;&amp; view.drawable.toBitmap().sameAs(expectedBitmap)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="52-vectordrawable-的坑"><a class="markdownIt-Anchor" href="#52-vectordrawable-的坑"></a> 5.2 VectorDrawable 的坑</h3><p>从 5.0 之后， Android 支持矢量图，即 <code>VectorDrawable</code>，在 <code>ImageView</code> 中使用 <code>app:srcCompat</code> 进行显示。</p><p>但是，虽然在普通的 apk 中可以正常显示矢量图，但是在运行仪器测试时仅仅这样是显示不了的，还需要在代码中使用 <code>setImageResource()</code> 才能在测试中显示出矢量图。</p><p>目前来看这是 Android 测试框架的一个 Bug，如果不想改代码的话可以不进行这方面的测试，毕竟图能不能显示出来，用眼睛看看就行了。</p><h3 id="53-vectordrawable-和-tint-的坑"><a class="markdownIt-Anchor" href="#53-vectordrawable-和-tint-的坑"></a> 5.3 VectorDrawable 和 tint 的坑</h3><p>上面说到了 Drawable 需要 tint，如果我们的 <code>ImageView</code> 显示的是 <code>VectorDrawable</code>，那就要小心了，因为 <code>VectorDrawable</code> 可以在它自己的 xml 文件中进行着色：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">vector</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">android:height</span>=<span class="string">"152dp"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">android:tint</span>=<span class="string">"?attr/colorControlNormal"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">android:viewportHeight</span>=<span class="string">"152"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">android:viewportWidth</span>=<span class="string">"149"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">android:width</span>=<span class="string">"149dp"</span>&gt;</span></span><br></pre></td></tr></table></figure><p>注意上面的 <strong><code>android:tint=&quot;?attr/colorControlNormal&quot;</code></strong>，这是在 <code>vector</code> 中定义的。</p><p>如果你给这个 <code>tint</code> 设定的是一个 <code>&lt;selector&gt;</code>，那么就需要注意了：</p><p>如果你的 <code>&lt;selector&gt;</code> 的第一个 <code>&lt;item&gt;</code> 不是默认颜色，而是 <code>state_enable:false</code> 之类的有状态的颜色，那么就需要在测试代码中获取 <code>R.attr.colorControlNormal</code> 并对 Drawable 重新进行着色，否则即使你没有对这个 Drawable 进行过任何修改，测试依旧会报错失败。</p><p>如果你的 <code>&lt;selector&gt;</code> 的第一个 <code>&lt;item&gt;</code> 是默认的不带有状态限定的颜色，那么就不需要重新着色。</p><p>鉴于默认的 <code>colorControlNormal</code> 是 <code>&lt;selector&gt;</code> 颜色，我建议在测试 Drawable 的时候都统一进行重新着色。</p><p>而如何在运行时取到 <code>colorControlNormal</code> 的真正的颜色资源 ID，可以参照以下代码：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> typedValue = TypedValue()</span><br><span class="line">it.activity?.theme?.resolveAttribute(R.attr.colorControlNormal, typedValue, <span class="literal">true</span>)</span><br><span class="line">tintColorRes = typedValue.resourceId</span><br></pre></td></tr></table></figure><p>最后拿到的 <code>tintColorRes</code> 即为颜色资源 ID。</p><p>关于其中具体原理，可以参照我的<a href="/Android/android-%E6%B5%8B%E8%AF%95%E5%9D%91%E7%82%B9%E8%AF%A6%E8%A7%A3%EF%BC%88%E4%BA%8C%EF%BC%89%E2%80%94%E2%80%94-vectordrawable-%E5%92%8C-tint-%E9%97%AE%E9%A2%98%E8%A7%A3%E6%9E%90/">下一篇文章</a>。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;最近在迁移到 AndroidX 之后一直折腾 TDD 的事情，也遇到了大的小的不少坑点；&lt;/p&gt;&lt;p&gt;鉴于 AndroidX 在测试方面还没有太多的文档，就写一篇博文来总结一下折腾的经验，也给后来人做一些参考。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Android" scheme="https://wafer.li/categories/Android/"/>
    
    
      <category term="Android" scheme="https://wafer.li/tags/Android/"/>
    
      <category term="Instrument Test" scheme="https://wafer.li/tags/Instrument-Test/"/>
    
      <category term="Espresso" scheme="https://wafer.li/tags/Espresso/"/>
    
  </entry>
  
  <entry>
    <title>ConnectedDevice: No Test Found 调试过程</title>
    <link href="https://wafer.li//Android/connecteddevice-no-test-found-%E8%B0%83%E8%AF%95%E8%BF%87%E7%A8%8B/"/>
    <id>https://wafer.li//Android/connecteddevice-no-test-found-调试过程/</id>
    <published>2019-05-26T03:39:00.000Z</published>
    <updated>2019-05-27T15:00:18.000Z</updated>
    
    <content type="html"><![CDATA[<p>之前又稍微折腾着想尝试一下 TDD，并在每次构建的时候加入测试环节，当测试不通过就不允许 build。</p><p>当一切都配置好，点下 build App 的时候，却出现了 <code>There were failing tests.</code>。</p><p>我心想，不会啊，现在我就根本没写几个测试用例，为什么会通不过？</p><p>于是，就开始了艰难的调试过程</p><a id="more"></a><h2 id="0-更新"><a class="markdownIt-Anchor" href="#0-更新"></a> 0. 更新</h2><p>2019-05-27 更新： Google 回复：Instant Run 在新版本已经不被支持了，他们开发了一个更好的功能叫 Apply Change。</p><p><img alt="Google Response Instant Run Deprecated" data-src="../../images/connecteddevice-no-test-found-%E8%B0%83%E8%AF%95%E8%BF%87%E7%A8%8B/google-response-instant-run-deprecated.png"></p><blockquote><p>Instant Run has been deprecated in Android Studio 3.5 and instead we’ve implemented a brand new solution called Apply Changes that is more stable and doesn’t modify your APK on build.<br>…<br>We recommend <strong>turning off Instant Run</strong> in the settings for earlier versions of Android Studio</p></blockquote><p>尝试了一下 2019-05-23 编译的 Android Studio 3.6 Canary 1 ，问题的确已经被修复了。</p><p><img alt="Build Success with AS 3.6.1" data-src="../../images/connecteddevice-no-test-found-%E8%B0%83%E8%AF%95%E8%BF%87%E7%A8%8B/build-success-with-as-3-6-1.png"></p><p>所以还在使用 3.4 稳定版的，直接把 Instant Run 关掉吧。</p><h2 id="1-connecteddevice-no-tests-found"><a class="markdownIt-Anchor" href="#1-connecteddevice-no-tests-found"></a> 1. ConnectedDevice No tests found</h2><p>打开测试结果，就得到了下面这张图</p><p><img alt="ConnectedDevice No test found" data-src="../../images/connecteddevice-no-test-found-%E8%B0%83%E8%AF%95%E8%BF%87%E7%A8%8B/connecteddevice-no-test-found.png"></p><p>再点进去一看：<br><img alt="ConnectedDevice No Test found detail" data-src="../../images/connecteddevice-no-test-found-%E8%B0%83%E8%AF%95%E8%BF%87%E7%A8%8B/connecteddevice-no-tests-found-detail.png"></p><p>它说我没有按照 JUnit 的方式编写测试用例，但是我的测试用例都是加了 <code>@Test</code> 的啊</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(AndroidJUnit4::class)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ApplicationTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">useAppContext</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// Context of the app under test.</span></span><br><span class="line">        <span class="keyword">val</span> appContext = InstrumentationRegistry.getInstrumentation().targetContext</span><br><span class="line"></span><br><span class="line">        assertEquals(<span class="string">"aaa.bbb.ccc.ddd"</span>, appContext.packageName)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>于是就陷入了困境，问题到这里就消失了，到底应该怎样才能定位到问题呢？</p><h2 id="2-使用-gradle-命令行进行构建尝试"><a class="markdownIt-Anchor" href="#2-使用-gradle-命令行进行构建尝试"></a> 2. 使用 gradle 命令行进行构建尝试</h2><p>Android Studio 的 Run App 实际上就是先执行 <code>assemble[Build-Variant]</code> 然后再将生成的 apk 安装到手机的过程。</p><p>而这个 <code>assemble</code> 实际上是通过 <code>gradle</code> 执行的，于是可以尝试通过 gradle 命令行进行编译，看看是不是 gradle 导致的问题。</p><p>然而，gradle 单独进行编译并没有这个问题：</p><p><img alt="gradle build successful" data-src="/images/connecteddevice-no-test-found-%E8%B0%83%E8%AF%95%E8%BF%87%E7%A8%8B/gradle-build-successful.png"></p><p>所以很有可能是 Android Studio 自身的构建出现了问题，但是，目前的构建信息并不足以让我们定位到问题，所以需要获取更多的构建信息。</p><h2 id="3-instrument-process-crashed"><a class="markdownIt-Anchor" href="#3-instrument-process-crashed"></a> 3. INSTRUMENT: Process Crashed</h2><p>首先，我们在 <code>Build, Execution, Deployment -&gt; Compiler</code> 开启 <code>gradle --scan</code></p><p><img alt="Gradle Scan In Android Studio" data-src="../../images/connecteddevice-no-test-found-%E8%B0%83%E8%AF%95%E8%BF%87%E7%A8%8B/gradle-scan-in-android-studio.png"></p><p>然后，点击红框里面的小图标让 Build 信息变成文字：</p><p><img alt="Build Output Text" data-src="../../images/connecteddevice-no-test-found-%E8%B0%83%E8%AF%95%E8%BF%87%E7%A8%8B/build-output-text.png"></p><p>之后，就看到了 build 失败的详细信息了：</p><p><img alt="Fail due to Process Crashed" data-src="../../images/connecteddevice-no-test-found-%E8%B0%83%E8%AF%95%E8%BF%87%E7%A8%8B/fail-due-to-process-crash.png"></p><p>原来是在测试的时候程序崩溃了，这才导致了测试的失败。</p><p>经过一番 StackOverflow 之后，<span class="exturl" data-url="aHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9hLzIxNjExMzcw" title="https://stackoverflow.com/a/21611370">这个答案<i class="fa fa-external-link"></i></span> 提醒了我：</p><p><img alt="StackOverflow See LogCat" data-src="../../images/connecteddevice-no-test-found-%E8%B0%83%E8%AF%95%E8%BF%87%E7%A8%8B/stackoverflow-see-logcat.png"></p><p>由于 Instrument Test 实际上是安装了一个 <code>test.apk</code>，所以它的报错信息会在 Log Cat 而不是 Build Output 中。</p><h2 id="4-didnt-find-class-corecomponentfactory"><a class="markdownIt-Anchor" href="#4-didnt-find-class-corecomponentfactory"></a> 4. Didn’t find class CoreComponentFactory</h2><p>打开 Log Cat，首先映入眼帘的是 <code>Unable to instantiate application</code></p><p><img alt="Unable to instantiate application" data-src="../../images/connecteddevice-no-test-found-%E8%B0%83%E8%AF%95%E8%BF%87%E7%A8%8B/unable-to-instantiate-application.png"></p><p>原来在执行测试的时候，没有办法实例化 <code>Application</code> 导致 Instrument Test 无法找到 <code>Context</code>，于是程序就崩溃导致测试失败了。</p><p>再往上看，可以看到导致无法实例化 <code>Application</code> 的原因：</p><p><img alt="Didn't find class CoreComponentFactory" data-src="../../images/connecteddevice-no-test-found-%E8%B0%83%E8%AF%95%E8%BF%87%E7%A8%8B/didn-t-find-class-corecomponentfactory.png"></p><p>原来是构建 <code>Application</code> 的工厂找不到了，从而造成它无法实例化。</p><h2 id="5-罪魁祸首-instant-run"><a class="markdownIt-Anchor" href="#5-罪魁祸首-instant-run"></a> 5. 罪魁祸首 Instant Run</h2><p><code>Didn't find class CoreComponentFactory</code> 这个问题之前也遇到过，是因为 R8 将其混淆了，导致在 release 模式下找不到这个类，但是现在是 debug 模式，并没有启用混淆，但是依然还是找不到这个类。</p><p>在经过又一阵子的 StackOverflow 之后，我找到了<span class="exturl" data-url="aHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9hLzU2MTg2ODIx" title="https://stackoverflow.com/a/56186821">这么一个答案<i class="fa fa-external-link"></i></span>：</p><p><img alt="Answer Disable Instant Run" data-src="../../images/connecteddevice-no-test-found-%E8%B0%83%E8%AF%95%E8%BF%87%E7%A8%8B/answer-disable-instant-run.png"></p><p>虽然它被减成了负分，但是也不妨碍我尝试一下它的可用性。</p><p>于是我将 Instant Run 取消掉，奇迹发生了，程序竟然就编译通过并成功安装在了模拟器上。</p><p><img alt="Build Success" data-src="../../images/connecteddevice-no-test-found-%E8%B0%83%E8%AF%95%E8%BF%87%E7%A8%8B/build-success.png"></p><p><img alt="Run Success" data-src="../../images/connecteddevice-no-test-found-%E8%B0%83%E8%AF%95%E8%BF%87%E7%A8%8B/run-success.png"></p><h2 id="6-总结"><a class="markdownIt-Anchor" href="#6-总结"></a> 6. 总结</h2><p>到这里，整个调试过程就结束了，也给 Google 提了这个 bug。</p><p>虽然不敢肯定一定是 Instant Run 的问题，但是目前（AS 3.4.1）来看，取消 Instant Run 就可以运行成功。</p><p>这个问题本身可能有一些特异性，不过倒是从中学到了一个知识：</p><p>类似的 Instrument Test 的失败最好先去 Log Cat 寻找原因。</p><p>也希望大家能从这篇博客中能学到一些什么吧。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;之前又稍微折腾着想尝试一下 TDD，并在每次构建的时候加入测试环节，当测试不通过就不允许 build。&lt;/p&gt;&lt;p&gt;当一切都配置好，点下 build App 的时候，却出现了 &lt;code&gt;There were failing tests.&lt;/code&gt;。&lt;/p&gt;&lt;p&gt;我心想，不会啊，现在我就根本没写几个测试用例，为什么会通不过？&lt;/p&gt;&lt;p&gt;于是，就开始了艰难的调试过程&lt;/p&gt;
    
    </summary>
    
    
      <category term="Android" scheme="https://wafer.li/categories/Android/"/>
    
    
      <category term="Android" scheme="https://wafer.li/tags/Android/"/>
    
      <category term="Instrument Test" scheme="https://wafer.li/tags/Instrument-Test/"/>
    
  </entry>
  
  <entry>
    <title>使用 buildSrcVersions 轻松管理 gradle 依赖</title>
    <link href="https://wafer.li//Android/%E4%BD%BF%E7%94%A8-buildsrcversions-%E8%BD%BB%E6%9D%BE%E7%AE%A1%E7%90%86-gradle-%E4%BE%9D%E8%B5%96/"/>
    <id>https://wafer.li//Android/使用-buildsrcversions-轻松管理-gradle-依赖/</id>
    <published>2019-05-25T16:04:00.000Z</published>
    <updated>2019-05-26T04:37:41.000Z</updated>
    
    <content type="html"><![CDATA[<p>如果你开发过稍微有点体量的 Android App，都会因为越来越多的 Gradle 依赖而头疼。</p><p>一个 App 的编译依赖少则十几项，多则几十项，如果再加上多 module，那么依赖的统一管理就很重要了。</p><p>但是，如何高效统一管理，则是一个难题。今天就来说说如何使用 buildSrcVersions 轻松管理 gradle 依赖。</p><a id="more"></a><h2 id="1-ext-的弊端"><a class="markdownIt-Anchor" href="#1-ext-的弊端"></a> 1. Ext 的弊端</h2><p>在介绍 buildSrcVersions 之前，我们先来看看 Google 官方推荐的统一管理方式，即使用 <code>ext</code> 进行管理，例如：</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ext &#123;</span><br><span class="line">    <span class="comment">// The following are only a few examples of the types of properties you can define.</span></span><br><span class="line">    compileSdkVersion = <span class="number">28</span></span><br><span class="line">    buildToolsVersion = <span class="string">"28.0.3"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// You can also use this to specify versions for dependencies. Having consistent</span></span><br><span class="line">    <span class="comment">// versions between modules can avoid behavior conflicts.</span></span><br><span class="line">    supportLibVersion = <span class="string">"28.0.0"</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后在 <code>build.gradle</code> 中</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">  <span class="comment">// Use the following syntax to access properties you defined at the project level:</span></span><br><span class="line">  <span class="comment">// rootProject.ext.property_name</span></span><br><span class="line">  compileSdkVersion rootProject.ext.compileSdkVersion</span><br><span class="line">  buildToolsVersion rootProject.ext.buildToolsVersion</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但是！这种方式有很大的问题：</p><ol><li>由于多 module 工程需要共享一些变量，<code>ext</code> 定义的位置可能在其他地方</li><li>最大的问题在于，IDE 不能跳转到这些变量的定义</li></ol><p>在日常使用中，如果你对工程不是很熟悉，那么在依赖版本需要更改的时候就要翻箱倒柜找一阵，这不免令人烦躁，影响工作效率。</p><p>那么除了 <code>ext</code> 之外有没有更好的统一管理依赖的方式呢？</p><p>有的，Gradle 提供了一个 <code>buildSrc</code> 方式。</p><h2 id="2-kotlin-buildsrc-管理-gradle-依赖"><a class="markdownIt-Anchor" href="#2-kotlin-buildsrc-管理-gradle-依赖"></a> 2. Kotlin + buildSrc 管理 gradle 依赖</h2><p>时至今日，Kotlin 不仅可以作为源文件用于开发目的，而且也可以当成脚本运行，这就是 <code>.kts</code> 文件，而且 Gradle 系统也支持使用 <code>kts</code> 文件作为 build 脚本。</p><p>废话不多说，使用 Kotlin 和 buildSrc 进行依赖管理主要需要以下步骤：</p><ol><li>在根目录建立 <code>buildSrc</code> 文件夹</li><li>在 <code>buildSrc</code> 中创建 <code>build.gradle.kts</code>，并加上如下语句</li></ol><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">  `kotlin-dsl`</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">repositories &#123;</span><br><span class="line">  jcenter()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>在 <code>buildSrc/src/main/java</code> 中创建 <code>Versions.kt</code> 和 <code>Libs.kt</code></li></ol><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">object</span> Versions &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">val</span> compileSdkVersion = <span class="number">28</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">val</span> targetSdkVersion = <span class="number">28</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">val</span> retrofit = <span class="string">"2.8.6"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">object</span> Libs &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">val</span> retrofit = <span class="string">"com.squareup.retrofit2:retrofit:<span class="subst">$&#123;Versions.retrofit&#125;</span>”</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><ol start="4"><li>最后，在 <code>app/build.gradle</code> 中</li></ol><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">  compileSdkVersion(Versions.compileSdkVersion)</span><br><span class="line">&#125;</span><br><span class="line">dependencies &#123;</span><br><span class="line">  implementation(Libs.retrofit)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样，我们既能实现依赖的统一管理，也能使用到 IDE 的自动补全和定义跳转功能，迅速定位到需要改动的版本。</p><p>但是！上面我们还是要自己去编写 <code>buildSrc</code>，不免有些麻烦。</p><p>而于此同时，我们也丢失了原先 gradle 会自动提示依赖的版本升级特性。</p><p>那么有没有一种东西能够把这两个东西结合在一起实现文体两开花呢？</p><p>到这里终于进入本篇主题：使用 <code>buildSrcVersions</code> 插件</p><h2 id="3-buildsrcversions-自动生成-buildsrc-目录"><a class="markdownIt-Anchor" href="#3-buildsrcversions-自动生成-buildsrc-目录"></a> 3. buildSrcVersions 自动生成 buildSrc 目录</h2><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2ptZmF5YXJkL2J1aWxkU3JjVmVyc2lvbnM=" title="https://github.com/jmfayard/buildSrcVersions"><code>buildSrcVersions</code> 插件的项目地址<i class="fa fa-external-link"></i></span></p><p>首先，我们在根目录的 <code>build.gradle</code> 中引入插件：</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">buildscript &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line">plugins &#123;</span><br><span class="line">  id(<span class="string">"de.fayard.buildSrcVersions"</span>) version <span class="string">"0.3.2"</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Don't put any code before the buildscripts &#123;&#125; and plugins &#123;&#125; block</span></span><br></pre></td></tr></table></figure><p>这个插件增加了 <code>buildSrcVersions</code> 这个 gradle task。</p><p>运行这个 task，它就会扫描并读取你的依赖项，并以此自动生成 <code>buildSrc</code> 目录。</p><p>运行的结果如下：<br><img alt="buildSrcVersions Result" data-src="https://pic2.superbed.cn/item/5ce99625451253d178df7b87.jpg"></p><p>接下来，我们就可以将 <code>build.gradle</code> 中的依赖换成使用 <code>Libs</code> 进行引用</p><p><img alt="build.gradle with buildSrc" data-src="https://pic.superbed.cn/item/5ce9971a451253d178df821a.jpg"></p><p>可以看到，上面这些依赖都是染了色的，也就是说它们可以直接跳转到对应的定义，而且也可以进行补全。</p><p>同时，<code>buildSrcVersions</code> 还具备检查更新的能力，如果你已经生成过 <code>buildSrc</code> 了，那么再次运行 <code>buildSrcVersions</code> task 就会对你的依赖项进行更新检查，可用的新版本会以注释的形式附在对应依赖项字符串的后面。</p><p><img alt="buildSrcVersions Update" data-src="https://pic.superbed.cn/item/5ce99890451253d178df8c1e.jpg"></p><p>当然，它是不会随便改你的代码的，这个更新它只是进行一下提示，到底要不要使用新版本还是根据项目情况来决定。</p><p>不过，这个好用的插件也是有缺陷的：</p><p>首先，它会生成一个空的 <code>settings.gradle.kts</code> 文件，因为工程中只能有一个 <code>settings.gradle</code>，所以当它为空时还好，但是如果你往里面填东西，就会让 gradle 摸不着头脑，导致编译不稳定</p><p>对此，我们需要让它自动将 <code>settings.gradle</code> 文件删掉，为 <code>buildSrcVersions</code> task 增加一个 <code>doLast()</code> 即可：</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tasks[<span class="string">"buildSrcVersions"</span>].doLast &#123; delete(<span class="string">"$&#123;rootDir.path&#125;/buildSrc/settings.gradle.kts"</span>) &#125;</span><br></pre></td></tr></table></figure><p>其次，它会导致 <code>build configuration</code> 失败，如图：</p><p><img alt data-src="https://pic.superbed.cn/item/5ce99ac2451253d178df9b03.jpg"></p><p>其原因在于它的进程会占用 <code>build/dependenciesUpdate</code> 导致 <code>task(&quot;clean&quot;)</code> 无法创建。</p><p>虽然不影响工程的 Sync 和构建，但是有这个黄条总归是看的不爽的。</p><p>最后，它并不能自动的帮你改你的 <code>build.gradle</code>，需要你手动修改，当第一次使用这个东西的时候需要打的字还挺多的。</p><p>不过，比起它能自动快速构建 <code>buildSrc</code> 来说，也还算得上是瑕不掩瑜。</p><h2 id="4-一些潜在的坑"><a class="markdownIt-Anchor" href="#4-一些潜在的坑"></a> 4. 一些潜在的坑</h2><p>如果你选择使用 <code>buildSrcVersions</code> 插件，那么请将 Android 构建相关的版本号单独放置在一个新文件中：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AndroidVersions.kt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">object</span> AndroidVersions &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">val</span> compileSdkVersion = <span class="number">28</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">val</span> targetSdkVersion = <span class="number">28</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">val</span> minSdkVersiosn = <span class="number">20</span></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>因为每次 <code>buildSrcVersions</code> 运行都有可能会替换掉它生成的 <code>Versions.kt</code> 和 <code>Libs.kt</code></p><p>如果你选择自己编写 <code>buildSrc</code> 目录，务必注意以下几件事情：</p><ol><li>使用正确的目录结构</li></ol><blockquote><p><code>buildSrc</code> 遵循默认的 Java/Kotlin 目录结构，即 <code>buildSrc/src/main/java/...</code></p></blockquote><ol start="2"><li>不要忘记加 <code>jcenter()</code></li></ol><blockquote><p>不要忘记在 <code>buildSrc/build.gradle.kts</code> 中增加 <code>jcenter()</code>，否则 <code>kotlin-dsl</code> 插件是加载不成功的</p></blockquote><p>最后，也希望我的这篇文章能给大家提高劳动生产率吧，毕竟谁都想偷懒不是？😆</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;如果你开发过稍微有点体量的 Android App，都会因为越来越多的 Gradle 依赖而头疼。&lt;/p&gt;&lt;p&gt;一个 App 的编译依赖少则十几项，多则几十项，如果再加上多 module，那么依赖的统一管理就很重要了。&lt;/p&gt;&lt;p&gt;但是，如何高效统一管理，则是一个难题。今天就来说说如何使用 buildSrcVersions 轻松管理 gradle 依赖。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Android" scheme="https://wafer.li/categories/Android/"/>
    
    
      <category term="Android" scheme="https://wafer.li/tags/Android/"/>
    
      <category term="Gradle" scheme="https://wafer.li/tags/Gradle/"/>
    
  </entry>
  
  <entry>
    <title>递归树分析归并排序算法复杂度</title>
    <link href="https://wafer.li//Algorithm/%E9%80%92%E5%BD%92%E6%A0%91%E5%88%86%E6%9E%90%E5%BD%92%E5%B9%B6%E7%AE%97%E6%B3%95%E5%A4%8D%E6%9D%82%E5%BA%A6/"/>
    <id>https://wafer.li//Algorithm/递归树分析归并算法复杂度/</id>
    <published>2018-02-18T18:36:00.000Z</published>
    <updated>2018-02-20T04:42:12.000Z</updated>
    
    <content type="html"><![CDATA[<p>之前学算法分析的时候只知道通过数语句来计算算法的复杂度，而对于递归算法没有很好的方法；</p><p>由于递归算法通常采用分治思路，每递归一次，子问题在增多，但是子问题的规模在减少，所以如何去计算这种递归类算法的复杂度呢？<br>斯坦福的教授提供了一种使用 <strong>递归树</strong> 的方法。</p><a id="more"></a><h2 id="归并的复杂度"><a class="markdownIt-Anchor" href="#归并的复杂度"></a> 归并的复杂度</h2><p>这里我们采用经典的归并排序算法作为一个例子，使用递归树来分析它的复杂度。</p><p>我们知道，归并排序算法主要分为三个步骤：</p><ol><li>递归左半部分</li><li>递归右半部份</li><li>将排好序的左半边和右半边合并</li></ol><p>对于归并(merge)部分，我们可以很清楚地计算出其复杂度：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">for k from 0 to N-1:</span><br><span class="line">    if A[i] &lt; B[j]:</span><br><span class="line">        C[k] = A[i]</span><br><span class="line">        i++</span><br><span class="line">    else if B[j] &lt; A[i]:</span><br><span class="line">        C[k] = B[j]</span><br><span class="line">        j++</span><br></pre></td></tr></table></figure><p>首先在循环部分，循环的每一次执行了 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>4</mn></mrow><annotation encoding="application/x-tex">4</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.64444em;vertical-align:0"></span><span class="mord">4</span></span></span></span> 次操作，所以一共需要 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>4</mn><mi>N</mi></mrow><annotation encoding="application/x-tex">4N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord">4</span><span class="mord mathdefault" style="margin-right:.10903em">N</span></span></span></span> 次操作；</p><p>然后初始化 <code>i</code> 和 <code>j</code> 需要两次操作；</p><p>所以，归并部分一共执行 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>4</mn><mi>N</mi><mo>+</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">4N + 2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76666em;vertical-align:-.08333em"></span><span class="mord">4</span><span class="mord mathdefault" style="margin-right:.10903em">N</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:.64444em;vertical-align:0"></span><span class="mord">2</span></span></span></span> 次操作，由于 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>N</mi><mo>≥</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">N \ge 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.8193em;vertical-align:-.13597em"></span><span class="mord mathdefault" style="margin-right:.10903em">N</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.64444em;vertical-align:0"></span><span class="mord">1</span></span></span></span>，所以：</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>4</mn><mi>N</mi><mo>+</mo><mn>2</mn><mo>≤</mo><mn>6</mn><mi>N</mi></mrow><annotation encoding="application/x-tex">4N + 2 \le 6N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76666em;vertical-align:-.08333em"></span><span class="mord">4</span><span class="mord mathdefault" style="margin-right:.10903em">N</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:.78041em;vertical-align:-.13597em"></span><span class="mord">2</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord">6</span><span class="mord mathdefault" style="margin-right:.10903em">N</span></span></span></span></span></p><p>粗糙一点，我们可以使用 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>6</mn><mi>N</mi></mrow><annotation encoding="application/x-tex">6N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord">6</span><span class="mord mathdefault" style="margin-right:.10903em">N</span></span></span></span> 作为归并部分的复杂度。</p><h2 id="递归树和归并排序的复杂度"><a class="markdownIt-Anchor" href="#递归树和归并排序的复杂度"></a> 递归树和归并排序的复杂度</h2><p>对于我们的递归程序，我们采用递归树来分析它的复杂度：</p><p><img alt data-src="https://ws3.sinaimg.cn/large/006tNc79gy1fomd2buxgyj30h208vglh.jpg"></p><p>其中，横条表示的是 <strong>输入数据的长度</strong>，根节点的输入规模为 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord mathdefault" style="margin-right:.10903em">N</span></span></span></span>；</p><p>每进行一次递归，树就向下深入一层；</p><p>那么，根据二叉树结论，树的总层数为 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>log</mi><mo>⁡</mo><mi>N</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\log{N} + 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.8888799999999999em;vertical-align:-.19444em"></span><span class="mop">lo<span style="margin-right:.01389em">g</span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mord mathdefault" style="margin-right:.10903em">N</span></span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:.64444em;vertical-align:0"></span><span class="mord">1</span></span></span></span>；</p><p>对于第 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.85396em;vertical-align:-.19444em"></span><span class="mord mathdefault" style="margin-right:.05724em">j</span></span></span></span> 层，拥有 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mn>2</mn><mi>j</mi></msup></mrow><annotation encoding="application/x-tex">2^j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.824664em;vertical-align:0"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.824664em"><span style="top:-3.063em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:.05724em">j</span></span></span></span></span></span></span></span></span></span></span> 个节点，同时每个节点的输入规模为 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>N</mi><mi mathvariant="normal">/</mi><msup><mn>2</mn><mi>j</mi></msup></mrow><annotation encoding="application/x-tex">N / {2^j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0746639999999998em;vertical-align:-.25em"></span><span class="mord mathdefault" style="margin-right:.10903em">N</span><span class="mord">/</span><span class="mord"><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.824664em"><span style="top:-3.063em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:.05724em">j</span></span></span></span></span></span></span></span></span></span></span></span></p><p>所以，对于第 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.85396em;vertical-align:-.19444em"></span><span class="mord mathdefault" style="margin-right:.05724em">j</span></span></span></span> 层，其执行的操作数为：</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mn>2</mn><mi>j</mi></msup><mo>×</mo><mn>6</mn><mo stretchy="false">(</mo><mi>N</mi><mi mathvariant="normal">/</mi><msup><mn>2</mn><mi>j</mi></msup><mo stretchy="false">)</mo><mo>=</mo><mn>6</mn><mi>N</mi></mrow><annotation encoding="application/x-tex">2^j \times 6(N/2^j) = 6N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.957994em;vertical-align:-.08333em"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.874664em"><span style="top:-3.1130000000000004em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:.05724em">j</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1.124664em;vertical-align:-.25em"></span><span class="mord">6</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:.10903em">N</span><span class="mord">/</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.874664em"><span style="top:-3.1130000000000004em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:.05724em">j</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord">6</span><span class="mord mathdefault" style="margin-right:.10903em">N</span></span></span></span></span></p><p>而二叉树一共有 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>log</mi><mo>⁡</mo><mi>N</mi></mrow><annotation encoding="application/x-tex">\log{N}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.8888799999999999em;vertical-align:-.19444em"></span><span class="mop">lo<span style="margin-right:.01389em">g</span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mord mathdefault" style="margin-right:.10903em">N</span></span></span></span></span> 层，所以，归并排序的总复杂度是：</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">(</mo><mi>log</mi><mo>⁡</mo><mi>N</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mn>6</mn><mi>N</mi><mo>=</mo><mn>6</mn><mi>N</mi><mi>log</mi><mo>⁡</mo><mi>N</mi><mo>+</mo><mn>6</mn><mi>N</mi></mrow><annotation encoding="application/x-tex">(\log{N} + 1) \times 6N = 6N\log{N} + 6N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:.01389em">g</span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mord mathdefault" style="margin-right:.10903em">N</span></span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord">6</span><span class="mord mathdefault" style="margin-right:.10903em">N</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.8888799999999999em;vertical-align:-.19444em"></span><span class="mord">6</span><span class="mord mathdefault" style="margin-right:.10903em">N</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mop">lo<span style="margin-right:.01389em">g</span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mord mathdefault" style="margin-right:.10903em">N</span></span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord">6</span><span class="mord mathdefault" style="margin-right:.10903em">N</span></span></span></span></span></p><p>所以，我们就得到了归并排序的总复杂度 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mi>log</mi><mo>⁡</mo><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N\log{N})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathdefault" style="margin-right:.02778em">O</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:.10903em">N</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mop">lo<span style="margin-right:.01389em">g</span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mord mathdefault" style="margin-right:.10903em">N</span></span><span class="mclose">)</span></span></span></span></p><h2 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h2><p>这里来总结一下使用递归树进行算法分析的步骤：</p><ol><li>计算递归的每一步中的复杂度</li><li>按照递归的分裂程度，画出不同的递归树</li><li>分析 <strong>每一层</strong> 的时间复杂度，重点关注<strong>节点数量</strong>和<strong>该层每节点的输入规模</strong></li><li>每一层的复杂度乘以层数，就是递归算法的总复杂度</li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;之前学算法分析的时候只知道通过数语句来计算算法的复杂度，而对于递归算法没有很好的方法；&lt;/p&gt;&lt;p&gt;由于递归算法通常采用分治思路，每递归一次，子问题在增多，但是子问题的规模在减少，所以如何去计算这种递归类算法的复杂度呢？&lt;br&gt;斯坦福的教授提供了一种使用 &lt;strong&gt;递归树&lt;/strong&gt; 的方法。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Algorithm" scheme="https://wafer.li/categories/Algorithm/"/>
    
    
      <category term="Algorithm" scheme="https://wafer.li/tags/Algorithm/"/>
    
      <category term="Algorithm Analysis" scheme="https://wafer.li/tags/Algorithm-Analysis/"/>
    
  </entry>
  
  <entry>
    <title>GPG + Yubikey 4 折腾手记</title>
    <link href="https://wafer.li//GPG/GPG%20+%20Yubikey%204%20%E6%8A%98%E8%85%BE%E6%89%8B%E8%AE%B0/"/>
    <id>https://wafer.li//GPG/GPG + Yubikey 4 折腾手记/</id>
    <published>2018-01-21T16:30:00.000Z</published>
    <updated>2018-01-22T13:55:23.000Z</updated>
    
    <content type="html"><![CDATA[<p>GPG 相信很多人都折腾过，Yubikey 也有很多人买过；</p><p>但是好像只有老外折腾过 Yubikey + GPG 的；</p><p>最近刚折腾完毕，因为自己不慎还把一个老钥匙搞丢了，现在只能随它去了；</p><p>这里就写写我折腾过程中遇到的坑，前车之鉴，后事之师。</p><a id="more"></a><h2 id="准备-yubikey"><a class="markdownIt-Anchor" href="#准备-yubikey"></a> 准备 Yubikey</h2><p>Yubikey 买不就行了，为什么要单开一个 section 来说呢？</p><p>其实 Yubikey 目前主要有两个系列，一个是 Yubikey 4，一个是 Yubikey NEO。</p><p>这两者有什么区别呢？</p><ol><li>Yubikey 4 不支持 NFC，但是可以支持 4096 bit 的密钥</li><li>Yubikey NEO 支持 NFC，但是只能支持 2048 bit 的密钥</li></ol><p>也就是说，如果你想在手机上用，那么就只能使用 2048 bit 的密钥；</p><p>如果你想更长的密钥，就不能在手机上用。</p><p>当然，除了用于 GPG 的 Smartcard 以外，Yubikey 还可以用于两步验证等其他方面，这就要看你的需求的取舍了，这个东西在你买的时候就要考虑好。</p><h2 id="安装-gpg"><a class="markdownIt-Anchor" href="#安装-gpg"></a> 安装 GPG</h2><p>折腾 GPG 的第一步当然就是安装 GPG，我使用的是 Mac，所以直接安装 <span class="exturl" data-url="aHR0cHM6Ly9ncGd0b29scy5vcmcv" title="https://gpgtools.org/">GPGSuite<i class="fa fa-external-link"></i></span>，然后再用 <code>brew</code> 安装 <code>gnupg</code> 就行了。</p><p>不过，如果你使用 4096 bit 的密钥，那么你需要使用 <code>gpg2</code> 而不是 <code>gpg</code></p><h2 id="编辑卡的信息"><a class="markdownIt-Anchor" href="#编辑卡的信息"></a> 编辑卡的信息</h2><p>把 Yubikey 拿到手之后我们先别忙着生成密钥，首先，我们要配置一下卡的信息，其实主要就是设置卡的 PIN 和 Admin PIN，而这个在要把密钥导入卡的时候需要。</p><p>将卡插入 USB，然后执行 <code>gpg2 --card-edit</code>；</p><p>然后你就会看到卡的相关信息：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Reader ...........: Yubico Yubikey 4 OTP U2F CCID</span><br><span class="line">Application ID ...: D2760001240102010006046218630000</span><br><span class="line">Version ..........: 2.1</span><br><span class="line">Manufacturer .....: Yubico</span><br><span class="line">Serial number ....: 04621863</span><br><span class="line">Name of cardholder: Wafer Li</span><br><span class="line">Language prefs ...: zh</span><br><span class="line">Sex ..............: 男性</span><br><span class="line">URL of public key : hkp://keys.gnupg.net</span><br><span class="line">Login data .......: omyshokami@gmail.com</span><br><span class="line">Signature PIN ....: 必须</span><br><span class="line">Key attributes ...: rsa4096 rsa4096 rsa4096</span><br><span class="line">Max. PIN lengths .: 127 127 127</span><br><span class="line">PIN retry counter : 3 0 3</span><br><span class="line">Signature counter : 43</span><br><span class="line">Signature key ....: E219 29F0 DEC5 FAEC 434A  91D7 E22B 63C2 E449 298F</span><br><span class="line">      created ....: 2018-01-21 09:31:56</span><br><span class="line">Encryption key....: 20F2 E95E 0107 1097 A853  A5CC E6AB 1330 6FE4 E5D9</span><br><span class="line">      created ....: 2018-01-21 09:31:56</span><br><span class="line">Authentication key: C1A4 2561 3A5D E7D5 4CBF  CD4B 7440 5003 FFA1 4684</span><br><span class="line">      created ....: 2018-01-21 09:32:39</span><br><span class="line">General key info..: pub  rsa4096/E22B63C2E449298F 2018-01-21 Wafer Li (Gmail. Mainly used <span class="keyword">in</span> git) &lt;omyshokami@gmail.com&gt;</span><br><span class="line">sec&gt;  rsa4096/E22B63C2E449298F  创建于：2018-01-21  有效至：2020-01-21</span><br><span class="line">                                卡号：0006 04621863</span><br><span class="line">ssb&gt;  rsa4096/E6AB13306FE4E5D9  创建于：2018-01-21  有效至：2020-01-21</span><br><span class="line">                                卡号：0006 04621863</span><br><span class="line">ssb&gt;  rsa4096/74405003FFA14684  创建于：2018-01-21  有效至：2020-01-21</span><br><span class="line">                                卡号：0006 04621863</span><br></pre></td></tr></table></figure><p>然后输入 <code>admin</code>，再输入 <code>help</code>，就可以使用管理员命令并看到相关帮助：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">gpg/card&gt; admin</span><br><span class="line">允许使用管理员命令</span><br><span class="line"></span><br><span class="line">gpg/card&gt; <span class="built_in">help</span></span><br><span class="line">quit           离开这个菜单</span><br><span class="line">admin          显示管理员命令</span><br><span class="line"><span class="built_in">help</span>           显示这份在线说明</span><br><span class="line">list           列出所有可用数据</span><br><span class="line">name           更改卡持有人的姓名</span><br><span class="line">url            更改获取密钥的 URL</span><br><span class="line">fetch          根据卡中指定的 URL 获取密钥</span><br><span class="line">login          更改登录名</span><br><span class="line">lang           更改首选语言首选</span><br><span class="line">sex            更改卡持有人的性别</span><br><span class="line">cafpr          更改一个 CA 指纹</span><br><span class="line">forcesig       设定 PIN 签名是否必须</span><br><span class="line">generate       生成新的密钥</span><br><span class="line">passwd         更改或解锁 PIN 的菜单</span><br><span class="line">verify         验证 PIN 并列出所有数据</span><br><span class="line">unblock        unblock the PIN using a Reset Code</span><br><span class="line">factory-reset  destroy all keys and data</span><br></pre></td></tr></table></figure><p>最近 <code>gpg2</code> 的中文化做的不错，相信你已经看懂大概了，要修改密码，我们输入 <code>passwd</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">gpg/card&gt; passwd</span><br><span class="line">gpg: 检测到 OpenPGP 卡号 D2760001240102010006046218630000</span><br><span class="line"></span><br><span class="line">1 - change PIN</span><br><span class="line">2 - unblock PIN</span><br><span class="line">3 - change Admin PIN</span><br><span class="line">4 - <span class="built_in">set</span> the Reset Code</span><br><span class="line">Q - quit</span><br><span class="line"></span><br><span class="line">您的选择？</span><br></pre></td></tr></table></figure><p>然后我们分别输入 <code>1</code> 和 <code>2</code> 去修改 PIN 和 Admin PIN。</p><p>接着会弹出一个框让你输入原来的 PIN，那么原来的 PIN 是什么呢？</p><p>根据 Yubikey 的文档，<strong>PIN 和 Admin PIN 的出厂设置都是 12345678</strong>。</p><p>记住这个密码，如果你接下来把东西搞炸了，你还可以把 Yubikey 恢复出厂设置，这时你就需要它了。</p><p>改完密码之后我们选择 <code>Q</code> 和 <code>quit</code> 退出卡的编辑界面，注意不要 <code>Ctrl + C</code>，可能会丢失修改，最好还是使用它的退出来退出。</p><h2 id="生成密钥"><a class="markdownIt-Anchor" href="#生成密钥"></a> 生成密钥</h2><p>现在我们终于要生成密钥了，生成密钥这个很多人都讲过了，操作也就那些，这里就不再细讲，说点要注意的地方。</p><p>首先就是密钥的长度，如果你使用 Yubikey 4 的话，使用 4096 bit 的，如果你使用 Yubikey NEO 的话，那么就只能使用默认的 2048 bit 了。</p><p>但是，如果你以后想换成 Yubikey NEO 的话，那么还是用 2048 的，不要用 4096 的。</p><p>然后在生成密钥的时候为了让它得到更多的熵，多动动鼠标就行了，不需要敲键盘，否则就敲到什么命令了。</p><p>生成完毕之后，输入 <code>gpg2 --expert --edit-key KEYID</code> 进入下一个步骤。</p><h3 id="生成子密钥"><a class="markdownIt-Anchor" href="#生成子密钥"></a> 生成子密钥</h3><p>这个可能很多人没讲过，实际上 Yubikey 可以存储 3 种密钥，签名、加密和认证；</p><p>默认生成的只有签名密钥和加密密钥，并不会生成认证密钥。</p><p>认证密钥有什么用呢？我查到主要还是用于 SSH 登录，不过这次我没有折腾出来，之后可能会写另外一篇关于这个的文章。</p><p>刚才我们进入了 <code>--edit-key</code> 的界面，在这里我们输入 <code>addkey</code> 就可以增加一个子密钥了。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">gpg&gt; addkey</span><br><span class="line">主钥的私钥部分存储在卡上。</span><br><span class="line">请选择您要使用的密钥种类：</span><br><span class="line">   (3) DSA (仅用于签名)</span><br><span class="line">   (4) RSA (仅用于签名)</span><br><span class="line">   (5) ElGamal (仅用于加密)</span><br><span class="line">   (6) RSA (仅用于加密)</span><br><span class="line">   (7) DSA (自定义用途)</span><br><span class="line">   (8) RSA (自定义用途)</span><br><span class="line">  (10) ECC (sign only)</span><br><span class="line">  (11) ECC (<span class="built_in">set</span> your own capabilities)</span><br><span class="line">  (12) ECC (encrypt only)</span><br><span class="line">  (13) Existing key</span><br><span class="line">您的选择？</span><br></pre></td></tr></table></figure><p>这里之所以出现这么多选项是因为我们上面使用了 <code>--expert</code> 模式，如果你要创建认证密钥，那么就必须使用这种模式。</p><p>在这里我们选择 8，用 RSA 算法来生成认证子密钥。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">RSA 密钥可能的操作：签名 加密 认证</span><br><span class="line">目前允许的操作：签名 加密</span><br><span class="line"></span><br><span class="line">   (S) 选择是否用于签名</span><br><span class="line">   (E) 选择是否用于加密</span><br><span class="line">   (A) 选择是否用于认证</span><br><span class="line">   (Q) 已完成</span><br><span class="line"></span><br><span class="line">您的选择？</span><br></pre></td></tr></table></figure><p>这里给你的选项是个开关选项，像现在的状态，我如果选择 S，上面的 <em>目前允许的操作</em> 就会变成只有加密。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">您的选择？ s</span><br><span class="line"></span><br><span class="line">RSA 密钥可能的操作：签名 加密 认证</span><br><span class="line">目前允许的操作：加密</span><br><span class="line"></span><br><span class="line">   (S) 选择是否用于签名</span><br><span class="line">   (E) 选择是否用于加密</span><br><span class="line">   (A) 选择是否用于认证</span><br><span class="line">   (Q) 已完成</span><br><span class="line"></span><br><span class="line">您的选择？</span><br></pre></td></tr></table></figure><p>然后我们让这个密钥只能进行认证，然后生成它就行了。</p><p>最后输入 <code>save</code> 保存并退出。</p><h2 id="备份密钥"><a class="markdownIt-Anchor" href="#备份密钥"></a> 备份密钥</h2><p>注意！</p><p><strong>这个操作必须在将密钥传入 Yubikey 之前进行！</strong></p><p>备份是很重要的，一旦你将密钥传入 Yubikey 中，那么就再也取不出来了！</p><p style="font-weight:700;font-size:x-large">而且尤其注意要备份你的主密钥！</p><p></p><p>你的主密钥不仅具有签名功能，而且还代表了你的身份，如果丢失了主密钥，就意味着你的身份就此丢失，你只能创建一个新的密钥，并把原来的吊销掉。</p><p>这里尤其要注意：</p><p style="font-weight:700;font-size:xx-large">请记住你的密钥 passphrase</p><p></p><p>因为 GPG 在导入一个私钥的时候会要求它的密码，如果你把它忘记了，那么你就丢失了你的密钥。</p><p>使用下面的命令来导出你的私钥：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpg2 --armor --export-secret-keys KEYID &gt;&gt; private.asc</span><br></pre></td></tr></table></figure><p>请好好保存它，并记住它的密码。</p><h2 id="转移密钥到-yubikey"><a class="markdownIt-Anchor" href="#转移密钥到-yubikey"></a> 转移密钥到 Yubikey</h2><p>当你备份并保存好你的主私钥之后，就可以将密钥传入 Yubikey 了。</p><p>当然其实也可以不将主密钥传到 Yubikey 中，不过在有了良好备份的情况下，我们就可以追求更高的安全性，毕竟把你的私钥保存在电脑里面总是不好的。</p><p>进入密钥编辑模式：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpg2 --edit-key KEYID</span><br></pre></td></tr></table></figure><p>输入 <code>toggle</code>，然后输入 <code>keytocard</code>，输入 <code>y</code> 确认将主密钥传入 Yubikey 中，然后选择 <code>1</code>，将主密钥作为签名密钥。</p><p>这时就会把你的主密钥传到 Yubikey 中，这时它就会问你密钥的密码，还有 Yubikey 的 Admin PIN。</p><p>输入 <code>key 1</code> 选择<strong>第二个</strong>密钥：</p><p><img alt data-src="https://ws1.sinaimg.cn/large/006tNc79ly1fnppmejbx9j307b06ft8m.jpg"></p><p>这时候你的第二个密钥就会有个 <code>*</code>，如上图所示。</p><p>然后继续输入 <code>keytocard</code> 将密钥传入，接着选择对应的密钥类型就行了。</p><p>第二个密钥传入完成之后，我们输入 <code>key 1</code> <strong>取消选择第二个密钥</strong>。</p><p><img alt data-src="https://ws4.sinaimg.cn/large/006tNc79ly1fnpppmud1vj307b061q2u.jpg"></p><p>接着，我们再输入 <code>key 2</code> 选择第三个密钥。</p><p><img alt data-src="https://ws4.sinaimg.cn/large/006tNc79ly1fnppq8ms3xj308105lq2u.jpg"></p><p>接着再输入 <code>keytocard</code> 传入 Yubikey，选择对应的密钥类型就行了。</p><h2 id="关于-keytocard-的说明"><a class="markdownIt-Anchor" href="#关于-keytocard-的说明"></a> 关于 keytocard 的说明</h2><p>当你使用了 keytocard 之后会发现，好像你的密钥并没有传出去啊？</p><p>如果你使用 <code>gpg2 --export-secret-keys</code> 也能正常导出，这是怎么回事呢？</p><p>其实，<code>keytocard</code> 的确将你的密钥导出了，但是它在电脑里面留下了一个 stub，这个实际上是没有什么用的。</p><p>使用 <code>gpg2 --export-secret-keys</code> 可以将你的密钥导出，但是，并没有什么卵用，它不是真的私钥，如果你将你的 Yubikey 恢复出厂设置，删掉你的私钥并将这个新导出的导入。</p><p>然后你就会发现你<strong>并没有导入私钥</strong>，在你的钥匙链里面显示的你的密钥是<strong>公钥</strong>，并不是密钥对。</p><p>这也是为什么我一再强调必须备份私钥并记住密码的原因了；</p><p>假如你随便乱搞，没有备份私钥又将 Yubikey 恢复出厂设置，那么你的私钥就彻底丢失了。</p><h2 id="使用密钥"><a class="markdownIt-Anchor" href="#使用密钥"></a> 使用密钥</h2><p>GPG 能干嘛呢？可以给邮件加密，给 Git Commit 签名之类的。</p><p>或者你可以直接用 <code>gpg2 --clearsign</code> 签名一段信息；</p><p>如果你没用 Yubikey，那么 GPG 会直接询问你的密钥 passphrase；</p><p>但是如果你使用了 Yubikey，那么它就不会问你 passphrase，而是问你的 Yubikey PIN 作为密码。</p><p>如果你在 Yubikey 拔掉的时候进行 GPG 签名或者加密操作，那么它就会要求你插入智能卡。</p><p>如果你遇见了上面的情况，那么就说明你的配置成功了。</p><h2 id="yubikey-的支持性"><a class="markdownIt-Anchor" href="#yubikey-的支持性"></a> Yubikey 的支持性</h2><p>目前来看，PC 端(Mac)和 Android 都支持使用 Yubikey；</p><p>但是 Chrome 插件就不行了，还是只能使用 passphrase 解锁私钥。</p><p>这也是为什么要让你记住 passphrase 的原因。</p><h2 id="最后"><a class="markdownIt-Anchor" href="#最后"></a> 最后</h2><p>说了这么多，最后欢迎大家导入我的公钥给我发加密邮件。</p><p>我的密钥是 E449298F<br>指纹：E219 29F0 DEC5 FAEC 434A 91D7 E22B 63C2 E449 298F</p><p>你应该会至少看到 3 个标识，两个邮箱，一个 PhotoID；</p><p>其中邮箱有 Tsanie Lily(1701D0C1) 的签名。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;GPG 相信很多人都折腾过，Yubikey 也有很多人买过；&lt;/p&gt;&lt;p&gt;但是好像只有老外折腾过 Yubikey + GPG 的；&lt;/p&gt;&lt;p&gt;最近刚折腾完毕，因为自己不慎还把一个老钥匙搞丢了，现在只能随它去了；&lt;/p&gt;&lt;p&gt;这里就写写我折腾过程中遇到的坑，前车之鉴，后事之师。&lt;/p&gt;
    
    </summary>
    
    
      <category term="GPG" scheme="https://wafer.li/categories/GPG/"/>
    
    
      <category term="GPG" scheme="https://wafer.li/tags/GPG/"/>
    
      <category term="Yubikey" scheme="https://wafer.li/tags/Yubikey/"/>
    
  </entry>
  
  <entry>
    <title>解决脚注中数学公式不能渲染的问题</title>
    <link href="https://wafer.li//Hexo/%E8%A7%A3%E5%86%B3%E8%84%9A%E6%B3%A8%E4%B8%AD%E6%95%B0%E5%AD%A6%E5%85%AC%E5%BC%8F%E4%B8%8D%E8%83%BD%E6%B8%B2%E6%9F%93%E7%9A%84%E9%97%AE%E9%A2%98/"/>
    <id>https://wafer.li//Hexo/解决脚注中数学公式不能渲染的问题/</id>
    <published>2018-01-16T08:39:00.000Z</published>
    <updated>2018-02-01T17:56:49.000Z</updated>
    
    <content type="html"><![CDATA[<p>最近，鉴于性能考量，我从 MathJax 迁移到了 Katex，但是随之而来出现了一个问题，就是脚注里面的数学公式没办法渲染出来。</p><a id="more"></a><p>如图：<br><img alt="Math Cannot Render In Footnote" data-src="https://user-images.githubusercontent.com/12459199/34936577-4bafd6de-fa25-11e7-972d-6f165f2e94ab.png"></p><p>但是，如果我仅仅使用 <code>node</code> 的 REPL 和用于 markdown 渲染的 <code>markdown-it</code> 以及它的两个插件 <code>markdown-it-katex</code> 和 <code>markdonw-it-footnote</code> 分别用于提供 Katex 和脚注功能的话；</p><p>是可以渲染出 Katex 和脚注的 HTML 结构的：</p><p><img alt data-src="https://user-images.githubusercontent.com/12459199/34937236-7d5a1652-fa27-11e7-9601-8ca331a00cde.png"></p><p>这是怎么回事呢？</p><p>经过辛苦的研究之后发现，我的原本的 <code>_config.yml</code> 写的就比较有毒，很多自定义的配置都插在了原来配置的中间，而且缩进格式也不规范。</p><p>后来重新将所有配置都写在原来配置的后面，规范了一下缩进问题就解决了。</p><p>所以大家遇到这种问题的时候最好检查一下自己的 <code>_config.yml</code> 文件有没有格式上的错误，特别是缩进的错误。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;最近，鉴于性能考量，我从 MathJax 迁移到了 Katex，但是随之而来出现了一个问题，就是脚注里面的数学公式没办法渲染出来。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Hexo" scheme="https://wafer.li/categories/Hexo/"/>
    
    
      <category term="Hexo" scheme="https://wafer.li/tags/Hexo/"/>
    
      <category term="Katex" scheme="https://wafer.li/tags/Katex/"/>
    
  </entry>
  
  <entry>
    <title>解决 Travis CI 总是更新旧博客的问题</title>
    <link href="https://wafer.li//Hexo/%E8%A7%A3%E5%86%B3%20Travis%20CI%20%E6%80%BB%E6%98%AF%E6%9B%B4%E6%96%B0%E6%97%A7%E5%8D%9A%E5%AE%A2%E7%9A%84%E9%97%AE%E9%A2%98/"/>
    <id>https://wafer.li//Hexo/解决 Travis CI 总是更新旧博客的问题/</id>
    <published>2018-01-12T07:45:00.000Z</published>
    <updated>2018-01-13T04:02:33.000Z</updated>
    
    <content type="html"><![CDATA[<p>本文着重介绍一下如何解决 Travis CI 在进行自动集成的时候，总是会更新旧博客的问题。</p><p>之前有想过要把这篇文章合并到上一篇里面，不过这个问题比较隐蔽，而且较难解决，最后还是新开一篇文章来详细讲一下该怎么做，防止以后有人再被这个问题困扰。</p><a id="more"></a><h2 id="1-初级症状master-的-commit-只有两个"><a class="markdownIt-Anchor" href="#1-初级症状master-的-commit-只有两个"></a> 1. 初级症状——master 的 commit 只有两个</h2><p>在经过上一篇文章的折腾之后，Travis CI 总算是能够正常执行脚本并提交到 GitHub 上进行；</p><p>不过，如果你查看 master 的 commit 情况就会发现，你原本满满当当的页面构建历史突然就只有两个了。</p><p>博客最重要的就是积累，现在一个构建你的博客就变成新博客了，简直不能忍。</p><p>这个问题的原因在于你的博客目录下没有之前 deploy 会生成的 <code>.deploy_git</code> 这个目录；</p><p>这个目录实际上也就是你的 master 分支，在没有这个目录的情况下，<code>hexo-deploy-git</code> 插件会自动生成 <code>.deploy_git</code>，并将 <code>public</code> 复制到这个目录下；</p><p>然后插件会进行 <strong>force push</strong>！这就是你的 commit 历史会丢失的原因！</p><p>解决方法也很简单，首先你需要在本地进行一次 deploy，来恢复你的 commit 历史</p><p>然后，只需要在每次构建的时候都 <code>clone</code> 一下这个目录，这样你的历史就不会丢失了。</p><p>往 <code>.travis.yml</code> 加入如下脚本即可：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">before_install:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">git</span> <span class="string">clone</span> <span class="bullet">--branch=master</span> <span class="string">&#123;your_blog_repo_git_url&#125;</span> <span class="string">.deploy_git</span></span><br></pre></td></tr></table></figure><h2 id="2-高级症状旧博客总是被更新"><a class="markdownIt-Anchor" href="#2-高级症状旧博客总是被更新"></a> 2. 高级症状——旧博客总是被更新</h2><p>这个症状是本文的重点，也是本文最终要解决的问题。</p><p>症状的具体表现在于，博客的更新时间总是最新的；</p><p><strong>就连你没有更新过的旧博客也一样！</strong></p><p>如图所示，图片中的更新时间全部都一样，按常理来说这是不可能的。</p><p><img alt data-src="https://ws2.sinaimg.cn/large/006tNc79ly1fnedchdb50j30jn0dg0ta.jpg"></p><p>这到底是什么原因呢？</p><h3 id="21-症状原因"><a class="markdownIt-Anchor" href="#21-症状原因"></a> 2.1 症状原因</h3><p>经过一番查询之后，我查到了<span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmphbWVzcGFuLm1lLzIwMTYvMDQvMjQvcmVzdG9yZS1maWxlcy1tb2RpZmljYXRpb24tdGltZS1pbi1naXQ=" title="https://blog.jamespan.me/2016/04/24/restore-files-modification-time-in-git">这篇博文<i class="fa fa-external-link"></i></span>；</p><p>里面提到，Hexo 并不识别文章的更新时间，而是将这个更新时间交给了系统进行；</p><p>实际上 Hexo 的文章更改时间就是 markdown 文件的 <strong>最后修改时间</strong>；</p><p>到这里，原因已经很明显了：</p><p>由于 Travis CI 在构建的时候，总是 <strong>重新 clone repo</strong>，这就造成了 <strong>所有文件的最后修改时间都是最新的 clone 时间</strong>；</p><p>实际上，这并不是 Travis CI 的问题，而是 git 的问题，git 由于分布式的原因，并不会保留文件的最后修改时间；</p><p>不过，作为一个博客系统来说，我们可以采用 git 的最后 commit 时间来替代，这样子就能恢复文件的修改时间了。</p><h3 id="22-解决办法"><a class="markdownIt-Anchor" href="#22-解决办法"></a> 2.2 解决办法</h3><p>解决方案清楚之后我就开始寻找相关的实现，不过网上现有的一步到位修改文件 last modified time 的实现都不能解决 non-ASCII 的问题；</p><blockquote><p>所谓 non-ASCII 的问题就是当你的文件名含有中文或者其他的字符的时候，脚本就会炸掉，执行不下去。</p></blockquote><p>最后面还是毛主席说得好，自己动手丰衣足食，在参照了<span class="exturl" data-url="aHR0cHM6Ly9zZXJ2ZXJmYXVsdC5jb20vYS83NzQ1NzQ=" title="https://serverfault.com/a/774574">这个 StackOverflow 的答案<i class="fa fa-external-link"></i></span>之后，我编写了下面的脚本，终于解决了 non-ASCII 文件名的问题：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> shlex</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ != <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">raise</span> ImportError(<span class="string">"%s should not be used as a module."</span> % __name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 'git ls-files -z | xargs -0 -n1 -I&#123;&#125; -- git log -1 --format="%ct &#123;&#125;" &#123;&#125; | sort'</span></span><br><span class="line">git_ls_cmd = <span class="string">'git ls-files -z'</span></span><br><span class="line">xargs_cmd = <span class="string">'xargs -0 -n1 -I&#123;&#125; -- git log -1 --format="%ct &#123;&#125;" &#123;&#125;'</span></span><br><span class="line">sort_cmd = <span class="string">'sort'</span></span><br><span class="line"></span><br><span class="line">work_dir = os.getcwd()</span><br><span class="line"></span><br><span class="line">git_ls_result = subprocess.Popen(shlex.split(git_ls_cmd), stdout=subprocess.PIPE)</span><br><span class="line">xargs_result = subprocess.Popen(shlex.split(xargs_cmd), stdin=git_ls_result.stdout, stdout=subprocess.PIPE)</span><br><span class="line">result = subprocess.check_output(<span class="string">'sort'</span>, stdin=xargs_result.stdout)</span><br><span class="line"></span><br><span class="line">timestamp_file_list = [tuple(it.split(<span class="string">' '</span>, <span class="number">1</span>)) <span class="keyword">for</span> it <span class="keyword">in</span> result.decode(<span class="string">'utf-8'</span>).split(<span class="string">'\n'</span>)][:<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> timestamp, file_path <span class="keyword">in</span> timestamp_file_list:</span><br><span class="line">    os.utime(os.path.join(work_dir, file_path), (int(timestamp), int(timestamp)))</span><br></pre></td></tr></table></figure><p>你也可以在<span class="exturl" data-url="aHR0cHM6Ly9naXN0LmdpdGh1Yi5jb20vd2FmZXItbGkvYTdhNjJhNDQyM2NmMzljNDNkYzU2ZDYyOGZmNGMzNjU=" title="https://gist.github.com/wafer-li/a7a62a4423cf39c43dc56d628ff4c365">这个 gist<i class="fa fa-external-link"></i></span>里面获取其代码；</p><p>在你把 repo 克隆下来，进行了 <code>user.name</code> 和 <code>user.email</code> 的配置之后，用 <code>python3</code> 执行一下这个脚本，就能恢复文件的最后修改时间。</p><p>相关的 <code>.travis.yml</code> 配置：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">before_install:</span></span><br><span class="line">    <span class="comment"># Git Config</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">git</span> <span class="string">config</span> <span class="bullet">--global</span> <span class="string">user.name</span> <span class="string">"your_user_name"</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">git</span> <span class="string">config</span> <span class="bullet">--global</span> <span class="string">user.email</span> <span class="string">"your_email"</span></span><br><span class="line"><span class="comment"># Restore last modified time</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">chmod</span> <span class="string">+x</span> <span class="string">git_reset_mtime.py</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">python3</span> <span class="string">./git_reset_mtime.py</span></span><br></pre></td></tr></table></figure><blockquote><p>特别注意！<strong>必须使用 <code>python3</code> 执行</strong>，本脚本目前最低支持到 python 3.4</p></blockquote><blockquote><p>之所以是 3.4 是因为 Travis CI 的 python3 的最新版本就只到 3.4；<br>不能采用 3.5 之后才能使用的 <code>subprocess.run()</code></p></blockquote><h3 id="23-clone-depth-导致的问题"><a class="markdownIt-Anchor" href="#23-clone-depth-导致的问题"></a> 2.3 Clone Depth 导致的问题</h3><p>在经过上面的一番折腾之后，你会发现一个奇怪的现象：在本地测试脚本完全成功，但是把脚本放到 Travis CI 去运行却不行， <strong>最多只能恢复几天前的修改时间</strong>。</p><p>在查看了一下 Travis CI 的 log 之后，我发现：</p><p>Travis CI 默认会采用 <code>--depth=50</code> 这个参数，也就是说，它之后克隆 <strong>前 50 个 commit</strong>；</p><p>而我们的脚本需要<strong>完整的 git 历史记录</strong>才能正确的恢复文件的修改时间；</p><p>所以，我们还需要取消 Travis CI 的默认 <code>depth</code> 参数，让它克隆我们完整的 git 仓库:</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">git:</span></span><br><span class="line"><span class="attr">    depth:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><h2 id="3-最终的-travis-ci-脚本"><a class="markdownIt-Anchor" href="#3-最终的-travis-ci-脚本"></a> 3. 最终的 Travis CI 脚本</h2><p>这里给出我最终测试成功的 Travis CI 脚本给大家参考：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dist:</span> <span class="string">trusty</span></span><br><span class="line"><span class="attr">sudo:</span> <span class="string">required</span></span><br><span class="line"></span><br><span class="line"><span class="attr">addons:</span></span><br><span class="line"><span class="attr">    ssh_known_hosts:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">github.com</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">git.coding.net</span></span><br><span class="line"><span class="attr">    apt:</span></span><br><span class="line"><span class="attr">        packages:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">nasm</span></span><br><span class="line"></span><br><span class="line"><span class="attr">env:</span></span><br><span class="line"><span class="attr">    global:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">ATOM_WRITER_PATCH_URL=https://raw.githubusercontent.com/wafer-li/hexo-generator-atom-markdown-writer-meta/9f8ab23d42a60a9fa7ef8eed161f216a7716d14d/lib/generator.js</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">ATOM_WRITER_DIR=node_modules/hexo-generator-atom-markdown-writer-meta/</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">TZ=Asia/Tokyo</span></span><br><span class="line"></span><br><span class="line"><span class="attr">language:</span> <span class="string">node_js</span></span><br><span class="line"><span class="attr">node_js:</span> <span class="string">node</span></span><br><span class="line"></span><br><span class="line"><span class="attr">branches:</span></span><br><span class="line"><span class="attr">    only:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">source</span></span><br><span class="line"></span><br><span class="line"><span class="attr">git:</span></span><br><span class="line"><span class="attr">    depth:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    submodules:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="attr">cache:</span></span><br><span class="line"><span class="attr">    apt:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    directories:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">node_modules</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">before_install:</span></span><br><span class="line">    <span class="comment"># Git Config</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">sed</span> <span class="bullet">-i</span> <span class="string">'s/git@github.com:/https:\/\/github.com\//'</span> <span class="string">.gitmodules</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">git</span> <span class="string">config</span> <span class="bullet">--global</span> <span class="string">user.name</span> <span class="string">"wafer-li"</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">git</span> <span class="string">config</span> <span class="bullet">--global</span> <span class="string">user.email</span> <span class="string">"omyshokami@gmail.com"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Restore last modified time</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"git ls-files -z | while read -d '' path; do touch -d \"$(git log -1 --format=\"@%ct\" \"$path\")\" \"$path\"; done"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Submodules</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">git</span> <span class="string">submodule</span> <span class="string">update</span> <span class="bullet">--recursive</span> <span class="bullet">--remote</span> <span class="bullet">--init</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Deploy history</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">git</span> <span class="string">clone</span> <span class="bullet">--branch=master</span> <span class="bullet">--single-branch</span> <span class="attr">https://github.com/wafer-li/wafer-li.github.io.git</span> <span class="string">.deploy_git</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># SSH Setup</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">openssl</span> <span class="string">aes-256-cbc</span> <span class="bullet">-K</span> <span class="string">$encrypted_XXXXXXXXX_key</span> <span class="bullet">-iv</span> <span class="string">$encrypted_XXXXXXXXX_iv</span> <span class="bullet">-in</span> <span class="string">blog_deploy_key.enc</span> <span class="bullet">-out</span> <span class="string">blog_deploy_key</span> <span class="bullet">-d</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">eval</span> <span class="string">"$(ssh-agent -s)"</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">chmod</span> <span class="number">600</span> <span class="string">./blog_deploy_key</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ssh-add</span> <span class="string">./blog_deploy_key</span></span><br><span class="line"></span><br><span class="line"><span class="attr">install:</span> <span class="string">npm</span> <span class="string">install</span></span><br><span class="line"></span><br><span class="line"><span class="attr">before_script:</span></span><br><span class="line">    <span class="comment"># Patch atom writer generator</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">curl</span> <span class="string">$ATOM_WRITER_PATCH_URL</span> <span class="string">&gt;|</span> <span class="string">$&#123;ATOM_WRITER_DIR&#125;/lib/generator.js</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">## Theme Dependencies</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">cd</span> <span class="string">themes/next-reloaded</span></span><br><span class="line">    <span class="comment"># canvas-nest</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">git</span> <span class="string">clone</span> <span class="attr">https://github.com/theme-next/theme-next-canvas-nest</span> <span class="string">source/lib/canvas-nest</span></span><br><span class="line">    <span class="comment"># fancybox3</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">git</span> <span class="string">clone</span> <span class="attr">https://github.com/theme-next/theme-next-fancybox3</span> <span class="string">source/lib/fancybox</span></span><br><span class="line">    <span class="comment"># reading_progress</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">git</span> <span class="string">clone</span> <span class="attr">https://github.com/theme-next/theme-next-reading-progress</span> <span class="string">source/lib/reading_progress</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">    -</span> <span class="string">cd</span> <span class="string">../..</span></span><br><span class="line"></span><br><span class="line"><span class="attr">script:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">hexo</span> <span class="string">clean</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">hexo</span> <span class="string">g</span> <span class="bullet">-d</span> <span class="bullet">--config</span> <span class="string">source/_data/next.yml</span></span><br></pre></td></tr></table></figure><h2 id="4-参考资料"><a class="markdownIt-Anchor" href="#4-参考资料"></a> 4. 参考资料</h2><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmphbWVzcGFuLm1lLzIwMTYvMDQvMjQvcmVzdG9yZS1maWxlcy1tb2RpZmljYXRpb24tdGltZS1pbi1naXQ=" title="https://blog.jamespan.me/2016/04/24/restore-files-modification-time-in-git">从 Git 提交历史中「恢复」文件修改时间<i class="fa fa-external-link"></i></span></p><p><span class="exturl" data-url="aHR0cHM6Ly9zZXJ2ZXJmYXVsdC5jb20vYS83NzQ1NzQ=" title="https://serverfault.com/a/774574">How to retrieve the last modification date of all files in a git repository<i class="fa fa-external-link"></i></span></p><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL01lc3RyZUxpb24vZ2l0LXRvb2xzL2Jsb2IvbWFzdGVyL2dpdC1yZXN0b3JlLW10aW1l" title="https://github.com/MestreLion/git-tools/blob/master/git-restore-mtime">git-tools/git-restore-mtime at master · MestreLion/git-tools<i class="fa fa-external-link"></i></span></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文着重介绍一下如何解决 Travis CI 在进行自动集成的时候，总是会更新旧博客的问题。&lt;/p&gt;&lt;p&gt;之前有想过要把这篇文章合并到上一篇里面，不过这个问题比较隐蔽，而且较难解决，最后还是新开一篇文章来详细讲一下该怎么做，防止以后有人再被这个问题困扰。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Hexo" scheme="https://wafer.li/categories/Hexo/"/>
    
    
      <category term="Hexo" scheme="https://wafer.li/tags/Hexo/"/>
    
      <category term="Trivas CI" scheme="https://wafer.li/tags/Trivas-CI/"/>
    
  </entry>
  
  <entry>
    <title>Hexo 集成 Travis CI 自动部署博文</title>
    <link href="https://wafer.li//Hexo/Hexo%20%E9%9B%86%E6%88%90%20Travis%20CI%20%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2%E5%8D%9A%E6%96%87/"/>
    <id>https://wafer.li//Hexo/Hexo 集成 Travis CI 自动部署博文/</id>
    <published>2018-01-11T12:37:00.000Z</published>
    <updated>2018-01-12T19:05:33.000Z</updated>
    
    <content type="html"><![CDATA[<p>这个想法是我在折腾 Hexo Next 6.0 的时候发现的，有位仁兄在 Next 的新 repo 问如何处理 CI 问题，受到他的启发，我就开始折腾使用 Travis CI 进行博客的自动部署了。</p><a id="more"></a><h2 id="1-为什么要用-ci-来部署博客"><a class="markdownIt-Anchor" href="#1-为什么要用-ci-来部署博客"></a> 1. 为什么要用 CI 来部署博客</h2><p>遇到一项新技术，一个好习惯就是问一下自己 <strong>为什么要用这个新技术</strong>，它带来了什么好处，解决了什么问题？否则就会陷入为了使用新技术而使用新技术的陷阱之中。</p><p>那么为什么要用 CI 来部署呢？好处是显而易见的：</p><p>在未采用 CI 的时候，编写完博客总需要自己手动 <code>hexo g -d</code>，这种工作是重复性的、枯燥的，那么就应当尽量寻找让重复性的工作进行自动化的方法；</p><p>在使用 CI 之后，我只需要执行 <code>git push</code>，将博客的 markdown source 推到远端仓库，剩下的静态页面构建过程就由 CI 接手进行，而不需要我手动打字，而且还占用我的 CPU。</p><p>这虽然方便，但是不禁会有人担心：如果每 push 一次就会自己构建，博客会不会因为 push 上去了一些不好的东西而搞炸了？</p><p>其实这种担心是多余的，只需要在进行了大面积更改的时候先在本地查看一下，如果没有问题就再 push 就行了，这时候虽然需要本地生成，但是你不可能整天重构你的博客，所以 CI 的效率提升还是存在的。</p><h2 id="2-travis-ci-的配置流程"><a class="markdownIt-Anchor" href="#2-travis-ci-的配置流程"></a> 2. Travis CI 的配置流程</h2><p>本博客采用 Travis CI 作为持续集成工具，下面就介绍一下基本的配置流程。</p><p>由于 Travis CI 比较流行，注册和关联 repo 这种操作就不介绍了。</p><h3 id="21-获取相关权限"><a class="markdownIt-Anchor" href="#21-获取相关权限"></a> 2.1 获取相关权限</h3><p>在配置和使用 Travis CI 之前，我们首先要做的就是为 Travis CI 获取其所需要的权限。</p><p>当然，获取所需要的权限有很多种方法，这里推荐两种，分别为 Access Token和 Deploy Key</p><p>这两种各有好处，Deploy Key 的好处在于安全性比较高，Access Token 的好处是较为灵活。</p><p>下面每种都写了推荐使用的 repo，你可以根据你的 repo 的实际情况来选择。</p><h4 id="211-使用-depoly-key-进行部署"><a class="markdownIt-Anchor" href="#211-使用-depoly-key-进行部署"></a> 2.1.1 使用 Depoly Key 进行部署</h4><blockquote><p><strong>本方法适用于大多数的公有博客仓库</strong><br><strong>同时，仓库内不具备私有的子模块</strong><br><strong>建议首选</strong></p></blockquote><p>Deploy Key 是一个 SSH Key，区别于个人 SSH Key 的是，它仅对配置了它的仓库有效；</p><p>也就是说，如果应用使用了 Deploy Key，那么应用的权限就仅限于 repo 之中，准确的来说，是仅限于 repo 的 <strong>文件读写权限</strong>。</p><p>这就给 Deploy Key 带来了很高的安全度，即使 Key 泄漏了，威胁到的也只是设置了它的仓库，而不会威胁帐号本身。</p><p>使用了 SSH Key 也就意味着我们是使用 SSH 和 GitHub 进行连接，那么对 SSH 的配置是必不可少的；</p><h5 id="2111-密钥生成"><a class="markdownIt-Anchor" href="#2111-密钥生成"></a> 2.1.1.1 密钥生成</h5><p>首先我们要生成一对公钥和私钥，这个在很多地方都有操作介绍了，这里就不多讲。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -b 4096 -C <span class="string">"email"</span> -f key_file -N <span class="string">''</span></span><br></pre></td></tr></table></figure><p>接着，到 repo 的 Settings 里面创建一个 Deploy Key，把公钥的内容粘贴进去。</p><blockquote><p>如果是 <span class="exturl" data-url="aHR0cDovL2NvZGluZy5uZXQ=" title="http://coding.net">coding.net<i class="fa fa-external-link"></i></span> 的话，是配置在 <code>部署公钥</code> 之中。</p></blockquote><p>然后我们把公钥删掉，避免你误把它加入了 git 中。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -f key_file.pub</span><br></pre></td></tr></table></figure><h5 id="2112-使用-travis-命令行程序进行加密"><a class="markdownIt-Anchor" href="#2112-使用-travis-命令行程序进行加密"></a> 2.1.1.2 使用 Travis 命令行程序进行加密</h5><p>密钥显然是不能给别人看的，因此，我们就要把密钥通过 <code>travis</code> 程序加密。</p><p>首先，我们要安装 <code>travis</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gem install travis</span><br></pre></td></tr></table></figure><blockquote><p>如果你的 <code>ruby</code> 版本太旧，可能还需要先升级一下。<br><strong>最好在你的 repo 目录下执行 <code>travis</code> 命令</strong><br>方便 <code>travis</code> 自动识别仓库。</p></blockquote><p>然后，我们通过 <code>travis</code> 来登录：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">travis login</span><br></pre></td></tr></table></figure><p>这是为了让 <code>travis</code> 自动将加密好的东西上传到 Settings 的环境变量中，这样就不用我们配置 <code>.travis.yml</code> 文件了。</p><p>接着，我们对文件进行加密：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">travis encrypt key_file</span><br></pre></td></tr></table></figure><p>随后，我们把生成的 <code>.enc</code> 文件加入 git 中，并把私钥删掉。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rm -f key_file</span><br><span class="line">git add key_file.enc</span><br></pre></td></tr></table></figure><h5 id="2113-配置-known-hosts-和-ssh"><a class="markdownIt-Anchor" href="#2113-配置-known-hosts-和-ssh"></a> 2.1.1.3 配置 Known Hosts 和 SSH</h5><p>接下来，我们就进行 SSH 的相关配置；</p><p><strong>首先需要配置的是 Known Hosts，否则 CI 就会卡在问你是否要继续那里。</strong></p><p>然后，我们使用 <code>openssl</code> 把之前加密的文件解压成私钥，最后把私钥配置上就行了。</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">addons:</span></span><br><span class="line"><span class="attr">    ssh_known_hosts:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">github.com</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">git.coding.net</span></span><br><span class="line"></span><br><span class="line"><span class="attr">before_install:</span></span><br><span class="line">    <span class="comment"># SSH Setup</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">openssl</span> <span class="string">aes-256-cbc</span> <span class="bullet">-K</span> <span class="string">$encrypted_693585a97b8c_key</span> <span class="bullet">-iv</span> <span class="string">$encrypted_693585a97b8c_iv</span> <span class="bullet">-in</span> <span class="string">blog_deploy_key.enc</span> <span class="bullet">-out</span> <span class="string">blog_deploy_key</span> <span class="bullet">-d</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">eval</span> <span class="string">"$(ssh-agent -s)"</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">chmod</span> <span class="number">600</span> <span class="string">./blog_deploy_key</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ssh-add</span> <span class="string">./blog_deploy_key</span></span><br></pre></td></tr></table></figure><h4 id="212-获取-access-token"><a class="markdownIt-Anchor" href="#212-获取-access-token"></a> 2.1.2 获取 Access Token</h4><blockquote><p><strong>本方法适用于具有私有 Submodule 的仓库的情况</strong></p></blockquote><p>GitHub 获取 Access Token 的步骤如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Settings -&gt; Developer settings -&gt; Personal access token</span><br><span class="line">-&gt; Generate new token</span><br></pre></td></tr></table></figure><p>接着就进入创建 Access Token 的页面了，对于一个博客的 CI 来说，我们需要的权限比较少，我尝试了一下只需要 <code>public_repo</code> 的权限即可；</p><p>为了尽量保证我们 GitHub 帐号的安全，能少给权限就少给。</p><p>然后我们选择生成，此时会返回到 <code>Personal access token</code> 的页面，并显示我们刚才生成的 access token。</p><blockquote><p>需要注意的是，这个 access token <strong>只会在这一个页面显示一次</strong>，切记要复制下来，否则就只能 <strong>重新生成</strong>。</p></blockquote><p>然后我们到博客 repo 的 Travis CI 设置页面中新建一个环境变量，将这个 Access Token 粘贴到环境变量的 value 中。</p><blockquote><p>这里要注意一定要关掉 <code>Display in log</code> 的选项，否则你的 Access Token 就泄漏了。</p></blockquote><h3 id="22-只构建含有-travisyml-文件的分支"><a class="markdownIt-Anchor" href="#22-只构建含有-travisyml-文件的分支"></a> 2.2 只构建含有 <code>.travis.yml</code> 文件的分支</h3><p>对于本博客而言，我采用单 repo 双分支管理，即一个 <code>source</code> 分支保存原始的 markdown 文件，另一个 <code>master</code> 分支保存用于部署的 HTML。</p><p>对于这种情况，我们就 <strong>必须要</strong> 在 Travis CI 的 <strong>repo 设置页面</strong> 中勾选 <strong>只构建含有 <code>.travis.yml</code> 文件的分支</strong>；</p><p>由于 Travis CI 会侦听 commit 事件进行自动构建，而对于 master 上的 commit，是不含有 <code>.travis.yml</code> 文件也不需要构建的。</p><p>为了防止 Travis CI 构建 master 分支，我们就必须要勾选这个选项。</p><p>有些教程提到使用</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">branches:</span></span><br><span class="line"><span class="attr">    only:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">source</span></span><br></pre></td></tr></table></figure><p>也可以起到只构建 <code>source</code> 的功能；<br>不过在我这里这种方法行不通，最后还是使用了只构建含有 <code>.travis,yml</code> 文件的方法。</p><h3 id="23-travisyml-文件的基本配置"><a class="markdownIt-Anchor" href="#23-travisyml-文件的基本配置"></a> 2.3 <code>.travis.yml</code> 文件的基本配置</h3><p>本博客使用的 Hexo 框架是采用 Node.js 技术编写的，所以可以直接套用 Node.js 的 Travis CI 流程。</p><p>下面是一些基本的 Node.js <code>.travis.yml</code> 的配置</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 环境变量，注意一个 item 就会构建一次</span></span><br><span class="line"><span class="comment"># 所以一次构建中需要多个环境变量的，也要写到一行里</span></span><br><span class="line"><span class="attr">env:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ENV_1=xxxxxx</span> <span class="string">ENV_2=yyyyyy</span></span><br><span class="line"></span><br><span class="line"><span class="attr">language:</span> <span class="string">node_js</span>   <span class="comment"># 构建的编程语言</span></span><br><span class="line"><span class="attr">node_js:</span> <span class="string">node</span>       <span class="comment"># Node.js 的版本，node 表示最新版</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 缓存的目录</span></span><br><span class="line"><span class="comment"># Node.js 项目一般缓存 node_modules</span></span><br><span class="line"><span class="comment"># 用于加快构建速度</span></span><br><span class="line"><span class="attr">cache:</span></span><br><span class="line"><span class="attr">  directories:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"node_modules"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 install 阶段之前执行的命令</span></span><br><span class="line"><span class="attr">before_install:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Install 阶段，在这里是 npm install</span></span><br><span class="line"><span class="attr">install:</span> <span class="string">npm</span> <span class="string">install</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 script 之前执行的命令</span></span><br><span class="line"><span class="attr">before_script:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Script 阶段，执行 hexo 相关命令</span></span><br><span class="line"><span class="attr">script:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">hexo</span> <span class="string">clean</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">hexo</span> <span class="string">g</span> <span class="bullet">-d</span> <span class="bullet">--config</span> <span class="string">source/_data/next.yml</span></span><br></pre></td></tr></table></figure><p>在拥有 <code>.travis.yml</code> 文件后，每次 commit 之后 Travis CI 就会读取这个文件用来进行自动化构建工作</p><h2 id="3-相关的坑"><a class="markdownIt-Anchor" href="#3-相关的坑"></a> 3. 相关的坑</h2><p>当然，Travis CI 的配置不可能这么一帆风顺，还存在着非常多的坑。</p><p>下面就来介绍一下我所遇到的坑，希望给大家以前车之鉴。</p><h3 id="31-git-submodule-的坑"><a class="markdownIt-Anchor" href="#31-git-submodule-的坑"></a> 3.1 Git Submodule 的坑</h3><p>如果你的 GitHub 使用了两步验证，那么你平时肯定是使用 ssh 的地址进行 git 的相关操作；</p><p>但是对于 Travis CI 的虚拟机来说，它不具备你的 SSH key，当然也就不能使用 ssh 地址进行 clone 和 push。</p><p>特别是对于 git submodule，由于 Travis CI 自己可以处理 https 地址的 submodule，但是如果采用 ssh 方式，它根本就无法 clone 下来。</p><p>此时，我们就需要自己手动管理 git submodule，在 <code>.travis.yml</code> 中增加如下选项：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">git:</span></span><br><span class="line"><span class="attr">    submodules:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="attr">before_install:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">sed</span> <span class="bullet">-i</span> <span class="string">'s/git@github.com:/https:\/\/github.com\//'</span> <span class="string">.gitmodules</span></span><br></pre></td></tr></table></figure><p>上面的 <code>sed</code> 命令就是将 ssh 地址替换成 https 地址的。</p><p>不过，对于后面的部署阶段，由于要 push 到自己的仓库，所以 deploy 的地址需要修改为 <code>https://&lt;username&gt;:&lt;ACCESS_TOKEN&gt;@github.com/&lt;username&gt;/repo.git</code></p><p>所以，如果使用 <code>hexo-deploy</code> 插件的话，还需要以下的命令：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">before_script:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">sed</span> <span class="string">i</span> <span class="string">"s/git@github.com:/https:\/\/yourusername:$&#123;ACCESS_TOKEN&#125;@github.com\//"</span> <span class="string">you_config_file.yml</span></span><br></pre></td></tr></table></figure><p>把上面的 <code>yourusername</code> 和 <code>your_config_file.yml</code> 作出相应修改即可。</p><h3 id="32-安装某些额外程序包"><a class="markdownIt-Anchor" href="#32-安装某些额外程序包"></a> 3.2 安装某些额外程序包</h3><p>如果你使用 <code>hexo-all-minifier</code> 来进行 HTML 的相关文件压缩，那么你就需要额外安装一个系统程序包 <code>nasm</code>。</p><p>Travis CI 对此推出了 <code>addons</code> 选项来方便你配置：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">addons:</span></span><br><span class="line"><span class="attr">  apt:</span></span><br><span class="line"><span class="attr">    packages:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">nasm</span></span><br></pre></td></tr></table></figure><p>这个问题比较难暴露，我查看了很久的 log，最后在 <code>npm install</code> 的 log 里面发现了某个依赖没办法安装；</p><p>最后才发现是缺了一个系统的程序包。</p><h3 id="33-patch-某些-hexo-插件"><a class="markdownIt-Anchor" href="#33-patch-某些-hexo-插件"></a> 3.3 Patch 某些 Hexo 插件</h3><p>有时候你使用的 Hexo 插件有些问题，虽然有人提出了 PR，但是久久没有合并；</p><p>在本地生成的时代，你需要自己手动 patch 这个插件，然而我们现在使用 CI，当然不可能由你进去复制粘贴。</p><p>这时候，我们可以使用 <code>curl</code> 把 patch 文件下载下来，并覆写相关文件。</p><p>通过下面的命令可以进行覆写操作：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl &#123;raw-path-file-url&#125; &gt;| &#123;problem_file&#125;</span><br></pre></td></tr></table></figure><p>其中 <code>&gt;|</code> 符号可以使后面的文件清空，类似于文件操作的 <code>w</code> 选项。</p><h3 id="34-安装-hexo-next-主题的插件"><a class="markdownIt-Anchor" href="#34-安装-hexo-next-主题的插件"></a> 3.4 安装 Hexo Next 主题的插件</h3><p>Hexo Next 在 6.0 之后，把一些原本在 <code>source/lib</code> 中的 js 文件移到了新的 repo 中，以减少 next 本身 repo 的复杂度。</p><p>但是由于 Next 把 <code>source/lib</code> 这个路径 ignore 了，所以我们要手动将插件 clone 到 <code>source/lib</code> 里面。</p><p>在使用 CI 时，我们需要在 <code>hexo g -d</code> 之前将插件装好：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">before_script:</span></span><br><span class="line">  <span class="comment">## Theme Dependencies</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">cd</span> <span class="string">themes/next-reloaded</span></span><br><span class="line">  <span class="comment"># canvas-nest</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">git</span> <span class="string">clone</span> <span class="attr">https://github.com/theme-next/theme-next-canvas-nest</span> <span class="string">source/lib/canvas-nest</span></span><br><span class="line">  <span class="comment"># fancybox3</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">git</span> <span class="string">clone</span> <span class="attr">https://github.com/theme-next/theme-next-fancybox3</span> <span class="string">source/lib/fancybox</span></span><br><span class="line">  <span class="comment"># reading_progress</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">git</span> <span class="string">clone</span> <span class="attr">https://github.com/theme-next/theme-next-reading-progress</span> <span class="string">source/lib/reading_progress</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">cd</span> <span class="string">../..</span></span><br></pre></td></tr></table></figure><p>这里需要注意一下当前工作路径的问题，记得切换回原目录。</p><h3 id="35-时区问题"><a class="markdownIt-Anchor" href="#35-时区问题"></a> 3.5 时区问题</h3><p>Travis CI 好像默认使用的是美国的时区，这样就会让你的 master commit 历史变得很乱。</p><p>所以，我们有必要让 Travis CI 和你的本机时区进行统一</p><p>这个配置比较简单，通过设置 <code>TZ</code> 环境变量即可。</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">env:</span></span><br><span class="line"><span class="attr">    global:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">TZ=Asia/Tokyo</span></span><br></pre></td></tr></table></figure><blockquote><p>别吐槽我为什么用日本时区，玩游戏需要。</p></blockquote><p>这里需要多说一点的是，如果只有 <code>env</code>，如：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">env:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ENV1=xxxx</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ENV2=yyyy</span></span><br></pre></td></tr></table></figure><p>此时，Travis CI 就会进行 <strong>两次</strong> 构建，分别采用 <code>ENV1</code> 和 <code>ENV2</code></p><p>而对于 <code>global</code> 的环境变量，就会采取所有的环境变量，只构建一次。</p><h2 id="4-总结"><a class="markdownIt-Anchor" href="#4-总结"></a> 4. 总结</h2><p>经过一段时间的奋战，Travis CI 的集成终于做好了；<br>虽然花费了点时间，不过在折腾的过程中还接触了一下 Travis CI 的配置流程，想必还是有些收获的；</p><p>要不人们总说折腾博客比写博客有趣呢？</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;这个想法是我在折腾 Hexo Next 6.0 的时候发现的，有位仁兄在 Next 的新 repo 问如何处理 CI 问题，受到他的启发，我就开始折腾使用 Travis CI 进行博客的自动部署了。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Hexo" scheme="https://wafer.li/categories/Hexo/"/>
    
    
      <category term="Hexo" scheme="https://wafer.li/tags/Hexo/"/>
    
      <category term="Trivas CI" scheme="https://wafer.li/tags/Trivas-CI/"/>
    
  </entry>
  
  <entry>
    <title>Solidity 基础知识和概述</title>
    <link href="https://wafer.li//Solidity/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E5%92%8C%E6%A6%82%E8%BF%B0/"/>
    <id>https://wafer.li//Solidity/基础知识和概述/</id>
    <published>2018-01-09T06:09:00.000Z</published>
    <updated>2019-05-25T15:26:35.000Z</updated>
    
    <content type="html"><![CDATA[<p>Solidity 是运行于以太坊(Ethereum) 区块链上的智能合约语言，它是图灵完备的，意味着可以用它写一些任意复杂度的程序并运行于区块链中。</p><a id="more"></a><h2 id="1-区块链基础知识"><a class="markdownIt-Anchor" href="#1-区块链基础知识"></a> 1. 区块链基础知识</h2><p>区块链加密货币的技术基础，本文属于 Solidity，对此不过多介绍，可能在以后会在其他文章进行介绍。</p><h3 id="11-交易"><a class="markdownIt-Anchor" href="#11-交易"></a> 1.1 交易</h3><p>区块链形象的来说就是一个全球共享的交易数据库，这意味着每个人都可以访问这个数据库并发起更改，这个更改就是 <strong>交易</strong>。</p><p>区块链对交易有单一性保证，也就是当你的交易正在提交到数据库的时候，其他的交易不能影响你的交易。</p><p>同时，区块链对交易有完成保证，意思就是一个交易，要不就 <strong>全部完成</strong>，要不就 <strong>都不完成</strong>。不会出现一方余额变动，而另一方却不变的情况。</p><p>其次，一个交易总是由发起方进行密码学方面的签名(signed)，这也就保证交易的来源方的可信赖性。只有拥有对应的密钥键值对，才能从账户中转钱。</p><h3 id="12-区块"><a class="markdownIt-Anchor" href="#12-区块"></a> 1.2 区块</h3><p>交易数据库都有一个需要处理的基本问题：如果两个交易都想清空一个账户的余额怎么办？这在比特币的术语中叫做 <strong>“doble-spend attack”</strong>，也就是交易之间出现了冲突。</p><p>区块链对此作出的回答是， <strong>你不需要担心这种问题</strong>。<br>区块链会对交易的顺序作出选择，此时，这些交易会被捆绑进一个 <strong>区块</strong> 中，当两个交易出现冲突的时候，排在后面的交易就会被抛弃而不会进入区块中。</p><p>这些区块在时间上呈现出一种线性的形状，因而我们将这些区块所构成的系统，也就是上面的交易数据库称为 <strong>区块链</strong></p><p>而区块链中所应用的交易选择机制，也就是交易的公证机制，我们称其为 <strong>挖矿</strong></p><p>之所以称其为挖矿，原因在于新的包含 <strong>你所承认的交易</strong> 的区块是通过一系列的计算得到的，这个新区块的生成很类似从一堆数据中把金子挖出来的过程。</p><p>区块计算成功后，区块链系统会给予挖矿者奖励，在比特币系统中是赠与比特币，以太币系统则是奖励以太币。</p><p>当然，一个区块也有可能会被退回(reverted)，不过是仅当这个区块位于区块链的头部的时候；当越来越多的区块被加到区块链的头部之后，你所计算出的区块被退回的可能性就会越来越低。</p><h2 id="2-以太坊虚拟机evm"><a class="markdownIt-Anchor" href="#2-以太坊虚拟机evm"></a> 2. 以太坊虚拟机(EVM)</h2><p>以太坊虚拟机(Ethereum Virtual Machine) 是以太坊合约(contract)的运行环境，也即 Solidity 的运行环境。</p><p>和普通的虚拟机不同的是，EVM 不是一个沙盒系统，而是 <strong>完全独立的</strong></p><p>运行在 EVM 中的合约不能访问互联网、文件系统或者其他的进程，只能和运行于 EVM 的其他合约进行交互。</p><p>EVM 中有如下概念：</p><h3 id="21-账户accounts"><a class="markdownIt-Anchor" href="#21-账户accounts"></a> 2.1 账户(Accounts)</h3><p>EVM 中有着两种账户：<br>一种称为外来账户(External owned Accounts)，是使用公私有的键值对控制访问的，也就是真实人类控制的帐号。</p><p>另一种称为合约账户(Contract Accounts)，是含有代码的合约控制的帐号，代码被存储在合约中。</p><p>账户通过地址来进行标识；<br>外部账户的地址通过其 public key 来确定；<br>合约账户的地址是在其被创建的时候确定的，通过它的创建者(即交易的发送者)的地址和从创建者地址发送的交易数量来确定。</p><p>EVM 对于这两种账户都是平等对待的，不管它存不存储着代码。</p><p>每个账户都有着一个持久化的 key-value <code>mapping</code>(类似 <code>HashMap</code>)。<code>key</code> 和 <code>value</code> 分别是 256bit words 和 256bit words。这个 <code>mapping</code> 被称为 <code>storage</code></p><p>同时，每个账户都具有 <strong>以太币</strong> 的余额(balance)，可以通过发送以太币的交易来修改。</p><p>两种账户的对比</p><ul><li>外部账户(External Accounts)<ul><li>具有以太币余额</li><li>可以发送交易(可以发送或者触发合约代码)</li><li>使用键值对来控制</li><li>不储存有代码</li></ul></li></ul><hr><ul><li>合约账户(Contract Accounts)<ul><li>具有以太币余额</li><li>储存有代码</li><li>其代码的执行通过交易或者其他合约发送的信息来触发</li><li>当其代码执行时，可以：<ul><li>执行任意复杂度的操作(图灵完备)</li><li>修改其自身的持久性存储(storage)</li><li>调用其他合约</li></ul></li></ul></li></ul><h3 id="22-交易transactions"><a class="markdownIt-Anchor" href="#22-交易transactions"></a> 2.2 交易(Transactions)</h3><p>交易是一个账户发给另一个帐号的消息，交易可以包含二进制的数据(称为它的负载)，和以太币</p><p>如果目标账户具有代码，那么这个代码就会被执行，并且交易会提供其负载充当代码的输入数据。</p><p>如果目标账户是 <strong>零账户(zero-account)</strong>(它的账户的地址是 0)，那么，该交易就会创建一个 <strong>新的合约</strong>。上面已经说过，合约的地址是通过发送者的地址来确定的。</p><p>此时，交易的负载就会充当合约的构建参数，此时，EVM 开始执行构造函数，进行合约的构建，其结果即合约的代码，被存入合约账户中。</p><p>也就是说，不需要传入合约本身的代码即可完成合约的构建</p><h3 id="23-汽油gas"><a class="markdownIt-Anchor" href="#23-汽油gas"></a> 2.3 汽油(Gas)</h3><p>汽油是以太坊用于衡量执行交易的工作量的单位。</p><p>由于发起交易有可能导致合约的执行，代码执行就需要 CS 领域中的时间与空间，即需要矿工的算力来作为支撑。</p><p>为了保证网络中的算力不被大规模消耗和锁死，以太坊中的每一个交易都需要消耗汽油来完成，即交易的 <strong>手续费</strong>。</p><p>之所以称之为 <strong>汽油</strong>，是因为这个“手续费”是需要事先从交易发起者的账户中扣除掉，与该交易绑定，很类似一个汽车加油的过程。</p><p>唯一不同的是，<strong>交易的发起者可以自定义汽油的价格</strong></p><p>也就是说，交易发起者通过事先从账户中扣除一定量的 <strong>以太</strong>，作为充入的汽油；<br>充入的以太费用 = 汽油量 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>×</mo></mrow><annotation encoding="application/x-tex">\times</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.66666em;vertical-align:-.08333em"></span><span class="mord">×</span></span></span></span> 自定义的汽油价格，汽油量实际上是通过充入的以太费用倒推得到的。</p><p>这也就类似于一个加油的过程。</p><p>然后，矿工开始处理交易，并按照一定的规则 <strong>不断消耗汽油</strong></p><p>当计算完成时，区块被生成，并加入区块链中，矿工得到所消耗的汽油的以太费用作为交易的手续费；<br>同时， <strong>多余的汽油会被退还回交易发起者的账户</strong>。</p><p>但是，如果汽油耗尽，交易还未处理完成的话，那么矿工就会 <strong>回退所有修改</strong>，并将该交易作为 <strong>失败的交易</strong> 加入到区块链中，同时， <strong>收取所有的汽油费用，不退换给发起者。</strong></p><h3 id="24-存储-内存和栈"><a class="markdownIt-Anchor" href="#24-存储-内存和栈"></a> 2.4 存储, 内存和栈</h3><h4 id="241-存储storage"><a class="markdownIt-Anchor" href="#241-存储storage"></a> 2.4.1 存储(Storage)</h4><p>每一个帐号都会具有一个 256bit -&gt; 256 bit 的键值对，这个键值对被称作 <code>storage</code><br>在合约中进行 <code>storage</code> 的遍历和枚举是不可能的，而且在 <code>storage</code>的读写操作都是相对昂贵的。</p><blockquote><p>即通常用于存储一些持久化的数据，所以称作 <code>storage</code></p></blockquote><p>事实上 <code>storage</code> 的读写是十分昂贵的，它需要 20000 gas 进行一次初始化，需要 5000 gas 来进行数据的修改，同时还需要 200 gas 进行一个 word 的读取。</p><p>为什么需要这么贵呢？是因为存储在 <code>storage</code> 的数据是永久保存在区块链中的，需要真实的存储开销。</p><h4 id="242-内存memory"><a class="markdownIt-Anchor" href="#242-内存memory"></a> 2.4.2 内存(Memory)</h4><p>第二个存储类型是 <code>memory</code>，就像内存一样，<code>memory</code> 仅在合约运行中有效，当合约运行完成时，内存就会被清空重置。</p><p>内存是线性的并被字节编码；<br>对于读取操作来说，只能一次性读取 256bit 的数据，即一个 word;<br>而对于写入操作来说，可以写入 8bit 或者 256bit。</p><p>当你读写超过了一个 word 的时候，内存以 word(256bit) 的级别扩大；<br>当然，随着内存的扩大，就要相应收取 gas 作为费用。<br>需要注意的是，内存每扩大一个数量级，都是平方级别的，所以不要过多使用内存，否则会消耗很多 gas。</p><p>相比 <code>storage</code> 来说，<code>memory</code> 的处理开销就便宜很多。<br>它只需要 3 gas 来读写数据，如果内存扩大了那么就收取一些扩容费用的 gas。</p><p>一般来说，内存就是通常的工作用地，基本的，不需要永久存储的东西都可以放到内存中。</p><h4 id="243-栈stack"><a class="markdownIt-Anchor" href="#243-栈stack"></a> 2.4.3 栈(Stack)</h4><p>EVM 不像传统的计算机是一个以寄存器为主的机器，而是以栈为主的机器，所有的计算都在一个被称作 <code>stack</code> 的空间中进行。</p><p>这个栈具有 1024 个元素的容量，而且包含着一些 word。</p><p>对于栈的访问仅限于前 16 个元素；<br>在前 16 个元素中，你可以将任意一个复制到顶部，或者将任意一个元素和顶部的元素做交换。</p><p>其他的操作则是提取顶部元素(可以不止提取一个)进行计算并将结果压入栈中。</p><p>当然，你也可以将栈中的元素移到内存和存储中，不过对于比前 16 个更深一点的元素就不能访问到了，除非你将前 16 个元素移除。</p><p>通常，这个栈中的元素不会使用到，就像函数栈一样由编译器或者解释器来操作。</p><h3 id="25-指令集"><a class="markdownIt-Anchor" href="#25-指令集"></a> 2.5 指令集</h3><p>EVM 的指令集比较简短，所有的指令都是对基本数据类型和 256bit 的字的操作，包含了一般的算术运算、位运算、逻辑运算和比较运算等，同时还可以进行条件跳转和非条件跳转。</p><p>同时，合约还可以访问它所在区块的一些信息比如说区块的编号和区块的时间戳。</p><h3 id="26-信息调用message-calls"><a class="markdownIt-Anchor" href="#26-信息调用message-calls"></a> 2.6 信息调用(Message Calls)</h3><p>合约可以通过 <strong>信息调用</strong> 来调用其他的合约或者给一个非合约账户发送以太币。</p><p>信息调用和交易类似，都具备一个发送者，目标者，数据负载，以太币，汽油和返回的数据。</p><p>事实上，每一个交易都是由 top-level 的信息调用组成的，top-level 的信息调用可以创建其他信息调用。</p><p>合约可以决定通过信息调用所传递的 gas 数量，如果一个 out-of-gas exception 发生的话，调用栈中就会压入一个 error value 来标识异常的发生。</p><p>此时，只有通过该调用传送的 gas 会被消耗掉。同时，发起信息调用的合约会手动引起一个异常，以保证异常栈的呈现。</p><p>上面也说过，被调用的合约会收到一个新鲜的 <code>memory</code> 实例，并可以访问随调用传来的数据负载；</p><p>此时，系统会提供一个额外的空间用于存储这种数据负载，叫做 <code>calldata</code></p><p>当合约代码执行完毕后，它可以将数据返回，而返回的数据会存储在调用者的内存中。</p><p>调用的深度被限制在 <strong>1024</strong>，所以对于一些比较复杂的操作，使用循环会比使用递归要好。</p><h3 id="27-委托调用delegatecall调用代码callcode和库"><a class="markdownIt-Anchor" href="#27-委托调用delegatecall调用代码callcode和库"></a> 2.7 委托调用(Delegatecall)/调用代码(Callcode)和库</h3><p>委托调用是一种特别的信息调用，它可以将调用者的上下文暴露给被调用者。</p><p>下面举一个简单的例子：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">contract D &#123;</span><br><span class="line">    unit public n;</span><br><span class="line">    address public sender;</span><br><span class="line"></span><br><span class="line">    function delegatecallSetN(address _e, unit _n) &#123;</span><br><span class="line">        _e.delegatecall(byte4(sha3(&quot;setN(unit256)&quot;)), _n)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract E &#123;</span><br><span class="line">    unit public n;</span><br><span class="line">    address public sender;</span><br><span class="line">    funciton setN(unit _n) &#123;</span><br><span class="line">        n = _n;</span><br><span class="line">        sender = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当一个合约 <code>C</code> 调用 <code>D</code> 的方法时，是 <code>D</code> 的 <code>sender</code> 被设置成了 <code>C</code> ，而不是 <code>E</code> 的方法被设置。</p><p>这就是 delegatecall 和普通调用的区别，它相当于将其他合约的函数引入到了当前合约的作用域中。</p><p>引入这种调用之后，我们就可以在合约中动态调用函数，这也为我们实现 Solidity 的函数库提供了途径。</p><p>不过需要提醒的是，这个 <code>delegatecall</code> 方法是相当低级的方法， <strong>如果不做深入开发可以不管它</strong></p><h3 id="28-日志"><a class="markdownIt-Anchor" href="#28-日志"></a> 2.8 日志</h3><p>EVM 也提供从底层直至区块层级的日志功能，用这些功能来实现 <strong>事件系统</strong></p><p>但是，合约在它被创建之后就不能访问日志数据，不过日志数据可以从区块链的外部被访问。</p><p>一些日志数据被存储在布隆过滤器(bloom filter)中，所以一些轻量级的客户端也可以访问部分的区块链日志。</p><h3 id="29-合约创建"><a class="markdownIt-Anchor" href="#29-合约创建"></a> 2.9 合约创建</h3><p>合约除了通过信息调用来创建以外，还可以通过一个特别的指令来创建。</p><p>指令创建和普通的信息调用创建的区别在于，在指令创建完毕之后，创建者可以获取到新合约的地址。</p><h3 id="210-自毁"><a class="markdownIt-Anchor" href="#210-自毁"></a> 2.10 自毁</h3><p>想要去除区块链中的代码的唯一途径就是通过合约的自毁。</p><p>当合约调用析构指令(<code>selfdestruct</code>) 时，合约账户中剩余的以太币会被发往制定的目标，然后，合约的 <code>storage</code> 和代码就会从区块链中删除。</p><blockquote><p>即使合约代码中不包含 <code>selfdestruct</code> 指令，它也可以通过调用 <code>delegatecall</code> 或者 <code>callcode</code> 指令来执行</p></blockquote><blockquote><p>以太坊客户端似乎还未实现旧合约和旧代码的删除功能。存储节点可以自行选择是否删除合约。</p></blockquote><blockquote><p>当期，外部账户是无法被删除的。</p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Solidity 是运行于以太坊(Ethereum) 区块链上的智能合约语言，它是图灵完备的，意味着可以用它写一些任意复杂度的程序并运行于区块链中。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Solidity" scheme="https://wafer.li/categories/Solidity/"/>
    
    
      <category term="Solidity" scheme="https://wafer.li/tags/Solidity/"/>
    
      <category term="Ethereum" scheme="https://wafer.li/tags/Ethereum/"/>
    
  </entry>
  
  <entry>
    <title>近月少女的礼仪 2.1 感想</title>
    <link href="https://wafer.li//Talk/%E8%BF%91%E6%9C%88%E5%B0%91%E5%A5%B3%E7%9A%84%E7%A4%BC%E4%BB%AA%202.1%20%E6%84%9F%E6%83%B3/"/>
    <id>https://wafer.li//Talk/近月少女的礼仪 2.1 感想/</id>
    <published>2017-06-03T17:22:00.000Z</published>
    <updated>2017-06-03T18:30:11.000Z</updated>
    
    <content type="html"><![CDATA[<p>最近这部 FD 发售之后就忍不住玩了一下；</p><p>会结合本篇《近月少女的礼仪 2》(月に寄りそう乙女の作法２)　来谈一谈感想；</p><p>内有剧透，慎点</p><a id="more"></a><h2 id="1-介绍"><a class="markdownIt-Anchor" href="#1-介绍"></a> 1. 介绍</h2><p>此次发售的 FD 主要包含两条线路：艾斯特线和春心线，不过春心线是打酱油的，就没玩。</p><p>同时收录了前传《近月少女的礼仪0》，讲述大藏衣远学生时代的故事。</p><h2 id="2-内容和感想"><a class="markdownIt-Anchor" href="#2-内容和感想"></a> 2. 内容和感想</h2><p>艾斯特是本篇的女主角，在此 FD 中是着重描写的对象；</p><p>在取得菲丽展最优秀奖之后，两人回老家拜访父母（这基本属于固定流程了），随后回到学院展开第二年的学习生活的事。</p><p>对于本篇的评价中，多有『矛盾冲突不足』的批评；</p><p>相比前作《近月少女的礼仪 1》中暗流涌动的家族纷争，《近月 2》因为主角生长在优渥的环境中，因而在设定背景中缺失了磨炼的土壤，虽有才能，但是远远不及其父母闪耀。</p><p>在 FD 中此问题进一步暴露，由于取得了最优秀奖，班上的设计天才贾斯子开始认真对待设计的作业和考试，因而我们的主角小两口接连落败。</p><p>于是他们终于发现（实际上在本篇结尾也有体现），自己的才能只不过是人家的一个小指头；</p><p>于是一个问题就出现了， <strong>自己无论如何努力，都比不过天才</strong>；</p><p>小两口对此询问了很多的人，包括在公寓的邻居们，还直接向自己的父母求助；</p><p>不过露娜的回复真的比较令人伤心：</p><blockquote><p>「自己从来没有在才能上碰过壁，请随便努力一下吧」</p></blockquote><p>说实话，玩到这里的时候我是比较揪心的，明明自己也拥有耀眼的才能，但是，却只能这样任由其被更耀眼的光芒掩盖吗？</p><p>不过，幸好我们现在是主角小两口，经过和现任校长商量之后（顺便把校长洗白了），决定组成设计师组合『eS』一同向天才挑战！</p><p>不过，既然组成了设计师组合，那么提交设计的时候，就必须放弃一人，另外一人要尽力对设计图做出点检和修正。</p><p>于是很顺理成章的就过渡到是否要放弃自己的恋人身份，以女仆的身份来面对自己的主人兼恋人。</p><p>这个选项可以说是整个近月系列中最为重要和必有的选项</p><blockquote><p>为什么是『必有』？因为这是个伪娘游戏啊！</p></blockquote><p>但是，这个选项第一次承担了 END 分支的作用，而不只是单纯的 CG 回收。</p><p>如果选择了恋人，那么最后，就因为小两口要决出胜负，而双双输给天才贾斯子；</p><blockquote><p>不过即使输给了天才，小两口还是双双获得了二等奖，还是没有决出胜负（笑）</p></blockquote><p>如果选择了女仆，那么因为艾斯特的设计得到了完善，那么就能够战胜贾斯子。</p><p>这里是最让我惊艳的，<strong>如果你不选择被 gang，那么就达不成完美结局。</strong>（看起来官方也很懂玩家的心嘛）</p><p>也许在经过这一次的经历后，我们的才华大少爷才理解并践行了父亲一直以来对他的忠告：「能为谁派上用场是很了不起的事」</p><p>原本由于露娜的原因，我第一次选的时候仍然想让他去和自己的恋人竞争；</p><p>毕竟是樱小路露娜的儿子啊，怎么会输给他人，肯定是心性还不够成熟。</p><p>不过玩到最后，果然我们的主角还是「朝日的女儿」啊（笑）。</p><h2 id="3-亮点"><a class="markdownIt-Anchor" href="#3-亮点"></a> 3. 亮点</h2><ol><li><p>贾斯子和梅宫的百合剧</p><blockquote><p>《梅宫理论及其周边》（笑）</p></blockquote></li><li><p>才华的泳装</p><blockquote><p>我们的才华大小姐越来越漂亮了</p></blockquote></li><li><p>才华走 T 台的衣服</p><blockquote><p>真的好像他妈，差点认错了</p></blockquote></li><li><p>艾斯特的姐姐</p><blockquote><p>走 T 台和妹妹抢就算了，还要和妹妹抢男朋友……</p></blockquote></li></ol><h2 id="4-缺憾"><a class="markdownIt-Anchor" href="#4-缺憾"></a> 4. 缺憾</h2><p>最大的缺憾当然还是前作主要人物露娜和游星 <strong>没有登场</strong></p><p>估计官方还想再捞一笔，毕竟有很多人都期待这两个前作的最主要人物登场；</p><p>毕竟父亲（朝日娘）看到自己儿子女装侍奉另一个主人，想起来就十分有趣！</p><h2 id="5-和一代的比较"><a class="markdownIt-Anchor" href="#5-和一代的比较"></a> 5. 和一代的比较</h2><p>当然，整体剧情的矛盾和跌宕比不上一代是公认的；</p><p>不过，《近月 2》仍不失为一部十分优秀的作品，其中，我们的大少爷（小姐）的复杂性格和追求成功的方式可能更为现实，而不像露娜一样过于虚幻。</p><p>虽说如此，如果要做 《近月 3》的话，剧情安排上势必要起波澜（比如说大藏前家主身亡，衣远独力难支，家族重新陷入动荡和纷争），否则 3 只能是当做炒冷饭作品而已，这样只会砸烂近月的金字招牌。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;最近这部 FD 发售之后就忍不住玩了一下；&lt;/p&gt;&lt;p&gt;会结合本篇《近月少女的礼仪 2》(月に寄りそう乙女の作法２)　来谈一谈感想；&lt;/p&gt;&lt;p&gt;内有剧透，慎点&lt;/p&gt;
    
    </summary>
    
    
      <category term="杂谈" scheme="https://wafer.li/categories/Talk/"/>
    
    
      <category term="杂谈" scheme="https://wafer.li/tags/Talk/"/>
    
      <category term="Galgame" scheme="https://wafer.li/tags/Galgame/"/>
    
      <category term="月に寄りそう乙女の作法" scheme="https://wafer.li/tags/%E6%9C%88%E3%81%AB%E5%AF%84%E3%82%8A%E3%81%9D%E3%81%86%E4%B9%99%E5%A5%B3%E3%81%AE%E4%BD%9C%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>再谈单例模式</title>
    <link href="https://wafer.li//DesignPattern/%E5%86%8D%E8%B0%88%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/"/>
    <id>https://wafer.li//DesignPattern/再谈单例模式/</id>
    <published>2017-05-25T02:58:00.000Z</published>
    <updated>2017-05-26T17:55:32.000Z</updated>
    
    <content type="html"><![CDATA[<p>之前提到枚举实现是单例的最佳实现，这毋庸置疑；</p><p>不过，对比枚举和静态内部类，好像它们的区别就在于防止了反射攻击；</p><p>那么，都『攻击』了，为啥偏偏没事去改你的单例呢？直接获取更有意思的信息不是更好吗？</p><a id="more"></a><h2 id="1-反射攻击不是攻击"><a class="markdownIt-Anchor" href="#1-反射攻击不是攻击"></a> 1. 『反射攻击』不是攻击</h2><p>这里所提到的『反射攻击』的概念，实际上并不是信息安全领域的 『攻击』 的概念；</p><p>而是， <strong>通过反射的合理利用，可以令单例失效</strong>；</p><p>那么在日常开发中，最常遇到的反射攻击就是 <strong>对象的序列化</strong>。</p><p>当单例需要实现序列化的时候，反序列化过程实际上就是使用 <strong>反射</strong> 来生成了新的实例。</p><p>那么在序列化和反序列化的过程中，单例模式就被破坏掉了。</p><p>这时，有人提出可以利用 <code>readResolve()</code> 方法来防止这种事情的发生；</p><p>而实际上， <strong>单纯利用</strong> <code>readResolve()</code> 也并不能防止单例被破坏；</p><p>《Effective Java 第二版》在 77 条提出：</p><blockquote><p><strong>如果依赖 <code>readResolve()</code> 方法来进行实例控制，带有对象引用类型的所有实例域都必须声明为 <code>transient</code> 的。</strong></p><p>否则，那种破釜沉舟式的攻击者，就有可能在 <code>readResolve()</code> 方法运行之前，保护指向反序列化对象的引用。</p></blockquote><p>此时，枚举类型就派上用场了，枚举为了防止这种事情的发生，单独实现了一套序列化和反序列化的机制；</p><p>大体就是利用 <code>valueOf()</code> 来进行反序列化，而不是使用普通的序列化机制；</p><p>同时，也禁止声明 <code>readResolve()</code> 和 <code>readObject()</code> 这类方法。</p><h2 id="2-kotlin-单例是懒加载的"><a class="markdownIt-Anchor" href="#2-kotlin-单例是懒加载的"></a> 2. Kotlin 单例是懒加载的</h2><p>下面是 Kotlin 单例的反编译 Java 代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Test INSTANCE;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="title">Test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      INSTANCE = (Test)<span class="keyword">this</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">static</span> &#123;</span><br><span class="line">      <span class="keyword">new</span> Test();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>虽然它和所谓的饿汉式 Java 单例很类似，但是在实际使用中，它是 <strong>懒加载</strong> 的。</p><p>为什么呢？</p><p>原因就在于 JVM 类的加载时机；</p><p>JVM Specification 中在 <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm9yYWNsZS5jb20vamF2YXNlL3NwZWNzL2p2bXMvc2U3L2h0bWwvanZtcy01Lmh0bWwjanZtcy01LjQuMg==" title="https://docs.oracle.com/javase/specs/jvms/se7/html/jvms-5.html#jvms-5.4.2">准备阶段<i class="fa fa-external-link"></i></span> 中提出：</p><blockquote><p>explicit initializers for static fields are executed as part of initialization (§5.5), not preparation.</p></blockquote><p>所以，上面的 <code>INSTANCE</code> 的实例化，即 <code>static</code> 块是在类加载的 <strong>初始化阶段</strong> 进行的；</p><p>而对于初始化阶段，JVM Specification 强制规定了有且仅有 <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm9yYWNsZS5jb20vamF2YXNlL3NwZWNzL2p2bXMvc2U3L2h0bWwvanZtcy01Lmh0bWwjanZtcy01LjU=" title="https://docs.oracle.com/javase/specs/jvms/se7/html/jvms-5.html#jvms-5.5">5 种情况<i class="fa fa-external-link"></i></span> 可以触发初始化阶段；</p><p>而这 5 种情况，都是你真正使用到类的实例的时候才会出现的；</p><p>根据这 5 种情况，再结合 Kotlin <code>object</code> 的单例语法和使用，可以得出有且仅有 2 种情况会导致 <code>object</code> 单例提前进行初始化：</p><ol><li>反射</li><li>调用类中其他的静态变量</li></ol><p>对于反射，一个很典型的应用场景就是使用 classpath scanner 进行注解扫描；</p><p>不过，JB 的工程师提出，classpath scanner 并不需要反射来实现注解扫描<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>；</p><p>于是我随便找了一个 classpath scanner: <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2x1a2VodXRjaC9mYXN0LWNsYXNzcGF0aC1zY2FubmVy" title="https://github.com/lukehutch/fast-classpath-scanner">fast-classpath-scanner<i class="fa fa-external-link"></i></span>；</p><p>经过使用之后，发现即使打印出了单例的信息，但是 JVM 只加载了 <code>main</code> 方法的类，而并没有加载单例。</p><p>相关的结果在 <span class="exturl" data-url="aHR0cHM6Ly9naXN0LmdpdGh1Yi5jb20vd2FmZXItbGkvMTkzMTE3MGZkNzljMGVjMTU2N2Y1NzM3NDU0ZjYxYWI=" title="https://gist.github.com/wafer-li/1931170fd79c0ec1567f5737454f61ab">这个 gist<i class="fa fa-external-link"></i></span> 中。</p><blockquote><p>单例的名字叫 <code>Test</code>，而 <code>main()</code> 方法类的名字叫 <code>SingletonTest</code></p></blockquote><p>对于第二种情况，在 Kotlin 中是不存在的。为什么呢？</p><p>因为对于 Kotlin <code>object</code> 中，声明值的方法只有 <code>var</code> <code>val</code> 和 <code>const val</code> 三种；</p><p>对于前两种，虽然反编译出来的代码指明这样的确定义了两个静态的值；</p><p><code>var</code> 的情况：</p><p><img alt data-src="https://ws3.sinaimg.cn/large/006tNbRwgy1ffzakmwghkj30rc0uotax.jpg"></p><p><code>val</code> 的情况：</p><p><img alt data-src="https://ws4.sinaimg.cn/large/006tNbRwgy1ffzalhmszqj30rs0ty40u.jpg"></p><p>但是，当你使用的时候，却是通过 <code>INSTANCE</code> 来引用的。</p><p>这样无论如何都会导致单例的实例化。</p><p>而使用 <code>const val</code> 的确得到了一个 <code>public static</code> 的值；</p><p>但是，当你使用的时候，编译器会自动替换为 <strong>字面量</strong>，不会导致单例加载；</p><p><img alt data-src="https://ws1.sinaimg.cn/large/006tNbRwgy1ffzamh0h4pj30tc0q276e.jpg"></p><p>所以，综上所述，Kotlin 中 <code>object</code> 单例是懒加载的。</p><hr class="footnotes-sep"><section class="footnotes"><ol class="footnotes-list"><li id="fn1" class="footnote-item"><p><span class="exturl" data-url="aHR0cHM6Ly9kaXNjdXNzLmtvdGxpbmxhbmcub3JnL3Qva290bGluLXNpbmdsZXRvbi1pbXBsZW1lbnRhdGlvbi8yODUzLzY/dT1vbXlzaG8=" title="https://discuss.kotlinlang.org/t/kotlin-singleton-implementation/2853/6?u=omysho">https://discuss.kotlinlang.org/t/kotlin-singleton-implementation/2853/6?u=omysho<i class="fa fa-external-link"></i></span> <a href="#fnref1" class="footnote-backref">↩︎</a></p></li></ol></section>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;之前提到枚举实现是单例的最佳实现，这毋庸置疑；&lt;/p&gt;&lt;p&gt;不过，对比枚举和静态内部类，好像它们的区别就在于防止了反射攻击；&lt;/p&gt;&lt;p&gt;那么，都『攻击』了，为啥偏偏没事去改你的单例呢？直接获取更有意思的信息不是更好吗？&lt;/p&gt;
    
    </summary>
    
    
      <category term="DesignPattern" scheme="https://wafer.li/categories/DesignPattern/"/>
    
    
      <category term="DesignPattern" scheme="https://wafer.li/tags/DesignPattern/"/>
    
  </entry>
  
  <entry>
    <title>Retrofit2 + Rxjava2</title>
    <link href="https://wafer.li//Android/Retrofit/Retrofit2%20+%20Rxjava2/"/>
    <id>https://wafer.li//Android/Retrofit/Retrofit2 + Rxjava2/</id>
    <published>2017-05-01T20:49:00.000Z</published>
    <updated>2017-05-01T23:25:44.000Z</updated>
    
    <content type="html"><![CDATA[<p>Retrofit 和 Rxjava 结合应该算得上是 Rxjava 在 Android 应用得最广泛的一个方面了。</p><p>这里就来讲讲关于这两个库具体组合的用法。</p><a id="more"></a><h2 id="1-添加依赖"><a class="markdownIt-Anchor" href="#1-添加依赖"></a> 1. 添加依赖</h2><p>具体需要添加的依赖库有： <code>Retrofit2</code>、<code>Rxjava2</code>、<code>RxAndroid2</code>、<code>Gson</code> 、<code>Rtrofit2</code> 到 <code>Rxjava2</code> 的转换器、<code>Retrofit2</code> 到 <code>Gson</code> 的转换器</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Retrofit</span></span><br><span class="line">compile <span class="string">'com.squareup.retrofit2:retrofit:2.2.0'</span></span><br><span class="line">compile <span class="string">group:</span> <span class="string">'com.squareup.retrofit2'</span>, <span class="string">name:</span> <span class="string">'converter-gson'</span>, <span class="string">version:</span> <span class="string">'2.2.0'</span></span><br><span class="line">compile <span class="string">group:</span> <span class="string">'com.squareup.retrofit2'</span>, <span class="string">name:</span> <span class="string">'adapter-rxjava2'</span>, <span class="string">version:</span> <span class="string">'2.2.0'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Rx*</span></span><br><span class="line">compile <span class="string">'io.reactivex.rxjava2:rxjava:2.1.0'</span></span><br><span class="line">compile <span class="string">'io.reactivex.rxjava2:rxandroid:2.0.1'</span></span><br><span class="line">compile <span class="string">'io.reactivex.rxjava2:rxkotlin:2.0.1-RC1'</span></span><br></pre></td></tr></table></figure><p>其中，<code>Gson</code> 是 JSON 解析库，也可以使用 <code>Jackson</code> 替代；</p><p>上面的 <code>rxkotlin</code> 是 <code>Rxjava</code> 的 <code>Kotlin</code> 轻量支持库；</p><p>如果不使用 Kotlin 可以无视。</p><h2 id="2-构建-api"><a class="markdownIt-Anchor" href="#2-构建-api"></a> 2. 构建 API</h2><p>使用 <code>Retrofit</code> 的第一步当然就是构建 API 接口；</p><p>不过既然我们使用的是 Rxjava2，那么，这个 API 接口当然就稍微有点不一样：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">TrendingApi</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GET(<span class="meta-string">"&#123;language&#125;"</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getTrending</span><span class="params">(<span class="meta">@Path(<span class="meta-string">"language"</span>)</span> language: <span class="type">String</span> = <span class="string">"."</span>, <span class="meta">@Query(<span class="meta-string">"since"</span>)</span> since: <span class="type">String</span>)</span></span></span><br><span class="line">            : Observable&lt;ResponseBody&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到，我们 API 返回的是一个 <code>Observable&lt;T&gt;</code> 对象，而非通常的 <code>Call&lt;T&gt;</code> 对象。</p><p>对于这个 <code>Observable</code>，假设我们的 Body 对象为 <code>T</code>，那么 <code>Observable</code> 一共有以下的几种可能情况：</p><ul><li><code>Observable&lt;T&gt;</code></li><li><code>Observable&lt;Response&lt;T&gt;&gt;</code></li><li><code>Observable&lt;Result&lt;T&gt;&gt;</code></li></ul><p>前两个自然不用说，第三个 <code>Result</code> 是 <code>Response&lt;T&gt;</code> 和 <code>Throwable</code> 的包装对象；</p><p>也就是说，如果使用 <code>Result</code> 的话，我们可以在 <code>onNext()</code> 中同时处理正常情况和异常情况。</p><blockquote><p>所谓的异常情况指的是抛出了 Exception</p></blockquote><h2 id="3-三种-observable-的区别"><a class="markdownIt-Anchor" href="#3-三种-observable-的区别"></a> 3. 三种 <code>Observable</code> 的区别</h2><p>那么这三种 <code>Observable</code> 究竟有什么区别呢？</p><p>我们来看看具体 <code>adapter-rxjava2</code> 的源码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Observable&lt;Response&lt;R&gt;&gt; responseObservable = isAsync</span><br><span class="line">      ? <span class="keyword">new</span> CallEnqueueObservable&lt;&gt;(call)</span><br><span class="line">      : <span class="keyword">new</span> CallExecuteObservable&lt;&gt;(call);</span><br><span class="line"></span><br><span class="line">  Observable&lt;?&gt; observable;</span><br><span class="line">  <span class="keyword">if</span> (isResult) &#123;</span><br><span class="line">    observable = <span class="keyword">new</span> ResultObservable&lt;&gt;(responseObservable);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isBody) &#123;</span><br><span class="line">    observable = <span class="keyword">new</span> BodyObservable&lt;&gt;(responseObservable);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    observable = responseObservable;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>从这段代码可以看到，默认的情况就是 <code>Observable&lt;Response&lt;T&gt;&gt;</code>；</p><p>而这个默认的 <code>Observable</code> 是通过执行 <code>CallEnqueueObservable</code> 或者 <code>CallExecuteObservable</code> 得到的。</p><p>然后再通过判断 <code>Observable</code> 的包装状态，对上面得到的 <code>Observable&lt;Response&lt;T&gt;&gt;</code> 进行转换。</p><h3 id="31-observablet"><a class="markdownIt-Anchor" href="#31-observablet"></a> 3.1 <code>Observable&lt;T&gt;</code></h3><p>首先来看我们的 <code>BodyObservable</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">subscribeActual</span><span class="params">(Observer&lt;? <span class="keyword">super</span> T&gt; observer)</span> </span>&#123;</span><br><span class="line">  upstream.subscribe(<span class="keyword">new</span> BodyObserver&lt;T&gt;(observer));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到，在 <code>subscribeActual()</code> 中，对我们传入的 <code>observer</code> 封装了一层外壳 <code>BodyObserver</code>；</p><p>然后将其传入上层的 <code>subscribe</code> 中，以启动网络请求。</p><p>这层外壳正是这个 <code>Adapter</code> 的关键所在，通过使用另一个对象，来处理不同的网络情况，然后再委派到我们真正传入的 <code>observer</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">BodyObserver</span>&lt;<span class="title">R</span>&gt; <span class="keyword">implements</span> <span class="title">Observer</span>&lt;<span class="title">Response</span>&lt;<span class="title">R</span>&gt;&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Observer&lt;? <span class="keyword">super</span> R&gt; observer;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> terminated;</span><br><span class="line"></span><br><span class="line">  BodyObserver(Observer&lt;? <span class="keyword">super</span> R&gt; observer) &#123;</span><br><span class="line">    <span class="keyword">this</span>.observer = observer;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Disposable disposable)</span> </span>&#123;</span><br><span class="line">    observer.onSubscribe(disposable);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Response&lt;R&gt; response)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (response.isSuccessful()) &#123;</span><br><span class="line">      observer.onNext(response.body());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      terminated = <span class="keyword">true</span>;</span><br><span class="line">      Throwable t = <span class="keyword">new</span> HttpException(response);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        observer.onError(t);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Throwable inner) &#123;</span><br><span class="line">        Exceptions.throwIfFatal(inner);</span><br><span class="line">        RxJavaPlugins.onError(<span class="keyword">new</span> CompositeException(t, inner));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!terminated) &#123;</span><br><span class="line">      observer.onComplete();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable throwable)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!terminated) &#123;</span><br><span class="line">      observer.onError(throwable);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// This should never happen! onNext handles and forwards errors automatically.</span></span><br><span class="line">      Throwable broken = <span class="keyword">new</span> AssertionError(</span><br><span class="line">          <span class="string">"This should never happen! Report as a bug with the full stacktrace."</span>);</span><br><span class="line">      <span class="comment">//noinspection UnnecessaryInitCause Two-arg AssertionError constructor is 1.7+ only.</span></span><br><span class="line">      broken.initCause(throwable);</span><br><span class="line">      RxJavaPlugins.onError(broken);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到，其实这层壳处理的并不是我们的 <code>Body</code> 对象，而是之前使用 <code>Call</code> 调用时返回的 <code>Response</code> 对象。</p><p>我们重点来看看 <code>onNext()</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Response&lt;R&gt; response)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (response.isSuccessful()) &#123;</span><br><span class="line">    observer.onNext(response.body());</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    terminated = <span class="keyword">true</span>;</span><br><span class="line">    Throwable t = <span class="keyword">new</span> HttpException(response);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      observer.onError(t);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable inner) &#123;</span><br><span class="line">      Exceptions.throwIfFatal(inner);</span><br><span class="line">      RxJavaPlugins.onError(<span class="keyword">new</span> CompositeException(t, inner));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到，当成功访问并响应的时候(2xx)，结果返回给了我们的 <code>onNext()</code> ；</p><p>而当成功访问但不成功响应的时候(4xx/5xx)，返回的结果通过 <code>HttpException</code> 的包装，然后返回给了我们的 <code>onError()</code> 方法。</p><p>而当这个壳子中出现 <code>onError()</code> 时，意味着可能出现了断网的情况，或者其他异常；</p><p>此时也是通过 <code>onError()</code> 返回到我们的观察者中。</p><p>结论：</p><ul><li>2xx 结果通过 <code>onNext()</code> 返回</li><li>4xx/5xx 结果通过 <code>onError()</code> 返回</li><li>断网和其他异常情况也通过 <code>onError()</code> 返回</li></ul><h3 id="32-observableresultt"><a class="markdownIt-Anchor" href="#32-observableresultt"></a> 3.2 <code>Observable&lt;Result&lt;T&gt;&gt;</code></h3><p><code>Result</code> 是 <code>adapter-rxjava2</code> 新增的包装类，包装了 <code>error</code> 和 <code>response</code> ；</p><p>关于它具体如何工作的，我们来看看它的源码：</p><p>首先是 <code>Result</code> 类，下面的是 <code>ResultObservable</code> 使用到的静态工厂方法和 <code>Result</code> 的构造函数：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Result&lt;T&gt; <span class="title">error</span><span class="params">(Throwable error)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (error == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"error == null"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Result&lt;&gt;(<span class="keyword">null</span>, error);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Result&lt;T&gt; <span class="title">response</span><span class="params">(Response&lt;T&gt; response)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (response == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"response == null"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Result&lt;&gt;(response, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Response&lt;T&gt; response;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Throwable error;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">Result</span><span class="params">(Response&lt;T&gt; response, Throwable error)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.response = response;</span><br><span class="line">  <span class="keyword">this</span>.error = error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到，<code>error</code> 和 <code>response</code> 是不共戴天的关系，符合 <code>Retrofit</code> 的设计。</p><p>下面我们来看看具体的 <code>ResultObservable</code> 的包装类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ResultObserver</span>&lt;<span class="title">R</span>&gt; <span class="keyword">implements</span> <span class="title">Observer</span>&lt;<span class="title">Response</span>&lt;<span class="title">R</span>&gt;&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Observer&lt;? <span class="keyword">super</span> Result&lt;R&gt;&gt; observer;</span><br><span class="line"></span><br><span class="line">    ResultObserver(Observer&lt;? <span class="keyword">super</span> Result&lt;R&gt;&gt; observer) &#123;</span><br><span class="line">      <span class="keyword">this</span>.observer = observer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Disposable disposable)</span> </span>&#123;</span><br><span class="line">      observer.onSubscribe(disposable);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Response&lt;R&gt; response)</span> </span>&#123;</span><br><span class="line">      observer.onNext(Result.response(response));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable throwable)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        observer.onNext(Result.&lt;R&gt;error(throwable));</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          observer.onError(t);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable inner) &#123;</span><br><span class="line">          Exceptions.throwIfFatal(inner);</span><br><span class="line">          RxJavaPlugins.onError(<span class="keyword">new</span> CompositeException(t, inner));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      observer.onComplete();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      observer.onComplete();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到，这回，重点在 <code>onError</code> 方法；</p><p>通过重载 <code>onError</code> 并使用 <code>Result</code> 的静态工厂；</p><p>让我们的 <code>observer</code> 也能通过 <code>onNext</code> 获取到具体的 <code>Throwable</code>；</p><p>也就是说，我们可以在 <code>onNext()</code> 处理网络错误。</p><p>而当更严重的错误发生时，<code>onError()</code> 才会被调用</p><p>结论：</p><p>网络异常和正常的网络内容都通过 <code>onNext()</code> 进行处理。</p><h3 id="33-observableresponset-的获取"><a class="markdownIt-Anchor" href="#33-observableresponset-的获取"></a> 3.3 <code>Observable&lt;Response&lt;T&gt;&gt;</code> 的获取</h3><p>那么作为关键的 <code>Observable&lt;Response&lt;T&gt;&gt;</code> 对象是从哪里获取的呢？</p><p>让我们将目光转向在开头的两个 <code>Call</code> 开头的 <code>Observable</code>；</p><p>很容易知道，一个对应了 <code>Retrofit</code> 的 <code>call.execute()</code>；</p><p>而另外一个对应了 <code>call.enqueue()</code></p><p>为了简便，我们只看 <code>execute()</code> 部分的源码：</p><p>下面就是关键的 <code>subscribeActual</code> 方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">subscribeActual</span><span class="params">(Observer&lt;? <span class="keyword">super</span> Response&lt;T&gt;&gt; observer)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Since Call is a one-shot type, clone it for each new observer.</span></span><br><span class="line">  Call&lt;T&gt; call = originalCall.clone();</span><br><span class="line">  observer.onSubscribe(<span class="keyword">new</span> CallDisposable(call));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">boolean</span> terminated = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    Response&lt;T&gt; response = call.execute();</span><br><span class="line">    <span class="keyword">if</span> (!call.isCanceled()) &#123;</span><br><span class="line">      observer.onNext(response);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!call.isCanceled()) &#123;</span><br><span class="line">      terminated = <span class="keyword">true</span>;</span><br><span class="line">      observer.onComplete();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">    Exceptions.throwIfFatal(t);</span><br><span class="line">    <span class="keyword">if</span> (terminated) &#123;</span><br><span class="line">      RxJavaPlugins.onError(t);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!call.isCanceled()) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        observer.onError(t);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Throwable inner) &#123;</span><br><span class="line">        Exceptions.throwIfFatal(inner);</span><br><span class="line">        RxJavaPlugins.onError(<span class="keyword">new</span> CompositeException(t, inner));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到，通过调用 <code>call.execute()</code> 获取 <code>Response</code> 对象；</p><p>然后将获取到的 <code>Response</code> 对象进行传递，就实现了一个 <code>Observable</code> 的功能。</p><h3 id="34-原理和结论"><a class="markdownIt-Anchor" href="#34-原理和结论"></a> 3.4 原理和结论</h3><p>通过以上的源码解读，我们得出了 <code>adapter-rxjava2</code> 的具体原理：</p><p>首先通过 <code>CallExecuteObservable</code> 获取到 <code>Observable&lt;Response&lt;T&gt;&gt;</code> 对象；</p><p>然后根据不同的 <code>Observable</code> 类型对这个对象进行变换，最后传出，得到了我们需要的 <code>Observable</code>；</p><p>在调用 <code>Observable.subscribe(observer)</code> 时；</p><p>首先是最外层的 <code>subscribeActual()</code> 被调用；</p><p>然后被层层传递，直到 <code>CallExecuteObservable</code> 的 <code>subscribeActual()</code> 调用 <code>call.execute()</code>；</p><p>然后将 <code>Response</code> 向下进行层层传递，完成了整个订阅流程。</p><p>结论：</p><ol><li><p>只有最后 <code>subscribe()</code> 调用，才会触发网络请求</p><blockquote><p>在此之前可以先保留 <code>Observable</code> 对象；<br>直到需要的时候再进行调用</p></blockquote></li><li><p><code>Observable&lt;T&gt;</code> 的 2xx 结果在 <code>onNext()</code> 调用，4xx/5xx 结果在 <code>onError()</code> 调用</p></li><li><p><code>Observable&lt;Result&lt;T&gt;&gt;</code> 的 <code>error</code> 和 <code>response</code> 都在 <code>onNext()</code> 调用</p></li></ol><h2 id="4-创建-retrofit-实例"><a class="markdownIt-Anchor" href="#4-创建-retrofit-实例"></a> 4. 创建 <code>Retrofit</code> 实例</h2><p>当我们的 API 创建好之后，我们就可以开始创建 <code>Retrofit</code> 实例；</p><p>为了能够使用 Rxjava，必须给 <code>Retrofit</code> 加上 <code>CallAdapterFactory</code>：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> retrofitBuilder: Retrofit.Builder =</span><br><span class="line">         Retrofit.Builder()</span><br><span class="line">                 .baseUrl(BASE_URL)</span><br><span class="line">                 .addCallAdapterFactory(RxJava2CallAdapterFactory.create())</span><br><span class="line">                 .addConverterFactory(GsonConverterFactory.create(gson))</span><br></pre></td></tr></table></figure><p>这里来说一下有关 <code>RxJava2CallAdapterFactory</code> 的几个 <code>create()</code> 的区别；</p><p>这个工厂一共有三个静态构造方法：</p><ul><li><code>create()</code></li><li><code>createAsync()</code></li><li><code>createScheduler(scheduler)</code></li></ul><p>第一个是产生一个同步的 <code>Adapter</code>，相当于调用 <code>call.execute()</code>；</p><p>同时，也不对 <code>call.execute()</code> 的线程进行提前控制。</p><p>第二个是产生一个异步的 <code>Adapter</code>，相当于调用 <code>call.enqueue()</code>；</p><blockquote><p><strong>此时，<code>Observable</code> 的 <code>subscribeOn()</code> 方法失效</strong></p></blockquote><p>第三个是指定一个 <code>Scheduler</code>，让 <code>Adapter</code> 产生的 <code>Observable</code> 一开始就 <code>subscribeOn</code> 到那个线程上。</p><h2 id="5-调用网络-api"><a class="markdownIt-Anchor" href="#5-调用网络-api"></a> 5. 调用网络 API</h2><p>终于，我们可以开始对构建起来的 API 进行调用了，调用的方法和 Rxjava 的普通使用无异；</p><p>下面给出一个基本的例子：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ApiManager.createTrendingService(TrendingApi::<span class="class"><span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">                   .<span class="title">getTrending</span>(<span class="title">since</span>)</span></span><br><span class="line"><span class="class">                   .<span class="title">subscribeOn</span>(<span class="title">Schedulers</span>.<span class="title">io</span>())</span></span><br><span class="line"><span class="class">                   .<span class="title">observeOn</span>(<span class="title">AndroidSchedulers</span>.<span class="title">mainThread</span>())</span></span><br><span class="line"><span class="class">                   .<span class="title">subscribe</span>(<span class="title">observer</span>)</span>;</span><br></pre></td></tr></table></figure><p>这里，让我们的网络请求在 <code>io()</code> 线程上发生；</p><p>然后在 Android 的主线程进行回调；</p><p>需要注意的是，我们需要使用 <code>AndroidSchedulers</code> 来进行主线程的指定。</p><blockquote><p>特别需要注意的是，<code>observeOn()</code> 是可以多次指定的<br>如果你需要对结果进行变换操作<br>请务必将 <code>observeOn()</code> 紧挨在 <code>subscribe()</code> 进行设置<br>否则就会在主线程进行请求的变换操作</p></blockquote><h2 id="6-取消请求"><a class="markdownIt-Anchor" href="#6-取消请求"></a> 6. 取消请求</h2><p>讲了这么多都是在讲发起请求，那么该如何取消请求呢？</p><p>没有了 <code>Call</code> 对象，我们该如何取消已经发出去的请求呢？</p><p>实际上 <code>adapter-rxjava2</code> 已经考虑到了这一点。</p><p>在 <code>CallExecuteObservable</code> 中，它向 <code>observer</code> 的 <code>onSubscribe()</code> 传入了一个 <code>CallDisposable</code> 对象；</p><p>通过这个 <code>CallDisposable</code>，当我们取消订阅时，就会自动地将请求取消。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CallDisposable</span> <span class="keyword">implements</span> <span class="title">Disposable</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> Call&lt;?&gt; call;</span><br><span class="line"></span><br><span class="line">   CallDisposable(Call&lt;?&gt; call) &#123;</span><br><span class="line">     <span class="keyword">this</span>.call = call;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispose</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     call.cancel();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isDisposed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> call.isCanceled();</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>所以，只要在 <code>onSubscribe()</code> 中获取到 <code>Disposable</code> 对象；</p><p>通过调用 <code>dispose()</code> 就能取消请求。</p><h2 id="7-其他"><a class="markdownIt-Anchor" href="#7-其他"></a> 7. 其他</h2><p><code>adapter-rxjava2</code> 除了支持 <code>Observable</code> 以外，还支持了 <code>Flowable</code>、<code>Single</code> 和 <code>Maybe</code> 等对象；</p><p>由于原理都是类似的，在这里就不详细展开了。</p><blockquote><p>不过，请务必注意 <code>Flowable</code> 和 <code>Observable</code> 的区别。</p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Retrofit 和 Rxjava 结合应该算得上是 Rxjava 在 Android 应用得最广泛的一个方面了。&lt;/p&gt;&lt;p&gt;这里就来讲讲关于这两个库具体组合的用法。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Android" scheme="https://wafer.li/categories/Android/"/>
    
      <category term="Retrofit" scheme="https://wafer.li/categories/Android/Retrofit/"/>
    
    
      <category term="Android" scheme="https://wafer.li/tags/Android/"/>
    
      <category term="Rxjava2" scheme="https://wafer.li/tags/Rxjava2/"/>
    
      <category term="Retrofit" scheme="https://wafer.li/tags/Retrofit/"/>
    
  </entry>
  
  <entry>
    <title>Rxjava2 坑点详解</title>
    <link href="https://wafer.li//Rxjava/Rxjava2%20%E5%9D%91%E7%82%B9%E8%AF%A6%E8%A7%A3/"/>
    <id>https://wafer.li//Rxjava/Rxjava2 坑点详解/</id>
    <published>2017-05-01T19:03:00.000Z</published>
    <updated>2017-05-01T23:30:49.000Z</updated>
    
    <content type="html"><![CDATA[<p>Rxjava，是一个响应式的(Reactive)，基于观察者模式的异步框架。</p><p>除此之外，还有其他的 RxScala 和 RxSwift 等。</p><blockquote><p>说起来现在已经 2017 年了，应该没有什么 Java 工程师不知道什么是 Rxjava 了吧</p></blockquote><a id="more"></a><p>网上关于 Rxjava 的文章已经非常多了， 如果你没有了解过 Rxjava；</p><p>那么请直接到文章最后看一些资料和教程；</p><p>这里就主要来讲讲一些 Rxjava2 的坑点。</p><h2 id="1-observable-和-flowable"><a class="markdownIt-Anchor" href="#1-observable-和-flowable"></a> 1. <code>Observable</code> 和 <code>Flowable</code></h2><p>Rxjava2 新增了一个 <code>Flowable</code>，看起来 API 调用和 <code>Observable</code> 类似，而且官方的 README 上都是 <code>Flowable</code> 的示例教程；</p><p>那么很自然的就会联想到 <code>Flowable</code> 是 <code>Obserable</code> 的替代用品；</p><p>它们的 API 调用没有什么区别；</p><p>如果你这么想那就是 <strong>大错特错</strong>！</p><p>它们俩存在一个很大的区别就是关于背压问题的处理。</p><h3 id="11-什么是背压backpressure"><a class="markdownIt-Anchor" href="#11-什么是背压backpressure"></a> 1.1 什么是背压(backpressure)</h3><p>在异步任务中，经常会出现一种情况：生产者生产产品过快，而消费者消费速率不同；</p><p>如果不做处理，那么接收端就会被发送端淹没，或者发送端堆积一大堆事件无法处理，最终导致内存爆炸。</p><p>在计算机网络中，对于这种情况的最简单处理就是采用停等模型，直到收到接收端的回报之后，才发送下一个数据。</p><p>而背压，指的就是这样一种处理策略：</p><p>通过将默认的被动接受事件的模式变成 <strong>主动请求事件</strong> ，从而避免接收端处理不及而被淹没或者 OOM 的问题。</p><h3 id="12-关于背压的不同处理"><a class="markdownIt-Anchor" href="#12-关于背压的不同处理"></a> 1.2 关于背压的不同处理</h3><p>那么两者具体的区别就是：</p><ol><li><p><code>Flowable</code> 是有背压策略的，需要<strong>主动请求事件发送</strong></p></li><li><p>而 <code>Observable</code> 是没有背压策略的，事件会自动发送，多了就会 OOM</p></li></ol><h3 id="13-具体的例子"><a class="markdownIt-Anchor" href="#13-具体的例子"></a> 1.3 具体的例子</h3><p>Observable：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Observable.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">          .subscribe(<span class="keyword">new</span> Observer&lt;Integer&gt;() &#123;</span><br><span class="line">              <span class="meta">@Override</span></span><br><span class="line">              <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Disposable d)</span> </span>&#123;</span><br><span class="line">                  <span class="comment">// Disposable 用来取消订阅</span></span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              <span class="meta">@Override</span></span><br><span class="line">              <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Integer value)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              <span class="meta">@Override</span></span><br><span class="line">              <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              <span class="meta">@Override</span></span><br><span class="line">              <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">              &#125;</span><br><span class="line">          &#125;)</span><br></pre></td></tr></table></figure><p><code>Observable</code> 对应的是 <code>Observer</code>；</p><p>这个写法是没有背压控制的，如果事件过多会 OOM</p><p>Flowable：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">Flowable.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">.subscribe(<span class="keyword">new</span> Subscriber&lt;Integer&gt;() &#123;</span><br><span class="line">    Subscription sub;</span><br><span class="line">    <span class="comment">//当订阅后，会首先调用这个方法，其实就相当于onStart()，</span></span><br><span class="line">    <span class="comment">//传入的Subscription s参数可以用于请求数据或者取消订阅</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Subscription s)</span> </span>&#123;</span><br><span class="line">        Log.w(<span class="string">"TAG"</span>,<span class="string">"onsubscribe start"</span>);</span><br><span class="line">        sub=s;</span><br><span class="line">        sub.request(<span class="number">1</span>);</span><br><span class="line">        Log.w(<span class="string">"TAG"</span>,<span class="string">"onsubscribe end"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Integer o)</span> </span>&#123;</span><br><span class="line">        Log.w(<span class="string">"TAG"</span>,<span class="string">"onNext---&gt;"</span>+o);</span><br><span class="line">        sub.request(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable t)</span> </span>&#123;</span><br><span class="line">        t.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Log.w(<span class="string">"TAG"</span>,<span class="string">"onComplete"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><code>Flowable</code> 对应的是 <code>Subscriber</code></p><p>可以看到，在具体的回调方法中，我们需要使用 <code>request()</code> 来指示上游的数据传输。</p><p>否则， <strong>数据是不会自动传输的</strong>。</p><p>还有一个有趣的地方在于上面代码的输出结果：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">onsubscribe start</span><br><span class="line">onNext---&gt;0</span><br><span class="line">onNext---&gt;1</span><br><span class="line">onNext---&gt;2</span><br><span class="line">...</span><br><span class="line">onNext---&gt;10</span><br><span class="line">onComplete</span><br><span class="line">onsubscribe end</span><br></pre></td></tr></table></figure><p>可以看到，<code>onNext</code> 在 <code>onSubscribe</code> 方法 <strong>并没有执行完毕</strong> 就开始调用了。</p><p>具体来说，是在 <code>request()</code> 之后，<code>onNext</code> 方法就立即被执行了；</p><blockquote><p>不过在实践中也不一定是这样的结果</p></blockquote><p>所以千万要注意，在 <code>request()</code> 之前就要将所有的初始化工作做好。</p><h2 id="2-线程调度"><a class="markdownIt-Anchor" href="#2-线程调度"></a> 2. 线程调度</h2><p>能够对线程进行自由调度是 Rxjava 的一大优势；</p><p>但是，由于 Rxjava 的 API 是流式调用，所以很可能会出现线程调度的坑。</p><p>具体来说，Rxjava 通过 <code>subscribeOn()</code> 和 <code>observeOn()</code> 来实现对线程的调度；</p><p>其中，<code>subscribeOn()</code> 指定的是数据的生产线程；</p><p><code>observeOn()</code> 指定的是数据的消费线程。</p><p>但是，一个很重要的区别在于：</p><ol><li><p><code>subscribeOn()</code> 只能指定一次</p><blockquote><p>如果多次指定，则以第一次为准</p></blockquote></li><li><p><code>observeOn()</code> 可以指定多次</p><blockquote><p>每指定一次，其之后流式操作所在的线程就会是指定的线程</p></blockquote></li></ol><p>举个例子：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Observable.just(getFilePath())</span><br><span class="line">           <span class="comment">//指定在新线程中创建被观察者</span></span><br><span class="line">          .subscribeOn(Schedulers.newThread())</span><br><span class="line">          <span class="comment">//将接下来执行的线程环境指定为io线程</span></span><br><span class="line">          .observeOn(Schedulers.io())</span><br><span class="line">            <span class="comment">//map就处在io线程</span></span><br><span class="line">          .map(mMapOperater)</span><br><span class="line">            <span class="comment">//将后面执行的线程环境切换为主线程，</span></span><br><span class="line">            <span class="comment">//但是这一句依然执行在io线程</span></span><br><span class="line">          .observeOn(AndroidSchedulers.mainThread())</span><br><span class="line">          <span class="comment">//指定线程无效，但这句代码本身执行在主线程</span></span><br><span class="line">          .subscribeOn(Schedulers.io())</span><br><span class="line">          <span class="comment">//执行在主线程</span></span><br><span class="line">          .subscribe(mSubscriber)</span><br></pre></td></tr></table></figure><h2 id="3-参考资料"><a class="markdownIt-Anchor" href="#3-参考资料"></a> 3. 参考资料</h2><p><span class="exturl" data-url="aHR0cHM6Ly9nYW5rLmlvL3Bvc3QvNTYwZTE1YmUyZGNhOTMwZTAwZGExMDgz" title="https://gank.io/post/560e15be2dca930e00da1083">给 Android 开发者的 RxJava 详解<i class="fa fa-external-link"></i></span></p><p><span class="exturl" data-url="aHR0cDovL3d3dy5qaWFuc2h1LmNvbS9wLzZmZDg2NDAwNDZmMQ==" title="http://www.jianshu.com/p/6fd8640046f1">关于RxJava最友好的文章<i class="fa fa-external-link"></i></span></p><p><span class="exturl" data-url="aHR0cDovL3d3dy5qaWFuc2h1LmNvbS9wL2U2MWUxMzA3ZTUzOA==" title="http://www.jianshu.com/p/e61e1307e538">关于RxJava最友好的文章（进阶）<i class="fa fa-external-link"></i></span></p><p><span class="exturl" data-url="aHR0cDovL3d3dy5qaWFuc2h1LmNvbS9wLzJjNDc5OWZhOTFhNA==" title="http://www.jianshu.com/p/2c4799fa91a4">关于RxJava最友好的文章——背压（Backpressure）<i class="fa fa-external-link"></i></span></p><p><span class="exturl" data-url="aHR0cDovL3d3dy5qaWFuc2h1LmNvbS9wLzIyMDk1NWVlZmMxZg==" title="http://www.jianshu.com/p/220955eefc1f">关于 RxJava 最友好的文章—— RxJava 2.0 全新来袭<i class="fa fa-external-link"></i></span></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Rxjava，是一个响应式的(Reactive)，基于观察者模式的异步框架。&lt;/p&gt;&lt;p&gt;除此之外，还有其他的 RxScala 和 RxSwift 等。&lt;/p&gt;&lt;blockquote&gt;&lt;p&gt;说起来现在已经 2017 年了，应该没有什么 Java 工程师不知道什么是 Rxjava 了吧&lt;/p&gt;&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="Rxjava" scheme="https://wafer.li/categories/Rxjava/"/>
    
    
      <category term="Rxjava2" scheme="https://wafer.li/tags/Rxjava2/"/>
    
      <category term="Rxjava" scheme="https://wafer.li/tags/Rxjava/"/>
    
  </entry>
  
  <entry>
    <title>Kotlin Scoping 函数</title>
    <link href="https://wafer.li//Kotlin/Kotlin%20Scoping%20%E5%87%BD%E6%95%B0/"/>
    <id>https://wafer.li//Kotlin/Kotlin Scoping 函数/</id>
    <published>2017-04-22T12:02:00.000Z</published>
    <updated>2017-04-22T16:41:32.000Z</updated>
    
    <content type="html"><![CDATA[<p>在 Kotlin 的 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0pldEJyYWlucy9rb3RsaW4vYmxvYi9tYXN0ZXIvbGlicmFyaWVzL3N0ZGxpYi9zcmMva290bGluL3V0aWwvU3RhbmRhcmQua3Q=" title="https://github.com/JetBrains/kotlin/blob/master/libraries/stdlib/src/kotlin/util/Standard.kt">Standard.kt<i class="fa fa-external-link"></i></span> 中提供了一些特殊的高阶函数；</p><p>它们被称作 <strong>Scoping 函数</strong>，此类函数通过使用一个函数 <code>block</code>，将你需要对某对象进行的一系列操作限制在 lambda 作用域内；</p><p>这样，对于该对象操作的代码就不会泄露到外层作用域，使得代码更为干净整洁。</p><p>例如：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DbConnection.getConnection().let &#123; connection -&gt;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// connection is no longer visible here</span></span><br></pre></td></tr></table></figure><p>可以看到，对于 <code>connection</code> 的操作就仅局限于 <code>let</code> 的 lambda 区域，而在 lambda 区域外是不可见的；</p><p>这就可以保证对 <code>connection</code> 的操作，不会影响到接下来的作用域。</p><a id="more"></a><h2 id="1-let"><a class="markdownIt-Anchor" href="#1-let"></a> 1. <code>let</code></h2><h3 id="11-定义"><a class="markdownIt-Anchor" href="#11-定义"></a> 1.1 定义</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T, R&gt;</span> T.<span class="title">let</span><span class="params">(f: (<span class="type">T</span>)</span></span> -&gt; R): R = f(<span class="keyword">this</span>)</span><br></pre></td></tr></table></figure><h3 id="12-例子"><a class="markdownIt-Anchor" href="#12-例子"></a> 1.2 例子</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> s = <span class="string">"hoge"</span>.let &#123; it.toUpperCase() &#125;</span><br><span class="line">println(s) <span class="comment">//=&gt; HOGE</span></span><br></pre></td></tr></table></figure><p>从定义之中我们可以看到，<code>let</code> 是所有类型都具有的扩展函数；</p><p>它的 <code>lambda</code> 的参数就是 <code>let</code> 的调用者。</p><h3 id="13-主要用途"><a class="markdownIt-Anchor" href="#13-主要用途"></a> 1.3 主要用途</h3><p><code>let</code> 的主要用途在 Kotlin 的 <span class="exturl" data-url="aHR0cHM6Ly9rb3RsaW5sYW5nLm9yZy9kb2NzL3JlZmVyZW5jZS9pZGlvbXMuaHRtbCNleGVjdXRlLWlmLW5vdC1udWxs" title="https://kotlinlang.org/docs/reference/idioms.html#execute-if-not-null">Idioms<i class="fa fa-external-link"></i></span> 中有介绍；</p><p>主要就是用于在对象 <code>nullable</code> 的时候，对对象进行操作；</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">data</span>?.let &#123;</span><br><span class="line">    ... <span class="comment">// execute this block if not null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当 <code>data</code> 为 <code>null</code> 时，<code>let</code> 就不执行，而直接返回 <code>null</code>；</p><p>否则就执行 <code>let</code> 的 lambda。</p><p>此时，它与 Java <code>Optional</code> 的以下三个函数的功能类似：</p><ul><li><code>map</code></li><li><code>flatMap</code></li><li><code>ifPresent</code></li></ul><p>可以看到，<code>let</code> 实际上就相当于集合中的 <code>map</code>，作用就是进行元素的变换功能；</p><p><img alt data-src="https://ww2.sinaimg.cn/large/006tNbRwgy1fevs5lulszj30ho08k74u.jpg"></p><p>注意，不能在 <code>let</code> 中调用 <code>it</code> 的修改方法；</p><p>否则，就会对原有对象进行改变。</p><h2 id="2-with"><a class="markdownIt-Anchor" href="#2-with"></a> 2. <code>with</code></h2><h3 id="21-定义"><a class="markdownIt-Anchor" href="#21-定义"></a> 2.1 定义</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T, R&gt;</span> <span class="title">with</span><span class="params">(receiver: <span class="type">T</span>, f: <span class="type">T</span>.()</span></span> -&gt; R): R = receiver.f()</span><br></pre></td></tr></table></figure><h3 id="22-例子"><a class="markdownIt-Anchor" href="#22-例子"></a> 2.2 例子</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> w = Window()</span><br><span class="line">with(w) &#123;</span><br><span class="line">  setWidth(<span class="number">100</span>)</span><br><span class="line">  setHeight(<span class="number">200</span>)</span><br><span class="line">  setBackground(RED)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>和 <code>let</code> 不同，<code>with</code> <strong>并不是扩展函数</strong>；</p><p>它的第一个参数，是任意类型的对象，如上面的 <code>x</code>；</p><p>需要注意的是它的 lambda 部分，它的 lambda 要求接收者（调用者）必须是第一个参数的类型；</p><p>也就是说，我们可以在它的 lambda 中调用第一个参数的方法；</p><p>正如上面的例子，其中的几个 <code>set</code> 方法都隐含了调用者是 <code>w</code></p><h3 id="23-主要用途"><a class="markdownIt-Anchor" href="#23-主要用途"></a> 2.3 主要用途</h3><p>由于指定了接收者类型，所以 <code>with</code> 函数主要用于对复杂对象的一系列配置操作。</p><p>如上面的设置 <code>Window</code> 的宽度和高度，以及背景颜色等。</p><p><img alt data-src="https://ww4.sinaimg.cn/large/006tNbRwgy1fevsj7j8fij30e60agjrw.jpg"></p><p>可以看到，<code>with</code> 的调用 <strong>会改变传入的对象</strong></p><p>实际上，这里也可以使用 <code>let</code> 函数进行这种操作；</p><p>不过由于 <code>let</code> 函数是将对象当做 <strong>参数</strong> 传入，所以如果要获得和 <code>with</code> 一样的效果，就必须在前面加 <code>it</code>：</p><p><img alt data-src="https://ww3.sinaimg.cn/large/006tNbRwly1fevslr0wr7j30iu0aijrz.jpg"></p><p>所以，<code>let</code> 并不适合这里所说的这个用途，利用 <code>let</code> 进行元素变换即可。</p><h2 id="3-run"><a class="markdownIt-Anchor" href="#3-run"></a> 3. <code>run</code></h2><h3 id="31-定义"><a class="markdownIt-Anchor" href="#31-定义"></a> 3.1 定义</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T, R&gt;</span> T.<span class="title">run</span><span class="params">(f: <span class="type">T</span>.()</span></span> -&gt; R): R = f()</span><br></pre></td></tr></table></figure><h3 id="32-例子"><a class="markdownIt-Anchor" href="#32-例子"></a> 3.2 例子</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> s = <span class="string">"hoge"</span>.run &#123; toUpperCase() &#125;</span><br><span class="line">println(s) <span class="comment">//=&gt; HOGE</span></span><br></pre></td></tr></table></figure><p>可以看到，<code>run</code> 实际上就是 <code>let</code> 和 <code>with</code> 的结合；</p><p>可以让 <code>with</code> 不需要指定 <code>receiver</code> 参数就进行对象内部属性的配置；</p><p>同时，<code>run</code> 也是一个扩展函数，可以通过任何的类进行调用。</p><h3 id="33-主要用途"><a class="markdownIt-Anchor" href="#33-主要用途"></a> 3.3 主要用途</h3><p>作为 <code>let</code> 和 <code>with</code> 的合体方法，那么最主要的用途当然还是进行某个对象的配置。</p><p><img alt data-src="https://ww1.sinaimg.cn/large/006tNbRwgy1fevw96ztszj30go0843yz.jpg"></p><p>需要注意的是，<code>run</code> 也会对对象进行改变。</p><h2 id="4-apply"><a class="markdownIt-Anchor" href="#4-apply"></a> 4. <code>apply</code></h2><h3 id="41-定义"><a class="markdownIt-Anchor" href="#41-定义"></a> 4.1 定义</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> T.<span class="title">apply</span><span class="params">(f: <span class="type">T</span>.()</span></span> -&gt; <span class="built_in">Unit</span>): T &#123; f(); <span class="keyword">return</span> <span class="keyword">this</span> &#125;</span><br></pre></td></tr></table></figure><h3 id="42-例子"><a class="markdownIt-Anchor" href="#42-例子"></a> 4.2 例子</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> s = <span class="string">"hoge"</span>.apply &#123; toUpperCase() &#125;</span><br><span class="line">println(s) <span class="comment">//=&gt; hoge</span></span><br></pre></td></tr></table></figure><p>相比之前的结果，返回的依旧是小写字符；</p><p>这是由于 <code>apply</code> 返回的是 <code>apply</code> 的调用者的缘故。</p><h3 id="43-主要用途"><a class="markdownIt-Anchor" href="#43-主要用途"></a> 4.3 主要用途</h3><p>由于 <code>apply</code> 的返回类型为调用者自身，所以可以利用 <code>apply</code> 实现一个 <strong>流式 API 调用</strong>。</p><p>实际上就是 <code>with</code> 最后返回 <code>this</code> 的简略版本。</p><p><img alt data-src="https://ww1.sinaimg.cn/large/006tNbRwgy1fevwr9abcuj30va062q3m.jpg"></p><h2 id="5-also"><a class="markdownIt-Anchor" href="#5-also"></a> 5. <code>also</code></h2><p>这是 Kotlin 1.1 新增的 scoping 函数</p><h3 id="51-定义"><a class="markdownIt-Anchor" href="#51-定义"></a> 5.1 定义</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> T.<span class="title">also</span><span class="params">(block: (<span class="type">T</span>)</span></span> -&gt; <span class="built_in">Unit</span>): T &#123; block(<span class="keyword">this</span>); <span class="keyword">return</span> <span class="keyword">this</span> &#125;</span><br></pre></td></tr></table></figure><h3 id="52-使用例子"><a class="markdownIt-Anchor" href="#52-使用例子"></a> 5.2 使用例子</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> s = <span class="string">"hoge"</span>.also &#123; it.toUpperCase() &#125;</span><br><span class="line">println(s) <span class="comment">//=&gt; hoge</span></span><br></pre></td></tr></table></figure><p>可以看到，其作用和 <code>apply</code> 一样；</p><p>但是和 <code>apply</code> 的区别在于，<code>also</code> 的函数参数并非指定接收者；</p><p>而是将调用者 <code>T</code> 当做其参数传入 lambda；</p><p>类似于 <code>let</code> 的 <code>apply</code> 版本。</p><h3 id="53-主要用途"><a class="markdownIt-Anchor" href="#53-主要用途"></a> 5.3 主要用途</h3><p>那么这样做有什么好处呢？</p><p>首先，由于 <strong>没有指定接收者</strong>，所以 lambda 内外的 <code>this</code> 的含义没有改变：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// applyを使用</span></span><br><span class="line"><span class="keyword">val</span> button = Button(<span class="keyword">this</span>).apply &#123;</span><br><span class="line">  text = <span class="string">"Click me"</span></span><br><span class="line">  setOnClickListener &#123;</span><br><span class="line">    startActivity(Intent(<span class="keyword">this</span><span class="symbol">@MainActivity</span>, NextActivity::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>))</span></span><br><span class="line">    <span class="comment">// 単なる「this」ではNG   ^</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// alsoを使用</span></span><br><span class="line"><span class="keyword">val</span> button = Button(<span class="keyword">this</span>).also &#123; button -&gt;</span><br><span class="line">  button.text = <span class="string">"Click me"</span></span><br><span class="line">  button.setOnClickListener &#123;</span><br><span class="line">    startActivity(Intent(<span class="keyword">this</span>, NextActivity::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>))</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其次，可以通过赋予 lambda 参数名字，例如上面的 <code>button</code> ，增强可读性。</p><h3 id="54-和-let-的区别"><a class="markdownIt-Anchor" href="#54-和-let-的区别"></a> 5.4 和 <code>let</code> 的区别</h3><p><code>also</code> 和 <code>let</code> 都是通过将调用者作为 lambda 的参数传入函数的形式进行调用；</p><p>其区别就在于 <code>also</code> 最终返回值为其自身的调用者，即 <code>this</code>；</p><p>而 <code>let</code> 的最终返回值由它的 lambda 的最后一个表达式的返回值决定。</p><p>类似于 <code>apply</code> 和 <code>with</code> 的区别；</p><p>同理，也可以利用 <code>let</code> 来实现上面的 <code>also</code> 实现的功能：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> button = Button(<span class="keyword">this</span>).let &#123; button -&gt;</span><br><span class="line">  button.text = <span class="string">"Click me"</span></span><br><span class="line">  button.setOnClickListener &#123;</span><br><span class="line">    startActivity(Intent(<span class="keyword">this</span>, NextActivity::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>))</span></span><br><span class="line">  &#125;</span><br><span class="line">  button <span class="comment">// letの場合はこれが必要になる</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="6-总结"><a class="markdownIt-Anchor" href="#6-总结"></a> 6. 总结</h2><ol><li><code>let</code> 用于进行元素变换操作，类似于 <code>map</code></li><li><code>with</code> 用于对复杂对象的配置，需要提供具体的对象</li><li><code>run</code> 是 <code>with</code> 的 <code>let</code> 版本，配置对象属性，不需要提供具体对象</li><li><code>apply</code> 是 <code>with</code> 的流式 API 版本</li><li><code>also</code> 是 <code>let</code> 的 <code>apply</code> 版本，用于对象配置，同时保留流式 API 和 当前 <code>this</code> 的含义</li></ol><h2 id="7-参考资料"><a class="markdownIt-Anchor" href="#7-参考资料"></a> 7. 参考资料</h2><p><span class="exturl" data-url="aHR0cDovL3FpaXRhLmNvbS9uZ3N3X3Rhcm8vaXRlbXMvZDI5ZTMwODBkOWZjOGEzODY5MWUjJUU1JUFFJTlBJUU3JUJFJUE5LTI=" title="http://qiita.com/ngsw_taro/items/d29e3080d9fc8a38691e#%E5%AE%9A%E7%BE%A9-2">Kotlin スコープ関数 用途まとめ<i class="fa fa-external-link"></i></span></p><p><span class="exturl" data-url="aHR0cDovL2JldXN0LmNvbS93ZWJsb2cvMjAxNS8xMC8zMC9leHBsb3JpbmctdGhlLWtvdGxpbi1zdGFuZGFyZC1saWJyYXJ5Lw==" title="http://beust.com/weblog/2015/10/30/exploring-the-kotlin-standard-library/">Exploring the Kotlin standard library<i class="fa fa-external-link"></i></span></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;在 Kotlin 的 &lt;a href=&quot;https://github.com/JetBrains/kotlin/blob/master/libraries/stdlib/src/kotlin/util/Standard.kt&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Standard.kt&lt;/a&gt; 中提供了一些特殊的高阶函数；&lt;/p&gt;&lt;p&gt;它们被称作 &lt;strong&gt;Scoping 函数&lt;/strong&gt;，此类函数通过使用一个函数 &lt;code&gt;block&lt;/code&gt;，将你需要对某对象进行的一系列操作限制在 lambda 作用域内；&lt;/p&gt;&lt;p&gt;这样，对于该对象操作的代码就不会泄露到外层作用域，使得代码更为干净整洁。&lt;/p&gt;&lt;p&gt;例如：&lt;/p&gt;&lt;figure class=&quot;highlight kotlin&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;DbConnection.getConnection().let &amp;#123; connection -&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// connection is no longer visible here&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;可以看到，对于 &lt;code&gt;connection&lt;/code&gt; 的操作就仅局限于 &lt;code&gt;let&lt;/code&gt; 的 lambda 区域，而在 lambda 区域外是不可见的；&lt;/p&gt;&lt;p&gt;这就可以保证对 &lt;code&gt;connection&lt;/code&gt; 的操作，不会影响到接下来的作用域。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Kotlin" scheme="https://wafer.li/categories/Kotlin/"/>
    
    
      <category term="Kotlin" scheme="https://wafer.li/tags/Kotlin/"/>
    
  </entry>
  
  <entry>
    <title>Scala for-comprehension</title>
    <link href="https://wafer.li//Scala/Scala%20for-comprehension/"/>
    <id>https://wafer.li//Scala/Scala for-comprehension/</id>
    <published>2017-04-22T05:21:00.000Z</published>
    <updated>2017-04-22T08:08:51.000Z</updated>
    
    <content type="html"><![CDATA[<p>Scala 作为函数式语言，提供了很多用于高阶函数来解决一类范式问题；</p><p>但是，使用过多的高阶函数就会让代码的可读性变差；</p><p>所以，对此 Scala 提供了一种类 Python 的简便的语法糖，用来解决代码的可读性问题。</p><a id="more"></a><h2 id="1-问题背景"><a class="markdownIt-Anchor" href="#1-问题背景"></a> 1. 问题背景</h2><p>在这里举一个 <em>Effective Scala</em> 中的例子：</p><p>比如说，我要列出所有不同字母组成的 <code>pair</code>，那么该怎么办呢？</p><p>如果用 Java 的话，就会有两层 <code>for</code>，那么在 Scala 下，我们就应该用到 <code>flatMap</code>：</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> chars = 'a' to 'z'</span><br><span class="line"></span><br><span class="line">chars flatMap &#123; a =&gt;</span><br><span class="line">    chars flatMap &#123; b =&gt;</span><br><span class="line">        <span class="type">Vector</span>(<span class="string">"%c%c"</span>.format(a, b))</span><br><span class="line">    &#125;</span><br><span class="line">&#125; filter &#123; s =&gt; s.head != s.last &#125;</span><br></pre></td></tr></table></figure><p>这里用到了两个 <code>flatMap</code>，为什么？</p><p>首先，如果都使用 <code>map</code>，那么内部的 <code>map</code> 将元素转变为了 <code>Vector</code>；</p><p>而 <code>char</code> 作为 <code>Range</code>，会默认选择 <code>Vector</code> 作为 <code>map</code> 的选项；</p><p>此时， <code>a</code> 转换成的东西就变成了 <code>Vector[Vector[String]]</code>；</p><p>而 <code>chars</code> 又会默认生成一层 <code>Vector</code>；</p><p>所以，最后生成的东西就会有三层 <code>Vector</code>，即 <code>Vector[Vector[Vector(String)]]</code>；</p><p>所以，我们需要两次 <code>flatten</code> 进行展平，才能最终得到 <code>Vector(String)</code>；</p><p>这也是为什么需要两次 <code>flatMap</code> 的原因。</p><p>可以看到，如果采用 <code>flatMap</code>，那么操作就会变得十分难以理解。</p><h2 id="2-for-comprehension"><a class="markdownIt-Anchor" href="#2-for-comprehension"></a> 2. <code>for-comprehension</code></h2><p>对此，Scala 提供了一种简便的，用于生成 <code>Seq</code> 的 <code>for</code> 表达式；</p><p>通常称为 <code>for-comprehension</code>，也称为 <code>Sequence Comprehension</code>，或者 <code>for expression</code>。</p><p>它的语法结构如下：</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (s) <span class="keyword">yield</span> e</span><br></pre></td></tr></table></figure><p>其中，<code>s</code> 被称作 <code>enumerators</code>，<code>e</code> 则是遍历生成的元素；</p><p>表达式对于 <code>s</code> 有以下几点要求：</p><ol><li><p><code>s</code> 是 <code>generator</code> 和 <code>filter</code> 组成的，以分号间隔的语句序列。</p></li><li><p><code>genrator</code> 的形式为： <code>p &lt;- c</code>。</p><blockquote><p>其中 <code>p</code> 是一个模式(pattern)，<code>c</code> 则是一个集合</p></blockquote></li><li><p><code>filter</code> 的形式为 <code>if condition</code>，其中 <code>condition</code> 是个布尔表达式</p></li><li><p>允许多个 <code>generator</code>，但是在下面的 <code>generator</code> 必须比在上面的要变化的快。</p><blockquote><p>换成指令性语言的话，就是在下面的 <code>generator</code> 必须在更内部的 <code>for</code> 循环中。</p></blockquote></li></ol><p>经过执行之后，这个表达式会返回一个由 <code>e</code> 组成的集合；</p><p>具体返回的集合类型，例如 <code>List</code> 和 <code>Vector</code>，则由 <code>s</code> 来决定；</p><p>如果类型不能满足，则会向类型结构的上一层回溯，直到找到一个最接近的满足要求的类型为止。</p><p>同时，<code>for-comprehension</code> 可以使用花括号代替圆括号，此时，就不需要用分号来分隔语句了。</p><h2 id="3-使用-for-comprehension-解决问题"><a class="markdownIt-Anchor" href="#3-使用-for-comprehension-解决问题"></a> 3. 使用 <code>for-comprehension</code> 解决问题</h2><p>那么，对于上面的问题，我们试着使用 <code>for-comprehension</code> 来解决：</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> chars = 'a' to 'z'</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">    a &lt;- chars</span><br><span class="line">    b &lt;- chars</span><br><span class="line">    <span class="keyword">if</span> (a != b)</span><br><span class="line">&#125; <span class="keyword">yield</span> <span class="string">"%c%c"</span>.format(a, b)</span><br></pre></td></tr></table></figure><p>可以看到，使用 <code>for-comprehension</code> 来解决，写出来的代码会比 <code>flatMap</code> 简单得多。</p><h2 id="4-关于返回类型"><a class="markdownIt-Anchor" href="#4-关于返回类型"></a> 4. 关于返回类型</h2><p>对于上面的表达式，它的返回类型是什么呢？</p><p>实际上，是一个 <code>Vector</code>。</p><p>为什么是一个 <code>Vector</code> ？</p><p>这是因为，<code>chars</code> 实际上是一个 <code>Range</code> 对象；</p><p>而对于 <code>Range</code> 对象，它不能拥有一堆 <code>String</code>；</p><p>此时，Scala 编译器会在类型结构中向上寻找最近的满足条件的类型；</p><p>此时，寻找到的是 <code>IndexedSeq</code>，而这个类型的默认 <code>Seq</code> 实现就是 <code>Vector</code></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Scala 作为函数式语言，提供了很多用于高阶函数来解决一类范式问题；&lt;/p&gt;&lt;p&gt;但是，使用过多的高阶函数就会让代码的可读性变差；&lt;/p&gt;&lt;p&gt;所以，对此 Scala 提供了一种类 Python 的简便的语法糖，用来解决代码的可读性问题。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Scala" scheme="https://wafer.li/categories/Scala/"/>
    
    
      <category term="Scala" scheme="https://wafer.li/tags/Scala/"/>
    
  </entry>
  
  <entry>
    <title>Scala List 高阶函数</title>
    <link href="https://wafer.li//Scala/Scala%20List%20%E9%AB%98%E9%98%B6%E5%87%BD%E6%95%B0/"/>
    <id>https://wafer.li//Scala/Scala List 高阶函数/</id>
    <published>2017-04-20T18:20:00.000Z</published>
    <updated>2017-04-22T18:21:13.000Z</updated>
    
    <content type="html"><![CDATA[<p>高阶函数是函数式编程的一个很大的特性；</p><p>同时，其中集合类的高阶函数在日常的开发和使用中，占了一个很重要的位置；</p><p>但是，这些函数有可能会在刚接触的时候搞不懂它们的具体作用；</p><p>那么今天就以 <code>List</code> 来说一说常用的高阶函数具体的作用。</p><a id="more"></a><h2 id="1-子集操作"><a class="markdownIt-Anchor" href="#1-子集操作"></a> 1. 子集操作</h2><p>在一个集合中选取一些特定的元素作为子集；</p><p>我们在指令性语言中，通常选用 <code>for</code> 语句来实现这个需求；</p><p>而在函数式语言中，我们有对应的高阶函数来解决这个问题。</p><h3 id="11-filterp-t-boolean"><a class="markdownIt-Anchor" href="#11-filterp-t-boolean"></a> 1.1 <code>filter(p: (T) =&gt; Boolean)</code></h3><p>顾名思义， <strong>过滤器</strong>，用来 <strong>选取符合条件的元素</strong>， 并将其作为返回值；</p><p>这里的 <strong>符合条件</strong> 指的是 使得函数 <code>p</code> 的返回值为 <code>true</code> 的元素。</p><p>例如：</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> list = <span class="type">List</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">list.filter((x) =&gt; x &gt; <span class="number">2</span>) <span class="comment">// List(3, 4)</span></span><br></pre></td></tr></table></figure><h3 id="12-filternotp-t-boolean"><a class="markdownIt-Anchor" href="#12-filternotp-t-boolean"></a> 1.2 <code>filterNot(p: (T) =&gt; Boolean)</code></h3><p>同理，这个函数是上面的反面，也就是用来 <strong>过滤掉</strong> 符合条件的元素；</p><p>返回的是， <strong>不包含符合元素的子集</strong>；</p><p>例如：</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> list = <span class="type">List</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">list.filterNot((x) =&gt; x == <span class="number">2</span>) <span class="comment">// List(1, 3)</span></span><br></pre></td></tr></table></figure><h3 id="13-partitionp-t-boolean"><a class="markdownIt-Anchor" href="#13-partitionp-t-boolean"></a> 1.3 <code>partition(p: (T) =&gt; Boolean)</code></h3><p>这个函数是上面两个函数的集合体，返回的是一个 <code>Turple</code>，包含的元素为：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(list.filter, list.filterNot)</span><br></pre></td></tr></table></figure><p>例如：</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> list = <span class="type">List</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Returns: (List(1, 2, 3), List(4, 5, 6, 7))</span></span><br><span class="line">list.partition((x) =&gt; x &lt; <span class="number">4</span>)</span><br></pre></td></tr></table></figure><h3 id="14-takewhilep-t-boolean"><a class="markdownIt-Anchor" href="#14-takewhilep-t-boolean"></a> 1.4 <code>takeWhile(p: (T) =&gt; Boolean)</code></h3><p>这个函数会一直选取元素， <strong>直到 <code>p</code> 的返回值为 <code>false</code></strong>，然后将元素作为新的集合返回。</p><p>可以看到，这个函数返回的就是 <strong>符合条件的集合前缀</strong></p><p>例如：</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> list = <span class="type">List</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注意最后一个 1 并没有拿走</span></span><br><span class="line">list.takeWhile((x) =&gt; x == <span class="number">1</span>) <span class="comment">// List(1, 1, 1, 1)</span></span><br></pre></td></tr></table></figure><h3 id="15-dropwhilep-t-boolean"><a class="markdownIt-Anchor" href="#15-dropwhilep-t-boolean"></a> 1.5 <code>dropWhile(p: (T) =&gt; Boolean)</code></h3><p>和上面的方法相反，这个方法会一直 <strong>丢弃</strong> 元素，直到 <code>p</code> 的返回值为 <code>false</code>；</p><p>那么可以看到，这个函数返回的就是 <strong>不符合条件的集合后缀</strong>；</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> list = <span class="type">List</span>(<span class="number">1</span>, <span class="number">3</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">list.dropWhile((x) x != <span class="number">4</span>) <span class="comment">// List(4, 2, 1)</span></span><br></pre></td></tr></table></figure><h3 id="16-spanp-t-boolean"><a class="markdownIt-Anchor" href="#16-spanp-t-boolean"></a> 1.6 <code>span(p: (T) =&gt; Boolean)</code></h3><p>这个函数是上两个函数的结合，它返回的是如下的一个 <code>Turple</code>：</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(list.takeWhile, list.dropWhile)</span><br></pre></td></tr></table></figure><h3 id="17-partition-span-和它们的基本方法的区别"><a class="markdownIt-Anchor" href="#17-partition-span-和它们的基本方法的区别"></a> 1.7 <code>partition</code>、<code>span</code> 和它们的基本方法的区别</h3><p>既然 <code>partition</code> 和 <code>span</code> 都可以用基本的 <code>filter</code>、<code>filterNot</code> 和 <code>takeWhile</code>、<code>dropWhile</code> 来解决，那为什么还要专门实现一次这两个方法呢？</p><p>其实，<code>span</code> 和 <code>partition</code> 只需要扫描一次集合；</p><p>但是如果使用 <code>filter</code>、<code>filterNot</code> 和 <code>takeWhile</code>、<code>dropWhile</code> 来实现的话，就需要扫描两次集合了。</p><p>所以，如果同时需要两者的数据的话，那么使用 <code>span</code> 和 <code>partition</code> 显然是更经济的。</p><h3 id="18-withfilter"><a class="markdownIt-Anchor" href="#18-withfilter"></a> 1.8 <code>withFilter</code></h3><p>Scala 除了 <code>filter</code> 之外，还提供了一个 <code>withFilter</code> 函数；</p><p>那么，这两者有什么区别呢？</p><p>根据文档：</p><blockquote><p>Note: the difference between <code>c filter p</code> and <code>c withFilter p</code> is that the former creates a new collection, whereas the latter only restricts the domain of subsequent map, flatMap, foreach, and withFilter operations.</p></blockquote><p>也就是说，<code>filter</code> 会返回一个 <strong>新的 <code>List</code></strong>；</p><p>但是 <code>withFilter</code> 不会返回新的 <code>List</code>；</p><p>它只会提供一个过滤器的作用，让符合条件的元素通过，以方便接下来的 <code>map</code> 等其他高阶函数的使用；</p><p>而就效率而言，<code>withFilter</code> 比 <code>filter</code> 要快。</p><p>如果你需要返回一个新的集合，就使用 <code>filter</code>；</p><p>如果你只是需要一个元素过滤器，而接下来，还需要进行其他操作，那么就使用 <code>withFilter</code></p><h2 id="2-元素检查"><a class="markdownIt-Anchor" href="#2-元素检查"></a> 2. 元素检查</h2><p>有时候，我们会希望检查集合内部的元素状态；</p><p>比如说， <strong>是否所有的元素都满足某个特定条件</strong>；</p><p>或者， <strong>是否有元素满足特定条件</strong>。</p><p>在 Scala 中，我们有高阶函数来进行这个操作。</p><h3 id="21-forallp-t-boolean-boolean"><a class="markdownIt-Anchor" href="#21-forallp-t-boolean-boolean"></a> 2.1 <code>forAll(p: (T) =&gt; Boolean): Boolean</code></h3><p>顾名思义，检查 <strong>是否所有的元素都满足特定条件</strong></p><p>例如：</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> list = <span class="type">List</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">list.forAll(c =&gt; c &gt; <span class="number">0</span>) <span class="comment">// true</span></span><br></pre></td></tr></table></figure><h3 id="22-existsp-t-boolean-boolean"><a class="markdownIt-Anchor" href="#22-existsp-t-boolean-boolean"></a> 2.2 <code>exists(p: (T) =&gt; Boolean): Boolean</code></h3><p>同理，检查 <strong>是否存在满足条件的元素</strong></p><p>例如：</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> list = <span class="type">List</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">list.exists(c =&gt; c &lt; <span class="number">0</span>) <span class="comment">// false</span></span><br></pre></td></tr></table></figure><h2 id="3-变换"><a class="markdownIt-Anchor" href="#3-变换"></a> 3. 变换</h2><h3 id="31-mapf-t-u"><a class="markdownIt-Anchor" href="#31-mapf-t-u"></a> 3.1 <code>map(f: (T) =&gt; U)</code></h3><p><code>map</code> 函数，可以说是这里面用的最多的高阶函数了；</p><p><code>map</code> 函数的真正作用，实际上是一种变换功能，而且不仅可以变换成和现元素类型相同的类型，也可以变换成不同的类型；</p><p>也就是说，可以通过 <code>map</code> 函数，将一种元素的集合，变成另一种元素的集合。</p><p>例子：</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将所有元素都乘以 2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> list = <span class="type">List</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">list.map((x) =&gt; x * <span class="number">2</span>)  <span class="comment">// List(2, 4, 6, 8)</span></span><br></pre></td></tr></table></figure><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将 Int 变成 String</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> list = <span class="type">List</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">list.map((x) =&gt; x.toString())   <span class="comment">// List("1", "2", "3", "4")</span></span><br></pre></td></tr></table></figure><h3 id="32-flatten"><a class="markdownIt-Anchor" href="#32-flatten"></a> 3.2 <code>flatten</code></h3><p>这个函数可以将嵌套的 <code>List</code> 展平，就像它的名字一样。</p><p>例如：</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> listOfLists = <span class="type">List</span>(<span class="type">List</span>(<span class="number">1</span>, <span class="number">2</span>), <span class="type">List</span>(<span class="number">3</span>, <span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">listOfLists.flatten = <span class="type">List</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>)</span><br></pre></td></tr></table></figure><h3 id="33-flatmap"><a class="markdownIt-Anchor" href="#33-flatmap"></a> 3.3 <code>flatMap</code></h3><p>它是 <code>map</code> 和 <code>flatten</code> 的集合体，相当于先进行 <code>map</code> 然后 <code>flatten</code>。</p><p>例子：</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> listOfLists = <span class="type">List</span>(<span class="type">List</span>(<span class="number">1</span>, <span class="number">2</span>), <span class="type">List</span>(<span class="number">3</span>, <span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">listOfLists.flatMap((x) =&gt; x.map(_ * <span class="number">2</span>)) <span class="comment">// List(2, 4, 6, 8)</span></span><br></pre></td></tr></table></figure><p>也就是说，<code>flatMap</code> 先将元素 <code>map</code> 成 <strong>嵌套的</strong> <code>List</code>；</p><p>随后，再调用 <code>flatten</code>，将嵌套的 <code>List</code> 展平</p><blockquote><p><code>flatMap</code> 的作用过于强大，使用时需要小心谨慎<br>在 Twitter 的 <em>Effective Scala</em> 中，推荐使用 <em>for-comprehention</em> 来代替 <code>flatMap</code> 的使用</p></blockquote><h3 id="34-ziptxs-listu-listt-u"><a class="markdownIt-Anchor" href="#34-ziptxs-listu-listt-u"></a> 3.4 <code>zip[T](xs: List[U]): List[(T, U)]</code></h3><p>压缩，它的左右两个操作数分别是 <strong>两个 <code>List</code></strong>；</p><p>然后返回一个分别包含两个 <code>List</code> 元素的二元组的 <code>List</code>。</p><p>例如：</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> list1 = <span class="type">List</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line"><span class="keyword">val</span> list2 = <span class="type">List</span>(<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>, <span class="string">"d"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// List((1, "a"), (2, "b"), (3, "c"), (4, "d"))</span></span><br><span class="line">list1 zip list2</span><br></pre></td></tr></table></figure><h3 id="35-unzip"><a class="markdownIt-Anchor" href="#35-unzip"></a> 3.5 <code>unzip</code></h3><p>有压缩就有解压；</p><p>这个函数的作用就是将上面压缩后的结果解压出来；</p><p>具体来说就是接受一个二元组的 <code>List</code>， 返回一个 <code>List</code> 的二元组。</p><p>例如：</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> list1 = <span class="type">List</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line"><span class="keyword">val</span> list2 = <span class="type">List</span>(<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>, <span class="string">"d"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// (List(1, 2, 3, 4), List("a", "b", "c", "d"))</span></span><br><span class="line">(list1 zip list2) unzip</span><br></pre></td></tr></table></figure><h3 id="36-collect"><a class="markdownIt-Anchor" href="#36-collect"></a> 3.6 <code>collect</code></h3><p>根据文档，<code>collect</code> 接受一个 <code>PartialFunction</code>，然后对集合中的每个元素都 apply 这个函数，返回一个新的集合。</p><p>听起来，这个方法和 <code>map</code> 很像，不过其区别就是在于 <code>collect</code> 接受的是一个 <code>PartialFnction</code> ；</p><p>这具体是什么意思呢？</p><p>我们来举个例子：</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> convertFn: <span class="type">PartialFunction</span>[<span class="type">Any</span>, <span class="type">Int</span>] = &#123;</span><br><span class="line">  <span class="keyword">case</span> i: <span class="type">Int</span> =&gt; i;</span><br><span class="line">  <span class="keyword">case</span> s: <span class="type">String</span> =&gt; s.toInt;</span><br><span class="line">  <span class="keyword">case</span> <span class="type">Some</span>(s: <span class="type">String</span>) =&gt; s.toInt</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">List</span>(<span class="number">0</span>, <span class="number">1</span>, <span class="string">"2"</span>, <span class="string">"3"</span>, <span class="type">Some</span>(<span class="number">4</span>), <span class="type">Some</span>(<span class="string">"5"</span>)).</span><br><span class="line">  collect(convertFn)</span><br><span class="line"></span><br><span class="line"><span class="comment">// List[Int] = List(0, 1, 2, 3, 5)</span></span><br></pre></td></tr></table></figure><p>注意到， <code>collect</code> 的 lambda 中，并没有对所有的 <code>case</code> 都进行处理；</p><p>上面的 <code>List</code> 除了含有 <code>String</code> 、 <code>Int</code> 和 <code>Some[String]</code> 之外，还含有 <code>Some[Int]</code>；</p><p>这就是所谓的 <code>PartialFunction</code> ，它并没有对所有的情形都进行处理，也没有提供一个默认的选项。</p><p>如果上面的 <code>collect</code> 替换为 <code>map</code>，则第四个 <code>Some(4)</code> 就会导致 <code>MatchError</code>；</p><p>而 <code>collect</code> 则避开了这个错误。</p><p>理论上，<code>collect</code> 进行了 <code>map</code> 和 <code>filter</code> 的两重功能。</p><p>虽然，<code>collect</code> 不会造成 <code>MatchError</code>；</p><p>但是 <code>collect</code> 不是使用 <code>try...catch</code> 实现的。</p><p><code>collect</code> 是通过检查函数中提供的 <code>case</code> 检查；</p><p>如果 <code>case</code> 不匹配，则跳过该元素，不调用函数；</p><p>如果 <code>case</code> 中存在 <code>???</code>，那么同样也会抛出异常：</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">List</span>(<span class="number">1</span>, <span class="string">""</span>).collect(</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> i: <span class="type">Int</span> =&gt; i;</span><br><span class="line">    <span class="keyword">case</span> _ =&gt; ???</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">scala.<span class="type">NotImplementedError</span>: an implementation is missing</span><br><span class="line">  at scala.<span class="type">Predef</span>$.$qmark$qmark$qmark(<span class="type">Predef</span>.scala:<span class="number">225</span>)</span><br><span class="line">  at $anonfun$<span class="number">1.</span>applyOrElse(&lt;console&gt;:<span class="number">8</span>)</span><br><span class="line">  at scala.collection.immutable.<span class="type">List</span>.collect(<span class="type">List</span>.scala:<span class="number">303</span>)</span><br><span class="line">  ... <span class="number">33</span> elided</span><br></pre></td></tr></table></figure><h3 id="37-collectfirst"><a class="markdownIt-Anchor" href="#37-collectfirst"></a> 3.7 <code>collectFirst</code></h3><p>这是 <code>collect</code> 的简化版本；</p><p>它只会将函数应用在 <strong>第一个满足</strong> 其 <code>case</code> 的元素中，并返回一个包含该元素的 <code>Option</code> 对象。</p><p>如果不存在这样的函数，那么就返回 <code>None</code></p><h3 id="38-groupbyaf-a-k-mapk-seqa"><a class="markdownIt-Anchor" href="#38-groupbyaf-a-k-mapk-seqa"></a> 3.8 <code>groupBy[A](f: (A) =&gt; K): Map[K, Seq[A]]</code></h3><p><code>groupBy</code> 通过函数 <code>f</code>，将 <code>List</code> 分成不同的部分；</p><p>每一个部分由一个键值 <code>K</code> 来进行映射，最终返回结果为一个 <code>Map</code> 对象。</p><p>例子：</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> fruit = <span class="type">List</span>(<span class="string">"apple"</span>, <span class="string">"peer"</span>, <span class="string">"orange"</span>, <span class="string">"pineapple"</span>)</span><br><span class="line"></span><br><span class="line">fruit groupBy (_.head)</span><br><span class="line"></span><br><span class="line"><span class="comment">//&gt; Map(p -&gt; List("peer", "pineapple"),</span></span><br><span class="line"><span class="comment">//      a -&gt; List("apple"),</span></span><br><span class="line"><span class="comment">//      o -&gt; List("orange"))</span></span><br></pre></td></tr></table></figure><h2 id="4-规约"><a class="markdownIt-Anchor" href="#4-规约"></a> 4. 规约</h2><p>在一个集合中，我们通常还会进行规约操作；</p><p>例如求一个 1 到 100 的和；</p><p>那么，此时，我们就是将一个 1 到 100 的集合规约到一个 <code>Int</code>，它是这个集合所有元素的和。</p><p>下面介绍的就是一系列规约函数。</p><h3 id="41-reduceleftop-b-t-b"><a class="markdownIt-Anchor" href="#41-reduceleftop-b-t-b"></a> 4.1 <code>reduceLeft(op: (B, T) =&gt; B)</code></h3><p>顾名思义，从左到右进行规约操作；</p><p>该函数会从左到右地使用操作符 <code>op</code> 将元素连接起来。</p><p>注意 <code>op</code> 是个二元操作，它接受两个参数，返回一个值。</p><p>那么产生的结果就是一个 <strong>左斜的树</strong>：</p><img data-src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIKICJodHRwOi8vd3d3LnczLm9yZy9HcmFwaGljcy9TVkcvMS4xL0RURC9zdmcxMS5kdGQiPgo8IS0tIEdlbmVyYXRlZCBieSBncmFwaHZpeiB2ZXJzaW9uIDIuMzguMCAoMjAxNDA0MTMuMjA0MSkKIC0tPgo8IS0tIFRpdGxlOiBHIFBhZ2VzOiAxIC0tPgo8c3ZnIHdpZHRoPSIyMDZwdCIgaGVpZ2h0PSIyNjBwdCIKIHZpZXdCb3g9IjAuMDAgMC4wMCAyMDYuMDAgMjYwLjAwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIj4KPGcgaWQ9ImdyYXBoMCIgY2xhc3M9ImdyYXBoIiB0cmFuc2Zvcm09InNjYWxlKDEgMSkgcm90YXRlKDApIHRyYW5zbGF0ZSg0IDI1NikiPgo8dGl0bGU+RzwvdGl0bGU+Cjxwb2x5Z29uIGZpbGw9IndoaXRlIiBzdHJva2U9Im5vbmUiIHBvaW50cz0iLTQsNCAtNCwtMjU2IDIwMiwtMjU2IDIwMiw0IC00LDQiLz4KPCEtLSBvcDEgLS0+CjxnIGlkPSJub2RlMSIgY2xhc3M9Im5vZGUiPjx0aXRsZT5vcDE8L3RpdGxlPgo8dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4PSI2MyIgeT0iLTg2LjMiIGZvbnQtZmFtaWx5PSJUaW1lcyxzZXJpZiIgZm9udC1zaXplPSIxNC4wMCI+b3A8L3RleHQ+CjwvZz4KPCEtLSB4MSAtLT4KPGcgaWQ9Im5vZGU0IiBjbGFzcz0ibm9kZSI+PHRpdGxlPngxPC90aXRsZT4KPHRleHQgdGV4dC1hbmNob3I9Im1pZGRsZSIgeD0iMjciIHk9Ii0xNC4zIiBmb250LWZhbWlseT0iVGltZXMsc2VyaWYiIGZvbnQtc2l6ZT0iMTQuMDAiPngxPC90ZXh0Pgo8L2c+CjwhLS0gb3AxJiM0NTsmZ3Q7eDEgLS0+CjxnIGlkPSJlZGdlMSIgY2xhc3M9ImVkZ2UiPjx0aXRsZT5vcDEmIzQ1OyZndDt4MTwvdGl0bGU+CjxwYXRoIGZpbGw9Im5vbmUiIHN0cm9rZT0iYmxhY2siIGQ9Ik01NC4xMDExLC03MS42OTY2QzQ4LjUyMDksLTYwLjg0NjMgNDEuMzU3MiwtNDYuOTE2NyAzNS43OTY1LC0zNi4xMDQzIi8+CjwvZz4KPCEtLSB4MiAtLT4KPGcgaWQ9Im5vZGU1IiBjbGFzcz0ibm9kZSI+PHRpdGxlPngyPC90aXRsZT4KPHRleHQgdGV4dC1hbmNob3I9Im1pZGRsZSIgeD0iOTkiIHk9Ii0xNC4zIiBmb250LWZhbWlseT0iVGltZXMsc2VyaWYiIGZvbnQtc2l6ZT0iMTQuMDAiPngyPC90ZXh0Pgo8L2c+CjwhLS0gb3AxJiM0NTsmZ3Q7eDIgLS0+CjxnIGlkPSJlZGdlMiIgY2xhc3M9ImVkZ2UiPjx0aXRsZT5vcDEmIzQ1OyZndDt4MjwvdGl0bGU+CjxwYXRoIGZpbGw9Im5vbmUiIHN0cm9rZT0iYmxhY2siIGQ9Ik03MS44OTg5LC03MS42OTY2Qzc3LjQ3OTEsLTYwLjg0NjMgODQuNjQyOCwtNDYuOTE2NyA5MC4yMDM1LC0zNi4xMDQzIi8+CjwvZz4KPCEtLSBvcDIgLS0+CjxnIGlkPSJub2RlMiIgY2xhc3M9Im5vZGUiPjx0aXRsZT5vcDI8L3RpdGxlPgo8dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4PSI5OSIgeT0iLTE1OC4zIiBmb250LWZhbWlseT0iVGltZXMsc2VyaWYiIGZvbnQtc2l6ZT0iMTQuMDAiPm9wPC90ZXh0Pgo8L2c+CjwhLS0gb3AyJiM0NTsmZ3Q7b3AxIC0tPgo8ZyBpZD0iZWRnZTMiIGNsYXNzPSJlZGdlIj48dGl0bGU+b3AyJiM0NTsmZ3Q7b3AxPC90aXRsZT4KPHBhdGggZmlsbD0ibm9uZSIgc3Ryb2tlPSJibGFjayIgZD0iTTkwLjEwMTEsLTE0My42OTdDODQuNTIwOSwtMTMyLjg0NiA3Ny4zNTcyLC0xMTguOTE3IDcxLjc5NjUsLTEwOC4xMDQiLz4KPC9nPgo8IS0tIHgzIC0tPgo8ZyBpZD0ibm9kZTYiIGNsYXNzPSJub2RlIj48dGl0bGU+eDM8L3RpdGxlPgo8dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4PSIxMzUiIHk9Ii04Ni4zIiBmb250LWZhbWlseT0iVGltZXMsc2VyaWYiIGZvbnQtc2l6ZT0iMTQuMDAiPngzPC90ZXh0Pgo8L2c+CjwhLS0gb3AyJiM0NTsmZ3Q7eDMgLS0+CjxnIGlkPSJlZGdlNCIgY2xhc3M9ImVkZ2UiPjx0aXRsZT5vcDImIzQ1OyZndDt4MzwvdGl0bGU+CjxwYXRoIGZpbGw9Im5vbmUiIHN0cm9rZT0iYmxhY2siIGQ9Ik0xMDcuODk5LC0xNDMuNjk3QzExMy40NzksLTEzMi44NDYgMTIwLjY0MywtMTE4LjkxNyAxMjYuMjAzLC0xMDguMTA0Ii8+CjwvZz4KPCEtLSBvcDMgLS0+CjxnIGlkPSJub2RlMyIgY2xhc3M9Im5vZGUiPjx0aXRsZT5vcDM8L3RpdGxlPgo8dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4PSIxMzUiIHk9Ii0yMzAuMyIgZm9udC1mYW1pbHk9IlRpbWVzLHNlcmlmIiBmb250LXNpemU9IjE0LjAwIj5vcDwvdGV4dD4KPC9nPgo8IS0tIG9wMyYjNDU7Jmd0O29wMiAtLT4KPGcgaWQ9ImVkZ2U1IiBjbGFzcz0iZWRnZSI+PHRpdGxlPm9wMyYjNDU7Jmd0O29wMjwvdGl0bGU+CjxwYXRoIGZpbGw9Im5vbmUiIHN0cm9rZT0iYmxhY2siIHN0cm9rZS1kYXNoYXJyYXk9IjEsNSIgZD0iTTEyNi4xMDEsLTIxNS42OTdDMTIwLjUyMSwtMjA0Ljg0NiAxMTMuMzU3LC0xOTAuOTE3IDEwNy43OTcsLTE4MC4xMDQiLz4KPC9nPgo8IS0tIHhuIC0tPgo8ZyBpZD0ibm9kZTciIGNsYXNzPSJub2RlIj48dGl0bGU+eG48L3RpdGxlPgo8dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4PSIxNzEiIHk9Ii0xNTguMyIgZm9udC1mYW1pbHk9IlRpbWVzLHNlcmlmIiBmb250LXNpemU9IjE0LjAwIj54bjwvdGV4dD4KPC9nPgo8IS0tIG9wMyYjNDU7Jmd0O3huIC0tPgo8ZyBpZD0iZWRnZTYiIGNsYXNzPSJlZGdlIj48dGl0bGU+b3AzJiM0NTsmZ3Q7eG48L3RpdGxlPgo8cGF0aCBmaWxsPSJub25lIiBzdHJva2U9ImJsYWNrIiBkPSJNMTQzLjg5OSwtMjE1LjY5N0MxNDkuNDc5LC0yMDQuODQ2IDE1Ni42NDMsLTE5MC45MTcgMTYyLjIwMywtMTgwLjEwNCIvPgo8L2c+CjwvZz4KPC9zdmc+Cg=="><p>需要注意的是，<code>reduceLeft</code> 不仅能返回和原有元素相同类型的值，也能返回不同类型的值；</p><p>基于这样的树结构，那么对 <code>op</code> 的类型就有了要求；</p><p>可以看到，在上面，下方的 <code>op</code> 的返回值是作为上方 <code>op</code> 的左节点；</p><p>也就是说，<code>reduceLeft</code> 要求， <strong><code>op</code> 的左边参数的类型，必须和其返回值的类型相同。</strong></p><h3 id="42-foldleftz-bop-b-t-b"><a class="markdownIt-Anchor" href="#42-foldleftz-bop-b-t-b"></a> 4.2 <code>foldLeft(z: B)(op: (B, T) =&gt; B)</code></h3><p><code>foldLeft</code> 则是对 <code>reduceLeft</code> 的进一步泛化；</p><p><code>reduceLeft</code> 是不允许在 <strong>空列表</strong> 中执行的；</p><p>对此，<code>foldLeft</code> 提供了一个 <strong>初始值</strong> <code>z</code>；</p><p>如果列表为空，那么就返回 <code>z</code>；</p><p>它生成的树如下：</p><img data-src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIKICJodHRwOi8vd3d3LnczLm9yZy9HcmFwaGljcy9TVkcvMS4xL0RURC9zdmcxMS5kdGQiPgo8IS0tIEdlbmVyYXRlZCBieSBncmFwaHZpeiB2ZXJzaW9uIDIuMzguMCAoMjAxNDA0MTMuMjA0MSkKIC0tPgo8IS0tIFRpdGxlOiBHIFBhZ2VzOiAxIC0tPgo8c3ZnIHdpZHRoPSIyMDZwdCIgaGVpZ2h0PSIyNjBwdCIKIHZpZXdCb3g9IjAuMDAgMC4wMCAyMDYuMDAgMjYwLjAwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIj4KPGcgaWQ9ImdyYXBoMCIgY2xhc3M9ImdyYXBoIiB0cmFuc2Zvcm09InNjYWxlKDEgMSkgcm90YXRlKDApIHRyYW5zbGF0ZSg0IDI1NikiPgo8dGl0bGU+RzwvdGl0bGU+Cjxwb2x5Z29uIGZpbGw9IndoaXRlIiBzdHJva2U9Im5vbmUiIHBvaW50cz0iLTQsNCAtNCwtMjU2IDIwMiwtMjU2IDIwMiw0IC00LDQiLz4KPCEtLSBvcDEgLS0+CjxnIGlkPSJub2RlMSIgY2xhc3M9Im5vZGUiPjx0aXRsZT5vcDE8L3RpdGxlPgo8dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4PSI2MyIgeT0iLTg2LjMiIGZvbnQtZmFtaWx5PSJUaW1lcyxzZXJpZiIgZm9udC1zaXplPSIxNC4wMCI+b3A8L3RleHQ+CjwvZz4KPCEtLSB6IC0tPgo8ZyBpZD0ibm9kZTQiIGNsYXNzPSJub2RlIj48dGl0bGU+ejwvdGl0bGU+Cjx0ZXh0IHRleHQtYW5jaG9yPSJtaWRkbGUiIHg9IjI3IiB5PSItMTQuMyIgZm9udC1mYW1pbHk9IlRpbWVzLHNlcmlmIiBmb250LXNpemU9IjE0LjAwIj56PC90ZXh0Pgo8L2c+CjwhLS0gb3AxJiM0NTsmZ3Q7eiAtLT4KPGcgaWQ9ImVkZ2UxIiBjbGFzcz0iZWRnZSI+PHRpdGxlPm9wMSYjNDU7Jmd0O3o8L3RpdGxlPgo8cGF0aCBmaWxsPSJub25lIiBzdHJva2U9ImJsYWNrIiBkPSJNNTQuMTAxMSwtNzEuNjk2NkM0OC41MjA5LC02MC44NDYzIDQxLjM1NzIsLTQ2LjkxNjcgMzUuNzk2NSwtMzYuMTA0MyIvPgo8L2c+CjwhLS0geDEgLS0+CjxnIGlkPSJub2RlNSIgY2xhc3M9Im5vZGUiPjx0aXRsZT54MTwvdGl0bGU+Cjx0ZXh0IHRleHQtYW5jaG9yPSJtaWRkbGUiIHg9Ijk5IiB5PSItMTQuMyIgZm9udC1mYW1pbHk9IlRpbWVzLHNlcmlmIiBmb250LXNpemU9IjE0LjAwIj54MTwvdGV4dD4KPC9nPgo8IS0tIG9wMSYjNDU7Jmd0O3gxIC0tPgo8ZyBpZD0iZWRnZTIiIGNsYXNzPSJlZGdlIj48dGl0bGU+b3AxJiM0NTsmZ3Q7eDE8L3RpdGxlPgo8cGF0aCBmaWxsPSJub25lIiBzdHJva2U9ImJsYWNrIiBkPSJNNzEuODk4OSwtNzEuNjk2NkM3Ny40NzkxLC02MC44NDYzIDg0LjY0MjgsLTQ2LjkxNjcgOTAuMjAzNSwtMzYuMTA0MyIvPgo8L2c+CjwhLS0gb3AyIC0tPgo8ZyBpZD0ibm9kZTIiIGNsYXNzPSJub2RlIj48dGl0bGU+b3AyPC90aXRsZT4KPHRleHQgdGV4dC1hbmNob3I9Im1pZGRsZSIgeD0iOTkiIHk9Ii0xNTguMyIgZm9udC1mYW1pbHk9IlRpbWVzLHNlcmlmIiBmb250LXNpemU9IjE0LjAwIj5vcDwvdGV4dD4KPC9nPgo8IS0tIG9wMiYjNDU7Jmd0O29wMSAtLT4KPGcgaWQ9ImVkZ2UzIiBjbGFzcz0iZWRnZSI+PHRpdGxlPm9wMiYjNDU7Jmd0O29wMTwvdGl0bGU+CjxwYXRoIGZpbGw9Im5vbmUiIHN0cm9rZT0iYmxhY2siIGQ9Ik05MC4xMDExLC0xNDMuNjk3Qzg0LjUyMDksLTEzMi44NDYgNzcuMzU3MiwtMTE4LjkxNyA3MS43OTY1LC0xMDguMTA0Ii8+CjwvZz4KPCEtLSB4MiAtLT4KPGcgaWQ9Im5vZGU2IiBjbGFzcz0ibm9kZSI+PHRpdGxlPngyPC90aXRsZT4KPHRleHQgdGV4dC1hbmNob3I9Im1pZGRsZSIgeD0iMTM1IiB5PSItODYuMyIgZm9udC1mYW1pbHk9IlRpbWVzLHNlcmlmIiBmb250LXNpemU9IjE0LjAwIj54MjwvdGV4dD4KPC9nPgo8IS0tIG9wMiYjNDU7Jmd0O3gyIC0tPgo8ZyBpZD0iZWRnZTQiIGNsYXNzPSJlZGdlIj48dGl0bGU+b3AyJiM0NTsmZ3Q7eDI8L3RpdGxlPgo8cGF0aCBmaWxsPSJub25lIiBzdHJva2U9ImJsYWNrIiBkPSJNMTA3Ljg5OSwtMTQzLjY5N0MxMTMuNDc5LC0xMzIuODQ2IDEyMC42NDMsLTExOC45MTcgMTI2LjIwMywtMTA4LjEwNCIvPgo8L2c+CjwhLS0gb3AzIC0tPgo8ZyBpZD0ibm9kZTMiIGNsYXNzPSJub2RlIj48dGl0bGU+b3AzPC90aXRsZT4KPHRleHQgdGV4dC1hbmNob3I9Im1pZGRsZSIgeD0iMTM1IiB5PSItMjMwLjMiIGZvbnQtZmFtaWx5PSJUaW1lcyxzZXJpZiIgZm9udC1zaXplPSIxNC4wMCI+b3A8L3RleHQ+CjwvZz4KPCEtLSBvcDMmIzQ1OyZndDtvcDIgLS0+CjxnIGlkPSJlZGdlNSIgY2xhc3M9ImVkZ2UiPjx0aXRsZT5vcDMmIzQ1OyZndDtvcDI8L3RpdGxlPgo8cGF0aCBmaWxsPSJub25lIiBzdHJva2U9ImJsYWNrIiBzdHJva2UtZGFzaGFycmF5PSIxLDUiIGQ9Ik0xMjYuMTAxLC0yMTUuNjk3QzEyMC41MjEsLTIwNC44NDYgMTEzLjM1NywtMTkwLjkxNyAxMDcuNzk3LC0xODAuMTA0Ii8+CjwvZz4KPCEtLSB4biAtLT4KPGcgaWQ9Im5vZGU3IiBjbGFzcz0ibm9kZSI+PHRpdGxlPnhuPC90aXRsZT4KPHRleHQgdGV4dC1hbmNob3I9Im1pZGRsZSIgeD0iMTcxIiB5PSItMTU4LjMiIGZvbnQtZmFtaWx5PSJUaW1lcyxzZXJpZiIgZm9udC1zaXplPSIxNC4wMCI+eG48L3RleHQ+CjwvZz4KPCEtLSBvcDMmIzQ1OyZndDt4biAtLT4KPGcgaWQ9ImVkZ2U2IiBjbGFzcz0iZWRnZSI+PHRpdGxlPm9wMyYjNDU7Jmd0O3huPC90aXRsZT4KPHBhdGggZmlsbD0ibm9uZSIgc3Ryb2tlPSJibGFjayIgZD0iTTE0My44OTksLTIxNS42OTdDMTQ5LjQ3OSwtMjA0Ljg0NiAxNTYuNjQzLC0xOTAuOTE3IDE2Mi4yMDMsLTE4MC4xMDQiLz4KPC9nPgo8L2c+Cjwvc3ZnPgo="><p>这里比较有意思的就是 <code>foldLeft</code> 实际上是一个 <strong>柯里化函数</strong>；</p><p>可以先提供初始值，然后在 <code>op</code> 操作确定之后，再进行规约运算。</p><h3 id="43-reducerightop-t-b-b"><a class="markdownIt-Anchor" href="#43-reducerightop-t-b-b"></a> 4.3 <code>reduceRight(op: (T, B) =&gt; B)</code></h3><p>我们既然能从左边规约，当然也可以从右边规约；</p><p><code>reduceRight</code> 的作用就是， <strong>从右到左</strong> 执行规约操作；</p><p>那么，它所生成的树就是 <strong>右斜的</strong>：</p><img data-src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIKICJodHRwOi8vd3d3LnczLm9yZy9HcmFwaGljcy9TVkcvMS4xL0RURC9zdmcxMS5kdGQiPgo8IS0tIEdlbmVyYXRlZCBieSBncmFwaHZpeiB2ZXJzaW9uIDIuMzguMCAoMjAxNDA0MTMuMjA0MSkKIC0tPgo8IS0tIFRpdGxlOiBHIFBhZ2VzOiAxIC0tPgo8c3ZnIHdpZHRoPSIyMDZwdCIgaGVpZ2h0PSIyNjBwdCIKIHZpZXdCb3g9IjAuMDAgMC4wMCAyMDYuMDAgMjYwLjAwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIj4KPGcgaWQ9ImdyYXBoMCIgY2xhc3M9ImdyYXBoIiB0cmFuc2Zvcm09InNjYWxlKDEgMSkgcm90YXRlKDApIHRyYW5zbGF0ZSg0IDI1NikiPgo8dGl0bGU+RzwvdGl0bGU+Cjxwb2x5Z29uIGZpbGw9IndoaXRlIiBzdHJva2U9Im5vbmUiIHBvaW50cz0iLTQsNCAtNCwtMjU2IDIwMiwtMjU2IDIwMiw0IC00LDQiLz4KPCEtLSBvcDEgLS0+CjxnIGlkPSJub2RlMSIgY2xhc3M9Im5vZGUiPjx0aXRsZT5vcDE8L3RpdGxlPgo8dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4PSI2MyIgeT0iLTIzMC4zIiBmb250LWZhbWlseT0iVGltZXMsc2VyaWYiIGZvbnQtc2l6ZT0iMTQuMDAiPm9wPC90ZXh0Pgo8L2c+CjwhLS0gb3AyIC0tPgo8ZyBpZD0ibm9kZTIiIGNsYXNzPSJub2RlIj48dGl0bGU+b3AyPC90aXRsZT4KPHRleHQgdGV4dC1hbmNob3I9Im1pZGRsZSIgeD0iOTkiIHk9Ii0xNTguMyIgZm9udC1mYW1pbHk9IlRpbWVzLHNlcmlmIiBmb250LXNpemU9IjE0LjAwIj5vcDwvdGV4dD4KPC9nPgo8IS0tIG9wMSYjNDU7Jmd0O29wMiAtLT4KPGcgaWQ9ImVkZ2UyIiBjbGFzcz0iZWRnZSI+PHRpdGxlPm9wMTpzZSYjNDU7Jmd0O29wMjwvdGl0bGU+CjxwYXRoIGZpbGw9Im5vbmUiIHN0cm9rZT0iYmxhY2siIGQ9Ik04MSwtMjE2QzkwLjQ4MjUsLTIwNi41MTggOTQuOTcyMiwtMTkxLjg1NyA5Ny4wOTY2LC0xODAuMzU3Ii8+CjwvZz4KPCEtLSB4MSAtLT4KPGcgaWQ9Im5vZGU1IiBjbGFzcz0ibm9kZSI+PHRpdGxlPngxPC90aXRsZT4KPHRleHQgdGV4dC1hbmNob3I9Im1pZGRsZSIgeD0iMjciIHk9Ii0xNTguMyIgZm9udC1mYW1pbHk9IlRpbWVzLHNlcmlmIiBmb250LXNpemU9IjE0LjAwIj54MTwvdGV4dD4KPC9nPgo8IS0tIG9wMSYjNDU7Jmd0O3gxIC0tPgo8ZyBpZD0iZWRnZTEiIGNsYXNzPSJlZGdlIj48dGl0bGU+b3AxOnN3JiM0NTsmZ3Q7eDE8L3RpdGxlPgo8cGF0aCBmaWxsPSJub25lIiBzdHJva2U9ImJsYWNrIiBkPSJNNDUsLTIxNkMzNS41MTc1LC0yMDYuNTE4IDMxLjAyNzgsLTE5MS44NTcgMjguOTAzNCwtMTgwLjM1NyIvPgo8L2c+CjwhLS0gb3AzIC0tPgo8ZyBpZD0ibm9kZTMiIGNsYXNzPSJub2RlIj48dGl0bGU+b3AzPC90aXRsZT4KPHRleHQgdGV4dC1hbmNob3I9Im1pZGRsZSIgeD0iMTM1IiB5PSItODYuMyIgZm9udC1mYW1pbHk9IlRpbWVzLHNlcmlmIiBmb250LXNpemU9IjE0LjAwIj5vcDwvdGV4dD4KPC9nPgo8IS0tIG9wMiYjNDU7Jmd0O29wMyAtLT4KPGcgaWQ9ImVkZ2U0IiBjbGFzcz0iZWRnZSI+PHRpdGxlPm9wMjpzZSYjNDU7Jmd0O29wMzwvdGl0bGU+CjxwYXRoIGZpbGw9Im5vbmUiIHN0cm9rZT0iYmxhY2siIHN0cm9rZS1kYXNoYXJyYXk9IjEsNSIgZD0iTTExNywtMTQ0QzEyNi40ODIsLTEzNC41MTggMTMwLjk3MiwtMTE5Ljg1NyAxMzMuMDk3LC0xMDguMzU3Ii8+CjwvZz4KPCEtLSB4MiAtLT4KPGcgaWQ9Im5vZGU2IiBjbGFzcz0ibm9kZSI+PHRpdGxlPngyPC90aXRsZT4KPHRleHQgdGV4dC1hbmNob3I9Im1pZGRsZSIgeD0iNjMiIHk9Ii04Ni4zIiBmb250LWZhbWlseT0iVGltZXMsc2VyaWYiIGZvbnQtc2l6ZT0iMTQuMDAiPngyPC90ZXh0Pgo8L2c+CjwhLS0gb3AyJiM0NTsmZ3Q7eDIgLS0+CjxnIGlkPSJlZGdlMyIgY2xhc3M9ImVkZ2UiPjx0aXRsZT5vcDI6c3cmIzQ1OyZndDt4MjwvdGl0bGU+CjxwYXRoIGZpbGw9Im5vbmUiIHN0cm9rZT0iYmxhY2siIGQ9Ik04MSwtMTQ0QzcxLjUxNzUsLTEzNC41MTggNjcuMDI3OCwtMTE5Ljg1NyA2NC45MDM0LC0xMDguMzU3Ii8+CjwvZz4KPCEtLSB4X24gLS0+CjxnIGlkPSJub2RlNCIgY2xhc3M9Im5vZGUiPjx0aXRsZT54X248L3RpdGxlPgo8dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4PSI5OSIgeT0iLTE0LjMiIGZvbnQtZmFtaWx5PSJUaW1lcyxzZXJpZiIgZm9udC1zaXplPSIxNC4wMCI+eF9uJiM0NTsxPC90ZXh0Pgo8L2c+CjwhLS0gb3AzJiM0NTsmZ3Q7eF9uIC0tPgo8ZyBpZD0iZWRnZTUiIGNsYXNzPSJlZGdlIj48dGl0bGU+b3AzOnN3JiM0NTsmZ3Q7eF9uPC90aXRsZT4KPHBhdGggZmlsbD0ibm9uZSIgc3Ryb2tlPSJibGFjayIgZD0iTTExNywtNzJDMTA3LjUxOCwtNjIuNTE3NSAxMDMuMDI4LC00Ny44NTcyIDEwMC45MDMsLTM2LjM1NjgiLz4KPC9nPgo8IS0tIHhuIC0tPgo8ZyBpZD0ibm9kZTciIGNsYXNzPSJub2RlIj48dGl0bGU+eG48L3RpdGxlPgo8dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4PSIxNzEiIHk9Ii0xNC4zIiBmb250LWZhbWlseT0iVGltZXMsc2VyaWYiIGZvbnQtc2l6ZT0iMTQuMDAiPnhuPC90ZXh0Pgo8L2c+CjwhLS0gb3AzJiM0NTsmZ3Q7eG4gLS0+CjxnIGlkPSJlZGdlNiIgY2xhc3M9ImVkZ2UiPjx0aXRsZT5vcDM6c2UmIzQ1OyZndDt4bjwvdGl0bGU+CjxwYXRoIGZpbGw9Im5vbmUiIHN0cm9rZT0iYmxhY2siIGQ9Ik0xNTMsLTcyQzE2Mi40ODIsLTYyLjUxNzUgMTY2Ljk3MiwtNDcuODU3MiAxNjkuMDk3LC0zNi4zNTY4Ii8+CjwvZz4KPC9nPgo8L3N2Zz4K"><p>同理，<code>reduceRight</code> 要求，它的右操作数的类型必须和它的返回值类型相同。</p><h3 id="44-foldrightz-bop-t-b-b"><a class="markdownIt-Anchor" href="#44-foldrightz-bop-t-b-b"></a> 4.4 <code>foldRight(z: B)(op: (T, B) =&gt; B)</code></h3><p>同样的，我们也具有一个 <code>foldRight</code> 函数，在集合为空时，返回初始值 <code>z</code>；</p><p>它生成的树如下：</p><img data-src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIKICJodHRwOi8vd3d3LnczLm9yZy9HcmFwaGljcy9TVkcvMS4xL0RURC9zdmcxMS5kdGQiPgo8IS0tIEdlbmVyYXRlZCBieSBncmFwaHZpeiB2ZXJzaW9uIDIuMzguMCAoMjAxNDA0MTMuMjA0MSkKIC0tPgo8IS0tIFRpdGxlOiBHIFBhZ2VzOiAxIC0tPgo8c3ZnIHdpZHRoPSIyMDZwdCIgaGVpZ2h0PSIyNjBwdCIKIHZpZXdCb3g9IjAuMDAgMC4wMCAyMDYuMDAgMjYwLjAwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIj4KPGcgaWQ9ImdyYXBoMCIgY2xhc3M9ImdyYXBoIiB0cmFuc2Zvcm09InNjYWxlKDEgMSkgcm90YXRlKDApIHRyYW5zbGF0ZSg0IDI1NikiPgo8dGl0bGU+RzwvdGl0bGU+Cjxwb2x5Z29uIGZpbGw9IndoaXRlIiBzdHJva2U9Im5vbmUiIHBvaW50cz0iLTQsNCAtNCwtMjU2IDIwMiwtMjU2IDIwMiw0IC00LDQiLz4KPCEtLSBvcDEgLS0+CjxnIGlkPSJub2RlMSIgY2xhc3M9Im5vZGUiPjx0aXRsZT5vcDE8L3RpdGxlPgo8dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4PSI2MyIgeT0iLTIzMC4zIiBmb250LWZhbWlseT0iVGltZXMsc2VyaWYiIGZvbnQtc2l6ZT0iMTQuMDAiPm9wPC90ZXh0Pgo8L2c+CjwhLS0gb3AyIC0tPgo8ZyBpZD0ibm9kZTIiIGNsYXNzPSJub2RlIj48dGl0bGU+b3AyPC90aXRsZT4KPHRleHQgdGV4dC1hbmNob3I9Im1pZGRsZSIgeD0iOTkiIHk9Ii0xNTguMyIgZm9udC1mYW1pbHk9IlRpbWVzLHNlcmlmIiBmb250LXNpemU9IjE0LjAwIj5vcDwvdGV4dD4KPC9nPgo8IS0tIG9wMSYjNDU7Jmd0O29wMiAtLT4KPGcgaWQ9ImVkZ2UyIiBjbGFzcz0iZWRnZSI+PHRpdGxlPm9wMTpzZSYjNDU7Jmd0O29wMjwvdGl0bGU+CjxwYXRoIGZpbGw9Im5vbmUiIHN0cm9rZT0iYmxhY2siIGQ9Ik04MSwtMjE2QzkwLjQ4MjUsLTIwNi41MTggOTQuOTcyMiwtMTkxLjg1NyA5Ny4wOTY2LC0xODAuMzU3Ii8+CjwvZz4KPCEtLSB4MSAtLT4KPGcgaWQ9Im5vZGU0IiBjbGFzcz0ibm9kZSI+PHRpdGxlPngxPC90aXRsZT4KPHRleHQgdGV4dC1hbmNob3I9Im1pZGRsZSIgeD0iMjciIHk9Ii0xNTguMyIgZm9udC1mYW1pbHk9IlRpbWVzLHNlcmlmIiBmb250LXNpemU9IjE0LjAwIj54MTwvdGV4dD4KPC9nPgo8IS0tIG9wMSYjNDU7Jmd0O3gxIC0tPgo8ZyBpZD0iZWRnZTEiIGNsYXNzPSJlZGdlIj48dGl0bGU+b3AxOnN3JiM0NTsmZ3Q7eDE8L3RpdGxlPgo8cGF0aCBmaWxsPSJub25lIiBzdHJva2U9ImJsYWNrIiBkPSJNNDUsLTIxNkMzNS41MTc1LC0yMDYuNTE4IDMxLjAyNzgsLTE5MS44NTcgMjguOTAzNCwtMTgwLjM1NyIvPgo8L2c+CjwhLS0gb3AzIC0tPgo8ZyBpZD0ibm9kZTMiIGNsYXNzPSJub2RlIj48dGl0bGU+b3AzPC90aXRsZT4KPHRleHQgdGV4dC1hbmNob3I9Im1pZGRsZSIgeD0iMTM1IiB5PSItODYuMyIgZm9udC1mYW1pbHk9IlRpbWVzLHNlcmlmIiBmb250LXNpemU9IjE0LjAwIj5vcDwvdGV4dD4KPC9nPgo8IS0tIG9wMiYjNDU7Jmd0O29wMyAtLT4KPGcgaWQ9ImVkZ2U0IiBjbGFzcz0iZWRnZSI+PHRpdGxlPm9wMjpzZSYjNDU7Jmd0O29wMzwvdGl0bGU+CjxwYXRoIGZpbGw9Im5vbmUiIHN0cm9rZT0iYmxhY2siIHN0cm9rZS1kYXNoYXJyYXk9IjEsNSIgZD0iTTExNywtMTQ0QzEyNi40ODIsLTEzNC41MTggMTMwLjk3MiwtMTE5Ljg1NyAxMzMuMDk3LC0xMDguMzU3Ii8+CjwvZz4KPCEtLSB4MiAtLT4KPGcgaWQ9Im5vZGU1IiBjbGFzcz0ibm9kZSI+PHRpdGxlPngyPC90aXRsZT4KPHRleHQgdGV4dC1hbmNob3I9Im1pZGRsZSIgeD0iNjMiIHk9Ii04Ni4zIiBmb250LWZhbWlseT0iVGltZXMsc2VyaWYiIGZvbnQtc2l6ZT0iMTQuMDAiPngyPC90ZXh0Pgo8L2c+CjwhLS0gb3AyJiM0NTsmZ3Q7eDIgLS0+CjxnIGlkPSJlZGdlMyIgY2xhc3M9ImVkZ2UiPjx0aXRsZT5vcDI6c3cmIzQ1OyZndDt4MjwvdGl0bGU+CjxwYXRoIGZpbGw9Im5vbmUiIHN0cm9rZT0iYmxhY2siIGQ9Ik04MSwtMTQ0QzcxLjUxNzUsLTEzNC41MTggNjcuMDI3OCwtMTE5Ljg1NyA2NC45MDM0LC0xMDguMzU3Ii8+CjwvZz4KPCEtLSB6IC0tPgo8ZyBpZD0ibm9kZTYiIGNsYXNzPSJub2RlIj48dGl0bGU+ejwvdGl0bGU+Cjx0ZXh0IHRleHQtYW5jaG9yPSJtaWRkbGUiIHg9Ijk5IiB5PSItMTQuMyIgZm9udC1mYW1pbHk9IlRpbWVzLHNlcmlmIiBmb250LXNpemU9IjE0LjAwIj56PC90ZXh0Pgo8L2c+CjwhLS0gb3AzJiM0NTsmZ3Q7eiAtLT4KPGcgaWQ9ImVkZ2U1IiBjbGFzcz0iZWRnZSI+PHRpdGxlPm9wMzpzdyYjNDU7Jmd0O3o8L3RpdGxlPgo8cGF0aCBmaWxsPSJub25lIiBzdHJva2U9ImJsYWNrIiBkPSJNMTE3LC03MkMxMDcuNTE4LC02Mi41MTc1IDEwMy4wMjgsLTQ3Ljg1NzIgMTAwLjkwMywtMzYuMzU2OCIvPgo8L2c+CjwhLS0geG4gLS0+CjxnIGlkPSJub2RlNyIgY2xhc3M9Im5vZGUiPjx0aXRsZT54bjwvdGl0bGU+Cjx0ZXh0IHRleHQtYW5jaG9yPSJtaWRkbGUiIHg9IjE3MSIgeT0iLTE0LjMiIGZvbnQtZmFtaWx5PSJUaW1lcyxzZXJpZiIgZm9udC1zaXplPSIxNC4wMCI+eG48L3RleHQ+CjwvZz4KPCEtLSBvcDMmIzQ1OyZndDt4biAtLT4KPGcgaWQ9ImVkZ2U2IiBjbGFzcz0iZWRnZSI+PHRpdGxlPm9wMzpzZSYjNDU7Jmd0O3huPC90aXRsZT4KPHBhdGggZmlsbD0ibm9uZSIgc3Ryb2tlPSJibGFjayIgZD0iTTE1MywtNzJDMTYyLjQ4MiwtNjIuNTE3NSAxNjYuOTcyLC00Ny44NTcyIDE2OS4wOTcsLTM2LjM1NjgiLz4KPC9nPgo8L2c+Cjwvc3ZnPgo="><h3 id="45-left-和-right-的区别"><a class="markdownIt-Anchor" href="#45-left-和-right-的区别"></a> 4.5 <code>left</code> 和 <code>right</code> 的区别</h3><p>那么 <code>left</code> 和 <code>right</code> 有什么区别呢？</p><p>实际上，高阶函数的作用范围都是 <strong>整个列表</strong>；</p><p>所以，对于满足 <strong>交换律</strong> 和 <strong>结合律</strong> 的运算，从左边执行和从右边执行的结果是 <strong>一样的</strong>，例如 <strong>加法操作</strong>；</p><p>但是，对于不满足交换律和结合律的运算，例如 <strong>减法操作</strong>；</p><p>那么这两个函数的执行结果就不一样。</p><h3 id="46-其他规约函数"><a class="markdownIt-Anchor" href="#46-其他规约函数"></a> 4.6 其他规约函数</h3><p>Scala 还提供了一些其他的针对数字类型的规约函数；</p><p>例如：<code>sum</code>， <code>product</code>，<code>max</code> 和 <code>min</code>；</p><p>不过，<code>sum</code> 和 <code>product</code> 只能用于数字类型，否则会报错。</p><h2 id="5-其他高阶函数"><a class="markdownIt-Anchor" href="#5-其他高阶函数"></a> 5. 其他高阶函数</h2><p>Scala 集合中还拥有其他的高阶函数，诸如：<code>count</code>、<code>find</code>、<code>sortWith</code> 等；</p><p>这些函数的作用比较明显，可以从它的命名中推测出其作用，在这里就不多做解释了。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;高阶函数是函数式编程的一个很大的特性；&lt;/p&gt;&lt;p&gt;同时，其中集合类的高阶函数在日常的开发和使用中，占了一个很重要的位置；&lt;/p&gt;&lt;p&gt;但是，这些函数有可能会在刚接触的时候搞不懂它们的具体作用；&lt;/p&gt;&lt;p&gt;那么今天就以 &lt;code&gt;List&lt;/code&gt; 来说一说常用的高阶函数具体的作用。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Scala" scheme="https://wafer.li/categories/Scala/"/>
    
    
      <category term="Scala" scheme="https://wafer.li/tags/Scala/"/>
    
  </entry>
  
  <entry>
    <title>ofo 使用体验</title>
    <link href="https://wafer.li//Talk/ofo%20%E4%BD%BF%E7%94%A8%E4%BD%93%E9%AA%8C/"/>
    <id>https://wafer.li//Talk/ofo 使用体验/</id>
    <published>2017-04-18T13:10:00.000Z</published>
    <updated>2017-04-18T13:34:15.000Z</updated>
    
    <content type="html"><![CDATA[<p>最近因为和舍友出去看电影，终于第一次体验了一下著名的小黄车 ofo；</p><p>ofo 的确是很方便，同时也解决了所谓「最后一公里」的这个需求痛点；</p><p>但是，我不得不说，ofo 的运营团队还很年轻，一些很基本的流程问题都没搞清楚就胡乱上线功能。</p><a id="more"></a><h2 id="1-校园认证"><a class="markdownIt-Anchor" href="#1-校园认证"></a> 1. 校园认证</h2><p>就比如说 ofo 的校园认证，的确对我等大学生有很大的优惠；</p><p>但是，当你校园认证不通过，而你急着用车，去进行了普通认证，那么：</p><p><strong>你就再也不能进行校园认证了!</strong></p><p>明明就是一个很容易考虑到的 Corner Case，可是 ofo 却没有处理好；</p><p>看来 ofo 还需要多招几个测试大牛。</p><h2 id="2-客服电话"><a class="markdownIt-Anchor" href="#2-客服电话"></a> 2. 客服电话</h2><p>APP 上解决不了的问题，一般的用户就会想着去联系客服解决；</p><p>在这里我不得不说一声 MMP，ofo 的客服电话三天两头打不通；</p><p>在半个小时之内，我连续向其拨打了 12 通电话；但是，只有 3 通是能接通的。</p><p>第一通电话接通之后，首先是让我退押金，然后再打电话；</p><blockquote><p>这也无可厚非，毕竟银行信用卡激活就是这么要求的</p></blockquote><p>第二通电话，就有点莫名其妙了，首先接话员连普通话也说不标准；</p><p>然后说没有权限恢复我的认证状态，在经过多次撕逼之后，让我去找一个微信号去解决；</p><p>结果这个微信号居然是个 <strong>异常号！</strong></p><p>第三通电话之后，告诉我，你还有余额没有退，所以不能给你恢复认证状态。</p><p>结果呢？帮我申请了余额退款，说要到账之后才能进行下一步的操作。</p><p>所以就导致我现在，没有押金，余额还在银行流转，所以小黄车就不关我什么事了。</p><h2 id="3-总结"><a class="markdownIt-Anchor" href="#3-总结"></a> 3. 总结</h2><p>可以看出，就是因为一个没有考虑到的 Corner Case ，现在我只能去骑 mobike;</p><p>想到当年即使是写小学期项目，也要跟队员讨论个大半天的 Corner Case 才开始着手编码；</p><p>可能这就是互联网 APP 泡沫生态的现状吧：</p><p>大家都去抢功能，让功能尽早上线，剩下的维护啊支持啊，都可以往后边放一放。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;最近因为和舍友出去看电影，终于第一次体验了一下著名的小黄车 ofo；&lt;/p&gt;&lt;p&gt;ofo 的确是很方便，同时也解决了所谓「最后一公里」的这个需求痛点；&lt;/p&gt;&lt;p&gt;但是，我不得不说，ofo 的运营团队还很年轻，一些很基本的流程问题都没搞清楚就胡乱上线功能。&lt;/p&gt;
    
    </summary>
    
    
      <category term="杂谈" scheme="https://wafer.li/categories/Talk/"/>
    
    
      <category term="ofo" scheme="https://wafer.li/tags/ofo/"/>
    
      <category term="杂谈" scheme="https://wafer.li/tags/Talk/"/>
    
  </entry>
  
  <entry>
    <title>Coursera 作业之函数集合</title>
    <link href="https://wafer.li//Coursera/Scala/Coursera%20%E4%BD%9C%E4%B8%9A%E4%B9%8B%E5%87%BD%E6%95%B0%E9%9B%86%E5%90%88/"/>
    <id>https://wafer.li//Coursera/Scala/Coursera 作业之函数集合/</id>
    <published>2017-04-16T17:41:00.000Z</published>
    <updated>2017-04-18T16:32:07.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>本文源码：<br><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3dhZmVyLWxpL3NjYWxhLWNvdXJzZXJhL3RyZWUvbWFzdGVyL2Z1bnNldHM=" title="https://github.com/wafer-li/scala-coursera/tree/master/funsets">https://github.com/wafer-li/scala-coursera/tree/master/funsets<i class="fa fa-external-link"></i></span></p></blockquote><h2 id="1-背景知识"><a class="markdownIt-Anchor" href="#1-背景知识"></a> 1. 背景知识</h2><p>该作业是实现一个函数集合的相关内容。</p><p>何为函数集合？</p><p>一般来说，编程语言中的集合(Collection)都是有限集合；</p><p>但是，在数学上，还有很多的集合是无限集合，比如说 <strong>负数集</strong>；</p><p>我们有没有一种办法去表示这个集合呢？</p><a id="more"></a><p>当然有的，对于上面的负数集来说，我们如何知道一个数字是不是负数集中的元素呢？</p><p>将它与 0 进行比较，如果 x &lt; 0，那么它就是负数集的元素。</p><p>此时，<code>(x) =&gt; x == 0</code> 就成为了负数集的判断标准，我们将其作为负数集的 <strong>特征函数</strong>，通过特征函数来指代特定的集合。</p><p>于是，我们得到了函数集合的定义：<code>type Set = (Int) =&gt; Boolean</code></p><p>和它的一个基本方法 <code>contains()</code>：</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">contains</span></span>(set: <span class="type">Set</span>, x : <span class="type">Int</span>) = set(x)</span><br></pre></td></tr></table></figure><h2 id="2-基本方法"><a class="markdownIt-Anchor" href="#2-基本方法"></a> 2. 基本方法</h2><p>接下来，题目要求我们实现一些集合的基本方法。</p><h3 id="21-singletonset"><a class="markdownIt-Anchor" href="#21-singletonset"></a> 2.1 <code>singletonSet()</code></h3><p>如何返回一个只有一个元素的函数集合呢？</p><p>对于我们的特征函数来说，也就是只有给定的元素才能满足这个特征函数，这样的集合就是只存在给定元素的集合。</p><p>所以，定义如下：</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">singletonSet</span></span>(elem: <span class="type">Int</span>): <span class="type">Set</span> = (x) =&gt; x == elem</span><br></pre></td></tr></table></figure><h3 id="22-交-并-补"><a class="markdownIt-Anchor" href="#22-交-并-补"></a> 2.2 交、并、补</h3><p>这几个基本的数学集合操作并不难，只需要抓住我们特征函数就是 <code>contains()</code> 这一点就行了。</p><h3 id="23-filter"><a class="markdownIt-Anchor" href="#23-filter"></a> 2.3 <code>filter()</code></h3><p>这个方法算是在 JVM 函数式语言中经常出现的集合方法；</p><p>作用就是返回满足条件的集合内的元素；</p><p>其中，一个很有趣的地方在于，<code>filter(s, p)</code> 的两个参数，虽然其表面上的类型不一样；</p><p>但是实际上他们的类型是一样的，也就是说，<code>s</code> 和 <code>p</code> 都是集合！</p><p>所以，我们只需要返回 <code>s</code> 和 <code>p</code> 的交集就行了</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter</span></span>(s: <span class="type">Set</span>, p: <span class="type">Int</span> =&gt; <span class="type">Boolean</span>) = intersect(s, p)</span><br></pre></td></tr></table></figure><h2 id="3-forall"><a class="markdownIt-Anchor" href="#3-forall"></a> 3. <code>forAll()</code></h2><p>然后，有趣的地方来了，题目要求我们实现一个 <code>forAll()</code> 方法，用来检测是否 <strong>所有的</strong> 元素都满足给定的条件。</p><p>当然，我们不能遍历全部的无限集元素；</p><p>所以，我们就采取一个区间的办法，如果在这个区间内的所有的元素都满足条件，那么我们有信心认为所有的元素都满足了条件。</p><p>在这里，同样要注意， <code>s</code> 和 <code>p</code> 的类型实际上是一样的！</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">forall</span></span>(s: <span class="type">Set</span>, p: <span class="type">Int</span> =&gt; <span class="type">Boolean</span>): <span class="type">Boolean</span> = &#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">iter</span></span>(a: <span class="type">Int</span>): <span class="type">Boolean</span> = &#123;</span><br><span class="line">    <span class="keyword">if</span> (a &gt; bound) <span class="literal">true</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (diff(s, p)(a)) <span class="literal">false</span></span><br><span class="line">    <span class="keyword">else</span> iter(a + <span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  iter(-bound)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4-exists"><a class="markdownIt-Anchor" href="#4-exists"></a> 4. <code>exists()</code></h2><p>本题第二难的地方来了，题目要求实现一个 <code>exists()</code> 函数，用于检测 <strong>是否存在</strong> 一个元素满足给定的条件。</p><p>按说这个还不是很难，但是，题目要求使用 <code>forAll()</code> 进行实现。</p><p>按照我的早就丢给高中老师的逻辑关系知识，『所有』和 『存在』好像并无什么联系。</p><p>不过，在论坛上有人提醒了我，可以使用 <strong>间接法</strong>；</p><p>也就是说，我们可以考虑一下 <strong>不存在</strong> 的情况；</p><p>也就是说，对于 <strong>所有的</strong> 元素，都 <strong>不满足</strong> 给定的条件；</p><p>到此，我们就可以利用上之前实现的 <code>forAll()</code> 了。</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exists</span></span>(s: <span class="type">Set</span>, p: <span class="type">Int</span> =&gt; <span class="type">Boolean</span>) =</span><br><span class="line">    !forAll(s, (elem) =&gt; !p(elem))</span><br></pre></td></tr></table></figure><p>但是，这显得太长了，能不能缩短到只有一行代码呢？</p><p>之前提到，<code>s</code> 和 <code>p</code> 的类型实际上是一样的，也就是说，我们可以重用上面的方法来对 <code>s</code> 和 <code>p</code> 进行处理。</p><p>那么，<code>s</code> 和 <code>p</code> 在不存在的情况下，是什么样的关系呢？</p><p>我们可以从上面的结论出发继续思考：</p><p>对于所有的元素，都不满足给定条件 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>⇒</mo></mrow><annotation encoding="application/x-tex">\Rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.36687em;vertical-align:0"></span><span class="mrel">⇒</span></span></span></span> 对于 <code>s</code> 的所有元素，都位于「在 <code>s</code> 且不在 <code>p</code> 中」这个集合内</p><p>所以，我们得到了一个简便的写法：</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exists</span></span>(s: <span class="type">Set</span>, p: <span class="type">Int</span> =&gt; <span class="type">Boolean</span>) = !forAll(s, diff(s, p))</span><br></pre></td></tr></table></figure><h2 id="5-map"><a class="markdownIt-Anchor" href="#5-map"></a> 5. <code>map()</code></h2><p>本题最难的部分来了，<code>map()</code> 函数，用于对集合中的元素进行变换操作，返回一个变换过后的新集合。</p><p>鉴于我们的集合是一个 <strong>函数</strong>，那么 <code>map()</code> 方法也就是返回一个 <strong>新函数</strong>，用来检测参数是否满足新变换过后的条件。</p><p>因为 <code>map()</code> 函数是针对原有集合进行变换，所以，我们应该基于原有集合生成上面的新函数。</p><p>也就是说，对于原有集合来说，是否存在一个元素，它变换过后的数值和传入的参数相等：</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">map</span></span>(s: <span class="type">Set</span>, f: <span class="type">Int</span> =&gt; <span class="type">Int</span>) =</span><br><span class="line">    x =&gt; exists(s, elem =&gt; x==f(elem))</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;&lt;p&gt;本文源码：&lt;br&gt;&lt;a href=&quot;https://github.com/wafer-li/scala-coursera/tree/master/funsets&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://github.com/wafer-li/scala-coursera/tree/master/funsets&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;&lt;h2 id=&quot;1-背景知识&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#1-背景知识&quot;&gt;&lt;/a&gt; 1. 背景知识&lt;/h2&gt;&lt;p&gt;该作业是实现一个函数集合的相关内容。&lt;/p&gt;&lt;p&gt;何为函数集合？&lt;/p&gt;&lt;p&gt;一般来说，编程语言中的集合(Collection)都是有限集合；&lt;/p&gt;&lt;p&gt;但是，在数学上，还有很多的集合是无限集合，比如说 &lt;strong&gt;负数集&lt;/strong&gt;；&lt;/p&gt;&lt;p&gt;我们有没有一种办法去表示这个集合呢？&lt;/p&gt;
    
    </summary>
    
    
      <category term="Coursera" scheme="https://wafer.li/categories/Coursera/"/>
    
      <category term="Scala" scheme="https://wafer.li/categories/Coursera/Scala/"/>
    
    
      <category term="Scala" scheme="https://wafer.li/tags/Scala/"/>
    
      <category term="Coursera" scheme="https://wafer.li/tags/Coursera/"/>
    
  </entry>
  
  <entry>
    <title>Scala 模式匹配</title>
    <link href="https://wafer.li//Scala/Scala%20%E6%A8%A1%E5%BC%8F%E5%8C%B9%E9%85%8D/"/>
    <id>https://wafer.li//Scala/Scala 模式匹配/</id>
    <published>2017-04-15T18:07:00.000Z</published>
    <updated>2017-04-18T16:32:07.000Z</updated>
    
    <content type="html"><![CDATA[<p>模式匹配，是 Scala 相比 Java 在类型上的一个很好地改进；</p><p>通过引入模式匹配，消除了 Java 中常见的类型检测和强制转换(cast)；</p><p>拥有更高的安全性</p><a id="more"></a><h2 id="1-问题背景"><a class="markdownIt-Anchor" href="#1-问题背景"></a> 1. 问题背景</h2><p>模式匹配主要解决的问题就是一个树状的类型依赖图；</p><p>比如算数表达式，由文法可知，它是具有树状依赖关系的：</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mi>E</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>→</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mi>E</mi><mo>+</mo><mi>E</mi><mtext> </mtext><mi mathvariant="normal">∣</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mi>E</mi><mo>−</mo><mi>E</mi><mtext> </mtext><mi mathvariant="normal">∣</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mi>E</mi><mo>∗</mo><mi>E</mi><mtext> </mtext><mi mathvariant="normal">∣</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mi>E</mi><mi mathvariant="normal">/</mi><mi>E</mi><mtext> </mtext><mi mathvariant="normal">∣</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo stretchy="false">(</mo><mi>E</mi><mo stretchy="false">)</mo><mtext> </mtext><mi mathvariant="normal">∣</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mi>i</mi></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned} E &amp; \rightarrow \\ &amp; E+E \ | \\ &amp; E-E \ | \\ &amp; E*E \ | \\ &amp; E/E \ | \\ &amp; (E) \ | \\ &amp; i \end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:10.500000000000004em;vertical-align:-5.000000000000002em"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:5.500000000000001em"><span style="top:-7.660000000000001em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathdefault" style="margin-right:.05764em">E</span></span></span><span style="top:-6.16em"><span class="pstrut" style="height:3em"></span><span class="mord"></span></span><span style="top:-4.659999999999999em"><span class="pstrut" style="height:3em"></span><span class="mord"></span></span><span style="top:-3.1599999999999993em"><span class="pstrut" style="height:3em"></span><span class="mord"></span></span><span style="top:-1.6599999999999993em"><span class="pstrut" style="height:3em"></span><span class="mord"></span></span><span style="top:-.15999999999999837em"><span class="pstrut" style="height:3em"></span><span class="mord"></span></span><span style="top:1.3400000000000016em"><span class="pstrut" style="height:3em"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:5.000000000000002em"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:5.500000000000001em"><span style="top:-7.660000000000001em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">→</span></span></span><span style="top:-6.16em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"></span><span class="mord mathdefault" style="margin-right:.05764em">E</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mord mathdefault" style="margin-right:.05764em">E</span><span class="mspace"> </span><span class="mord">∣</span></span></span><span style="top:-4.659999999999999em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"></span><span class="mord mathdefault" style="margin-right:.05764em">E</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mord mathdefault" style="margin-right:.05764em">E</span><span class="mspace"> </span><span class="mord">∣</span></span></span><span style="top:-3.1599999999999993em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"></span><span class="mord mathdefault" style="margin-right:.05764em">E</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mord mathdefault" style="margin-right:.05764em">E</span><span class="mspace"> </span><span class="mord">∣</span></span></span><span style="top:-1.6599999999999993em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"></span><span class="mord mathdefault" style="margin-right:.05764em">E</span><span class="mord">/</span><span class="mord mathdefault" style="margin-right:.05764em">E</span><span class="mspace"> </span><span class="mord">∣</span></span></span><span style="top:-.15999999999999837em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:.05764em">E</span><span class="mclose">)</span><span class="mspace"> </span><span class="mord">∣</span></span></span><span style="top:1.3400000000000016em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"></span><span class="mord mathdefault">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:5.000000000000002em"><span></span></span></span></span></span></span></span></span></span></span></span></p><p>所以，我们可以使用如下的类来表示一个算术表达式：</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">Expr</span></span></span><br><span class="line"><span class="class"><span class="title">class</span> <span class="title">Number</span>(<span class="params">n: <span class="type">Int</span></span>) <span class="keyword">extends</span> <span class="title">Expr</span></span></span><br><span class="line"><span class="class"><span class="title">class</span> <span class="title">Sum</span>(<span class="params">leftOp: <span class="type">Expr</span>, rightOp: <span class="type">Expr</span></span>) <span class="keyword">extends</span> <span class="title">Expr</span></span></span><br></pre></td></tr></table></figure><p>那么当我们需要使用类似 <code>eval()</code> 的方法时，该如何实现这个方法呢？</p><h2 id="2-各有缺陷的解法"><a class="markdownIt-Anchor" href="#2-各有缺陷的解法"></a> 2. 各有缺陷的解法</h2><h3 id="21-使用类型说明"><a class="markdownIt-Anchor" href="#21-使用类型说明"></a> 2.1 使用类型说明</h3><p>一个暴力解决的思路就是为 <code>Expr</code> 添加上一个类型的说明，即：</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">Expr</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">isNumber</span></span>: <span class="type">Boolean</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">isSum</span></span>: <span class="type">Boolean</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>不过，随着以后算术表达式的种类越来越多，比如加入了乘法和除法；</p><p>那么，这个实现会导致方法数的平方级别爆炸。</p><blockquote><p>每增加一个种类，都需要对现有的所有类进行方法的增加</p></blockquote><p>显然，使用类型说明(classification) 是不行的。</p><h3 id="22-类型检测和造型"><a class="markdownIt-Anchor" href="#22-类型检测和造型"></a> 2.2 类型检测和造型</h3><p>Java 这门面向对象语言对此则有比较好的解法：</p><p>通过对对象进行类型检测和强制转换(cast)；</p><p>由于强制转换后类型得到限定，所以就可以分别进行检测工作：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">eval</span><span class="params">(Expr e)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (e <span class="keyword">instanceof</span> Number) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> Sum) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>相对的，Scala 也具有这种语法特性：</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">eval</span></span>(e: <span class="type">Expr</span>): <span class="type">Int</span> = &#123;</span><br><span class="line">    <span class="keyword">if</span> (e.isInstanceOf[<span class="type">Number</span>]) &#123;</span><br><span class="line">        e.asInstanceOf[<span class="type">Number</span>].numberValue</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (e.isInstanceOf[<span class="type">Sum</span>]) &#123;</span><br><span class="line">        <span class="keyword">val</span> sum = e.asInstanceOf[<span class="type">Sum</span>]</span><br><span class="line">        eval(sum.leftOp) + eval(sum.rightOp)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>不过，这种方法由于是比较低层级的，具有指令性特征；</p><p>同时，过多的类型检测和强制转换也造成了诸多不安全因素：</p><p>如果运行时类型改变了，那么很可能会出现异常。</p><h3 id="23-面向对象的解法"><a class="markdownIt-Anchor" href="#23-面向对象的解法"></a> 2.3 面向对象的解法</h3><p>现在我们来选择一个更高级的解决办法，通过利用多态特性，来解决此类问题。</p><p>相比将 <code>eval()</code> 作为一个外部的函数，不如将其作为类的一个内部方法：</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">Expr</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">eval</span></span>: <span class="type">Int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Number</span>(<span class="params">n: <span class="type">Int</span></span>) <span class="keyword">extends</span> <span class="title">Expr</span> </span>&#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">eval</span></span>: <span class="type">Int</span> = n</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sum</span>(<span class="params">leftOp: <span class="type">Expr</span>, rightOp: <span class="type">Expr</span></span>) <span class="keyword">extends</span> <span class="title">Expr</span> </span>&#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">eval</span></span>: <span class="type">Int</span> = leftOp.eval + rightOp.eval</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过语言自带的多态特性，我们可以使用到具体的 <code>eval()</code>；</p><p>这样就能很优雅的解决上面的问题；</p><p>不过，这种写法有个缺陷；</p><p>如果我们需要添加一个新的方法，例如 <code>show()</code>，则需要更改所有的现存类；</p><p>而且，如果我们需要一个化简操作，它不能仅仅只考虑一个节点，而需要多个节点综合考虑；</p><p>这样，我们可以发现，即使使用多态，也没能解决我们所有的问题</p><h2 id="3-模式匹配"><a class="markdownIt-Anchor" href="#3-模式匹配"></a> 3. 模式匹配</h2><p>在 Scala 中，具有一个很常用的语法用于解决这类问题，即 <strong>模式匹配</strong>；</p><p>模式匹配使用 <code>match</code> 定义：</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">e <span class="keyword">match</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="type">Number</span>(n) =&gt; n</span><br><span class="line">    <span class="keyword">case</span> <span class="type">Sum</span>(left, right) =&gt; left.eval + right.eval</span><br><span class="line">    <span class="keyword">case</span> anotherE =&gt; anotherE.eval</span><br><span class="line">    <span class="keyword">case</span> _ =&gt; <span class="comment">//Ignore</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>match</code> 语句块中，包含多个 <code>case</code> 语句；</p><p>每个 <code>case</code> 语句包括：<code>case</code> 关键字，模式和表达式，模式和表达式使用 <code>=&gt;</code> 分隔。</p><p>乍一看，这个语法和 C++/Java 中的 <code>switch</code> 很像；</p><p>不过，它进行了大幅度的强化，主要就是放宽了对选择器的限制：</p><p>现在 <code>case</code> 语句可以是：</p><ol><li>构造器</li><li>变量</li><li>常量</li><li>通配符 <code>_</code></li></ol><p>其中：</p><ul><li>构造器必须是 <code>case class</code></li><li>变量必须以小写字母开头</li><li>常量必须以大写字母开头</li></ul><h2 id="4-匹配处理"><a class="markdownIt-Anchor" href="#4-匹配处理"></a> 4. 匹配处理</h2><p>首先，如果没有 <code>case</code> 能够匹配选择器，则会抛出异常。</p><p>然后，如果匹配成功，会将 <strong>整个 <code>match</code> 语句</strong> 替换为 <code>case</code> 的 right-hand side。</p><p>对于不同的情况，则是：</p><ul><li>构造器，将参数绑定 <code>case</code> 中的形参</li><li>变量，对变量进行赋值</li><li>常量，检测和常量的相等性</li></ul><h2 id="5-case-class"><a class="markdownIt-Anchor" href="#5-case-class"></a> 5. Case Class</h2><p>Case Class 是一种特殊的类，通常用于进行模式匹配；</p><p>但是，它还具有一些其他的有用特性：</p><p>它不需要 <code>new</code> 关键字进行构建：</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="type">Person</span>(name: <span class="type">String</span>, age: <span class="type">Int</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> person = <span class="type">Person</span>(<span class="string">"hehe"</span>, <span class="number">18</span>)</span><br></pre></td></tr></table></figure><p>它的主要构造器参数直接可以作为类的字段：</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> name = person.name</span><br></pre></td></tr></table></figure><p>它的相等性判断是结构化的，当它所有的成员都相等时，它就相等，和引用无关；</p><p>同时还提供了 <code>toString()</code> 方法：</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> firstSms = <span class="type">SMS</span>(<span class="string">"12345"</span>, <span class="string">"Hello!"</span>)</span><br><span class="line"><span class="keyword">val</span> secondSms = <span class="type">SMS</span>(<span class="string">"12345"</span>, <span class="string">"Hello!"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (firstSms == secondSms) &#123;</span><br><span class="line">  println(<span class="string">"They are equal!"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">println(<span class="string">"SMS is: "</span> + firstSms)</span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">They are equal!</span><br><span class="line">SMS is: SMS(12345, Hello!)</span><br></pre></td></tr></table></figure><h2 id="6-模式匹配的解决办法"><a class="markdownIt-Anchor" href="#6-模式匹配的解决办法"></a> 6. 模式匹配的解决办法</h2><p>使用模式匹配，我们不仅可以对单个节点进行解析工作；</p><p>同时，我们还可以查看节点之间的关系：</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">Expr</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">eval</span></span>: <span class="type">Int</span> = <span class="keyword">this</span> <span class="keyword">match</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="type">Number</span>(n) =&gt; n</span><br><span class="line">    <span class="keyword">case</span> <span class="type">Sum</span>(left, right) =&gt; left.eval + right.eval</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">show</span></span>: <span class="type">String</span> = <span class="keyword">this</span> <span class="keyword">match</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="type">Number</span>(n) =&gt; n.toString</span><br><span class="line">    <span class="keyword">case</span> <span class="type">Sum</span>(left, right) =&gt; left.show + <span class="string">"+"</span> + right.show</span><br><span class="line">    <span class="keyword">case</span> <span class="type">Prod</span>(left, right) =&gt;</span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">f</span></span>(e: <span class="type">Expr</span>): <span class="type">String</span> = e <span class="keyword">match</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="type">Sum</span>(l, r) =&gt; <span class="string">"("</span> + l.show + <span class="string">"+"</span> + r.show + <span class="string">")"</span></span><br><span class="line">        <span class="keyword">case</span> _ =&gt; e.show</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      f(left) + <span class="string">"*"</span> + f(right)</span><br><span class="line">    <span class="keyword">case</span> <span class="type">Var</span>(x) =&gt; x</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Number</span>(<span class="params">n: <span class="type">Int</span></span>) <span class="keyword">extends</span> <span class="title">Expr</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">case</span> <span class="title">class</span> <span class="title">Sum</span>(<span class="params">left: <span class="type">Expr</span>, right: <span class="type">Expr</span></span>) <span class="keyword">extends</span> <span class="title">Expr</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">case</span> <span class="title">class</span> <span class="title">Var</span>(<span class="params">x: <span class="type">String</span></span>) <span class="keyword">extends</span> <span class="title">Expr</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">case</span> <span class="title">class</span> <span class="title">Prod</span>(<span class="params">left: <span class="type">Expr</span>, right: <span class="type">Expr</span></span>) <span class="keyword">extends</span> <span class="title">Expr</span></span></span><br></pre></td></tr></table></figure><p>上面的 <code>show</code> 方法通过查看子节点情况，实现了优先级区分:</p><p><img alt data-src="https://ww1.sinaimg.cn/large/006tNc79ly1fenynuh6prj316g09g763.jpg"></p><h2 id="7-和多态方法的区别"><a class="markdownIt-Anchor" href="#7-和多态方法的区别"></a> 7. 和多态方法的区别</h2><p>那么模式匹配相比面向对象方法有什么优势呢？</p><p>如果你倾向于在现有的类架构上添加 <strong>通用的方法</strong>，那么采用模式匹配会更好；</p><p>因为模式匹配只需要修改匹配代码，而不需要在各个子类重新实现方法。</p><p>但是，如果你倾向于增加子类，而不是增加通用的处理方法，那么采用多态方法会更好；</p><p>原因是采用多态架构只需要建立一个子类，而重载方法这些繁琐工作 IDE 会帮你做好；</p><p>而模式匹配还需要在顶层代码中进行修改</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;模式匹配，是 Scala 相比 Java 在类型上的一个很好地改进；&lt;/p&gt;&lt;p&gt;通过引入模式匹配，消除了 Java 中常见的类型检测和强制转换(cast)；&lt;/p&gt;&lt;p&gt;拥有更高的安全性&lt;/p&gt;
    
    </summary>
    
    
      <category term="Scala" scheme="https://wafer.li/categories/Scala/"/>
    
    
      <category term="Scala" scheme="https://wafer.li/tags/Scala/"/>
    
  </entry>
  
  <entry>
    <title>打字训练网站</title>
    <link href="https://wafer.li//Talk/%E6%89%93%E5%AD%97%E8%AE%AD%E7%BB%83%E7%BD%91%E7%AB%99/"/>
    <id>https://wafer.li//Talk/打字训练网站/</id>
    <published>2017-04-15T04:37:00.000Z</published>
    <updated>2017-04-15T14:32:18.000Z</updated>
    
    <content type="html"><![CDATA[<p>买了新键盘之后就想试一试它的威力，所以就找了一个打字训练网站来打字；</p><p>在知乎上找了一圈，结果就找到了 <span class="exturl" data-url="aHR0cDovL3d3dy5rZXlici5jb20vcHJhY3RpY2U=" title="http://www.keybr.com/practice">这个<i class="fa fa-external-link"></i></span>；</p><p>练了一圈的感受就是： <strong>左手好累啊！！！</strong></p><p>基本上单词表里面最长的 S 和 T 都在左手了，而我又习惯使用左手来按空格键；</p><p>结果就是我的左手现在累得不成样子了；</p><p>不过最后成绩也不怎么样，大概也就 50 多 wpm 吧，相信大家一定会比我打字快的。</p><p><img alt data-src="https://ww4.sinaimg.cn/large/006tNc79ly1fenqgox6a5j317a0jejtu.jpg"></p>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;买了新键盘之后就想试一试它的威力，所以就找了一个打字训练网站来打字；&lt;/p&gt;&lt;p&gt;在知乎上找了一圈，结果就找到了 &lt;span class=&quot;exturl&quot; data-url=&quot;aHR0cDovL3d3dy5rZXlici5jb20vcHJhY3RpY2U=&quot;
        
      
    
    </summary>
    
    
      <category term="杂谈" scheme="https://wafer.li/categories/Talk/"/>
    
    
      <category term="杂谈" scheme="https://wafer.li/tags/Talk/"/>
    
      <category term="打字" scheme="https://wafer.li/tags/Typing/"/>
    
      <category term="Typing training" scheme="https://wafer.li/tags/Typing-training/"/>
    
  </entry>
  
  <entry>
    <title>Realforce 87u</title>
    <link href="https://wafer.li//Buying/Realforce%2087u/"/>
    <id>https://wafer.li//Buying/Realforce 87u/</id>
    <published>2017-04-11T04:28:00.000Z</published>
    <updated>2018-01-08T05:35:57.000Z</updated>
    
    <content type="html"><![CDATA[<p>最近终于下定决心来买这个键盘了。</p><p>主要说说使用感受吧</p><p>2018/1/8 更新部分内容</p><a id="more"></a><h2 id="1-手感"><a class="markdownIt-Anchor" href="#1-手感"></a> 1. 手感</h2><p>我买的这个是静音版，手感介于红轴和茶轴之间，就是稍微软一点的茶轴，按起来有种噗噗的感觉；</p><p>显然，打击感是一点也没有了，不过真的有种揉胸的感觉。</p><p>不过这个键盘的优点在于：由于是分区压力，所以能极大地缓解小拇指的压力；</p><p>之前我用的 filco 青轴，最后有 40% 的概率用小拇指打不出 shift 按键；</p><p>这也是为什么我要买一个新键盘的原因。</p><h2 id="2-特色功能"><a class="markdownIt-Anchor" href="#2-特色功能"></a> 2. 特色功能</h2><p>Realforce 87u 有个特色功能，就是把没有什么卵用的 Scroll Lock 变成了 NumLock；</p><p>也就是说，这个键盘有 <strong>小键盘</strong> 的功能！</p><p>这是我在 87 键盘上从来没有见到过的。</p><p>不过在 Mac 上，这个 NumLock 就失效了；</p><blockquote><p>2018/1/8 补充：<br><strong>可惜的是，自从升级到 High Sierra 之后下面的方法就不管用了</strong><br><strong>不过吧，反正我也不怎么用这个小键盘，先就这样吧。</strong></p></blockquote><p>需要使用 Karabiner 进行键位修改。</p><p>首先下载 Karabiner，这里有个小问题就是 <code>brew cask</code> 会报 <code>Operation not permitted</code> 的错误；</p><p>所以最好还是自己下载镜像安装为好。</p><p>随后点击 <code>Open private.xml</code>：</p><p><img alt data-src="https://ww1.sinaimg.cn/large/006tNbRwly1feindhtm6kj318g0zoagn.jpg"></p><p>然后加上一条自定义配置<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>Map Realforce Numlock to OSX Numlock function<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">identifier</span>&gt;</span>private.pc_numlock_to_mac_numlock<span class="tag">&lt;/<span class="name">identifier</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">autogen</span>&gt;</span>__KeyToKey__ KeyCode::KEYPAD_CLEAR, KeyCode::VK_IOHIKEYBOARD_TOGGLE_NUMLOCK<span class="tag">&lt;/<span class="name">autogen</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br></pre></td></tr></table></figure><p>最后再到 <code>Change Key</code> 启用就可以了。</p><p><img alt data-src="https://ww3.sinaimg.cn/large/006tNbRwly1feingd0pg8j30ts06qabi.jpg"></p><h2 id="3-缺点"><a class="markdownIt-Anchor" href="#3-缺点"></a> 3. 缺点</h2><p>目前遇到的缺点只有一个：</p><p>就是它的导线槽太紧了，几乎是死死卡住键盘的线缆；</p><p>结果我摆弄的时候需要用很大的力气才能把线弄出来，希望以后不要弄烂为好；</p><blockquote><p>小贴士：弄的时候长痛不如短痛，直接一个猛劲可以更快的减轻线缆的损伤</p></blockquote><p>其次就是居然不配理线用的尼龙扎带，差评！</p><h2 id="4-为什么不买-hhkb"><a class="markdownIt-Anchor" href="#4-为什么不买-hhkb"></a> 4. 为什么不买 HHKB</h2><p>不喜欢 HHKB 的配列。</p><p>我就爱用 <code>Caps Lock</code> 🙃</p><h2 id="5-总结"><a class="markdownIt-Anchor" href="#5-总结"></a> 5. 总结</h2><p>如果你很喜欢用青轴，很享受用青轴的打击感，请直接买青轴，静电容不适合你；</p><p>如果你用青轴感觉到力不从心，但是钱不够，请买茶轴或者红轴；</p><p>如果你有点闲钱，而且比较有意向打造一个良好的打字环境，那么可以考虑买一个静电容；</p><p>最后来一张玉照：</p><p><img alt data-src="https://ww3.sinaimg.cn/large/006tNbRwly1feinxuuro5j31kw23ve83.jpg"></p><h2 id="6-补充"><a class="markdownIt-Anchor" href="#6-补充"></a> 6. 补充</h2><p>上传一张 Switch 的说明书，说不定以后会用到。</p><p><img alt data-src="https://ws3.sinaimg.cn/large/006tNc79ly1fn953gfiazj31kw2t5h2v.jpg"></p><hr class="footnotes-sep"><section class="footnotes"><ol class="footnotes-list"><li id="fn1" class="footnote-item"><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3F1ZXN0aW9uLzM5NTIyNDMxL2Fuc3dlci84MTc1MzcyMw==" title="https://www.zhihu.com/question/39522431/answer/81753723">https://www.zhihu.com/question/39522431/answer/81753723<i class="fa fa-external-link"></i></span> <a href="#fnref1" class="footnote-backref">↩︎</a></p></li></ol></section>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;最近终于下定决心来买这个键盘了。&lt;/p&gt;&lt;p&gt;主要说说使用感受吧&lt;/p&gt;&lt;p&gt;2018/1/8 更新部分内容&lt;/p&gt;
    
    </summary>
    
    
      <category term="买买买" scheme="https://wafer.li/categories/Buying/"/>
    
    
      <category term="买买买" scheme="https://wafer.li/tags/Buying/"/>
    
      <category term="键盘" scheme="https://wafer.li/tags/Keyboard/"/>
    
      <category term="Realforce" scheme="https://wafer.li/tags/Realforce/"/>
    
  </entry>
  
  <entry>
    <title>Hexo Experience</title>
    <link href="https://wafer.li//Hexo/Hexo%20Experience/"/>
    <id>https://wafer.li//Hexo/Hexo Experience/</id>
    <published>2017-04-08T16:56:00.000Z</published>
    <updated>2017-04-09T05:57:11.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-简介"><a class="markdownIt-Anchor" href="#1-简介"></a> 1. 简介</h2><p>这是我折腾 Hexo 博客框架的经验；</p><p>希望能给后来者以启迪。</p><a id="more"></a><h2 id="2-我所需要的功能"><a class="markdownIt-Anchor" href="#2-我所需要的功能"></a> 2. 我所需要的功能</h2><p>虽然，现今，网上已经很多教你如何一步一步地搭建 Hexo 博客，也有很多人踩过很多坑；</p><p>不过，对于我的一些要求，仍然有很多的方面未能解决。</p><p>我主要需要的功能一共有四个：</p><ol><li>数学公式渲染</li><li>PlantUML 图</li><li>TODO List</li><li>Footnotes</li></ol><h2 id="3-数学公式渲染"><a class="markdownIt-Anchor" href="#3-数学公式渲染"></a> 3. 数学公式渲染</h2><p>这个倒是有很多人发了很多博客，然后也解决了一些问题。</p><p>主要就是 <span class="exturl" data-url="aHR0cHM6Ly93d3cubnBtanMuY29tL3BhY2thZ2UvaGV4by1yZW5kZXJlci1tYXJrZWQ=" title="https://www.npmjs.com/package/hexo-renderer-marked"><code>hexo-renderer-marked</code><i class="fa fa-external-link"></i></span> 中，把 MathJax 中的 <code>_</code> 解析渲染成了斜体；</p><p>这样，就造成了解析错误；</p><p>同时，对于多行的数学公式，也存在很多问题。</p><p>经过一番倒腾，我的最终决定是使用 <span class="exturl" data-url="aHR0cHM6Ly93d3cubnBtanMuY29tL3BhY2thZ2UvaGV4by1yZW5kZXJlci1rcmFtZWQ=" title="https://www.npmjs.com/package/hexo-renderer-kramed"><code>hexo-renderer-karmed</code><i class="fa fa-external-link"></i></span> 代替原先官方自带的 <span class="exturl" data-url="aHR0cHM6Ly93d3cubnBtanMuY29tL3BhY2thZ2UvaGV4by1yZW5kZXJlci1tYXJrZWQ=" title="https://www.npmjs.com/package/hexo-renderer-marked"><code>hexo-renderer-marked</code><i class="fa fa-external-link"></i></span></p><p>对于另外的渲染器，它们主要的缺点有：</p><ul><li><span class="exturl" data-url="aHR0cHM6Ly93d3cubnBtanMuY29tL3BhY2thZ2UvaGV4by1yZW5kZXJlci1wYW5kb2M=" title="https://www.npmjs.com/package/hexo-renderer-pandoc"><code>hexo-renderer-pandoc</code><i class="fa fa-external-link"></i></span> 过于沉重</li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cubnBtanMuY29tL3BhY2thZ2UvaGV4by1yZW5kZXJlci1tYXJrZG93bi1pdA==" title="https://www.npmjs.com/package/hexo-renderer-markdown-it"><code>hexo-renderer-markdown-it</code><i class="fa fa-external-link"></i></span> 不支持 NexT 主题的 『Read More』</li></ul><p>所以，最后选择使用 <span class="exturl" data-url="aHR0cHM6Ly93d3cubnBtanMuY29tL3BhY2thZ2UvaGV4by1yZW5kZXJlci1tYXJrZG93bi1pdA==" title="https://www.npmjs.com/package/hexo-renderer-markdown-it"><code>hexo-renderer-karmed</code><i class="fa fa-external-link"></i></span>；</p><p>不过这个插件在某些时候也存在问题；</p><p>在<span class="exturl" data-url="aHR0cDovL3h1ZG9uZ3lhbmcuY29kaW5nLm1lL21hdGgtaW4taGV4by8=" title="http://xudongyang.coding.me/math-in-hexo/">这里<i class="fa fa-external-link"></i></span>有一个 workaround</p><h2 id="4-plantuml"><a class="markdownIt-Anchor" href="#4-plantuml"></a> 4. PlantUML</h2><p>平时我主要使用的 UML 绘图工具就是这个；</p><p>主要是因为我用 Atom 上面的 <code>markdown-preview-enhanced</code> 能够实时展现 PlantUML 图。</p><p>Hexo 插件列表中，也存在一个 PlantUML 的插件，<code>hexo-tag-plantuml</code>；</p><p>不过这个是 <code>tag</code> 插件，如果使用这个的话，我就需要使用标签来定义 UML；</p><p>而不能使用 markdown 原生的 code fence；</p><p>此时，我的 <code>markdown-preview-enhanced</code> 也会不起作用；</p><p>所以就只能自造轮子：自己实现了一个 <code>filter</code> 插件，用来将 code fence 转换成 PlantUML 图。</p><p>插件源码在<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3dhZmVyLWxpL2hleG8tZmlsdGVyLXBsYW50dW1s" title="https://github.com/wafer-li/hexo-filter-plantuml">这里<i class="fa fa-external-link"></i></span></p><h2 id="5-todo-list"><a class="markdownIt-Anchor" href="#5-todo-list"></a> 5. TODO List</h2><p>这个是比较神奇的：</p><p>之前选择的 <code>kramed</code> 没有这个功能，而 <code>marked</code> 有这个功能；</p><p>不过幸好代码量不多，可以直接将 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2hleG9qcy9oZXhvLXJlbmRlcmVyLW1hcmtlZC9wdWxsLzMy" title="https://github.com/hexojs/hexo-renderer-marked/pull/32">PR<i class="fa fa-external-link"></i></span> 中的改动合并到 <code>kramed</code> 中。</p><h2 id="6-footnotes"><a class="markdownIt-Anchor" href="#6-footnotes"></a> 6. Footnotes</h2><p>这个实际上是一个 Reference 的功能；</p><p>这个是目前最容易而且也没有坑的；</p><p>直接安装 <span class="exturl" data-url="aHR0cHM6Ly93d3cubnBtanMuY29tL3BhY2thZ2UvaGV4by1yZWZlcmVuY2U=" title="https://www.npmjs.com/package/hexo-reference"><code>hexo-reference</code><i class="fa fa-external-link"></i></span> 插件即可。</p><h2 id="参考链接"><a class="markdownIt-Anchor" href="#参考链接"></a> 参考链接</h2><p><span class="exturl" data-url="aHR0cDovL2lqaWFvYmVyLmdpdGh1Yi5pby9jYXRlZ29yaWVzL2hleG8v" title="http://ijiaober.github.io/categories/hexo/">Goon X 的 Hexo 合集<i class="fa fa-external-link"></i></span></p><p><span class="exturl" data-url="aHR0cDovLzJ3aWxka2lkcy5jb20vMjAxNi8xMC8wNi8lRTUlQTYlODIlRTQlQkQlOTUlRTUlQTQlODQlRTclOTAlODZIZXhvJUU1JTkyJThDTWF0aEpheCVFNyU5QSU4NCVFNSU4NSVCQyVFNSVBRSVCOSVFOSU5NyVBRSVFOSVBMiU5OC8=" title="http://2wildkids.com/2016/10/06/%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86Hexo%E5%92%8CMathJax%E7%9A%84%E5%85%BC%E5%AE%B9%E9%97%AE%E9%A2%98/">如何处理Hexo和MathJax的兼容问题<i class="fa fa-external-link"></i></span></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;1-简介&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#1-简介&quot;&gt;&lt;/a&gt; 1. 简介&lt;/h2&gt;&lt;p&gt;这是我折腾 Hexo 博客框架的经验；&lt;/p&gt;&lt;p&gt;希望能给后来者以启迪。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Hexo" scheme="https://wafer.li/categories/Hexo/"/>
    
    
      <category term="Hexo" scheme="https://wafer.li/tags/Hexo/"/>
    
      <category term="Blog" scheme="https://wafer.li/tags/Blog/"/>
    
  </entry>
  
  <entry>
    <title>Scala 泛型和变形</title>
    <link href="https://wafer.li//Scala/Scala%20%E6%B3%9B%E5%9E%8B%E5%92%8C%E5%8F%98%E5%BD%A2/"/>
    <id>https://wafer.li//Scala/Scala 泛型和变形/</id>
    <published>2017-04-07T15:00:00.000Z</published>
    <updated>2017-04-18T16:32:07.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-概述"><a class="markdownIt-Anchor" href="#1-概述"></a> 1. 概述</h2><p>泛型是多态的一个重要组成部分，通过运行时确定的类型来加载对应的类代码；</p><p>作为一个面向对象语言，Scala 同样具有泛型功能。</p><a id="more"></a><h2 id="2-定义"><a class="markdownIt-Anchor" href="#2-定义"></a> 2. 定义</h2><p>与 Java 不同，Scala 的泛型是使用方括号 <code>[]</code> 定义的：</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">List</span>[<span class="type">T</span>] </span>&#123; ... &#125;</span><br></pre></td></tr></table></figure><p>同样，在泛型方法的定义中，泛型参数的位置也和 Java 不一样：</p><p>Java:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; listOf()</span><br></pre></td></tr></table></figure><p>Scala:</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">listOf</span></span>[<span class="type">T</span>]()</span><br></pre></td></tr></table></figure><h2 id="3-上界和下界"><a class="markdownIt-Anchor" href="#3-上界和下界"></a> 3. 上界和下界</h2><p>这个方面，Scala 和 Java 有些许不同；</p><p>首先，在定义方面，Scala 使用两个特殊的符号表示上下界：</p><p><code>A &lt;: B</code> 表示 A 是 B 的子类，也就是 B 是 A 的上界；</p><p><code>A &gt;: B</code> 表示 A 是 B 的超类，也就是 B 是 A 的下界。</p><p>而 Java 使用 <code>extends</code> 关键字来说明。</p><p>其次，Scala 中，可以使用超类限定类型参数；</p><p>而 Java 只能使用 <code>extends</code> 即子类限定类型参数：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// Scala</span><br><span class="line">[U &gt;: T]</span><br><span class="line"></span><br><span class="line">// Java</span><br><span class="line">U super T // ERROR!</span><br></pre></td></tr></table></figure><h2 id="4-逆变和协变"><a class="markdownIt-Anchor" href="#4-逆变和协变"></a> 4. 逆变和协变</h2><p>关于逆变和协变，Scala 相比于 Java 中的 <strong>使用声明</strong>，还可以在定义中指明协变和逆变。</p><h3 id="41-名词解释"><a class="markdownIt-Anchor" href="#41-名词解释"></a> 4.1 名词解释</h3><p>如果 <code>A &lt;: B</code> (A 是 B 的子类)，那么对于类 <code>C</code> 来说：</p><ol><li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>C</mi><mo stretchy="false">[</mo><mi>A</mi><mo stretchy="false">]</mo><mo>&lt;</mo><mo>:</mo><mi>C</mi><mo stretchy="false">[</mo><mi>B</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">C[A] &lt;: C[B]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathdefault" style="margin-right:.07153em">C</span><span class="mopen">[</span><span class="mord mathdefault">A</span><span class="mclose">]</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">&lt;</span></span><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mrel">:</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathdefault" style="margin-right:.07153em">C</span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:.05017em">B</span><span class="mclose">]</span></span></span></span> =&gt; C 是协变(covariant)的</li><li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>C</mi><mo stretchy="false">[</mo><mi>A</mi><mo stretchy="false">]</mo><mo>&gt;</mo><mo>:</mo><mi>C</mi><mo stretchy="false">[</mo><mi>B</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">C[A] &gt;: C[B]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathdefault" style="margin-right:.07153em">C</span><span class="mopen">[</span><span class="mord mathdefault">A</span><span class="mclose">]</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">&gt;</span></span><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mrel">:</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathdefault" style="margin-right:.07153em">C</span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:.05017em">B</span><span class="mclose">]</span></span></span></span> =&gt; C 是逆变(contravariant)的</li><li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>C</mi><mo stretchy="false">[</mo><mi>A</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">C[A]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathdefault" style="margin-right:.07153em">C</span><span class="mopen">[</span><span class="mord mathdefault">A</span><span class="mclose">]</span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>C</mi><mo stretchy="false">[</mo><mi>B</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">C[B]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathdefault" style="margin-right:.07153em">C</span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:.05017em">B</span><span class="mclose">]</span></span></span></span> 没有继承关系 =&gt; C 是不变(nonvariant) 的</li></ol><p>对 Java 而言，<code>? extends T</code> 提供了协变特性；</p><p><code>? super T</code> 提供了逆变特性</p><h3 id="42-定义中指明可变性"><a class="markdownIt-Anchor" href="#42-定义中指明可变性"></a> 4.2 定义中指明可变性</h3><p>这是 Scala 和 Kotlin 中相对于 Java 的一个改进，可以在 <strong>类定义</strong> 中指明泛型可变性。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// Scala</span><br><span class="line">class List[+T]</span><br><span class="line"></span><br><span class="line">// Kotlin</span><br><span class="line">class List&lt;out T&gt;</span><br></pre></td></tr></table></figure><p>此时，指明了 <code>List</code> 是 <strong>协变的</strong>，也就是说，<code>List[String]</code> 是 <code>List[Object]</code> 的子类。</p><p>同理，下面的写法指明了逆变性：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// Scala</span><br><span class="line">class List[-T]</span><br><span class="line"></span><br><span class="line">// Kotlin</span><br><span class="line">class List&lt;in T&gt;</span><br></pre></td></tr></table></figure><p>当不使用 <code>+</code>、<code>-</code> 号修饰时，就是不变(nonvariant)的</p><h3 id="43-函数"><a class="markdownIt-Anchor" href="#43-函数"></a> 4.3 函数</h3><p>事实上，在 Scala 中，函数也是一个对象；</p><p><code>def</code> 语句声明的函数会被转化成一个 <code>FunctionN&lt;-T, +U&gt;</code> 类：</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Function1</span>[-<span class="type">T</span>, +<span class="type">U</span>] </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">apply</span></span>(param: <span class="type">T</span>): <span class="type">U</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过 <code>apply</code> 函数来进行函数的调用。</p><p>我们可以看到，函数参数是逆变的，但是返回类型是协变的；</p><p>这是为什么呢？</p><p>实际上，这是里氏法则的应用：</p><p>如果 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>A</mi><mn>2</mn></msub><mo>&lt;</mo><mo>:</mo><msub><mi>A</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">A_2 &lt;: A_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.83333em;vertical-align:-.15em"></span><span class="mord"><span class="mord mathdefault">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.30110799999999993em"><span style="top:-2.5500000000000003em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">&lt;</span></span><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mrel">:</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.83333em;vertical-align:-.15em"></span><span class="mord"><span class="mord mathdefault">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.30110799999999993em"><span style="top:-2.5500000000000003em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 且 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>B</mi><mn>1</mn></msub><mo>&lt;</mo><mo>:</mo><msub><mi>B</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">B_1 &lt;: B_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.83333em;vertical-align:-.15em"></span><span class="mord"><span class="mord mathdefault" style="margin-right:.05017em">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.30110799999999993em"><span style="top:-2.5500000000000003em;margin-left:-.05017em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">&lt;</span></span><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mrel">:</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.83333em;vertical-align:-.15em"></span><span class="mord"><span class="mord mathdefault" style="margin-right:.05017em">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.30110799999999993em"><span style="top:-2.5500000000000003em;margin-left:-.05017em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span>，那么对于 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>A</mi><mn>1</mn></msub><mo>⇒</mo><msub><mi>B</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">A_1 \Rightarrow B_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.83333em;vertical-align:-.15em"></span><span class="mord"><span class="mord mathdefault">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.30110799999999993em"><span style="top:-2.5500000000000003em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">⇒</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.83333em;vertical-align:-.15em"></span><span class="mord"><span class="mord mathdefault" style="margin-right:.05017em">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.30110799999999993em"><span style="top:-2.5500000000000003em;margin-left:-.05017em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>A</mi><mn>2</mn></msub><mo>⇒</mo><msub><mi>B</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">A_2 \Rightarrow B_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.83333em;vertical-align:-.15em"></span><span class="mord"><span class="mord mathdefault">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.30110799999999993em"><span style="top:-2.5500000000000003em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">⇒</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.83333em;vertical-align:-.15em"></span><span class="mord"><span class="mord mathdefault" style="margin-right:.05017em">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.30110799999999993em"><span style="top:-2.5500000000000003em;margin-left:-.05017em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 来说：</p><p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>A</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">A_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.83333em;vertical-align:-.15em"></span><span class="mord"><span class="mord mathdefault">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.30110799999999993em"><span style="top:-2.5500000000000003em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 所接受的范围比 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>A</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">A_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.83333em;vertical-align:-.15em"></span><span class="mord"><span class="mord mathdefault">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.30110799999999993em"><span style="top:-2.5500000000000003em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 广，所以使用 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>A</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">A_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.83333em;vertical-align:-.15em"></span><span class="mord"><span class="mord mathdefault">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.30110799999999993em"><span style="top:-2.5500000000000003em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 作为参数，可以接受 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>A</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">A_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.83333em;vertical-align:-.15em"></span><span class="mord"><span class="mord mathdefault">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.30110799999999993em"><span style="top:-2.5500000000000003em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span>；</p><p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>B</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">B_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.83333em;vertical-align:-.15em"></span><span class="mord"><span class="mord mathdefault" style="margin-right:.05017em">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.30110799999999993em"><span style="top:-2.5500000000000003em;margin-left:-.05017em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 比 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>B</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">B_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.83333em;vertical-align:-.15em"></span><span class="mord"><span class="mord mathdefault" style="margin-right:.05017em">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.30110799999999993em"><span style="top:-2.5500000000000003em;margin-left:-.05017em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 要更加严格，所以返回 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>B</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">B_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.83333em;vertical-align:-.15em"></span><span class="mord"><span class="mord mathdefault" style="margin-right:.05017em">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.30110799999999993em"><span style="top:-2.5500000000000003em;margin-left:-.05017em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 就相当于肯定能返回 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>B</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">B_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.83333em;vertical-align:-.15em"></span><span class="mord"><span class="mord mathdefault" style="margin-right:.05017em">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.30110799999999993em"><span style="top:-2.5500000000000003em;margin-left:-.05017em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span>；</p><p>此时，因为 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>A</mi><mn>1</mn></msub><mo>⇒</mo><msub><mi>B</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">A_1 \Rightarrow B_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.83333em;vertical-align:-.15em"></span><span class="mord"><span class="mord mathdefault">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.30110799999999993em"><span style="top:-2.5500000000000003em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">⇒</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.83333em;vertical-align:-.15em"></span><span class="mord"><span class="mord mathdefault" style="margin-right:.05017em">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.30110799999999993em"><span style="top:-2.5500000000000003em;margin-left:-.05017em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 的形参和返回值都满足 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>A</mi><mn>2</mn></msub><mo>⇒</mo><msub><mi>B</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">A_2 \Rightarrow B_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.83333em;vertical-align:-.15em"></span><span class="mord"><span class="mord mathdefault">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.30110799999999993em"><span style="top:-2.5500000000000003em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">⇒</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.83333em;vertical-align:-.15em"></span><span class="mord"><span class="mord mathdefault" style="margin-right:.05017em">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.30110799999999993em"><span style="top:-2.5500000000000003em;margin-left:-.05017em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 的要求；</p><p>我们就可以使用前者替代后者，也就是说，此时：</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>A</mi><mn>1</mn></msub><mo>⇒</mo><msub><mi>B</mi><mn>1</mn></msub><mo>&lt;</mo><mo>:</mo><msub><mi>A</mi><mn>2</mn></msub><mo>⇒</mo><msub><mi>B</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">A_1 \Rightarrow B_1 &lt;: A_2 \Rightarrow B_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.83333em;vertical-align:-.15em"></span><span class="mord"><span class="mord mathdefault">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.30110799999999993em"><span style="top:-2.5500000000000003em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">⇒</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.83333em;vertical-align:-.15em"></span><span class="mord"><span class="mord mathdefault" style="margin-right:.05017em">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.30110799999999993em"><span style="top:-2.5500000000000003em;margin-left:-.05017em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">&lt;</span></span><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mrel">:</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.83333em;vertical-align:-.15em"></span><span class="mord"><span class="mord mathdefault">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.30110799999999993em"><span style="top:-2.5500000000000003em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">⇒</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.83333em;vertical-align:-.15em"></span><span class="mord"><span class="mord mathdefault" style="margin-right:.05017em">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.30110799999999993em"><span style="top:-2.5500000000000003em;margin-left:-.05017em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span></span></p><p>那么说明， <strong>函数形参是逆变的，而返回值是协变的</strong></p><p>Scala 会自动检查函数的泛型变形，以满足上面的要求。</p><h3 id="44-协变的函数形参"><a class="markdownIt-Anchor" href="#44-协变的函数形参"></a> 4.4 协变的函数形参</h3><p>函数上面的变形要求是为了保证数据的一致性；</p><p>如果你的函数不进行数据的更改操作，那么事实上是可以将形参声明为协变的；</p><p>不过，鉴于 Scala 的泛型检查，它禁止了这种方法的出现；</p><p>此时，我们可以使用泛型下界，来让我们的变形满足 Scala 的要求：</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">concat</span></span>[<span class="type">U</span> &gt;: <span class="type">T</span>](elem: <span class="type">U</span>): <span class="type">List</span>[<span class="type">U</span>] = <span class="keyword">new</span> <span class="type">Cons</span>(elem, <span class="type">Empty</span>)</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;1-概述&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#1-概述&quot;&gt;&lt;/a&gt; 1. 概述&lt;/h2&gt;&lt;p&gt;泛型是多态的一个重要组成部分，通过运行时确定的类型来加载对应的类代码；&lt;/p&gt;&lt;p&gt;作为一个面向对象语言，Scala 同样具有泛型功能。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Scala" scheme="https://wafer.li/categories/Scala/"/>
    
    
      <category term="Scala" scheme="https://wafer.li/tags/Scala/"/>
    
  </entry>
  
</feed>
