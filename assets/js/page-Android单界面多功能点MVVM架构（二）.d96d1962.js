(window.webpackJsonp=window.webpackJsonp||[]).push([[22],{949:function(e,v,o){"use strict";o.r(v);var _=o(1),d=Object(_.a)({},(function(){var e=this,v=e.$createElement,o=e._self._c||v;return o("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[o("p",[o("a",{attrs:{href:"/blog-corners/tech/android/arch/android-%E5%8D%95%E7%95%8C%E9%9D%A2%E5%A4%9A%E5%8A%9F%E8%83%BD%E7%82%B9-mvvm-%E6%9E%B6%E6%9E%84%EF%BC%88%E4%B8%80%EF%BC%89"}},[e._v("上文")]),e._v("  提出了一种单界面多功能点的 MVVM 架构，但是尚存在一点问题，就是当某个特定的事件需要多个 UseCase 进行响应的问题。")]),e._v(" "),o("p",[e._v("例如直播的送礼物事件，需要礼物动画和送礼物的列表同时进行变化，在这里针对这个问题提出解决办法。")]),e._v(" "),o("h2",{attrs:{id:"_1-从需求分析"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_1-从需求分析"}},[e._v("#")]),e._v(" 1. 从需求分析")]),e._v(" "),o("p",[e._v("我们可以从这个需求分析一下我们需要一些什么样的功能来实现我们这个需求。")]),e._v(" "),o("p",[e._v("首先，针对于 UseCase 之间的活动，我们可以通过他们的 ViewModel 对它们予以操控；因此，我们所提出的概念应该具备调用多个 ViewModel 的能力。")]),e._v(" "),o("p",[e._v("其次，这种跨 UseCase 的事件的发源地我们是无法确定的，它实际上和产品需求有关；因此，我们所提出的概念应该能够在多个 UseCase 获取到。")]),e._v(" "),o("p",[e._v("最后，它应该能处理 View 的生命周期问题，当 View 的生命周期结束时，它应当消除和它相关的一些变量等。")]),e._v(" "),o("p",[e._v("从这几点分析上来看，我们可以得出，我们需要的这个东西应当是一种"),o("strong",[e._v("ViewModel")]),e._v("；")]),e._v(" "),o("p",[e._v("而这种 ViewModel 具备操作多个其他 ViewModel 的能力。")]),e._v(" "),o("h2",{attrs:{id:"_2-viewmodelmanager"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_2-viewmodelmanager"}},[e._v("#")]),e._v(" 2. ViewModelManager")]),e._v(" "),o("p",[e._v("于是乎，我们为这个概念取名为 "),o("code",[e._v("ViewModelManager")]),e._v("；")]),e._v(" "),o("p",[e._v("首先，它继承于 "),o("code",[e._v("ViewModel")]),e._v("；")]),e._v(" "),o("p",[e._v("然后，通过给它传入 "),o("code",[e._v("ViewModelProvider")]),e._v("，我们就可以通过这个 Provider 去获取各类 ViewModel 的实例。")]),e._v(" "),o("p",[e._v("由于 "),o("code",[e._v("ViewModelManager")]),e._v(" 是 ViewModel，那么它自然而然的能处理生命周期；")]),e._v(" "),o("p",[e._v("最后，为了能让多个 UseCase 能够获取到 "),o("code",[e._v("ViewModelManager")]),e._v("，我们需要给 UseCase 提供一个特殊的 "),o("strong",[e._v("ViewModelProvider")]),e._v("，在这里称为 "),o("code",[e._v("viewModelManagerProvider")]),e._v("。")]),e._v(" "),o("p",[o("code",[e._v("ViewModelProvider")]),e._v(" 是通过传入所需的 "),o("code",[e._v("ViewModel")]),e._v(" 的 "),o("code",[e._v("Class")]),e._v(" 来获取对应的 ViewModel 的实例的类；")]),e._v(" "),o("p",[e._v("具体来说，它在接收到 "),o("code",[e._v("ViewModel")]),e._v(" 的 "),o("code",[e._v("Class")]),e._v(" 之后，会从它的 "),o("code",[e._v("ViewModelStore")]),e._v(" 中获取对应的 "),o("code",[e._v("ViewModel")]),e._v("；")]),e._v(" "),o("p",[e._v("如果没获取到，那么会使用 "),o("code",[e._v("ViewModelProvider.Factory")]),e._v(" 来对 ViewModel 进行构建。")]),e._v(" "),o("p",[e._v("所以，我们需要为 "),o("code",[e._v("ViewModelManager")]),e._v(" 提供一个能够构造它的 "),o("code",[e._v("Provider.Factory")]),e._v("；")]),e._v(" "),o("p",[e._v("针对这一步，我们直接照抄 "),o("code",[e._v("ViewModelProvider.Factory")]),e._v(" 的源码，再注入 "),o("code",[e._v("ViewModelProvider")]),e._v(" 即可。")]),e._v(" "),o("p",[e._v("那么通过构造 "),o("code",[e._v("viewModelManagerProvider")]),e._v("，我们就实现了在各个 UseCase 都能获取到某个 "),o("code",[e._v("ViewModelManager")]),e._v(" 的功能。")]),e._v(" "),o("div",{staticClass:"custom-block tip"},[o("p",{staticClass:"custom-block-title"},[e._v("提示")]),e._v(" "),o("p",[e._v("这里有个小坑点，由于默认的 "),o("code",[e._v("ViewModelProvider.Factory")]),e._v(" 是通过 "),o("strong",[e._v("反射")]),e._v(" 构建新的 ViewModel 的；")]),e._v(" "),o("p",[e._v("因此，我们需要对 "),o("code",[e._v("ViewModelManagerProviderFactory")]),e._v(" 配置混淆，让其构造函数不要被混淆处理，否则反射调用将会失败造成崩溃。")])]),e._v(" "),o("h2",{attrs:{id:"_3-架构图"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_3-架构图"}},[e._v("#")]),e._v(" 3. 架构图")]),e._v(" "),o("Mermaid",{attrs:{id:"mermaid-382ee204","data-code":"classDiagram%0A%20%20%20%20class%20ViewModel%20%7B%0A%0A%20%20%20%20%7D%0A%0A%20%20%20%20class%20ViewModelManager%20%7B%0A%20%20%20%20%20%20%2F%2F%20%E7%94%A8%E4%BA%8E%E8%8E%B7%E5%8F%96%E5%85%B6%E4%BB%96%20ViewModel%0A%20%20%20%20%20%20%23viewModelProvider%3A%20ViewModelProvider%0A%20%20%20%20%7D%0A%0A%20%20%20%20ViewModel%20%3C%7C--%20ViewModelManager%0A%0A%20%20%20%20class%20UseCase%20%7B%0A%20%20%20%20%20%20%2B%20viewModelManagerProvider%3A%20ViewModelProvider%0A%20%20%20%20%7D%0A%0A%20%20%20%20UseCase%20--%3E%20ViewModelManager%20%3A%20%E4%BD%BF%E7%94%A8%20viewModelManagerProvider%20%E8%8E%B7%E5%8F%96%0A"}})],1)}),[],!1,null,null,null);v.default=d.exports}}]);