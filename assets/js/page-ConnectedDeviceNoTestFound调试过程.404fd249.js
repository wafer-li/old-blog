(window.webpackJsonp=window.webpackJsonp||[]).push([[42],{958:function(t,n,e){"use strict";e.r(n);var s=e(1),a=Object(s.a)({},(function(){var t=this,n=t.$createElement,e=t._self._c||n;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("p",[t._v("之前又稍微折腾着想尝试一下 TDD，并在每次构建的时候加入测试环节，当测试不通过就不允许 build。")]),t._v(" "),e("p",[t._v("当一切都配置好，点下 build App 的时候，却出现了 "),e("code",[t._v("There were failing tests.")]),t._v("。")]),t._v(" "),e("p",[t._v("我心想，不会啊，现在我就根本没写几个测试用例，为什么会通不过？")]),t._v(" "),e("p",[t._v("于是，就开始了艰难的调试过程")]),t._v(" "),e("h2",{attrs:{id:"_0-更新"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_0-更新"}},[t._v("#")]),t._v(" 0. 更新")]),t._v(" "),e("p",[t._v("2019-05-27 更新： Google 回复：Instant Run 在新版本已经不被支持了，他们开发了一个更好的功能叫 Apply Change。")]),t._v(" "),e("p",[e("img",{attrs:{src:"/images/connecteddevice-no-test-found-调试过程/google-response-instant-run-deprecated.png",alt:"Google Response Instant Run Deprecated"}})]),t._v(" "),e("blockquote",[e("p",[t._v("Instant Run has been deprecated in Android Studio 3.5 and instead we've implemented a brand new solution called Apply Changes that is more stable and doesn't modify your APK on build.\n...\nWe recommend "),e("strong",[t._v("turning off Instant Run")]),t._v(" in the settings for earlier versions of Android Studio")])]),t._v(" "),e("p",[t._v("尝试了一下 2019-05-23 编译的 Android Studio 3.6 Canary 1 ，问题的确已经被修复了。")]),t._v(" "),e("p",[e("img",{attrs:{src:"/images/connecteddevice-no-test-found-调试过程/build-success-with-as-3-6-1.png",alt:"Build Success with AS 3.6.1"}})]),t._v(" "),e("p",[t._v("所以还在使用 3.4 稳定版的，直接把 Instant Run 关掉吧。")]),t._v(" "),e("h2",{attrs:{id:"_1-connecteddevice-no-tests-found"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-connecteddevice-no-tests-found"}},[t._v("#")]),t._v(" 1. ConnectedDevice No tests found")]),t._v(" "),e("p",[t._v("打开测试结果，就得到了下面这张图")]),t._v(" "),e("p",[e("img",{attrs:{src:"/images/connecteddevice-no-test-found-调试过程/connecteddevice-no-test-found.png",alt:"ConnectedDevice No test found"}})]),t._v(" "),e("p",[t._v("再点进去一看：\n"),e("img",{attrs:{src:"/images/connecteddevice-no-test-found-调试过程/connecteddevice-no-tests-found-detail.png",alt:"ConnectedDevice No Test found detail"}})]),t._v(" "),e("p",[t._v("它说我没有按照 JUnit 的方式编写测试用例，但是我的测试用例都是加了 "),e("code",[t._v("@Test")]),t._v(" 的啊")]),t._v(" "),e("div",{staticClass:"language-kotlin line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-kotlin"}},[e("code",[e("span",{pre:!0,attrs:{class:"token annotation builtin"}},[t._v("@RunWith")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("AndroidJUnit4"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" ApplicationTest "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token annotation builtin"}},[t._v("@Test")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("fun")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("useAppContext")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Context of the app under test.")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" appContext "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" InstrumentationRegistry"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("getInstrumentation")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("targetContext\n\n        "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("assertEquals")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"aaa.bbb.ccc.ddd"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" appContext"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("packageName"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br"),e("span",{staticClass:"line-number"},[t._v("9")]),e("br"),e("span",{staticClass:"line-number"},[t._v("10")]),e("br")])]),e("p",[t._v("于是就陷入了困境，问题到这里就消失了，到底应该怎样才能定位到问题呢？")]),t._v(" "),e("h2",{attrs:{id:"_2-使用-gradle-命令行进行构建尝试"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-使用-gradle-命令行进行构建尝试"}},[t._v("#")]),t._v(" 2. 使用 gradle 命令行进行构建尝试")]),t._v(" "),e("p",[t._v("Android Studio 的 Run App 实际上就是先执行 "),e("code",[t._v("assemble[Build-Variant]")]),t._v(" 然后再将生成的 apk 安装到手机的过程。")]),t._v(" "),e("p",[t._v("而这个 "),e("code",[t._v("assemble")]),t._v(" 实际上是通过 "),e("code",[t._v("gradle")]),t._v(" 执行的，于是可以尝试通过 gradle 命令行进行编译，看看是不是 gradle 导致的问题。")]),t._v(" "),e("p",[t._v("然而，gradle 单独进行编译并没有这个问题：")]),t._v(" "),e("p",[e("img",{attrs:{src:"/images/connecteddevice-no-test-found-调试过程/gradle-build-successful.png",alt:"gradle build successful"}})]),t._v(" "),e("p",[t._v("所以很有可能是 Android Studio 自身的构建出现了问题，但是，目前的构建信息并不足以让我们定位到问题，所以需要获取更多的构建信息。")]),t._v(" "),e("h2",{attrs:{id:"_3-instrument-process-crashed"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-instrument-process-crashed"}},[t._v("#")]),t._v(" 3. INSTRUMENT: Process Crashed")]),t._v(" "),e("p",[t._v("首先，我们在 "),e("code",[t._v("Build, Execution, Deployment -> Compiler")]),t._v(" 开启 "),e("code",[t._v("gradle --scan")])]),t._v(" "),e("p",[e("img",{attrs:{src:"/images/connecteddevice-no-test-found-调试过程/gradle-scan-in-android-studio.png",alt:"Gradle Scan In Android Studio"}})]),t._v(" "),e("p",[t._v("然后，点击红框里面的小图标让 Build 信息变成文字：")]),t._v(" "),e("p",[e("img",{attrs:{src:"/images/connecteddevice-no-test-found-调试过程/build-output-text.png",alt:"Build Output Text"}})]),t._v(" "),e("p",[t._v("之后，就看到了 build 失败的详细信息了：")]),t._v(" "),e("p",[e("img",{attrs:{src:"/images/connecteddevice-no-test-found-调试过程/fail-due-to-process-crash.png",alt:"Fail due to Process Crashed"}})]),t._v(" "),e("p",[t._v("原来是在测试的时候程序崩溃了，这才导致了测试的失败。")]),t._v(" "),e("p",[t._v("经过一番 StackOverflow 之后，"),e("a",{attrs:{href:"https://stackoverflow.com/a/21611370",target:"_blank",rel:"noopener noreferrer"}},[t._v("这个答案"),e("OutboundLink")],1),t._v(" 提醒了我：")]),t._v(" "),e("p",[e("img",{attrs:{src:"/images/connecteddevice-no-test-found-调试过程/stackoverflow-see-logcat.png",alt:"StackOverflow See LogCat"}})]),t._v(" "),e("p",[t._v("由于 Instrument Test 实际上是安装了一个 "),e("code",[t._v("test.apk")]),t._v("，所以它的报错信息会在 Log Cat 而不是 Build Output 中。")]),t._v(" "),e("h2",{attrs:{id:"_4-didn-t-find-class-corecomponentfactory"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-didn-t-find-class-corecomponentfactory"}},[t._v("#")]),t._v(" 4. Didn't find class CoreComponentFactory")]),t._v(" "),e("p",[t._v("打开 Log Cat，首先映入眼帘的是 "),e("code",[t._v("Unable to instantiate application")])]),t._v(" "),e("p",[e("img",{attrs:{src:"/images/connecteddevice-no-test-found-调试过程/unable-to-instantiate-application.png",alt:"Unable to instantiate application"}})]),t._v(" "),e("p",[t._v("原来在执行测试的时候，没有办法实例化 "),e("code",[t._v("Application")]),t._v(" 导致 Instrument Test 无法找到 "),e("code",[t._v("Context")]),t._v("，于是程序就崩溃导致测试失败了。")]),t._v(" "),e("p",[t._v("再往上看，可以看到导致无法实例化 "),e("code",[t._v("Application")]),t._v(" 的原因：")]),t._v(" "),e("p",[e("img",{attrs:{src:"/images/connecteddevice-no-test-found-调试过程/didn-t-find-class-corecomponentfactory.png",alt:"Didn't find class CoreComponentFactory"}})]),t._v(" "),e("p",[t._v("原来是构建 "),e("code",[t._v("Application")]),t._v(" 的工厂找不到了，从而造成它无法实例化。")]),t._v(" "),e("h2",{attrs:{id:"_5-罪魁祸首-instant-run"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5-罪魁祸首-instant-run"}},[t._v("#")]),t._v(" 5. 罪魁祸首 Instant Run")]),t._v(" "),e("p",[e("code",[t._v("Didn't find class CoreComponentFactory")]),t._v(" 这个问题之前也遇到过，是因为 R8 将其混淆了，导致在 release 模式下找不到这个类，但是现在是 debug 模式，并没有启用混淆，但是依然还是找不到这个类。")]),t._v(" "),e("p",[t._v("在经过又一阵子的 StackOverflow 之后，我找到了"),e("a",{attrs:{href:"https://stackoverflow.com/a/56186821",target:"_blank",rel:"noopener noreferrer"}},[t._v("这么一个答案"),e("OutboundLink")],1),t._v("：")]),t._v(" "),e("p",[e("img",{attrs:{src:"/images/connecteddevice-no-test-found-调试过程/answer-disable-instant-run.png",alt:"Answer Disable Instant Run"}})]),t._v(" "),e("p",[t._v("虽然它被减成了负分，但是也不妨碍我尝试一下它的可用性。")]),t._v(" "),e("p",[t._v("于是我将 Instant Run 取消掉，奇迹发生了，程序竟然就编译通过并成功安装在了模拟器上。")]),t._v(" "),e("p",[e("img",{attrs:{src:"/images/connecteddevice-no-test-found-调试过程/build-success.png",alt:"Build Success"}})]),t._v(" "),e("p",[e("img",{attrs:{src:"/images/connecteddevice-no-test-found-调试过程/run-success.png",alt:"Run Success"}})]),t._v(" "),e("h2",{attrs:{id:"_6-总结"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_6-总结"}},[t._v("#")]),t._v(" 6. 总结")]),t._v(" "),e("p",[t._v("到这里，整个调试过程就结束了，也给 Google 提了这个 bug。")]),t._v(" "),e("p",[t._v("虽然不敢肯定一定是 Instant Run 的问题，但是目前（AS 3.4.1）来看，取消 Instant Run 就可以运行成功。")]),t._v(" "),e("p",[t._v("这个问题本身可能有一些特异性，不过倒是从中学到了一个知识：")]),t._v(" "),e("p",[t._v("类似的 Instrument Test 的失败最好先去 Log Cat 寻找原因。")]),t._v(" "),e("p",[t._v("也希望大家能从这篇博客中能学到一些什么吧。")])])}),[],!1,null,null,null);n.default=a.exports}}]);