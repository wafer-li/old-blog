(window.webpackJsonp=window.webpackJsonp||[]).push([[59],{945:function(a,t,s){"use strict";s.r(t);var e=s(1),n=Object(e.a)({},(function(){var a=this,t=a.$createElement,s=a._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("p",[s("a",{attrs:{href:"/blog-corners/tech/android/itemdecoration-%E5%AE%9E%E6%88%98%E4%B9%8B-girdspacingitemdecoration%EF%BC%88%E4%B8%80%EF%BC%89"}},[a._v("上文")]),a._v("说到，相等间距的 GridLayoutManager 的 ItemDecoration 可以使用 "),s("strong",[a._v("公式法")]),a._v(" 来对所有四个方向的 offset 进行计算，由此可以大大简化 "),s("code",[a._v("itemOffset")]),a._v(" 的计算，同时也天然的支持 RTL。")]),a._v(" "),s("p",[a._v("但是，很多时候我们的 item 由于布局的原因，会出现一个 item 占据多个 span 的情况；")]),a._v(" "),s("p",[a._v("上文最后给出的代码并没能处理这种情况，本文在这里就这个问题再进行进一步的讨论。")]),a._v(" "),s("h2",{attrs:{id:"_1-spansizelookup"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-spansizelookup"}},[a._v("#")]),a._v(" 1. SpanSizeLookup")]),a._v(" "),s("p",[a._v("首先，为什么 GridLayoutManager 出现一个 item 占据多个格子的情况，实际上就是通过重载 "),s("code",[a._v("SpanSizeLookup")]),a._v(" 这个类进行处理的。")]),a._v(" "),s("p",[s("code",[a._v("SpanSizeLookup")]),a._v(" 是一个抽象类，通过重载它实现 "),s("code",[a._v("getSpanSize(position)")]),a._v(" 方法，就可以指定元素所占的"),s("strong",[a._v("span 的数量")]),a._v("。")]),a._v(" "),s("p",[a._v("注意这个方法所返回的是 item "),s("strong",[a._v("所占的 span 的数量")]),a._v("；")]),a._v(" "),s("p",[a._v("如图所示，某个 "),s("code",[a._v("GirdLayoutManager")]),a._v(" 的 "),s("code",[a._v("spanCount")]),a._v(" 是 3")]),a._v(" "),s("p",[s("img",{attrs:{src:"/images/不同-spansize-的-item.png",alt:"不同 spanSize 的 item"}})]),a._v(" "),s("p",[a._v("这里的第一个 "),s("code",[a._v("spanSize")]),a._v(" 就是 "),s("code",[a._v("2")]),a._v("，第二个 "),s("code",[a._v("spanSize")]),a._v(" 是 "),s("code",[a._v("1")])]),a._v(" "),s("h2",{attrs:{id:"_2-spanindex-和-spangroupindex"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-spanindex-和-spangroupindex"}},[a._v("#")]),a._v(" 2. spanIndex 和 spanGroupIndex")]),a._v(" "),s("p",[a._v("在允许了不等于 "),s("code",[a._v("1")]),a._v(" 的 "),s("code",[a._v("spanSize")]),a._v(" 之后，情况出现了变化，在水平方向上的数量不再是一致的，而竖直方向上，更不可能简单的通过 "),s("code",[a._v("position")]),a._v(" 和 "),s("code",[a._v("spanCount")]),a._v(" 算出现在是第几行；")]),a._v(" "),s("p",[a._v("那么怎么办呢？"),s("code",[a._v("SpanSizeLookup")]),a._v(" 为此提供了 "),s("code",[a._v("spanIndex")]),a._v(" 和 "),s("code",[a._v("spanGroupIndex")]),a._v("。")]),a._v(" "),s("h3",{attrs:{id:"_2-1-spangroupindex"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-spangroupindex"}},[a._v("#")]),a._v(" 2.1 spanGroupIndex")]),a._v(" "),s("p",[a._v("先说说 "),s("code",[a._v("spanGroupIndex")]),a._v("，"),s("code",[a._v("spanIndex")]),a._v(" 还有个潜在的坑；既然叫 "),s("code",[a._v("spanGroupIndex")]),a._v("，那肯定有一个 "),s("code",[a._v("group")]),a._v(" 的概念，在这里很显然，就是「一行」。")]),a._v(" "),s("p",[a._v("因此，「一行」就是一个 "),s("code",[a._v("spanGroup")]),a._v("，那么 "),s("code",[a._v("spanGroupIndex")]),a._v(" 就是当前"),s("strong",[a._v("行")]),a._v("的索引，也就是"),s("strong",[a._v("竖直方向上的 "),s("span",{staticClass:"katex"},[s("span",{staticClass:"katex-mathml"},[s("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[s("semantics",[s("mrow",[s("mo",{attrs:{stretchy:"false"}},[a._v("(")]),s("mrow",[s("mi",{attrs:{mathvariant:"normal"}},[a._v("n")]),s("mo",[a._v("−")]),s("mn",[a._v("1")])],1),s("mo",{attrs:{stretchy:"false"}},[a._v(")")])],1),s("annotation",{attrs:{encoding:"application/x-tex"}},[a._v("(\\mathrm{n-1})")])],1)],1)],1),s("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[s("span",{staticClass:"base"},[s("span",{staticClass:"strut",staticStyle:{height:"1em","vertical-align":"-0.25em"}}),s("span",{staticClass:"mopen"},[a._v("(")]),s("span",{staticClass:"mord"},[s("span",{staticClass:"mord mathrm"},[a._v("n")]),s("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2222222222222222em"}}),s("span",{staticClass:"mbin"},[a._v("−")]),s("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2222222222222222em"}}),s("span",{staticClass:"mord mathrm"},[a._v("1")])]),s("span",{staticClass:"mclose"},[a._v(")")])])])])])]),a._v(" "),s("p",[a._v("因此，我们只需要通过 "),s("code",[a._v("SpanSizeLookup")]),a._v(" 类计算出当前 "),s("code",[a._v("position")]),a._v(" 所在的行就能算出其上下的边距。")]),a._v(" "),s("h3",{attrs:{id:"_2-2-spanindex"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-spanindex"}},[a._v("#")]),a._v(" 2.2 spanIndex")]),a._v(" "),s("p",[s("code",[a._v("spanIndex")]),a._v(" 则稍微有点特殊，乍一眼看上去，会认为它和 "),s("code",[a._v("spanGroupIndex")]),a._v(" 一样，是当前的 item 在这一行的位置，然而并不是。")]),a._v(" "),s("p",[a._v("用上图来说，第二个 item 的 "),s("code",[a._v("spanIndex")]),a._v("，实际上是 "),s("code",[a._v("2")]),a._v("，而并不是当前 item 在这一行的索引。")]),a._v(" "),s("p",[a._v("也就是说，"),s("code",[a._v("spanIndex")]),a._v("，是当前的 item 所在的 "),s("strong",[a._v("span")]),a._v(" 的索引，一行有 3 个 span，那么第二个 item 在第 3 个 span，其索引就是 2。")]),a._v(" "),s("h2",{attrs:{id:"_3-使用-spansizelookup-计算-offset"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-使用-spansizelookup-计算-offset"}},[a._v("#")]),a._v(" 3. 使用 SpanSizeLookup 计算 Offset")]),a._v(" "),s("p",[a._v("现在，我们知道了 "),s("code",[a._v("spanGroupIndex")]),a._v(" 就是竖直方向的 "),s("span",{staticClass:"katex"},[s("span",{staticClass:"katex-mathml"},[s("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[s("semantics",[s("mrow",[s("mi",[a._v("n")]),s("mo",[a._v("−")]),s("mn",[a._v("1")])],1),s("annotation",{attrs:{encoding:"application/x-tex"}},[a._v("n-1")])],1)],1)],1),s("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[s("span",{staticClass:"base"},[s("span",{staticClass:"strut",staticStyle:{height:"0.66666em","vertical-align":"-0.08333em"}}),s("span",{staticClass:"mord mathnormal"},[a._v("n")]),s("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2222222222222222em"}}),s("span",{staticClass:"mbin"},[a._v("−")]),s("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2222222222222222em"}})]),s("span",{staticClass:"base"},[s("span",{staticClass:"strut",staticStyle:{height:"0.64444em","vertical-align":"0em"}}),s("span",{staticClass:"mord"},[a._v("1")])])])]),a._v("，可以直接进行对应计算。")]),a._v(" "),s("p",[a._v("但是对于 "),s("code",[a._v("spanIndex")]),a._v(" 则不然，我们又拿这幅图来说一下：")]),a._v(" "),s("p",[s("img",{attrs:{src:"/images/不同-spansize-的-item.png",alt:"不同 spanSize 的 item"}})]),a._v(" "),s("p",[a._v("对第一个 item 来说，它左边的 offset 是第 "),s("code",[a._v("0")]),a._v(" 个 item 的 "),s("code",[a._v("left")]),a._v("；")]),a._v(" "),s("p",[a._v("但是它的右边的 offset 是"),s("strong",[a._v("第 "),s("code",[a._v("1")]),a._v(" 个")]),a._v(" item 的 "),s("code",[a._v("right")]),a._v("；")]),a._v(" "),s("p",[a._v("所以在水平方向上来说：")]),a._v(" "),s("ol",[s("li",[a._v("startIndex = spanIndex")]),a._v(" "),s("li",[a._v("endIndex = spanIndex + spanSize - 1")])]),a._v(" "),s("p",[a._v("这个坑需要非常注意，否则就会算错 offset")]),a._v(" "),s("h2",{attrs:{id:"_4-总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-总结"}},[a._v("#")]),a._v(" 4. 总结")]),a._v(" "),s("p",[a._v("那么到这里，我们就已经知道了如何使用 "),s("code",[a._v("SpanSizeLookup")]),a._v(" 的相关属性来获取我们需要的 "),s("span",{staticClass:"katex"},[s("span",{staticClass:"katex-mathml"},[s("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[s("semantics",[s("mrow",[s("mi",[a._v("n")]),s("mo",[a._v("−")]),s("mn",[a._v("1")])],1),s("annotation",{attrs:{encoding:"application/x-tex"}},[a._v("n-1")])],1)],1)],1),s("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[s("span",{staticClass:"base"},[s("span",{staticClass:"strut",staticStyle:{height:"0.66666em","vertical-align":"-0.08333em"}}),s("span",{staticClass:"mord mathnormal"},[a._v("n")]),s("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2222222222222222em"}}),s("span",{staticClass:"mbin"},[a._v("−")]),s("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2222222222222222em"}})]),s("span",{staticClass:"base"},[s("span",{staticClass:"strut",staticStyle:{height:"0.64444em","vertical-align":"0em"}}),s("span",{staticClass:"mord"},[a._v("1")])])])]),a._v(" 这个值，而只要有了 "),s("span",{staticClass:"katex"},[s("span",{staticClass:"katex-mathml"},[s("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[s("semantics",[s("mrow",[s("mi",[a._v("n")]),s("mo",[a._v("−")]),s("mn",[a._v("1")])],1),s("annotation",{attrs:{encoding:"application/x-tex"}},[a._v("n-1")])],1)],1)],1),s("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[s("span",{staticClass:"base"},[s("span",{staticClass:"strut",staticStyle:{height:"0.66666em","vertical-align":"-0.08333em"}}),s("span",{staticClass:"mord mathnormal"},[a._v("n")]),s("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2222222222222222em"}}),s("span",{staticClass:"mbin"},[a._v("−")]),s("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2222222222222222em"}})]),s("span",{staticClass:"base"},[s("span",{staticClass:"strut",staticStyle:{height:"0.64444em","vertical-align":"0em"}}),s("span",{staticClass:"mord"},[a._v("1")])])])]),a._v(" 这个值，我们就可以通过等差数列的通项公式去计算各个 item 的各个方向上的 offset，那么一个动态 spanSize 的 GirdSpacingItemDecoration 就可以构建出来了。")]),a._v(" "),s("h2",{attrs:{id:"_5-番外-精度问题"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-番外-精度问题"}},[a._v("#")]),a._v(" 5. 番外：精度问题")]),a._v(" "),s("p",[a._v("虽然具体原理已经讲完了，但是对于 offset 的计算还需要注意一个精度的问题；")]),a._v(" "),s("p",[a._v("虽然各边的 offset 都是 "),s("code",[a._v("int")]),a._v(" 值，但是我们的 "),s("code",[a._v("sizeAvg")]),a._v(" 这个关键的量是需要通过除法计算的，所以如果 "),s("code",[a._v("sizeAvg")]),a._v(" 使用 "),s("code",[a._v("int")]),a._v(" 类型，就会丢失一部分的小数部分，导致最后计算出的 "),s("code",[a._v("offset")]),a._v(" 和需求的不一致，或者宽了，或者窄了。")]),a._v(" "),s("p",[a._v("因此，"),s("code",[a._v("sizeAvg")]),a._v(" 必须使用较高精度的浮点数进行表示，例如 "),s("code",[a._v("double")]),a._v("，那么也就说明我们给进去的参数也要是 "),s("code",[a._v("double")]),a._v(" 类型的，这点也需要特别注意。")]),a._v(" "),s("h2",{attrs:{id:"_6-代码"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_6-代码"}},[a._v("#")]),a._v(" 6. 代码")]),a._v(" "),s("p",[a._v("我知道大家就喜欢直入主题，代码"),s("a",{attrs:{href:"https://gist.github.com/wafer-li/8b0e6ebd98f799f21b9f9f90a69575a9",target:"_blank",rel:"noopener noreferrer"}},[a._v("在此"),s("OutboundLink")],1),a._v("；")]),a._v(" "),s("p",[a._v("虽然和"),s("a",{attrs:{href:"../itemdecoration-%E5%AE%9E%E6%88%98%E4%B9%8B-girdspacingitemdecoration%EF%BC%88%E4%B8%80%EF%BC%89"}},[a._v("上篇")]),a._v("的代码是同一个地址就是了。")])])}),[],!1,null,null,null);t.default=n.exports}}]);