(window.webpackJsonp=window.webpackJsonp||[]).push([[54],{957:function(s,a,t){"use strict";t.r(a);var e=t(1),n=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[s._v("这个想法是我在折腾 Hexo Next 6.0 的时候发现的，有位仁兄在 Next 的新 repo 问如何处理 CI 问题，受到他的启发，我就开始折腾使用 Travis CI 进行博客的自动部署了。")]),s._v(" "),t("h2",{attrs:{id:"_1-为什么要用-ci-来部署博客"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-为什么要用-ci-来部署博客"}},[s._v("#")]),s._v(" 1. 为什么要用 CI 来部署博客")]),s._v(" "),t("p",[s._v("遇到一项新技术，一个好习惯就是问一下自己 "),t("strong",[s._v("为什么要用这个新技术")]),s._v("，它带来了什么好处，解决了什么问题？否则就会陷入为了使用新技术而使用新技术的陷阱之中。")]),s._v(" "),t("p",[s._v("那么为什么要用 CI 来部署呢？好处是显而易见的：")]),s._v(" "),t("p",[s._v("在未采用 CI 的时候，编写完博客总需要自己手动 "),t("code",[s._v("hexo g -d")]),s._v("，这种工作是重复性的、枯燥的，那么就应当尽量寻找让重复性的工作进行自动化的方法；")]),s._v(" "),t("p",[s._v("在使用 CI 之后，我只需要执行 "),t("code",[s._v("git push")]),s._v("，将博客的 markdown source 推到远端仓库，剩下的静态页面构建过程就由 CI 接手进行，而不需要我手动打字，而且还占用我的 CPU。")]),s._v(" "),t("p",[s._v("这虽然方便，但是不禁会有人担心：如果每 push 一次就会自己构建，博客会不会因为 push 上去了一些不好的东西而搞炸了？")]),s._v(" "),t("p",[s._v("其实这种担心是多余的，只需要在进行了大面积更改的时候先在本地查看一下，如果没有问题就再 push 就行了，这时候虽然需要本地生成，但是你不可能整天重构你的博客，所以 CI 的效率提升还是存在的。")]),s._v(" "),t("h2",{attrs:{id:"_2-travis-ci-的配置流程"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-travis-ci-的配置流程"}},[s._v("#")]),s._v(" 2. Travis CI 的配置流程")]),s._v(" "),t("p",[s._v("本博客采用 Travis CI 作为持续集成工具，下面就介绍一下基本的配置流程。")]),s._v(" "),t("p",[s._v("由于 Travis CI 比较流行，注册和关联 repo 这种操作就不介绍了。")]),s._v(" "),t("h3",{attrs:{id:"_2-1-获取相关权限"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-获取相关权限"}},[s._v("#")]),s._v(" 2.1 获取相关权限")]),s._v(" "),t("p",[s._v("在配置和使用 Travis CI 之前，我们首先要做的就是为 Travis CI 获取其所需要的权限。")]),s._v(" "),t("p",[s._v("当然，获取所需要的权限有很多种方法，这里推荐两种，分别为 Access Token和 Deploy Key")]),s._v(" "),t("p",[s._v("这两种各有好处，Deploy Key 的好处在于安全性比较高，Access Token 的好处是较为灵活。")]),s._v(" "),t("p",[s._v("下面每种都写了推荐使用的 repo，你可以根据你的 repo 的实际情况来选择。")]),s._v(" "),t("h4",{attrs:{id:"_2-1-1-使用-depoly-key-进行部署"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-1-使用-depoly-key-进行部署"}},[s._v("#")]),s._v(" 2.1.1 使用 Depoly Key 进行部署")]),s._v(" "),t("blockquote",[t("p",[t("strong",[s._v("本方法适用于大多数的公有博客仓库")]),s._v(" "),t("strong",[s._v("同时，仓库内不具备私有的子模块")]),s._v(" "),t("strong",[s._v("建议首选")])])]),s._v(" "),t("p",[s._v("Deploy Key 是一个 SSH Key，区别于个人 SSH Key 的是，它仅对配置了它的仓库有效；")]),s._v(" "),t("p",[s._v("也就是说，如果应用使用了 Deploy Key，那么应用的权限就仅限于 repo 之中，准确的来说，是仅限于 repo 的 "),t("strong",[s._v("文件读写权限")]),s._v("。")]),s._v(" "),t("p",[s._v("这就给 Deploy Key 带来了很高的安全度，即使 Key 泄漏了，威胁到的也只是设置了它的仓库，而不会威胁帐号本身。")]),s._v(" "),t("p",[s._v("使用了 SSH Key 也就意味着我们是使用 SSH 和 GitHub 进行连接，那么对 SSH 的配置是必不可少的；")]),s._v(" "),t("h5",{attrs:{id:"_2-1-1-1-密钥生成"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-1-1-密钥生成"}},[s._v("#")]),s._v(" 2.1.1.1 密钥生成")]),s._v(" "),t("p",[s._v("首先我们要生成一对公钥和私钥，这个在很多地方都有操作介绍了，这里就不多讲。")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("ssh-keygen -t rsa -b "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4096")]),s._v(" -C "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"email"')]),s._v(" -f key_file -N "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("''")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("接着，到 repo 的 Settings 里面创建一个 Deploy Key，把公钥的内容粘贴进去。")]),s._v(" "),t("blockquote",[t("p",[s._v("如果是 coding.net 的话，是配置在 "),t("code",[s._v("部署公钥")]),s._v(" 之中。")])]),s._v(" "),t("p",[s._v("然后我们把公钥删掉，避免你误把它加入了 git 中。")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" -f key_file.pub\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h5",{attrs:{id:"_2-1-1-2-使用-travis-命令行程序进行加密"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-1-2-使用-travis-命令行程序进行加密"}},[s._v("#")]),s._v(" 2.1.1.2 使用 Travis 命令行程序进行加密")]),s._v(" "),t("p",[s._v("密钥显然是不能给别人看的，因此，我们就要把密钥通过 "),t("code",[s._v("travis")]),s._v(" 程序加密。")]),s._v(" "),t("p",[s._v("首先，我们要安装 "),t("code",[s._v("travis")])]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("gem "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" travis\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("blockquote",[t("p",[s._v("如果你的 "),t("code",[s._v("ruby")]),s._v(" 版本太旧，可能还需要先升级一下。\n"),t("strong",[s._v("最好在你的 repo 目录下执行 "),t("code",[s._v("travis")]),s._v(" 命令")]),s._v("\n方便 "),t("code",[s._v("travis")]),s._v(" 自动识别仓库。")])]),s._v(" "),t("p",[s._v("然后，我们通过 "),t("code",[s._v("travis")]),s._v(" 来登录：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("travis login\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("这是为了让 "),t("code",[s._v("travis")]),s._v(" 自动将加密好的东西上传到 Settings 的环境变量中，这样就不用我们配置 "),t("code",[s._v(".travis.yml")]),s._v(" 文件了。")]),s._v(" "),t("p",[s._v("接着，我们对文件进行加密：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("travis encrypt key_file\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("随后，我们把生成的 "),t("code",[s._v(".enc")]),s._v(" 文件加入 git 中，并把私钥删掉。")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" -f key_file\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" key_file.enc\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h5",{attrs:{id:"_2-1-1-3-配置-known-hosts-和-ssh"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-1-3-配置-known-hosts-和-ssh"}},[s._v("#")]),s._v(" 2.1.1.3 配置 Known Hosts 和 SSH")]),s._v(" "),t("p",[s._v("接下来，我们就进行 SSH 的相关配置；")]),s._v(" "),t("p",[t("strong",[s._v("首先需要配置的是 Known Hosts，否则 CI 就会卡在问你是否要继续那里。")])]),s._v(" "),t("p",[s._v("然后，我们使用 "),t("code",[s._v("openssl")]),s._v(" 把之前加密的文件解压成私钥，最后把私钥配置上就行了。")]),s._v(" "),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("addons")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ssh_known_hosts")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" github.com\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" git.coding.net\n\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("before_install")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# SSH Setup")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" openssl aes"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("256"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("cbc "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("K $encrypted_693585a97b8c_key "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("iv $encrypted_693585a97b8c_iv "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("in blog_deploy_key.enc "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("out blog_deploy_key "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("d\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(' eval "$(ssh'),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("agent "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v('s)"\n    '),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" chmod 600 ./blog_deploy_key\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ssh"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("add ./blog_deploy_key\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("h4",{attrs:{id:"_2-1-2-获取-access-token"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-2-获取-access-token"}},[s._v("#")]),s._v(" 2.1.2 获取 Access Token")]),s._v(" "),t("blockquote",[t("p",[t("strong",[s._v("本方法适用于具有私有 Submodule 的仓库的情况")])])]),s._v(" "),t("p",[s._v("GitHub 获取 Access Token 的步骤如下：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("Settings -> Developer settings -> Personal access token\n-> Generate new token\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("接着就进入创建 Access Token 的页面了，对于一个博客的 CI 来说，我们需要的权限比较少，我尝试了一下只需要 "),t("code",[s._v("public_repo")]),s._v(" 的权限即可；")]),s._v(" "),t("p",[s._v("为了尽量保证我们 GitHub 帐号的安全，能少给权限就少给。")]),s._v(" "),t("p",[s._v("然后我们选择生成，此时会返回到 "),t("code",[s._v("Personal access token")]),s._v(" 的页面，并显示我们刚才生成的 access token。")]),s._v(" "),t("blockquote",[t("p",[s._v("需要注意的是，这个 access token "),t("strong",[s._v("只会在这一个页面显示一次")]),s._v("，切记要复制下来，否则就只能 "),t("strong",[s._v("重新生成")]),s._v("。")])]),s._v(" "),t("p",[s._v("然后我们到博客 repo 的 Travis CI 设置页面中新建一个环境变量，将这个 Access Token 粘贴到环境变量的 value 中。")]),s._v(" "),t("blockquote",[t("p",[s._v("这里要注意一定要关掉 "),t("code",[s._v("Display in log")]),s._v(" 的选项，否则你的 Access Token 就泄漏了。")])]),s._v(" "),t("h3",{attrs:{id:"_2-2-只构建含有-travis-yml-文件的分支"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-只构建含有-travis-yml-文件的分支"}},[s._v("#")]),s._v(" 2.2 只构建含有 "),t("code",[s._v(".travis.yml")]),s._v(" 文件的分支")]),s._v(" "),t("p",[s._v("对于本博客而言，我采用单 repo 双分支管理，即一个 "),t("code",[s._v("source")]),s._v(" 分支保存原始的 markdown 文件，另一个 "),t("code",[s._v("master")]),s._v(" 分支保存用于部署的 HTML。")]),s._v(" "),t("p",[s._v("对于这种情况，我们就 "),t("strong",[s._v("必须要")]),s._v(" 在 Travis CI 的 "),t("strong",[s._v("repo 设置页面")]),s._v(" 中勾选 "),t("strong",[s._v("只构建含有 "),t("code",[s._v(".travis.yml")]),s._v(" 文件的分支")]),s._v("；")]),s._v(" "),t("p",[s._v("由于 Travis CI 会侦听 commit 事件进行自动构建，而对于 master 上的 commit，是不含有 "),t("code",[s._v(".travis.yml")]),s._v(" 文件也不需要构建的。")]),s._v(" "),t("p",[s._v("为了防止 Travis CI 构建 master 分支，我们就必须要勾选这个选项。")]),s._v(" "),t("p",[s._v("有些教程提到使用")]),s._v(" "),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("branches")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("only")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" source\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("也可以起到只构建 "),t("code",[s._v("source")]),s._v(" 的功能；\n不过在我这里这种方法行不通，最后还是使用了只构建含有 "),t("code",[s._v(".travis,yml")]),s._v(" 文件的方法。")]),s._v(" "),t("h3",{attrs:{id:"_2-3-travis-yml-文件的基本配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-travis-yml-文件的基本配置"}},[s._v("#")]),s._v(" 2.3 "),t("code",[s._v(".travis.yml")]),s._v(" 文件的基本配置")]),s._v(" "),t("p",[s._v("本博客使用的 Hexo 框架是采用 Node.js 技术编写的，所以可以直接套用 Node.js 的 Travis CI 流程。")]),s._v(" "),t("p",[s._v("下面是一些基本的 Node.js "),t("code",[s._v(".travis.yml")]),s._v(" 的配置")]),s._v(" "),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 环境变量，注意一个 item 就会构建一次")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 所以一次构建中需要多个环境变量的，也要写到一行里")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("env")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ENV_1=xxxxxx ENV_2=yyyyyy\n\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("language")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" node_js   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 构建的编程语言")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("node_js")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" node       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Node.js 的版本，node 表示最新版")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 缓存的目录")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Node.js 项目一般缓存 node_modules")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 用于加快构建速度")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cache")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("directories")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"node_modules"')]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在 install 阶段之前执行的命令")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("before_install")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Install 阶段，在这里是 npm install")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("install")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" npm install\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在 script 之前执行的命令")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("before_script")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Script 阶段，执行 hexo 相关命令")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("script")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" hexo clean\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" hexo g "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("d "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("config source/_data/next.yml\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br")])]),t("p",[s._v("在拥有 "),t("code",[s._v(".travis.yml")]),s._v(" 文件后，每次 commit 之后 Travis CI 就会读取这个文件用来进行自动化构建工作")]),s._v(" "),t("h2",{attrs:{id:"_3-相关的坑"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-相关的坑"}},[s._v("#")]),s._v(" 3. 相关的坑")]),s._v(" "),t("p",[s._v("当然，Travis CI 的配置不可能这么一帆风顺，还存在着非常多的坑。")]),s._v(" "),t("p",[s._v("下面就来介绍一下我所遇到的坑，希望给大家以前车之鉴。")]),s._v(" "),t("h3",{attrs:{id:"_3-1-git-submodule-的坑"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-git-submodule-的坑"}},[s._v("#")]),s._v(" 3.1 Git Submodule 的坑")]),s._v(" "),t("p",[s._v("如果你的 GitHub 使用了两步验证，那么你平时肯定是使用 ssh 的地址进行 git 的相关操作；")]),s._v(" "),t("p",[s._v("但是对于 Travis CI 的虚拟机来说，它不具备你的 SSH key，当然也就不能使用 ssh 地址进行 clone 和 push。")]),s._v(" "),t("p",[s._v("特别是对于 git submodule，由于 Travis CI 自己可以处理 https 地址的 submodule，但是如果采用 ssh 方式，它根本就无法 clone 下来。")]),s._v(" "),t("p",[s._v("此时，我们就需要自己手动管理 git submodule，在 "),t("code",[s._v(".travis.yml")]),s._v(" 中增加如下选项：")]),s._v(" "),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("git")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("submodules")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("false")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("before_install")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" sed "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("i 's/git@github.com"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/https"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\\/\\/github.com\\//' .gitmodules\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("上面的 "),t("code",[s._v("sed")]),s._v(" 命令就是将 ssh 地址替换成 https 地址的。")]),s._v(" "),t("p",[s._v("不过，对于后面的部署阶段，由于要 push 到自己的仓库，所以 deploy 的地址需要修改为 "),t("code",[s._v("https://<username>:<ACCESS_TOKEN>@github.com/<username>/repo.git")])]),s._v(" "),t("p",[s._v("所以，如果使用 "),t("code",[s._v("hexo-deploy")]),s._v(" 插件的话，还需要以下的命令：")]),s._v(" "),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("before_script")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(' sed i "s/git@github.com'),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/https"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\\/\\/yourusername"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("$"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("ACCESS_TOKEN"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v('@github.com\\//" you_config_file.yml\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("把上面的 "),t("code",[s._v("yourusername")]),s._v(" 和 "),t("code",[s._v("your_config_file.yml")]),s._v(" 作出相应修改即可。")]),s._v(" "),t("h3",{attrs:{id:"_3-2-安装某些额外程序包"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-安装某些额外程序包"}},[s._v("#")]),s._v(" 3.2 安装某些额外程序包")]),s._v(" "),t("p",[s._v("如果你使用 "),t("code",[s._v("hexo-all-minifier")]),s._v(" 来进行 HTML 的相关文件压缩，那么你就需要额外安装一个系统程序包 "),t("code",[s._v("nasm")]),s._v("。")]),s._v(" "),t("p",[s._v("Travis CI 对此推出了 "),t("code",[s._v("addons")]),s._v(" 选项来方便你配置：")]),s._v(" "),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("addons")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apt")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("packages")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" nasm\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("这个问题比较难暴露，我查看了很久的 log，最后在 "),t("code",[s._v("npm install")]),s._v(" 的 log 里面发现了某个依赖没办法安装；")]),s._v(" "),t("p",[s._v("最后才发现是缺了一个系统的程序包。")]),s._v(" "),t("h3",{attrs:{id:"_3-3-patch-某些-hexo-插件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-patch-某些-hexo-插件"}},[s._v("#")]),s._v(" 3.3 Patch 某些 Hexo 插件")]),s._v(" "),t("p",[s._v("有时候你使用的 Hexo 插件有些问题，虽然有人提出了 PR，但是久久没有合并；")]),s._v(" "),t("p",[s._v("在本地生成的时代，你需要自己手动 patch 这个插件，然而我们现在使用 CI，当然不可能由你进去复制粘贴。")]),s._v(" "),t("p",[s._v("这时候，我们可以使用 "),t("code",[s._v("curl")]),s._v(" 把 patch 文件下载下来，并覆写相关文件。")]),s._v(" "),t("p",[s._v("通过下面的命令可以进行覆写操作：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("raw-path-file-url"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("problem_file"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("其中 "),t("code",[s._v(">|")]),s._v(" 符号可以使后面的文件清空，类似于文件操作的 "),t("code",[s._v("w")]),s._v(" 选项。")]),s._v(" "),t("h3",{attrs:{id:"_3-4-安装-hexo-next-主题的插件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-安装-hexo-next-主题的插件"}},[s._v("#")]),s._v(" 3.4 安装 Hexo Next 主题的插件")]),s._v(" "),t("p",[s._v("Hexo Next 在 6.0 之后，把一些原本在 "),t("code",[s._v("source/lib")]),s._v(" 中的 js 文件移到了新的 repo 中，以减少 next 本身 repo 的复杂度。")]),s._v(" "),t("p",[s._v("但是由于 Next 把 "),t("code",[s._v("source/lib")]),s._v(" 这个路径 ignore 了，所以我们要手动将插件 clone 到 "),t("code",[s._v("source/lib")]),s._v(" 里面。")]),s._v(" "),t("p",[s._v("在使用 CI 时，我们需要在 "),t("code",[s._v("hexo g -d")]),s._v(" 之前将插件装好：")]),s._v(" "),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("before_script")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## Theme Dependencies")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" cd themes/next"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("reloaded\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# canvas-nest")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" git clone https"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//github.com/theme"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("next/theme"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("next"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("canvas"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("nest source/lib/canvas"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("nest\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# fancybox3")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" git clone https"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//github.com/theme"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("next/theme"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("next"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("fancybox3 source/lib/fancybox\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# reading_progress")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" git clone https"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//github.com/theme"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("next/theme"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("next"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("reading"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("progress source/lib/reading_progress\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" cd ../..\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("p",[s._v("这里需要注意一下当前工作路径的问题，记得切换回原目录。")]),s._v(" "),t("h3",{attrs:{id:"_3-5-时区问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-5-时区问题"}},[s._v("#")]),s._v(" 3.5 时区问题")]),s._v(" "),t("p",[s._v("Travis CI 好像默认使用的是美国的时区，这样就会让你的 master commit 历史变得很乱。")]),s._v(" "),t("p",[s._v("所以，我们有必要让 Travis CI 和你的本机时区进行统一")]),s._v(" "),t("p",[s._v("这个配置比较简单，通过设置 "),t("code",[s._v("TZ")]),s._v(" 环境变量即可。")]),s._v(" "),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("env")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("global")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" TZ=Asia/Tokyo\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("blockquote",[t("p",[s._v("别吐槽我为什么用日本时区，玩游戏需要。")])]),s._v(" "),t("p",[s._v("这里需要多说一点的是，如果只有 "),t("code",[s._v("env")]),s._v("，如：")]),s._v(" "),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("env")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ENV1=xxxx\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ENV2=yyyy\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("此时，Travis CI 就会进行 "),t("strong",[s._v("两次")]),s._v(" 构建，分别采用 "),t("code",[s._v("ENV1")]),s._v(" 和 "),t("code",[s._v("ENV2")])]),s._v(" "),t("p",[s._v("而对于 "),t("code",[s._v("global")]),s._v(" 的环境变量，就会采取所有的环境变量，只构建一次。")]),s._v(" "),t("h2",{attrs:{id:"_4-总结"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-总结"}},[s._v("#")]),s._v(" 4. 总结")]),s._v(" "),t("p",[s._v("经过一段时间的奋战，Travis CI 的集成终于做好了；\n虽然花费了点时间，不过在折腾的过程中还接触了一下 Travis CI 的配置流程，想必还是有些收获的；")]),s._v(" "),t("p",[s._v("要不人们总说折腾博客比写博客有趣呢？")])])}),[],!1,null,null,null);a.default=n.exports}}]);