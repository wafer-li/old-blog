(window.webpackJsonp=window.webpackJsonp||[]).push([[19],{947:function(t,a,s){"use strict";s.r(a);var n=s(1),e=Object(n.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("p",[t._v("最近在迁移到 AndroidX 之后一直折腾 TDD 的事情，也遇到了大的小的不少坑点；")]),t._v(" "),s("p",[t._v("鉴于 AndroidX 在测试方面还没有太多的文档，就写一篇博文来总结一下折腾的经验，也给后来人做一些参考。")]),t._v(" "),s("h2",{attrs:{id:"_1-国产-rom-的坑"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-国产-rom-的坑"}},[t._v("#")]),t._v(" 1. 国产 ROM 的坑")]),t._v(" "),s("p",[s("code",[t._v("ActivityScenario")]),t._v(" 和 "),s("code",[t._v("ActivityScenarioRule")]),t._v(" 是新推出的操作 Activity 生命周期的类。")]),t._v(" "),s("p",[t._v("当构建 "),s("code",[t._v("ActivityScenario")]),t._v(" 时，它便会自动启动你指定的 Activity 并让它处于 "),s("code",[t._v("RESUMED")]),t._v(" 状态。")]),t._v(" "),s("p",[t._v("使用示例如下：")]),t._v(" "),s("div",{staticClass:"language-kotlin line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-kotlin"}},[s("code",[s("span",{pre:!0,attrs:{class:"token annotation builtin"}},[t._v("@RunWith")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("AndroidJunit4"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" MainActivityTest "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token annotation builtin"}},[t._v("@get:Rule")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" mainActivityScenarioRule "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ActivityScenarioRule"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("MainActivity"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("MainActivity"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("::")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("java"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token annotation builtin"}},[t._v("@Test")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("fun")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("onCreate_saveInstanceNull")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        mainActivityScenarioRule"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("scenario\n                "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("onActivity")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" activity "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("\n                  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 在这里获取 Activity 实例")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br")])]),s("p",[t._v("但是，当我在手机上跑这个测试的时候，却遇到了下面的问题：")]),t._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("java.lang.AssertionError: Activity never becomes requested state "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"[RESUMED]"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("last lifecycle transition "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"PRE_ON_CREATE"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br")])]),s("p",[t._v("也就是说，我这个 Activity 实际上并没有真正的 "),s("code",[t._v("onCreate")]),t._v(" 而是一直处于被创建之前的状态，随后因为超时导致了报错退出。")]),t._v(" "),s("blockquote",[s("p",[t._v("具体的超时时间是 45 秒")])]),t._v(" "),s("p",[t._v("但是到底是什么东西导致我的 Activity 启动不了却没有什么头绪，直到我用模拟器运行测试代码的时候，我发现： "),s("strong",[t._v("居然测试通过了！")])]),t._v(" "),s("p",[t._v("原来，Android 的仪器测试(Instrumented Test)都会构建一个独立的 "),s("code",[t._v("test.apk")]),t._v(" 并自动安装和运行。")]),t._v(" "),s("p",[t._v("而国产的手机系统对于应用自启动的管理非常激进（例如华为），而我也没有对 "),s("code",[t._v("test.apk")]),t._v(" 设置白名单，于是系统就一直禁止 "),s("code",[t._v("tesk.apk")]),t._v(" 的启动，导致测试失败。")]),t._v(" "),s("p",[t._v("在华为的手机应用管家中为 "),s("code",[t._v("test.apk")]),t._v(" 设置白名单，测试就可以通过了。")]),t._v(" "),s("h2",{attrs:{id:"_2-fragment-testing-的坑"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-fragment-testing-的坑"}},[t._v("#")]),t._v(" 2. Fragment Testing 的坑")]),t._v(" "),s("h3",{attrs:{id:"_2-1-编译依赖的坑"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-编译依赖的坑"}},[t._v("#")]),t._v(" 2.1 编译依赖的坑")]),t._v(" "),s("p",[t._v("和 "),s("code",[t._v("ActivityScenario")]),t._v(" 一样，Google 也提供了一个 "),s("code",[t._v("FragmentScenario")]),t._v(" 方便在测试中获取 "),s("code",[t._v("Fragment")]),t._v(" 实例和对 "),s("code",[t._v("Fragment")]),t._v(" 进行操作。")]),t._v(" "),s("p",[t._v("但是需要引入 "),s("code",[t._v("fragment-testing")]),t._v(" 库，按照 Google 的文档是下面的这条语句:")]),t._v(" "),s("div",{staticClass:"language-groovy line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-groovy"}},[s("code",[t._v("debugImplementation "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'androidx.fragment:fragment-testing:1.1.0-alpha07'")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[t._v("这里就是它的第一个坑，如果你只引入上面的这条语句，实际上根本不可能成功 Build。")]),t._v(" "),s("p",[t._v("主要有以下两点原因：")]),t._v(" "),s("ol",[s("li",[s("p",[s("code",[t._v("fragment-testing")]),t._v(" 需要依赖 "),s("code",[t._v("androidx.test.core")]),t._v("，而 debugImplementation 并没有引入 "),s("code",[t._v("androidx.text.core")])])]),t._v(" "),s("li",[s("p",[t._v("我们需要在 Instrumented Test 中使用 "),s("code",[t._v("fragment-testing")]),t._v("，而上面并没有在 "),s("code",[t._v("androidTestImplementation")]),t._v(" 引入")])])]),t._v(" "),s("p",[t._v("于是乎，正确的引入方式是：")]),t._v(" "),s("div",{staticClass:"language-groovy line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-groovy"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("debugImplementation")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Libs"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("androidx_test_core"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("debugImplementation")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Libs"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("fragment_testing"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("androidTestImplementation")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Libs"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("androidx_test_core"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("androidTestImplementation")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Libs"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("fragment_testing"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br")])]),s("p",[t._v("那么能不能把 "),s("code",[t._v("debugImplementation")]),t._v(" 换成普通的 "),s("code",[t._v("implementation")]),t._v(" 呢？")]),t._v(" "),s("p",[t._v("很可惜，这是不行的，不过至于为什么不行，我目前并没有对此进行深入研究。")]),t._v(" "),s("h3",{attrs:{id:"_2-2-主题的坑"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-主题的坑"}},[t._v("#")]),t._v(" 2.2 主题的坑")]),t._v(" "),s("p",[t._v("导入和依赖的坑解决之后就到了如何使用的环节了。")]),t._v(" "),s("p",[t._v("具体的用法为：")]),t._v(" "),s("div",{staticClass:"language-kotlin line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-kotlin"}},[s("code",[s("span",{pre:!0,attrs:{class:"token annotation builtin"}},[t._v("@Test")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("fun")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("testFragment")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  launchFragmentScenario"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("LoginFragment"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" fragment "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 使用 fragment")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br")])]),s("p",[t._v("但是，这么使用也是不行的。")]),t._v(" "),s("p",[t._v("如果你使用了 Material 的组件，例如 "),s("code",[t._v("TextInputLayout")]),t._v("，那么它会报如下错误：")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("Caused by: android.view.InflateException: Binary XML file line\n#9: Error inflating class\n**com.google.android.material.textfield.TextInputLayout**\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br")])]),s("p",[t._v("在查阅相关资料之后，发现了"),s("a",{attrs:{href:"https://issuetracker.google.com/issues/119054431",target:"_blank",rel:"noopener noreferrer"}},[t._v("一个相关的 Issue"),s("OutboundLink")],1)]),t._v(" "),s("p",[t._v("其中 Google 的人指出：")]),t._v(" "),s("blockquote",[s("p",[t._v("You need to tell FragmentScenario "),s("strong",[t._v("what theme you want")]),t._v(" if you want something "),s("strong",[t._v("other than the default Theme.WithActionBar")]),t._v(", that's correct.")])]),t._v(" "),s("p",[t._v("也就是说，如果你使用了 Material 相关的主题，比如说常见的 "),s("code",[t._v("Theme.Appcompat")]),t._v(" 等，那么就需要向 "),s("code",[t._v("FragmentScenario")]),t._v(" 明确指出你使用的主题样式。")]),t._v(" "),s("p",[t._v("也就是说，上面的代码需要写成：")]),t._v(" "),s("div",{staticClass:"language-kotlin line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-kotlin"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("fun")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("testFragment")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  launchFragmentScenario"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("LoginFragment"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    themeResId "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" R"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("style"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Your_App_Theme\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" fragment "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 使用 fragment")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br")])]),s("p",[t._v("程序才能正常运行。")]),t._v(" "),s("h2",{attrs:{id:"_3-onfragment-onactivity-和-check-的坑"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-onfragment-onactivity-和-check-的坑"}},[t._v("#")]),t._v(" 3. onFragment/onActivity 和 check 的坑")]),t._v(" "),s("p",[s("code",[t._v("ActivityScenario")]),t._v(" 和 "),s("code",[t._v("FragmentScenario")]),t._v(" 都提供了一个相应的高阶函数 "),s("code",[t._v("onActivity()")]),t._v(" 和 "),s("code",[t._v("onFragment()")]),t._v("，可以在其中获取到对应的 "),s("code",[t._v("Activity")]),t._v(" 和 "),s("code",[t._v("Fragment")]),t._v(" 的实例，并用它做相应的操作。")]),t._v(" "),s("blockquote",[s("p",[t._v("实际上 "),s("code",[t._v("onFragment()")]),t._v(" 内部也是调用了 "),s("code",[t._v("onActivity()")])])]),t._v(" "),s("p",[t._v("但是！需要注意的是，这两个 "),s("code",[t._v("on")]),t._v(" 方法都是运行在主线程的，而 Espresso 的 "),s("code",[t._v("check()")]),t._v(" 函数是一个耗时操作，如果你在 "),s("code",[t._v("onFragment()")]),t._v(" 中调用 "),s("code",[t._v("check()")]),t._v("，那么就会 "),s("strong",[t._v("阻塞 UI 线程")]),t._v("。")]),t._v(" "),s("p",[t._v("也就是说，需要将 "),s("code",[t._v("onView()")]),t._v(" 相关的内容放到 "),s("code",[t._v("onFragment/onActivity")]),t._v(" 的外面：")]),t._v(" "),s("div",{staticClass:"language-kotlin line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-kotlin"}},[s("code",[t._v("launchFragmentInContainer"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("LoginFragment"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    themeResId "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" R"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("style"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Theme_Shrine\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("onFragment")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    tintColorRes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" typedValue"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("resourceId\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("onView")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("withContentDescription")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("R"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("string"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("shr_logo_content_description"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("check")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("matches")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("withDrawable")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("R"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("drawable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("shr_logo"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" tintColorRes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("check")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("matches")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("isCompletelyDisplayed")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br")])]),s("p",[t._v("等等，放到外面就不会阻塞 UI 线程了吗？难道不会阻塞 "),s("code",[t._v("test.apk")]),t._v(" 的 UI 线程？")]),t._v(" "),s("p",[t._v("经过反编译 "),s("code",[t._v("tesk.apk")]),t._v(" 之后发现，实际上 "),s("code",[t._v("test.apk")]),t._v(" "),s("strong",[t._v("只包含测试用例相关的内容")]),t._v("，甚至没有一个 "),s("code",[t._v("Activity")]),t._v("，而真正的被测试的内容实际上还是在我们原来的 apk 之中，"),s("code",[t._v("test.apk")]),t._v(" 实际上是通过启动被测试的 apk 的相关内容来实现仪器测试的。")]),t._v(" "),s("p",[t._v("也就是说，如果将 "),s("code",[t._v("onView")]),t._v(" 相关的代码放到外面，实际上是在 "),s("code",[t._v("test.apk")]),t._v(" 里面跑的，也就不会对被测试的 apk 进行阻塞。")]),t._v(" "),s("h2",{attrs:{id:"_4-动画的坑"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-动画的坑"}},[t._v("#")]),t._v(" 4. 动画的坑")]),t._v(" "),s("p",[t._v("Android 官方的 Espresso 测试框架不能兼容动画效果，在跑测试，特别是点击、输入等 UI 测试时，需要进入开发者模式把能显示动画的都关掉：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/images/android-espresso-坑点详解（一）/turn-off-animation.png",alt:"Turn Off Animation"}})]),t._v(" "),s("p",[t._v("不然 Espresso 会报 "),s("code",[t._v("PerformException")]),t._v("。")]),t._v(" "),s("h2",{attrs:{id:"_5-测试-imageview-的-drawable-的坑"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-测试-imageview-的-drawable-的坑"}},[t._v("#")]),t._v(" 5. 测试 ImageView 的 Drawable 的坑")]),t._v(" "),s("h3",{attrs:{id:"_5-1-android-tint-的坑"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-android-tint-的坑"}},[t._v("#")]),t._v(" 5.1 android:tint 的坑")]),t._v(" "),s("p",[t._v("对于 "),s("code",[t._v("ImageView")]),t._v("，我们需要测试它是否展示出了我们传入的 Drawable，不过比较可惜的是，Espresso 自身并没有提供 "),s("code",[t._v("withDrawable()")]),t._v(" 方法，幸运的是，我们可以通过 Kotlin 的扩展函数实现这个功能：")]),t._v(" "),s("div",{staticClass:"language-kotlin line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-kotlin"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("fun")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("withDrawable")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token annotation builtin"}},[t._v("@DrawableRes")]),t._v(" id"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Int"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token annotation builtin"}},[t._v("@ColorRes")]),t._v(" tint"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Int"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" tintMode"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" PorterDuff"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Mode "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" SRC_IN"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("object")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" TypeSafeMatcher"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("View"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("override")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("fun")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("describeTo")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("description"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Description"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        description"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("appendText")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ImageView with drawable same as drawable with id '),s("span",{pre:!0,attrs:{class:"token interpolation variable"}},[t._v("$id")]),t._v('"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("override")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("fun")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("matchesSafely")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("view"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" View"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Boolean "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" context "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" view"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("context\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" expectedBitmap "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" context"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getDrawable")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("toBitmap")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" view "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("is")]),t._v(" ImageView "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" view"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("drawable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("toBitmap")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sameAs")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("expectedBitmap"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br")])]),s("p",[t._v("但是，"),s("code",[t._v("ImageView")]),t._v(" 支持着色 (tint) 功能，真正显示出来的 Drawable 和我们从 "),s("code",[t._v("Context")]),t._v(" 里面拿到的 Drawable 很可能是不一样的，因此，我们也需要给 "),s("code",[t._v("expectedBitmap")]),t._v(" 进行着色：")]),t._v(" "),s("div",{staticClass:"language-kotlin line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-kotlin"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("fun")]),t._v(" Int"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("toColor")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("context"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Context"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ContextCompat"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getColor")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("context"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("fun")]),t._v(" Drawable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("tinted")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token annotation builtin"}},[t._v("@ColorInt")]),t._v(" tintColor"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Int"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" tintMode"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" PorterDuff"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Mode "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" SRC_IN"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n        apply "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTintList")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tintColor"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("toColorStateList")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTintMode")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tintMode"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("fun")]),t._v(" Int"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("toColorStateList")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ColorStateList"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("valueOf")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("fun")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("withDrawable")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token annotation builtin"}},[t._v("@DrawableRes")]),t._v(" id"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Int"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token annotation builtin"}},[t._v("@ColorRes")]),t._v(" tint"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Int"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" tintMode"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" PorterDuff"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Mode "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" SRC_IN"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("object")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" TypeSafeMatcher"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("View"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("override")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("fun")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("describeTo")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("description"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Description"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        description"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("appendText")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ImageView with drawable same as drawable with id '),s("span",{pre:!0,attrs:{class:"token interpolation variable"}},[t._v("$id")]),t._v('"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        tint"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("let")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" description"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("appendText")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('", tint color id: '),s("span",{pre:!0,attrs:{class:"token interpolation variable"}},[t._v("$tint")]),t._v(", mode: "),s("span",{pre:!0,attrs:{class:"token interpolation variable"}},[t._v("$tintMode")]),t._v('"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("override")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("fun")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("matchesSafely")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("view"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" View"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Boolean "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" context "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" view"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("context\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" tintColor "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" tint"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("toColor")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("context"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" expectedBitmap "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" context"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getDrawable")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("tinted")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tintColor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" tintMode"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("toBitmap")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" view "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("is")]),t._v(" ImageView "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" view"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("drawable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("toBitmap")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sameAs")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("expectedBitmap"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br"),s("span",{staticClass:"line-number"},[t._v("22")]),s("br"),s("span",{staticClass:"line-number"},[t._v("23")]),s("br"),s("span",{staticClass:"line-number"},[t._v("24")]),s("br")])]),s("h3",{attrs:{id:"_5-2-vectordrawable-的坑"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-vectordrawable-的坑"}},[t._v("#")]),t._v(" 5.2 VectorDrawable 的坑")]),t._v(" "),s("p",[t._v("从 5.0 之后， Android 支持矢量图，即 "),s("code",[t._v("VectorDrawable")]),t._v("，在 "),s("code",[t._v("ImageView")]),t._v(" 中使用 "),s("code",[t._v("app:srcCompat")]),t._v(" 进行显示。")]),t._v(" "),s("p",[t._v("但是，虽然在普通的 apk 中可以正常显示矢量图，但是在运行仪器测试时仅仅这样是显示不了的，还需要在代码中使用 "),s("code",[t._v("setImageResource()")]),t._v(" 才能在测试中显示出矢量图。")]),t._v(" "),s("p",[t._v("目前来看这是 Android 测试框架的一个 Bug，如果不想改代码的话可以不进行这方面的测试，毕竟图能不能显示出来，用眼睛看看就行了。")]),t._v(" "),s("h3",{attrs:{id:"_5-3-vectordrawable-和-tint-的坑"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-3-vectordrawable-和-tint-的坑"}},[t._v("#")]),t._v(" 5.3 VectorDrawable 和 tint 的坑")]),t._v(" "),s("p",[t._v("上面说到了 Drawable 需要 tint，如果我们的 "),s("code",[t._v("ImageView")]),t._v(" 显示的是 "),s("code",[t._v("VectorDrawable")]),t._v("，那就要小心了，因为 "),s("code",[t._v("VectorDrawable")]),t._v(" 可以在它自己的 xml 文件中进行着色：")]),t._v(" "),s("div",{staticClass:"language-xml line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-xml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("vector")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("xmlns:")]),t._v("android")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("http://schemas.android.com/apk/res/android"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("android:")]),t._v("height")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("152dp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("android:")]),t._v("tint")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("?attr/colorControlNormal"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("android:")]),t._v("viewportHeight")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("152"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("android:")]),t._v("viewportWidth")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("149"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("android:")]),t._v("width")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("149dp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br")])]),s("p",[t._v("注意上面的 "),s("strong",[s("code",[t._v('android:tint="?attr/colorControlNormal"')])]),t._v("，这是在 "),s("code",[t._v("vector")]),t._v(" 中定义的。")]),t._v(" "),s("p",[t._v("如果你给这个 "),s("code",[t._v("tint")]),t._v(" 设定的是一个 "),s("code",[t._v("<selector>")]),t._v("，那么就需要注意了：")]),t._v(" "),s("p",[t._v("如果你的 "),s("code",[t._v("<selector>")]),t._v(" 的第一个 "),s("code",[t._v("<item>")]),t._v(" 不是默认颜色，而是 "),s("code",[t._v("state_enable:false")]),t._v(" 之类的有状态的颜色，那么就需要在测试代码中获取 "),s("code",[t._v("R.attr.colorControlNormal")]),t._v(" 并对 Drawable 重新进行着色，否则即使你没有对这个 Drawable 进行过任何修改，测试依旧会报错失败。")]),t._v(" "),s("p",[t._v("如果你的 "),s("code",[t._v("<selector>")]),t._v(" 的第一个 "),s("code",[t._v("<item>")]),t._v(" 是默认的不带有状态限定的颜色，那么就不需要重新着色。")]),t._v(" "),s("p",[t._v("鉴于默认的 "),s("code",[t._v("colorControlNormal")]),t._v(" 是 "),s("code",[t._v("<selector>")]),t._v(" 颜色，我建议在测试 Drawable 的时候都统一进行重新着色。")]),t._v(" "),s("p",[t._v("而如何在运行时取到 "),s("code",[t._v("colorControlNormal")]),t._v(" 的真正的颜色资源 ID，可以参照以下代码：")]),t._v(" "),s("div",{staticClass:"language-kotlin line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-kotlin"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" typedValue "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("TypedValue")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nit"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("activity"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("theme"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolveAttribute")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("R"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("attr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("colorControlNormal"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" typedValue"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ntintColorRes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" typedValue"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("resourceId\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br")])]),s("p",[t._v("最后拿到的 "),s("code",[t._v("tintColorRes")]),t._v(" 即为颜色资源 ID。")]),t._v(" "),s("p",[t._v("关于其中具体原理，可以参照我的"),s("RouterLink",{attrs:{to:"/Android/android-测试坑点详解（二）——-vectordrawable-和-tint-问题解析/"}},[t._v("下一篇文章")]),t._v("。")],1)])}),[],!1,null,null,null);a.default=e.exports}}]);