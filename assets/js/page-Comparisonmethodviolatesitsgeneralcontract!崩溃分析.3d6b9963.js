(window.webpackJsonp=window.webpackJsonp||[]).push([[39],{949:function(t,a,s){"use strict";s.r(a);var e=s(1),i=Object(e.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("p",[t._v("最近，公司产品中经常发现有用户报告各种列表突然不见的问题，后来发现是子线程报  "),s("code",[t._v("IllegalStateException")]),t._v("，其中的 "),s("code",[t._v("message")]),t._v(" 就是我们的标题。")]),t._v(" "),s("p",[t._v("这个问题还得从 JDK 1.7 开始说起。")]),t._v(" "),s("h2",{attrs:{id:"_1-timsort"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-timsort"}},[t._v("#")]),t._v(" 1. TimSort")]),t._v(" "),s("p",[t._v("JDK 1.7 之后，"),s("code",[t._v("Collections.sort")]),t._v(" 的内部实现从 "),s("strong",[t._v("归并排序")]),t._v(" 修改成了 "),s("strong",[t._v("Tim排序")]),t._v("；")]),t._v(" "),s("p",[t._v("TimSort 简单的来说，就是一个优化的归并排序，它结合了插入排序和归并排序，使得每次算法在归并的时候，避免归并数量相差过大的数组片段（我们称之为 "),s("code",[t._v("run")]),t._v("）以提高性能。")]),t._v(" "),s("p",[t._v("首先，为了找到或者构造出这个 "),s("code",[t._v("run")]),t._v("，我们需要找到一个 "),s("strong",[t._v("升序")]),t._v(" 或者 "),s("strong",[t._v("严格递减")]),t._v(" 的序列；")]),t._v(" "),s("p",[t._v("而在归并过程中，为了提高归并效率，算法提出了一个 "),s("strong",[t._v("Galloping Mode")]),t._v("：")]),t._v(" "),s("p",[t._v("首先，基于我们寻找到的 "),s("code",[t._v("run")]),t._v(" 都是有序的，那么我们就可以尝试将一个 "),s("code",[t._v("run")]),t._v(" 中的元素插入到另一个 "),s("code",[t._v("run")]),t._v(" 中，如果找到了该元素，那么在另一个 "),s("code",[t._v("run")]),t._v(" 中，该元素之前的元素都满足我们的排序要求。")]),t._v(" "),s("p",[t._v("例如，如果要将 "),s("span",{staticClass:"katex"},[s("span",{staticClass:"katex-mathml"},[s("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[s("semantics",[s("mrow",[s("mi",[t._v("X")])],1),s("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("X")])],1)],1)],1),s("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[s("span",{staticClass:"base"},[s("span",{staticClass:"strut",staticStyle:{height:"0.68333em","vertical-align":"0em"}}),s("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.07847em"}},[t._v("X")])])])]),t._v(" 和 "),s("span",{staticClass:"katex"},[s("span",{staticClass:"katex-mathml"},[s("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[s("semantics",[s("mrow",[s("mi",[t._v("Y")])],1),s("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("Y")])],1)],1)],1),s("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[s("span",{staticClass:"base"},[s("span",{staticClass:"strut",staticStyle:{height:"0.68333em","vertical-align":"0em"}}),s("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.22222em"}},[t._v("Y")])])])]),t._v(" 两个 "),s("code",[t._v("run")]),t._v(" 进行归并：")]),t._v(" "),s("blockquote",[s("p",[t._v("其中的 "),s("code",[t._v("temporary")]),t._v(" 是一个临时存储数组，它是通过较短的那个 "),s("code",[t._v("run")]),t._v(" 复制得到的\n这里的 "),s("code",[t._v("temporary")]),t._v(" 实际上就是 "),s("span",{staticClass:"katex"},[s("span",{staticClass:"katex-mathml"},[s("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[s("semantics",[s("mrow",[s("mi",[t._v("X")])],1),s("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("X")])],1)],1)],1),s("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[s("span",{staticClass:"base"},[s("span",{staticClass:"strut",staticStyle:{height:"0.68333em","vertical-align":"0em"}}),s("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.07847em"}},[t._v("X")])])])])])]),t._v(" "),s("p",[s("img",{attrs:{src:"/images/尝试将x-0-插入到y中.png",alt:"尝试将X[0]插入到Y中"}})]),t._v(" "),s("p",[t._v("我们会在 "),s("span",{staticClass:"katex"},[s("span",{staticClass:"katex-mathml"},[s("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[s("semantics",[s("mrow",[s("mi",[t._v("Y")])],1),s("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("Y")])],1)],1)],1),s("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[s("span",{staticClass:"base"},[s("span",{staticClass:"strut",staticStyle:{height:"0.68333em","vertical-align":"0em"}}),s("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.22222em"}},[t._v("Y")])])])]),t._v(" 中，尝试将 "),s("span",{staticClass:"katex"},[s("span",{staticClass:"katex-mathml"},[s("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[s("semantics",[s("mrow",[s("mi",[t._v("Y")]),s("mo",{attrs:{stretchy:"false"}},[t._v("[")]),s("mn",[t._v("0")]),s("mo",{attrs:{stretchy:"false"}},[t._v("]")])],1),s("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("Y[0]")])],1)],1)],1),s("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[s("span",{staticClass:"base"},[s("span",{staticClass:"strut",staticStyle:{height:"1em","vertical-align":"-0.25em"}}),s("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.22222em"}},[t._v("Y")]),s("span",{staticClass:"mopen"},[t._v("[")]),s("span",{staticClass:"mord"},[t._v("0")]),s("span",{staticClass:"mclose"},[t._v("]")])])])]),t._v(" 插入到 "),s("span",{staticClass:"katex"},[s("span",{staticClass:"katex-mathml"},[s("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[s("semantics",[s("mrow",[s("mi",[t._v("X")])],1),s("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("X")])],1)],1)],1),s("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[s("span",{staticClass:"base"},[s("span",{staticClass:"strut",staticStyle:{height:"0.68333em","vertical-align":"0em"}}),s("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.07847em"}},[t._v("X")])])])]),t._v(" 中，那么在 "),s("span",{staticClass:"katex"},[s("span",{staticClass:"katex-mathml"},[s("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[s("semantics",[s("mrow",[s("mi",[t._v("Y")]),s("mo",{attrs:{stretchy:"false"}},[t._v("[")]),s("mn",[t._v("0")]),s("mo",{attrs:{stretchy:"false"}},[t._v("]")])],1),s("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("Y[0]")])],1)],1)],1),s("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[s("span",{staticClass:"base"},[s("span",{staticClass:"strut",staticStyle:{height:"1em","vertical-align":"-0.25em"}}),s("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.22222em"}},[t._v("Y")]),s("span",{staticClass:"mopen"},[t._v("[")]),s("span",{staticClass:"mord"},[t._v("0")]),s("span",{staticClass:"mclose"},[t._v("]")])])])]),t._v(" 的插入位置之前的 "),s("span",{staticClass:"katex"},[s("span",{staticClass:"katex-mathml"},[s("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[s("semantics",[s("mrow",[s("mi",[t._v("x")]),s("mo",[t._v("∈")]),s("mi",[t._v("X")])],1),s("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("x \\in X")])],1)],1)],1),s("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[s("span",{staticClass:"base"},[s("span",{staticClass:"strut",staticStyle:{height:"0.5782em","vertical-align":"-0.0391em"}}),s("span",{staticClass:"mord mathnormal"},[t._v("x")]),s("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2777777777777778em"}}),s("span",{staticClass:"mrel"},[t._v("∈")]),s("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2777777777777778em"}})]),s("span",{staticClass:"base"},[s("span",{staticClass:"strut",staticStyle:{height:"0.68333em","vertical-align":"0em"}}),s("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.07847em"}},[t._v("X")])])])]),t._v(" 都满足 "),s("span",{staticClass:"katex"},[s("span",{staticClass:"katex-mathml"},[s("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[s("semantics",[s("mrow",[s("mi",[t._v("x")]),s("mo",[t._v("≤")]),s("mi",[t._v("Y")]),s("mo",{attrs:{stretchy:"false"}},[t._v("[")]),s("mn",[t._v("0")]),s("mo",{attrs:{stretchy:"false"}},[t._v("]")])],1),s("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("x \\le Y[0]")])],1)],1)],1),s("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[s("span",{staticClass:"base"},[s("span",{staticClass:"strut",staticStyle:{height:"0.7719400000000001em","vertical-align":"-0.13597em"}}),s("span",{staticClass:"mord mathnormal"},[t._v("x")]),s("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2777777777777778em"}}),s("span",{staticClass:"mrel"},[t._v("≤")]),s("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2777777777777778em"}})]),s("span",{staticClass:"base"},[s("span",{staticClass:"strut",staticStyle:{height:"1em","vertical-align":"-0.25em"}}),s("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.22222em"}},[t._v("Y")]),s("span",{staticClass:"mopen"},[t._v("[")]),s("span",{staticClass:"mord"},[t._v("0")]),s("span",{staticClass:"mclose"},[t._v("]")])])])]),t._v(";")]),t._v(" "),s("p",[t._v("同时，在寻找这个插入位置时，并不是一个一个的寻找，而是间隔寻找，寻找索引为 "),s("span",{staticClass:"katex"},[s("span",{staticClass:"katex-mathml"},[s("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[s("semantics",[s("mrow",[s("mn",[t._v("2")]),s("mi",[t._v("k")]),s("mo",[t._v("−")]),s("mn",[t._v("1")])],1),s("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("2k-1")])],1)],1)],1),s("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[s("span",{staticClass:"base"},[s("span",{staticClass:"strut",staticStyle:{height:"0.77777em","vertical-align":"-0.08333em"}}),s("span",{staticClass:"mord"},[t._v("2")]),s("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.03148em"}},[t._v("k")]),s("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2222222222222222em"}}),s("span",{staticClass:"mbin"},[t._v("−")]),s("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.2222222222222222em"}})]),s("span",{staticClass:"base"},[s("span",{staticClass:"strut",staticStyle:{height:"0.64444em","vertical-align":"0em"}}),s("span",{staticClass:"mord"},[t._v("1")])])])]),t._v(" 的元素，这样比较次数就是 "),s("span",{staticClass:"katex"},[s("span",{staticClass:"katex-mathml"},[s("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[s("semantics",[s("mrow",[s("mi",[t._v("log")]),s("mo",[t._v("⁡")]),s("mi",[t._v("X")])],1),s("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("\\log X")])],1)],1)],1),s("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[s("span",{staticClass:"base"},[s("span",{staticClass:"strut",staticStyle:{height:"0.8888799999999999em","vertical-align":"-0.19444em"}}),s("span",{staticClass:"mop"},[t._v("lo"),s("span",{staticStyle:{"margin-right":"0.01389em"}},[t._v("g")])]),s("span",{staticClass:"mspace",staticStyle:{"margin-right":"0.16666666666666666em"}}),s("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.07847em"}},[t._v("X")])])])]),t._v("，减少比较次数，有时候能比二分查找更快。")]),t._v(" "),s("p",[t._v("经过这样的查找之后，我们寻找到 "),s("code",[t._v("4")]),t._v(" 这个元素，将其插入结果中；")]),t._v(" "),s("p",[t._v("随后，我们反转查找目标，在 "),s("span",{staticClass:"katex"},[s("span",{staticClass:"katex-mathml"},[s("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[s("semantics",[s("mrow",[s("mi",[t._v("X")])],1),s("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("X")])],1)],1)],1),s("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[s("span",{staticClass:"base"},[s("span",{staticClass:"strut",staticStyle:{height:"0.68333em","vertical-align":"0em"}}),s("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.07847em"}},[t._v("X")])])])]),t._v(" 中尝试将 "),s("span",{staticClass:"katex"},[s("span",{staticClass:"katex-mathml"},[s("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[s("semantics",[s("mrow",[s("mi",[t._v("X")]),s("mo",{attrs:{stretchy:"false"}},[t._v("[")]),s("mn",[t._v("0")]),s("mo",{attrs:{stretchy:"false"}},[t._v("]")])],1),s("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("X[0]")])],1)],1)],1),s("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[s("span",{staticClass:"base"},[s("span",{staticClass:"strut",staticStyle:{height:"1em","vertical-align":"-0.25em"}}),s("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.07847em"}},[t._v("X")]),s("span",{staticClass:"mopen"},[t._v("[")]),s("span",{staticClass:"mord"},[t._v("0")]),s("span",{staticClass:"mclose"},[t._v("]")])])])]),t._v(" 插入到 "),s("span",{staticClass:"katex"},[s("span",{staticClass:"katex-mathml"},[s("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[s("semantics",[s("mrow",[s("mi",[t._v("Y")])],1),s("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("Y")])],1)],1)],1),s("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[s("span",{staticClass:"base"},[s("span",{staticClass:"strut",staticStyle:{height:"0.68333em","vertical-align":"0em"}}),s("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.22222em"}},[t._v("Y")])])])]),t._v(" 中：")]),t._v(" "),s("p",[s("img",{attrs:{src:"/images/将-x-0-插入到-y-中.png",alt:"将X\\[0\\]插入到Y中"}})]),t._v(" "),s("p",[t._v("随后又反转查找目标，不断进行，直到当次归并完成为止。")]),t._v(" "),s("h2",{attrs:{id:"_2-出现问题的原因"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-出现问题的原因"}},[t._v("#")]),t._v(" 2. 出现问题的原因")]),t._v(" "),s("p",[t._v("那么 TimSort 和这个崩溃有什么关系呢？")]),t._v(" "),s("p",[t._v("我们看到，在这个 Galloping 的过程中，我们需要将 "),s("span",{staticClass:"katex"},[s("span",{staticClass:"katex-mathml"},[s("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[s("semantics",[s("mrow",[s("mi",[t._v("X")])],1),s("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("X")])],1)],1)],1),s("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[s("span",{staticClass:"base"},[s("span",{staticClass:"strut",staticStyle:{height:"0.68333em","vertical-align":"0em"}}),s("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.07847em"}},[t._v("X")])])])]),t._v(" 中的元素和 "),s("span",{staticClass:"katex"},[s("span",{staticClass:"katex-mathml"},[s("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[s("semantics",[s("mrow",[s("mi",[t._v("Y")])],1),s("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("Y")])],1)],1)],1),s("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[s("span",{staticClass:"base"},[s("span",{staticClass:"strut",staticStyle:{height:"0.68333em","vertical-align":"0em"}}),s("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.22222em"}},[t._v("Y")])])])]),t._v(" 中进行比较，又要拿 "),s("span",{staticClass:"katex"},[s("span",{staticClass:"katex-mathml"},[s("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[s("semantics",[s("mrow",[s("mi",[t._v("Y")])],1),s("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("Y")])],1)],1)],1),s("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[s("span",{staticClass:"base"},[s("span",{staticClass:"strut",staticStyle:{height:"0.68333em","vertical-align":"0em"}}),s("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.22222em"}},[t._v("Y")])])])]),t._v(" 中的元素和 "),s("span",{staticClass:"katex"},[s("span",{staticClass:"katex-mathml"},[s("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[s("semantics",[s("mrow",[s("mi",[t._v("X")])],1),s("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("X")])],1)],1)],1),s("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[s("span",{staticClass:"base"},[s("span",{staticClass:"strut",staticStyle:{height:"0.68333em","vertical-align":"0em"}}),s("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.07847em"}},[t._v("X")])])])]),t._v(" 中的元素进行比较；")]),t._v(" "),s("p",[t._v("因此，对于 "),s("span",{staticClass:"katex"},[s("span",{staticClass:"katex-mathml"},[s("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[s("semantics",[s("mrow",[s("mi",[t._v("X")])],1),s("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("X")])],1)],1)],1),s("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[s("span",{staticClass:"base"},[s("span",{staticClass:"strut",staticStyle:{height:"0.68333em","vertical-align":"0em"}}),s("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.07847em"}},[t._v("X")])])])]),t._v(" 和 "),s("span",{staticClass:"katex"},[s("span",{staticClass:"katex-mathml"},[s("math",{attrs:{xmlns:"http://www.w3.org/1998/Math/MathML"}},[s("semantics",[s("mrow",[s("mi",[t._v("Y")])],1),s("annotation",{attrs:{encoding:"application/x-tex"}},[t._v("Y")])],1)],1)],1),s("span",{staticClass:"katex-html",attrs:{"aria-hidden":"true"}},[s("span",{staticClass:"base"},[s("span",{staticClass:"strut",staticStyle:{height:"0.68333em","vertical-align":"0em"}}),s("span",{staticClass:"mord mathnormal",staticStyle:{"margin-right":"0.22222em"}},[t._v("Y")])])])]),t._v(" 中的 "),s("code",[t._v("Comparator")]),t._v(" 的要求就比较严格，它需要满足以下三条 "),s("code",[t._v("Comparator")]),t._v(" 的合约：")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("1. compare(a, b) = -compare(b, a) （自反性）\n2. compare(a, b) > 0 && compare(b, c) > 0 then compare(a, c) > 0 （传递性）\n3. if compare(a, b) == 0 then compare(a, x) == compare(b, x)，其中 x 为任意值\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br")])]),s("p",[t._v("如果 "),s("code",[t._v("Comparator")]),t._v(" 不满足上面的合约，就会导致这个算法在归并的时候，明明还没归并完，但是某一个 "),s("code",[t._v("run")]),t._v(" 已经耗尽了，这说明这两个 "),s("code",[t._v("run")]),t._v(" 不是均衡的，不符合这个算法的初衷，因此它就会报错。")]),t._v(" "),s("p",[t._v("所以，在升级到 JDK 1.7 之后，需要着重注意 "),s("code",[t._v("Comparator")]),t._v(" 的设计，下面会列出几种造成 "),s("code",[t._v("Comparator")]),t._v(" 不符合合约的典型情况。")]),t._v(" "),s("h2",{attrs:{id:"_3-造成崩溃的典型情况"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-造成崩溃的典型情况"}},[t._v("#")]),t._v(" 3. 造成崩溃的典型情况")]),t._v(" "),s("h3",{attrs:{id:"_3-1-没有考虑相等的情况"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-没有考虑相等的情况"}},[t._v("#")]),t._v(" 3.1 没有考虑相等的情况")]),t._v(" "),s("p",[t._v("特别是使用 "),s("code",[t._v("?:")]),t._v(" 三目运算符计算出的 compare 结果，尤其会造成这种情况，例如:")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("a < b ? 1 : -1\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[t._v("在这里，如果 "),s("code",[t._v("a == b")]),t._v("，那就会出现 "),s("code",[t._v("compare(a, b) = 1")]),t._v(" 而且 "),s("code",[t._v("compare(b, a) == 1")]),t._v("，违反自反性。")]),t._v(" "),s("p",[t._v("解决办法：\n一定要遍历 "),s("code",[t._v("a")]),t._v(" 和 "),s("code",[t._v("b")]),t._v(" 可能的比较关系的三种情况。")]),t._v(" "),s("h3",{attrs:{id:"_3-2-使用四则计算、强制转换"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-使用四则计算、强制转换"}},[t._v("#")]),t._v(" 3.2 使用四则计算、强制转换")]),t._v(" "),s("p",[t._v("这种 "),s("code",[t._v("Comparator")]),t._v(" 很多书上都会这么写：")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("return o1 - o2\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[t._v("但是这个写法是不安全的，它会存在 "),s("strong",[t._v("溢出问题")]),t._v("，例如 "),s("code",[t._v("Int.MAX_VAL")]),t._v(" 和 "),s("code",[t._v("-1")]),t._v("，我们知道，"),s("code",[t._v("Int.MAX_VAL")]),t._v(" 是一定大于 "),s("code",[t._v("-1")]),t._v(" 的，但是如果使用这种计算方式，那么就会有：")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("compare(Int.MAX_VAL, -1) = Int.MAX_VAL - (-1) = -2147483648 < 0\n\ncompare(-1, Int.MAX_VAL) = -1 - Int.MAX_VAL = -2147483648 < 0\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br")])]),s("p",[t._v("违反自反性。")]),t._v(" "),s("p",[t._v("同理，如果将一个 "),s("code",[t._v("Long")]),t._v(" 值强制转换到 "),s("code",[t._v("Int")]),t._v(" 值也会出现这样的问题，因为强制转换的过程中丢失了精度，会导致溢出问题。")]),t._v(" "),s("p",[t._v("解决办法：\n对于数值型的比较问题，我们可以将这个工作委托给对应的类进行，例如 "),s("code",[t._v("Integer")]),t._v(" 就有一个 "),s("code",[t._v("compare()")]),t._v(" 方法用于比较两个 "),s("code",[t._v("int")]),t._v(" 值。")]),t._v(" "),s("h3",{attrs:{id:"_3-3-线程安全问题"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-线程安全问题"}},[t._v("#")]),t._v(" 3.3 线程安全问题")]),t._v(" "),s("p",[t._v("当然，在比较的过程中，我们还要注意线程安全问题，如果线程不安全，那很可能在归并过程中，元素的值被改动了，因此就会导致比较的结果不正确。")]),t._v(" "),s("p",[t._v("解决办法：\n对于线程安全，可以用传统的解决线程安全的办法进行解决，也可以让所有的元素都是 "),s("strong",[t._v("不变量")]),t._v("，如果一个量永远都不会变，那么它无论多少个线程进行操作，都是安全的。")]),t._v(" "),s("h2",{attrs:{id:"_4-系统兼容性"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-系统兼容性"}},[t._v("#")]),t._v(" 4. 系统兼容性")]),t._v(" "),s("p",[t._v("这里要特别注意的是，如果上述的解决办法难以实施，也可以通过参数配置使用原先的归并排序，归并排序不要求两个 "),s("code",[t._v("run")]),t._v(" 是均衡的，因此就不会出现这个崩溃问题；")]),t._v(" "),s("p",[t._v("但是，只有 JVM 系统才能使用这个 workaround，如果是 Android，它内置的源码就已经去除掉了原先的归并排序，只能迎难而上处理这个问题。")]),t._v(" "),s("h2",{attrs:{id:"_5-参考资料"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-参考资料"}},[t._v("#")]),t._v(" 5. 参考资料")]),t._v(" "),s("p",[s("a",{attrs:{href:"https://medium.com/@rscheiwe",target:"_blank",rel:"noopener noreferrer"}},[t._v("Richard Scheiwe"),s("OutboundLink")],1),t._v("——"),s("a",{attrs:{href:"https://medium.com/@rscheiwe/the-case-for-timsort-349d5ce1e414",target:"_blank",rel:"noopener noreferrer"}},[t._v("The Case for Timsort\n"),s("OutboundLink")],1)])])}),[],!1,null,null,null);a.default=i.exports}}]);